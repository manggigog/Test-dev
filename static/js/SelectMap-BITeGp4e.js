import{_ as Q,z as X,q as me,y as O,F as V,G as b,H as h,P as S,I as p,Q as ie,O as de,$ as N,a4 as Fe,X as ve,Y as he,r as i,J as xe,K as Se,Z as Y,N as Ae,o as _e,E as ye,ab as Ee,U as Be,T as w}from"./vendor-Dr_RpJ_Y.js";import{C as Re}from"./CommonVanProvider-KZuKVOde.js";import{u as Te}from"./useCityMap-gT1oK5g9.js";import{a as ge}from"./index-CU2nzZe6.js";import{P as G,L as fe,S as pe}from"./iconAssets-DsommeAx.js";import{_ as ze}from"./SearchBar-CUnT4Ffc.js";import"./BackIcon-CDrGaEPo.js";import"./localMark-YkRe0gPv.js";import"./search-B34EARrH.js";import"./delete-Dyula9w6.js";const Pe=l=>(ve("data-v-288c2402"),l=l(),he(),l),je={class:"w-full h-[158px] bg-white rounded-xl p-4 shadow-[0_0.5px_16px_0_rgba(0,0,0,0.16)]"},Ue={key:0,class:"w-full h-full flex justify-center items-center"},Ve={key:1,class:"h-full flex flex-col justify-between"},Ne={class:"shop-name flex items-center justify-between"},qe={class:"text-base text-b1 font-semibold line-clamp-1"},He={class:"shop-desc mt-1"},Ke={class:"text-b3 text-sm line-clamp-2"},Ze=Fe(" 确认选择 "),Ge={key:2,class:"w-full h-full flex justify-center items-center"},Oe=Pe(()=>p("span",{class:"text-base text-b3 font-normal"},"暂无结果",-1)),Je=[Oe],Qe=X({props:{storeInfo:null,loading:{type:Boolean},emptyFlag:{type:Boolean}},emits:["handleConfirm"],setup(l,{emit:A}){const d=l;me();const{getLeafletjsAddressTitle:f,getLeafletjsAddressDescription:s}=Te(),y=O(()=>d.storeInfo?f(d.storeInfo):""),_=O(()=>d.storeInfo?s(d.storeInfo):""),m=()=>{console.log("confirmSelect"),A("handleConfirm",{...d.storeInfo,title:y.value,description:_.value})};return(r,g)=>{const c=V("van-loading"),n=V("VanButton");return h(),b("div",je,[l.loading?(h(),b("div",Ue,[S(c,{class:"shrink-0",size:"40"})])):l.emptyFlag?(h(),b("div",Ge,Je)):(h(),b("div",Ve,[p("div",null,[p("div",Ne,[p("div",qe,ie(de(y)),1)]),p("div",He,[p("p",Ke,ie(de(_)),1)])]),S(n,{class:"shrink-0 w-full h-[46px] rounded-full border border-solid border-[#000] bg-btnOrBg text-b1 text-base font-semibold",onClick:m},{default:N(()=>[Ze]),_:1})]))])}}}),J=Q(Qe,[["__scopeId","data-v-288c2402"]]),Xe={class:"swiper-card-container"},Ye={class:"card-wrapper"},We={props:{cardData:{type:Array,default:()=>[]}},emits:["changeIndex","handleConfirm"],setup(l,{expose:A,emit:d}){const f=i(null),s=i(0),y=m=>{s.value=m,d("changeIndex",m)};return A({activeIndex:s,updateActiveIndex:m=>{s.value=m,f.value&&f.value.swipeTo(m)}}),(m,r)=>{const g=V("van-swipe-item"),c=V("van-swipe");return h(),b("div",Xe,[S(c,{ref:(n,I)=>{I.swiperRef=n,f.value=n},active:s.value,"onUpdate:active":r[1]||(r[1]=n=>s.value=n),loop:!1,"show-indicators":!1,touchable:!0,class:"custom-swiper",onChange:y},{default:N(()=>[(h(!0),b(xe,null,Se(l.cardData,(n,I)=>(h(),Y(g,{key:n.id,class:Ae(["swipe-item",{right:s.value+1===I,left:s.value-1===I}])},{default:N(()=>[p("div",Ye,[S(J,{storeInfo:n,onHandleConfirm:r[0]||(r[0]=M=>d("handleConfirm",M))},null,8,["storeInfo"])])]),_:2},1032,["class"]))),128))]),_:1},8,["active"])])}}},De=Q(We,[["__scopeId","data-v-def9542e"]]),et=l=>(ve("data-v-6d47d222"),l=l(),he(),l),tt={class:"w-full h-full relative"},ot=et(()=>p("div",{id:"map",class:"w-full h-full relative z-0"},null,-1)),st={class:"absolute bottom-[12px] left-0 right-0 z-10"},nt={key:1,class:"w-full flex justify-center items-center"},at={class:"shrink-0 w-[335px]"},lt={key:2,class:"w-full flex justify-center items-center"},rt={class:"shrink-0 w-[335px]"},ct=X({emits:["handleConfirm"],setup(l,{expose:A,emit:d}){const f=_e(),{cityMapStore:s}=ge(),y=i(null),_=i(0),m=i(""),r=i([]),g=i(!1),c=i(null),n=i(null),I=i(!1),M=i(null),v=i("current");let u=null,W=16,B=null,R=[];const D=O(()=>{var t,e,o,a,C,k,$,F;return(t=f.query)!=null&&t.lng&&((e=f.query)!=null&&e.lat)?{lng:+((o=f.query)==null?void 0:o.lng),lat:+((a=f.query)==null?void 0:a.lat)}:(C=s.locationCoords)!=null&&C.lng&&((k=s.locationCoords)!=null&&k.lat)?{lng:s.locationCoords.lng,lat:s.locationCoords.lat}:{lng:(($=s.currentActiveCity)==null?void 0:$.areaLongitude)||"",lat:((F=s.currentActiveCity)==null?void 0:F.areaLatitude)||""}}),Ce=t=>new Promise(e=>setTimeout(e,t)),ee=(t,e,o="网络连接失败",a=0,C=1e3)=>{const k=async $=>{const F=new AbortController,T=setTimeout(()=>F.abort(),15e3);try{const E={signal:F.signal},P=await(await fetch(t,E)).json();return clearTimeout(T),P}catch(E){return $>0?(await Ce(C),k($-1)):(clearTimeout(T),((e==null?void 0:e.showMode)==="list"&&H(e==null?void 0:e.keyword)||(e==null?void 0:e.showMode)==="current"&&q(e==null?void 0:e.lat,e==null?void 0:e.lng))&&(console.error(E),w.clear(),w.fail(o)),null)}};return k(a)},we=()=>{try{const t=D.value;u=L.map("map",{center:[t.lat,t.lng],zoom:12,trackResize:!0,zoomControl:!1}),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"",subdomains:"abcd",maxZoom:17,minZoom:7}).addTo(u),u.on("click",function(e){console.log("mapClick",e),v.value="current",w.clear();const o=e.latlng.lat,a=e.latlng.lng;z(),R.forEach((C,k)=>{C.setIcon(G)}),B=L.marker([o,a],{icon:fe}).addTo(u),te(o,a)}),setTimeout(()=>{Ie()})}catch{}finally{}},Ie=async()=>{let t="",e="";if(s.selectedMap)t=s.selectedMap.lat,e=s.selectedMap.lng;else{const o=D.value;t=o.lat,e=o.lng}t&&e&&(z(),B=L.marker([t,e],{icon:fe}).addTo(u),u.flyTo([t,e],W,{duration:.8,easeLinearity:1}),te(t,e))},ke=()=>{const t=r.value[_.value];t&&t.lat&&t.lng&&u.flyTo([t.lat,t.lng],W,{duration:.8,easeLinearity:1})},q=(t,e)=>{var o,a;return v.value==="current"&&((o=c.value)==null?void 0:o.lat)===t&&((a=c.value)==null?void 0:a.lng)===e},te=async(t,e)=>{c.value={lat:t,lng:e},I.value=!0;try{const o=await ee(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${t}&lon=${e}&addressdetails=1&accept-language=zh-CN`,{showMode:v.value,lat:t,lng:e});q(t,e)&&(I.value=!1,oe(t,e,o))}catch{q(t,e)&&(w.fail("网络请求失败"),I.value=!1,oe(t,e,null))}},oe=(t,e,o)=>{console.log("displayLocationInfo",o),o?(n.value={lat:+o.lat,lng:+o.lon,name:o.name,display_name:o.display_name,address:o.address},M.value={lat:+o.lat,lng:+o.lon,name:o.name,display_name:o.display_name,address:o.address}):(n.value=null,v.value="empty")},be=()=>{ae(),r.value.forEach((t,e)=>{if(t.lat&&t.lng){const o=e===_.value?pe:G,a=L.marker([t.lat,t.lng],{icon:o}).addTo(u);a.on("click",()=>{v.value="list",z(),K(e,!0)}),R.push(a)}})},se=()=>{R.forEach((t,e)=>{const o=e===_.value?pe:G;t.setIcon(o)})},H=t=>v.value==="list"&&m.value===t,Me=async(t="")=>{var k,$,F,T,E,Z,P,le,re,ce,ue;m.value=t,v.value="list",c.value=null,g.value=!0,w.loading({duration:0});let e=($=(k=M.value)==null?void 0:k.address)==null?void 0:$.country,o=(T=(F=M.value)==null?void 0:F.address)==null?void 0:T.country_code,a=((Z=(E=M.value)==null?void 0:E.address)==null?void 0:Z.state)||((le=(P=M.value)==null?void 0:P.address)==null?void 0:le.region),C=(ue=(ce=(re=M.value)==null?void 0:re.address)==null?void 0:ce.postcode)==null?void 0:ue.slice(0,4);C&&(C+="00");try{const j=await ee(`https://nominatim.openstreetmap.org/search?format=jsonv2&amenity=${encodeURI(t)}&state=${encodeURI(a)}&postalcode=${encodeURI(C)}&country=${encodeURI(e)}&country_code=${encodeURI(o)}&addressdetails=1&accept-language=zh-CN&extratags=1`,{showMode:v.value,keyword:t});if(g.value=!1,H(t)){if(console.log("搜索结果",j),!j)return;w.clear();let U=j||[];U=Array.from(new Map(U.map(x=>[x.osm_id,x])).values()),U.length?r.value=U.map(x=>({lat:+x.lat,lng:+x.lon,name:x.name,display_name:x.display_name,address:x.address})):(w.fail("暂无结果"),v.value="empty"),be(),K(0)}}catch{H(t)&&(g.value=!1,w.clear(),w.fail("网络请求失败"))}},K=(t,e=!1)=>{_.value=t,e&&y.value&&y.value.updateActiveIndex(t),ke(),e?se():setTimeout(()=>{se()},600)},$e=()=>{ne(),r.value=[],_.value=0},ne=()=>{R.forEach(t=>{u&&u.removeLayer(t)}),R=[]},z=()=>{B&&u&&(u.removeLayer(B),B=null)},ae=()=>{ne(),z()},Le=()=>{ae(),u&&(u.remove(),u=null)};return ye(async()=>{we()}),Ee(()=>{Le()}),A({searchKeyword:Me,clearArrData:$e}),(t,e)=>(h(),b("div",tt,[ot,p("div",st,[v.value==="list"&&r.value.length&&!g.value?(h(),Y(De,{key:0,ref:(o,a)=>{a.mapSearchResultList=o,y.value=o},"card-data":r.value,onChangeIndex:K,onHandleConfirm:e[0]||(e[0]=o=>d("handleConfirm",o))},null,8,["card-data"])):v.value==="current"?(h(),b("div",nt,[p("div",at,[S(J,{storeInfo:n.value,loading:I.value,onHandleConfirm:e[1]||(e[1]=o=>d("handleConfirm",o))},null,8,["storeInfo","loading"])])])):v.value==="empty"?(h(),b("div",lt,[p("div",rt,[S(J,{"empty-flag":"",onHandleConfirm:e[2]||(e[2]=o=>d("handleConfirm",o))})])])):Be("",!0)])]))}}),ut=Q(ct,[["__scopeId","data-v-6d47d222"]]),it={class:"h-[calc(100vh-50px)] w-full overflow-hidden"},dt={class:"px-3 pb-3"},ft={class:"h-[calc(100vh-50px-48px)] bg-[#F2F0EF]"},kt=X({setup(l){_e();const A=me(),{cityMapStore:d}=ge();i(!1);const f=i(null),s=i({keyword:""}),y=()=>{if(!s.value.keyword)return w.fail("请输入街道名称");f.value.searchKeyword(s.value.keyword)},_=()=>{f.value.clearArrData()},m=r=>{d.setSelectedMap(r),A.back()};return ye(()=>{}),(r,g)=>(h(),Y(Re,{title:"地图选点",class:"bg-white font-Puhui font-normal relative","theme-vars":{"field-placeholder-text-color":"#A6A6A6",navBarBackgroundColor:"#fff"},ref:(c,n)=>{n.searchRef=c}},{default:N(()=>[p("div",it,[p("div",dt,[S(ze,{modelValue:s.value.keyword,"onUpdate:modelValue":g[0]||(g[0]=c=>s.value.keyword=c),placeholder:"请输入街道名称","search-button-text":"搜索",onSearch:y,onClear:_},null,8,["modelValue"])]),p("section",ft,[S(ut,{ref:(c,n)=>{n.mapRef=c,f.value=c},onHandleConfirm:m},null,512)])])]),_:1},512))}});export{kt as default};
