import{_ as z,y as q,w as K,E as I,F as f,G as u,H as i,O as C,Q as g,I as P,J as G,N as B,aH as re,Y as U,Z as Y,x as D,B as M,K as J,a2 as L,P as d,a0 as ee,R as Ie,bf as Be,l as _e,be as te,bN as Se,r as j,z as Ae,D as De,bj as Me,T as oe,n as $e}from"./vendor-BUT0HZ5j.js";import{_ as Ne}from"./mall-BNNzTN-n.js";import{O as Ee}from"./OrderGoods-QgVMJTqN.js";import{_ as Fe}from"./MCOIN-BcbOHmhy.js";import{c as se,d as H,e as Re,r as Le,s as ne,q as ae}from"./index-k1FFr-1T.js";import{_ as qe}from"./DividingLine-9-ITJMKz.js";import{_ as Oe}from"./RecommendationFeed-Bbce_x7T.js";import{a as Ve,b as le,c as je,d as He}from"./cart-D1U0eSk3.js";import{c as Pe}from"./goods-Dr4TCxnz.js";import{P as $}from"./flashSale-DDyqLyYN.js";import{S as ce}from"./shop-CeqcS6K2.js";import"./BoutiqueLable-r45nG6V6.js";import"./ShopMaskTips-dKZ6_BUi.js";import"./GoodsList-Lr4FQrJv.js";import"./buy-cart-3M2I0Qjc.js";import"./goods-BVwS8oFG.js";import"./GoodsPrice-Ai76_1qQ.js";import"./mall-BnAUsXOy.js";import"./WaterFull-CDtRtt9C.js";import"./useShowActiveInfo-DuFFXoYb.js";import"./festivalActivities-BFq1MXfj.js";const Ge=n=>(U("data-v-27a50109"),n=n(),Y(),n),Je=Ge(()=>i("img",{src:Ne,class:"w-4 mr-1"},null,-1)),ze={class:"text-base font-semibold"},Ke=q({props:{cartInfo:null,isManage:{type:Boolean}},emits:["changeNumber","handelDel","handleTo","handleRemove"],setup(n,{emit:h}){const s=n,{t:b}=K(),p=(y,c)=>{re.confirm({message:b("cart.remove"),confirmButtonText:b("common.confirm"),confirmButtonColor:"#FF507A",cancelButtonText:b("common.cancel")}).then(()=>{h("handelDel",s.cartInfo,y,c)}).catch(()=>{})},k=(y,c)=>{h("handelDel",s.cartInfo,y,c),h("handleRemove",s.cartInfo,y,c)};return(y,c)=>{const l=I("van-icon"),_=I("van-checkbox"),x=I("van-button"),S=I("VanSwipeCell");return u(),f("div",null,[i("div",{class:"flex-start mt-2.5",onClick:c[0]||(c[0]=m=>h("handleTo",`/category?deliveryType=1&shopId=${n.cartInfo.storeId}`))},[Je,i("div",ze,g(n.cartInfo.storeName||"-"),1),C(l,{name:"arrow",class:"ml-2"})]),(u(!0),f(P,null,G(n.cartInfo.goods,(m,N)=>(u(),f("div",{class:"bg-white mt-2.5 rounded-xl p-2.5",key:m.id},[C(S,null,{right:B(()=>[C(x,{square:"",class:"right-btn",color:"#FEA021",text:y.$t("cart.removeTo"),onClick:T=>k(m,N)},null,8,["text","onClick"]),C(x,{square:"",class:"right-btn",color:"#FF507A",text:y.$t("shop.delete"),onClick:T=>p(m,N)},null,8,["text","onClick"])]),default:B(()=>[C(_,{disabled:m.disabled&&!n.isManage,name:m,class:"min-w-min mr-0"},{default:B(()=>[C(Ee,{goods:m,payType:m.payType,card:m,number:m.number||1,shopType:m.shopType,class:"w-full flex-1 mb-2.5 last:mb-0 pl-0",onChangeNumber:T=>h("changeNumber",m,T),onHandleTo:c[1]||(c[1]=T=>h("handleTo",T))},null,8,["goods","payType","card","number","shopType","onChangeNumber"])]),_:2},1032,["disabled","name"])]),_:2},1024)]))),128))])}}}),Ue=z(Ke,[["__scopeId","data-v-27a50109"]]),de=n=>(U("data-v-0c6757c2"),n=n(),Y(),n),Ye={class:"w-full h-14 flex items-center justify-between pb-0.5 px-2 bg-white rounded-full sm:w-[355px] shadow-2 pointer-events-auto"},Qe={class:"opacity-70"},Xe={key:0,class:"ml-2 text-sm text-default"},Ze=de(()=>i("span",{class:"opacity-70"},[i("span",{class:"mr-1 text-lg"},"≈")],-1)),We={class:"text-base font-semibold text-primary"},et={key:1,class:"flex items-center justify-between flex-1 text-default dropdown-class"},tt={key:0,class:"flex items-center justify-between flex-1 px-2.5"},ot={class:"text-sm text-default"},st={class:"text-xs font-normal"},nt={class:"text-xs font-normal text-center"},at={class:"text-right"},lt={class:"flex items-center justify-end flex-1 w-full text-base font-semibold text-right"},ct=de(()=>i("img",{class:"w-4 h-4 mr-1",src:Fe},null,-1)),rt={class:"text-base"},dt={key:0,class:"text-[#A45E00] text-xs"},it={key:0},ut=q({props:{voucherBalance:null,goodsChecked:null,loading:{type:Boolean},isCheckAll:{type:Boolean},totalAmount:null,isManage:{type:Boolean},isCollect:{type:Boolean}},emits:["totalCheck","handleCartBuy","handleDelMult","typeChange"],setup(n,{emit:h}){const s=n,{t:b}=K(),p=D(()=>s.goodsChecked.reduce((c,l)=>new M(c).plus(l.number),0)),k=D(()=>Math.min(s.voucherBalance,s.goodsChecked.reduce((c,l)=>l.goodsType>0?new M(c).plus(new M(l.number).multipliedBy(l.price).multipliedBy(l!=null&&l.goodsType?l==null?void 0:l.balanceDiscountRatio:(l==null?void 0:l.discountRatio)||0).div(100).multipliedBy(.5)):new M(c).plus(0),0)));function y(){re.confirm({messageAlign:"center",message:b("cart.delConfirm",{num:s.goodsChecked.length}),confirmButtonText:b("shop.delete"),confirmButtonColor:"#FF507A",cancelButtonText:b("cart.thinkAgain"),cancelButtonColor:"#2E2008"}).then(()=>{h("handleDelMult")}).catch(()=>{})}return(c,l)=>{const _=I("VanRadio"),x=I("VanButton");return u(),f("div",{class:Ie(["fixed bottom-0 w-full px-2.5 safe-bottom sm:bottom-[0%] lg:bottom-[0%] z-20 cartbarBody pointer-events-none",n.isCollect?"":"safe-bottom-page"])},[i("div",Ye,[n.isManage||n.isCollect?(u(),f("div",{key:0,class:"flex items-center justify-between text-default",onClick:l[0]||(l[0]=S=>h("totalCheck"))},[C(_,{checked:n.isCheckAll,"checked-color":"#FEA021"},{default:B(()=>[i("span",Qe,g(c.$t("common.check all")),1)]),_:1},8,["checked"]),n.goodsChecked&&n.goodsChecked.length&&!n.isManage?(u(),f("div",Xe,[Ze,i("span",We,g(d(se)(d(H)(n.totalAmount||0)))+"Mcoin",1)])):L("",!0)])):(u(),f("div",et,[C(_,{checked:n.isCheckAll,"checked-color":"#FEA021",onClick:l[1]||(l[1]=S=>h("totalCheck"))},null,8,["checked"]),n.goodsChecked&&n.goodsChecked.length&&!n.isManage?(u(),f("div",tt,[i("div",ot,[i("div",st,g(c.$t("cart.hasChecked",{num:d(p)||0})),1),i("div",nt,g(c.$t("cart.count")),1)]),i("div",at,[i("div",lt,[ct,i("span",rt,g(d(se)(d(H)(n.totalAmount||0))),1)]),d(k)?(u(),f("div",dt,g(c.$t("cart.VoucherAmount"))+g(d(H)(d(k))),1)):L("",!0)])])):L("",!0)])),n.isManage?(u(),J(x,{key:2,class:"btn-red btn-shadow px-8 h-[40px] text-white",loading:n.loading,disabled:!n.goodsChecked.length,onClick:y},{default:B(()=>[ee(g(c.$t("shop.delete")),1)]),_:1},8,["loading","disabled"])):(u(),J(x,{key:3,class:"btn-orange btn-shadow px-8 h-[40px] text-white",loading:n.loading,disabled:!n.goodsChecked.length,onClick:l[2]||(l[2]=S=>h("handleCartBuy"))},{default:B(()=>[ee(g(c.$t("cart.settle"))+" ",1),n.goodsChecked&&n.goodsChecked.length&&n.isCollect?(u(),f("span",it,"("+g(n.goodsChecked.length||0)+")",1)):L("",!0)]),_:1},8,["loading","disabled"]))])],2)}}}),ht=z(ut,[["__scopeId","data-v-0c6757c2"]]),mt=n=>(U("data-v-39412fec"),n=n(),Y(),n),gt={class:"p-2.5"},ft={class:"text-xl font-semibold flex-center-bw"},pt=mt(()=>i("div",{class:"safe-bottom-page"},null,-1)),Ct=q({name:"MallCart"});function kt(n){const{t:h}=K(),s=Be({originList:[],oldList:[],list:[],goodsChecked:[],goodsType:0}),b=_e(),{loadingToggle:p}=Le(),[k,y]=te(!1),{orderGoodsStore:c}=Re();Se("cart_number",1);const l="mall_cart_scroll_position",_=5*60*1e3,x=()=>{const o={position:document.querySelector("#fm-page").scrollTop,timestamp:Date.now()};sessionStorage.setItem(l,JSON.stringify(o))},S=()=>{const t=sessionStorage.getItem(l);if(t){const{position:o,timestamp:e}=JSON.parse(t);Date.now()-e<_?$e(()=>{const a=document.querySelector("#fm-page");a&&setTimeout(()=>{a.scrollTo({top:o,behavior:"smooth"}),console.log("恢复滚动位置:",o,a.scrollTop)},100)}):sessionStorage.removeItem(l)}},m=()=>{k.value&&(s.goodsChecked=s.goodsChecked.filter(t=>!t.disabled)),y(!k.value)},N=t=>{console.log(t),c.setGoodsCheckedCache(t.map(o=>o.goodsId))},T=t=>{b.push(t)},O=j(null),Q=D(()=>s.list.reduce((t,o)=>t+o.stores.reduce((e,a)=>e+a.goods.length,0),0)),X=D(()=>s.list.reduce((t,o)=>t+o.stores.reduce((e,a)=>e+a.goods.filter(r=>!r.disabled).length,0),0)),Z=D(()=>k.value?Q.value===s.goodsChecked.length:X.value===s.goodsChecked.length&&X.value!==0),ie=D(()=>s.goodsChecked.reduce((t,o)=>+new M(t).plus(+new M(o.payType===$.STORE_CARD?o.cardPrice:o.price).times(o.number)),0)),ue=async(t,o)=>{if(t.stock<o&&+t.goodsTypes!=2)return t.number=t.stock,oe(h("order.Insufficient stock"));p(!0);const e=await je({goodsId:t.goodsId,number:o});p(!1),e.success&&(t.number=o)},he=()=>{Z.value?me():E()},E=()=>{O.value.toggleAll({checked:!0,skipDisabled:!0})},me=()=>{O.value.toggleAll({skipDisabled:!0})},ge=async(t,o,e)=>{if(p(!0),!!(await le(o.goodsId)).success){t.goods.splice(e,1);for(let r=0;r<s.list.length;r++)s.list[r].stores=s.list[r].stores.filter(v=>v.goods&&v.goods.length>0);s.list=s.list.filter(r=>r.stores&&r.stores.length>0),s.goodsChecked=s.goodsChecked.filter(r=>r.id!==o.id),p(!1)}},fe=async(t,o)=>{p(!0);const e=await Pe({goodsIds:[o.goodsId],type:1,collectType:1});p(!1),e.success},pe=j(null),W=j(0),Ce=async()=>{const{balanceOf:t}=ne(ae.MCOIN),o=await t();pe.value=+o,W.value=+await ne(ae.FMCP).balanceOf()},ke=t=>JSON.parse(JSON.stringify(t)),V=async()=>{p(!0);const t=await Ve();p(!1),!(!t.success||!t.data)&&(s.originList=t.data||[],F(s.originList),S())},F=t=>{const o=ye(ke(t));s.list=o.map(e=>({goodsBoutiqueFlag:e[0].goodsType!==ce.SD,stores:be(e)}))},ye=t=>{let o={};for(;t.length;){let e=t.shift();const a=e.goodsType?"true":"false";o[a]=o[a]||[],o[a].push(e)}return Object.keys(o).map(e=>o[e])},be=t=>t.reduce((o,e)=>{const a=e.id,r=e.status!==1||!+e.stock&&e.goodsTypes!=2||+e.shopStatus==4||+e.shopStatus==0||+e.shopStatus==3;e.disabled=r,e.id=e.goodsId,e.icons=e.icon,r?s.goodsChecked=s.goodsChecked.filter(A=>A.id!==e.id):c.goodsCheckedCache.findIndex(A=>A===e.goodsId)!==-1&&s.goodsChecked.push(e);const v=o.findIndex(A=>A.storeId===e.storeId);return v!==-1?o[v].goods.push(e):o.push({id:a,storeId:e.storeId,storeName:e.storeName,goods:[e]}),o},[]),[ve,R]=te(!1),xe=(...t)=>{let o=0;return t.forEach(e=>{e===!0&&o++}),o},Te=async()=>{let t=s.goodsChecked.some(w=>w.goodsType!==ce.SD),o=s.goodsChecked.some(w=>w.payType===$.MC),e=s.goodsChecked.some(w=>w.payType===$.STORE_CARD);const a=xe(t,o,e);if(a>2||a===2&&e)return oe(h("cart.tips"));R(!0);let r=[];s.goodsChecked.forEach(w=>{r.push(w.id)});const v=await He(r.join(","));if(R(!1),!v.success)return;T(a===2||t||a===1&&o?"/submitOrderBoutiqueCart":"/submitOrderCart")},we=async()=>{R(!0);let t=[];s.goodsChecked.forEach(e=>{t.push(e.id)});const o=await le(t.join(","));s.goodsChecked=[],R(!1),o.success&&V()};return Ae(()=>s.goodsType,async t=>{if(+t==0)F(s.originList),E();else if(+t==2){const o=s.originList.filter(e=>(e==null?void 0:e.goodsBoutiqueFlag)&&(e==null?void 0:e.payType)!==$.STORE_CARD);await F(o),E()}else if(+t==1){const o=s.originList.filter(e=>!(e!=null&&e.goodsBoutiqueFlag)||(e==null?void 0:e.payType)===$.STORE_CARD);await F(o),E()}},{deep:!0}),De(()=>{V(),Ce(),document.querySelector("#fm-page").addEventListener("scroll",x)}),Me(()=>{document.querySelector("#fm-page").removeEventListener("scroll",x)}),(t,o)=>{const e=I("van-checkbox-group");return u(),f("div",null,[i("div",gt,[C(e,{modelValue:d(s).goodsChecked,"onUpdate:modelValue":o[0]||(o[0]=a=>d(s).goodsChecked=a),onChange:N,ref:(a,r)=>{r.checkboxGroup=a,O.value=a},"checked-color":"#FEA021"},{default:B(()=>[i("div",ft,[i("span",null,g(t.$t("cart.cart"))+"("+g(d(Q))+")",1),i("div",{class:"text-sm font-normal text-primary",onClick:m},g(d(k)?t.$t("common.quteManage"):t.$t("common.manage")),1)]),(u(!0),f(P,null,G(d(s).list,a=>(u(),f("div",{class:"cart-list",key:a.goodsBoutiqueFlag},[C(qe,{goodsBoutiqueFlag:a.goodsBoutiqueFlag},null,8,["goodsBoutiqueFlag"]),(u(!0),f(P,null,G(a.stores,(r,v)=>(u(),J(Ue,{isManage:d(k),key:v,cartInfo:r,onChangeNumber:ue,onHandelDel:ge,onHandleRemove:fe,onHandleTo:T},null,8,["isManage","cartInfo"]))),128))]))),128))]),_:1},8,["modelValue"])]),C(Oe,{onSuccessAdd:V,"title-text":d(h)("common.recommend_for_you"),class:"p-2.5"},null,8,["title-text"]),pt,C(ht,{voucherBalance:W.value,isManage:d(k),goodsChecked:d(s).goodsChecked,isCheckAll:d(Z),totalAmount:d(ie),loading:d(ve),onTotalCheck:he,onHandleCartBuy:Te,onHandleDelMult:we},null,8,["voucherBalance","isManage","goodsChecked","isCheckAll","totalAmount","loading"])])}}const yt=q({...Ct,setup:kt}),jt=z(yt,[["__scopeId","data-v-39412fec"]]);export{jt as default};
