import{_ as $e,r as v,a2 as m,F as I,G as W,H as S,P as x,$ as p,I as s,Q as y,N as oe,O as l,X as Oe,Y as Te,y as B,E as Ve,Z as z,T as r,q as Be,U as te,K as Ee,J as Ne,a0 as Re,a4 as J,bj as se,bt as ae,V as le,u as je}from"./vendor-Dr_RpJ_Y.js";import{s as Me}from"./zsbmd-kDP-np3s.js";import{S as Ue}from"./Switch-DuYcYVSQ.js";import{C as Fe}from"./CommonVanProvider-D__Wy38-.js";import{u as ze,ad as Pe,C as P,ab as We,ac as Je}from"./index-BckdT6oc.js";import{a as He}from"./activityContract-BZvr-VTx.js";import{g as Xe}from"./utils-DPKQXUBz.js";import{c as qe,d as Ge,u as Ke}from"./account-DB9d_JsQ.js";import"./BackIcon-CDrGaEPo.js";const Qe=""+new URL("../images/delete-BvkH-tFb.svg",import.meta.url).href,ne=h=>(Oe("data-v-65ec20c4"),h=h(),Te(),h),Ye={class:"relative overflow-x-hidden"},Ze={class:"bg-white rounded-[12px] py-4 px-3 relative z-50 font-Puhui"},et={class:"flex gap-2 items-start mb-3"},tt={class:"flex gap-2 h-[40px] items-center"},st=ne(()=>s("div",{class:"text-sm text-b3 font-normal flex-shrink-0"}," 白名单地址 ",-1)),at={class:"text-sm text-b1 break-all text-right pl-[10%] ml-auto w-full"},lt={class:"flex gap-2 items-start"},ot=ne(()=>s("div",{class:"text-sm text-b3 font-normal flex-shrink-0"},"备注",-1)),nt={class:"text-sm text-b1 font-normal word-break flex-1 text-right"},rt={class:"mr-[12px]"},it=["src"],dt={props:{disabled:{type:Boolean,default:!1},itemData:{type:Object,default:()=>({address:"",remark:""})}},emits:["delete"],setup(h,{emit:E}){const N=h,k=v(null),[$,O]=m(!1),T=()=>{const _=N.itemData||{};if(!_.address){Toast.fail("错误的数据：地址格式错误或地址为空");return}k.value.close(),E("delete",_)};return(_,L)=>{const R=I("van-swipe-cell");return S(),W("div",Ye,[x(R,{disabled:h.disabled,onOpen:L[0]||(L[0]=b=>l(O)(!0)),onClose:L[1]||(L[1]=b=>l(O)(!1)),ref:(b,A)=>{A.swipeCellRef=b,k.value=b}},{right:p(()=>[s("div",rt,[s("div",{class:oe(["translate-x-[-24px] w-[56px] h-[104px] flex justify-center items-center bg-transparent swipe-cell-right-button transition-all duration-300",{"!bg-[#F44] !w-[80px] !pr-5 !justify-end":l($)}]),onClick:T},[s("img",{src:l(Qe),class:"w-[20px] h-[20px]",alt:"删除"},null,8,it)],2)])]),default:p(()=>[s("div",Ze,[s("div",et,[s("div",tt,[st,s("div",at,y(h.itemData.address||"-"),1)])]),s("div",lt,[ot,s("div",nt,y(h.itemData.remark||"-"),1)])])]),_:1},8,["disabled"])])}}},ct=$e(dt,[["__scopeId","data-v-65ec20c4"]]),ut={class:"py-3"},ft={class:"bg-white rounded-[12px] px-3 py-4 flex items-center justify-between mx-3"},mt={class:"flex items-center flex-1 gap-2"},pt={class:"w-9 h-9"},ht=["src"],gt=s("div",{class:"flex-1"},[s("div",{class:"text-sm text-b1 font-normal"},"赠送白名单")],-1),vt={class:"mt-3 mx-3"},xt={class:"text-sm text-b3 font-normal"},_t={class:"overflow-y-auto pt-3 h-[calc(100vh-248px)] px-3"},bt={class:"w-full p-3 mx-auto fixed bottom-0 left-0 right-0 safe-bottom"},wt={class:""},yt=s("p",{class:"text-sm text-b1 font-normal text-left"},"地址",-1),Ct={class:"mt-4"},St=s("p",{class:"text-sm text-b1 font-normal text-left"},"备注",-1),kt={class:"relative mt-1"},Lt={class:"h-[86px]"},At={class:"text-sm text-b2 font-normal px-8 break-words h-[40px]"},Dt={class:"flex items-center justify-center gap-3 mt-6"},It=J(" 取消 "),$t=J(" 删除 "),Ut={setup(h){const{userTradeWhitelistView:E}=He(),N=Be(),[k,$]=m(!1),[O,T]=m(!1),[_,L]=m(!1),[R,b]=m(!1),A=v({sendStatus:!1,addressList:[]}),re=B(()=>o.value.length>=w),ie=B(()=>c.value?"审核中":"提交审核"),de=B(()=>`白名单地址（${o.value.length}/${w}）`),ce=B(()=>!c.value&&!re.value),g=v(!1),H=v([]),ue=async()=>{if(console.log("isAudit",c.value),c.value)c.value&&(g.value=ee.value);else try{const e=await E();console.log("res",e.result),e.success&&(g.value=e.result.switch_||!1,console.log("sendStatus",g.value),e.result.whitelists&&e.result.whitelists.length>0&&(H.value=e.result.whitelists||[],fe()))}catch(e){console.error("获取赠送白名单状态失败:",e),g.value=!1}},fe=()=>{const e=(H.value||[]).map(a=>({address:a,remark:""})),t=o.value||[];e.forEach(a=>{t.forEach(n=>{Pe(a.address,n.address)&&(a.remark=n.remark||"")})}),o.value=e||[]},o=v([]),w=20,[j,X]=m(!1),[me,M]=m(!1),d=v({address:"",remark:""}),pe=()=>{if(o.value&&o.value.length>w){r.fail(`最多添加${w}个白名单地址`);return}if(c.value){r.fail("审核中，无法添加地址");return}M(!0)},he=()=>{M(!1)},ge=()=>{if(d.value.address.trim()===""){r.fail("请输入地址");return}if(!je.isAddress(d.value.address)){r.fail("请输入正确的地址");return}if(o.value.some(e=>e.address.toLowerCase()===d.value.address.toLowerCase())){r.fail("该地址已添加");return}try{X(!0);const e=d.value.address.toLowerCase()||"",t=d.value.remark||"";o.value.push({address:e,remark:t}),d.value.address="",d.value.remark="",M(!1)}catch(e){console.error("添加地址失败:",e)}finally{X(!1)}console.log("确认添加地址")},[ve,q]=m(!1),[G,K]=m(!1),U=v({}),xe=e=>{U.value=e,q(!0)},D=()=>{q(!1)},_e=()=>{try{K(!0);const e=U.value;if(!e||!e.address){r.fail("删除失败：地址信息错误"),D();return}const t=o.value.findIndex(a=>(a.address||"").toLowerCase()===(e.address||"").toLowerCase());if(t===-1){r.fail("删除失败：未找到该地址"),D();return}o.value.splice(t,1),r.success("删除成功"),D()}catch(e){console.error("删除地址失败:",e),r.fail("删除地址失败")}finally{K(!1)}},[be,Q]=m(!1),[we,F]=m(!1),ye=()=>{Z()&&Q(!0)},Y=()=>{Q(!1)},Ce=async()=>{try{if(!Z())return;F(!0);const e=Xe(),t=await We(e),a=await Je(e);if(!a.success){r.fail("用户拒绝操作"),F(!1);return}const n=g.value||!1,u=o.value||[],C={applyInfo:JSON.stringify({switchStatus:n,addressList:u}),type:3,message:e,messageHash:t.result,signature:a.result},V=await Ke(C);V.success?(r.success("提交审核成功"),Y(),setTimeout(()=>{N.replace({path:"/securityCenter"})},800)):r.fail(V.message)}catch(e){console.error("提交审核失败:",e),r.fail("提交审核失败")}finally{F(!1)}},Se=()=>{if(!R.value)return!1;if(g.value!==A.value.sendStatus)return!0;const e=o.value||[],t=A.value.addressList||[];if(e.length!==t.length)return!0;const a=f=>{const i=new Map;return f.forEach(C=>{const V=(C.address||"").toLowerCase();i.set(V,C.remark||"")}),i},n=a(e),u=a(t);if(n.size!==u.size)return!0;for(const[f,i]of n.entries())if(!u.has(f)||u.get(f)!==i)return!0;for(const[f,i]of u.entries())if(!n.has(f)||n.get(f)!==i)return!0;return!1},Z=()=>o.value&&o.value.length>w?(r.fail(`最多添加${w}个白名单地址`),!1):c.value?(r.fail("审核中，无法添加地址"),!1):Se()?!0:(r.fail("没有任何变化，请检查后再提交"),!1),ke=async()=>{var e;try{const t=await Ge();t.success?c.value=!((e=t.data)!=null&&e.giveWhitelistApplyFlag):c.value=!1}catch(t){console.error("获取审核状态失败:",t)}},c=v(!1),ee=v(!1),Le=async()=>{var e,t;try{const a=ze().getCurrentAccount(),n=await qe({applyAddress:a});if(n.success){const u=((e=n==null?void 0:n.data)==null?void 0:e.reviewData)||((t=n==null?void 0:n.data)==null?void 0:t.approvedData);o.value=De(u)||[],ee.value=Ie(u)||!1}else o.value=[]}catch(a){console.error("获取当前白名单列表失败:",a)}finally{r.clear()}},Ae=async()=>{try{r.loading({message:"加载中...",duration:0}),$(!0),T(!0),await Le(),await ke(),await ue(),A.value={sendStatus:g.value,addressList:JSON.parse(JSON.stringify(o.value||[]))},b(!0)}catch(e){b(!1),console.error("获取初始数据失败:",e)}finally{$(!1),T(!1),r.clear()}},De=e=>{let t=(e==null?void 0:e.applyInfo)||"";if(!t)return!1;let a={};return typeof t=="string"&&(a=JSON.parse(t)||[]),a&&a.addressList?a.addressList||[]:[]},Ie=e=>{let t=(e==null?void 0:e.applyInfo)||"";if(!t)return!1;let a={};return typeof t=="string"&&(a=JSON.parse(t)||[]),a&&a.switchStatus&&a.switchStatus||!1};return Ve(()=>{Ae()}),(e,t)=>{const a=I("Empty"),n=I("van-list"),u=I("VanButton"),f=I("van-button");return S(),z(Fe,{title:"赠送白名单",class:"font-Puhui font-normal relative pb-20 bg-gray1",themeVars:{navBarBackgroundColor:"#ffffff"}},{right:p(()=>[l(ce)?(S(),W("span",{key:0,class:"text-sm text-b2 font-normal",role:"button",onClick:pe},"添加地址")):te("",!0)]),default:p(()=>[s("div",ut,[s("div",ft,[s("div",mt,[s("div",pt,[s("img",{src:l(Me),class:"w-full h-full",alt:"赠送白名单"},null,8,ht)]),gt]),s("div",null,[x(Ue,{modelValue:g.value,"onUpdate:modelValue":t[0]||(t[0]=i=>g.value=i),disabled:c.value,loading:l(O)||l(k)},null,8,["modelValue","disabled","loading"])])]),s("div",vt,[s("p",xt,y(l(de)),1)]),s("div",_t,[o.value.length===0&&!l(_)?(S(),z(a,{key:0,name:"无白名单地址",class:"py-6"})):te("",!0),x(n,{loading:l(_),"onUpdate:loading":t[1]||(t[1]=i=>Re(_)?_.value=i:null),finished:!0,"error-text":"请求失败，点击重新加载"},{default:p(()=>[(S(!0),W(Ne,null,Ee(o.value,(i,C)=>(S(),z(ct,{key:i.id||C,itemData:i,disabled:c.value,class:"mb-3",onDelete:xe},null,8,["itemData","disabled"]))),128))]),_:1},8,["loading"])])]),s("div",bt,[s("p",{class:"text-sm text-b2 font-normal text-center mb-[11px]"}," 最多添加"+y(w)+"个白名单地址 "),x(u,{onClick:ye,loading:l(j)||l(k),disabled:c.value,class:oe(["bg-btnOrBg w-full h-[46px] flex-center text-b1 text-base font-semibold z-50 rounded-3xl",{"!bg-[#D9D9D9] !opacity-100":c.value}])},{default:p(()=>[J(y(l(ie)),1)]),_:1},8,["loading","disabled","class"])]),x(P,{show:l(me),title:"添加新地址",showConfirm:!0,showReject:!1,confirmText:"添加",loading:l(j),confirmDisabled:l(j),onClose:he,onConfirm:ge},{default:p(()=>[s("div",wt,[s("div",null,[yt,se(s("textarea",{"onUpdate:modelValue":t[2]||(t[2]=i=>d.value.address=i),placeholder:"请输入白名单地址，请注意地址填写正确",class:"w-full h-[56px] rounded-lg bg-[#f5f5f5] p-2 text-b1 mt-1"},null,512),[[ae,d.value.address,void 0,{trim:!0}]])]),s("div",Ct,[St,s("div",kt,[se(s("textarea",{"onUpdate:modelValue":t[3]||(t[3]=i=>d.value.remark=i),placeholder:"请输入备注",maxlength:20,class:"w-full h-[36px] rounded-lg bg-[#f5f5f5] p-2 text-b1 pr-[50px]",style:le([{resize:"none"},{height:d.value.remark.length>14?"72px":"36px"}])},`
            `,4),[[ae,d.value.remark,void 0,{trim:!0}]]),s("p",{class:"text-sm text-b3 font-normal text-right absolute top-0 right-[8px] h-[36px] flex items-center justify-end font-Puhui",style:le({height:d.value.remark.length>14?"72px":"36px"})},y(d.value.remark.length)+"/20 ",5)])])])]),_:1},8,["show","loading","confirmDisabled"]),x(P,{show:l(ve),title:"是否将此地址从白名单删除",showConfirm:!1,showReject:!1,confirmText:"确认",onClose:D},{default:p(()=>[s("div",Lt,[s("p",At,y(U.value.address||"--"),1),s("div",Dt,[x(f,{class:"w-full h-[46px] bg-white border-[#D9D9D9] border rounded-[100px] text-[#333333] text-sm font-semibold text-center",loading:l(G),onClick:D},{default:p(()=>[It]),_:1},8,["loading"]),x(f,{class:"w-full h-[46px] bg-[#F44] border-none rounded-[100px] text-white text-sm font-semibold text-center",loading:l(G),onClick:_e},{default:p(()=>[$t]),_:1},8,["loading"])])])]),_:1},8,["show"]),x(P,{show:l(be),title:"是否要提交白名单审核?",content:"编辑后的白名单生效需要v9确认",showConfirm:!0,showReject:!1,confirmText:"确认",onClose:Y,onConfirm:Ce,loading:l(we)},null,8,["show","loading"])]),_:1})}}};export{Ut as default};
