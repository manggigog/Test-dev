import{_ as Ie,y as Be,F as c,G as i,a2 as N,P as t,I as y,a0 as m,Q as a,X as Ae,R as _,w as ze,x as q,r as E,bd as Oe,bc as S,bh as Ue,D as Pe,E as x,K as b,N as I,H as n,O as g,J as _e,a4 as Re,$ as je,B as we,Y as qe,Z as Ke,T as M}from"./vendor-CjApaIpB.js";import{_ as Xe}from"./member-BMygrgIC.js";import{S as Ge}from"./SkewCard-BD-urNEn.js";import{S as He}from"./shop-CeqcS6K2.js";import{e as Je,g as xe,b as Qe,d as Ye,V as ye,r as Ze,aS as We}from"./index-lKIcPnY0.js";import{b as et}from"./beiExtRewardContract-DUWomN6Z.js";import{q as tt,c as st,d as ot}from"./beiRanking-3R1HbwSb.js";import{b as nt}from"./beiConstContract-AdED8YsS.js";const at={key:0},it=m("普通店铺"),lt=Be({props:{type:null,width:{default:125}},setup(f){return(k,A)=>(i(),c("div",{class:_(["tag-box text-right text-white font-semibold pr-5 pt-1 h-[75px] min-w-[120px]",`bg-${f.type||0}`]),style:Ae({width:`${f.width}px`})},[f.type!==void 0?(i(),c("span",at,[f.type===t(He).SD?(i(),c(y,{key:0},[it],64)):(i(),c(y,{key:1},[m(a(k.$t(`common.shop_type_${f.type}`))+"店铺",1)],64))])):N("",!0)],6))}}),ct=Ie(lt,[["__scopeId","data-v-ea5a823e"]]),B=f=>(qe("data-v-63077a26"),f=f(),Ke(),f),rt={class:"relative m-auto text-sm font-normal font-Puhui"},ut={class:"relative z-0 p-3"},dt={class:"flex items-center gap-x-2"},ft={class:"relative"},mt={class:"-mt-5 w-[40px] border-[1px] border-solid border-white flex-center bg-yellow rounded-3xl mx-auto relative z-10"},pt=B(()=>n("img",{src:Xe,class:"w-4 h-4"},null,-1)),ht={class:"text-sm"},vt={class:"flex flex-col gap-1 flex-1"},gt={class:"text-base font-semibold line-clamp-1 name-width"},kt={class:"text-b3 flex items-center"},bt=["src"],_t=B(()=>n("span",{class:"mx-1"},"|",-1)),wt={class:"w-full h-[40px] bg-b5 rounded-full p-0.5 mt-4"},xt={class:"w-full h-full relative"},yt={class:"absolute w-full h-full flex items-center justify-center left-0 top-0"},It=["onClick"],Bt={class:"mt-4 flex items-center bg-b5 p-3 rounded-[10px]"},Ct={class:"flex items-center gap-x-3"},Ft=["onClick"],$t={class:"text-b3 mt-1 flex items-center"},Tt={key:0,class:"text-left text-b3 font-normal"},Vt={class:"flex items-center"},Lt=B(()=>n("span",{class:"text-success"},"充电：",-1)),Dt=m("预计系数"),Et={key:1},St=m("/电量+"),Mt={key:3},Nt={class:"flex items-center"},At=B(()=>n("span",{class:"text-error"},"放电：",-1)),zt=m("预计系数"),Ot={key:1},Ut=m("/电量-"),Pt={key:3},Rt={key:1,class:"flex items-center"},jt=B(()=>n("span",null,"测算结果",-1)),qt=[jt],Kt={class:"flex-center-bw mt-4 gap-x-3"},Xt=m("放电"),Gt=Be({props:{show:{type:Boolean},shopId:null,teleport:null},emits:["close","voteSuccess","handleTo"],setup(f,{emit:k}){const{show:A,shopId:K,teleport:Ht}=f,{t:X}=ze(),{contributesStore:z}=Je(),{voteByLp:Ce,userVoteDetailView:Fe,voteMonthTimestampView:$e}=et(),{userTotalLp:Te}=nt(),{loadingToggle:O}=Ze(),C=q(()=>[{id:1,text:X("ranking.points_ticket")},{id:2,text:X("ranking.lp_ticket")}]),r=E(null),Ve=[.25,.5,.75],o=Oe({tab:1,votesInfo:{1:{total:0,sumUsed:0},2:{total:0,sumUsed:0}},estimateInfo:{coefficient:1,coefficientLikeBudget:1,coefficientNotLikeBudget:1,score:0,scoreLikeBudget:0,scoreNotLikeBudget:0,likeDiffer:0,notlikeDiffer:0,tickets:0},totalTimes:5,rewardTimes:5}),F=q(()=>o==null?void 0:o.votesInfo[o.tab]),U=q(()=>{var s;return Math.max(((s=F.value)==null?void 0:s.total)-(F==null?void 0:F.value.sumUsed),0)}),d=E(null),G=E(null),H=E(null),[h,P]=S(!0),[$,J]=S(!1),[Q,Y]=S(!1),[T,Z]=S(!1),W=s=>{h.value||$.value||(d.value=Math.floor(new we(U.value).times(s).toNumber()))},R=()=>{O(!1),k("close")},Le=s=>{+o.tab!=+s&&(d.value=null,o.estimateInfo.tickets=0,o.tab=s)},ee=(s,e,u)=>{const p=Math.abs(Number(new we(s).minus(e)));return p<1e-4?"<0.0001":`${u}${p.toFixed(4)}`},De=async()=>{const{result:s}=await $e();H.value=+s.thisMonthTime},Ee=async()=>{O(!0);const{success:s,data:e}=await tt({shopId:K,month:We()});s&&(O(!1),r.value=e)},te=async()=>{var u,p;if(o.tab===1)return;if(d.value<=0){o.estimateInfo.tickets=0;return}Z(!0);const{success:s,data:e}=await ot(K,d.value);s&&(o.estimateInfo=e,o.estimateInfo.tickets=d.value,o.estimateInfo.likeDiffer=Math.abs((e==null?void 0:e.scoreLikeBudget)-((u=r.value)==null?void 0:u.score)),o.estimateInfo.notlikeDiffer=Math.abs((e==null?void 0:e.scoreNotLikeBudget)-((p=r.value)==null?void 0:p.score)),Z(!1))},Se=async()=>{var u;if(!Number(d.value)||+d.value<=0)return M({message:"请输入投票数",duration:2e3}),!1;if(+d.value>+U.value)return M({message:"超过可投数量",duration:2e3}),!1;const{success:s,data:e}=await st((u=r.value)==null?void 0:u.shopId);return s||M({message:"网络异常～",duration:2e3}),s&&!e&&M({message:"当前店铺无法投票请联系店家确认",duration:2e3}),e},Me=async()=>{var s;console.log(+o.rewardTimes,+o.totalTimes),k("close"),k("voteSuccess",{direct:200,differ:d.value*((s=r.value)==null?void 0:s.coefficient)},+o.rewardTimes<+o.totalTimes)},se=async s=>{var u,p,V,v,w,L;if(!await Se())return;J(!0),((u=o.estimateInfo)==null?void 0:u.tickets)!==d.value&&await te();const{success:e}=await Ce((p=r.value)==null?void 0:p.shopId,d.value,s);J(!1),e&&(k("close"),k("voteSuccess",{direct:s,differ:s===200?(V=o.estimateInfo)==null?void 0:V.likeDiffer:(v=o.estimateInfo)==null?void 0:v.notlikeDiffer,score:s===200?(w=o.estimateInfo)==null?void 0:w.scoreLikeBudget:(L=o.estimateInfo)==null?void 0:L.scoreNotLikeBudget}))},Ne=async()=>{P(!0),await De();const{success:s,result:e}=await Fe(H.value);o.rewardTimes=+(e==null?void 0:e.times),o.votesInfo[1]={total:Math.min(Math.floor(z.contributes/1e3),500),sumUsed:+(e==null?void 0:e.sumTickets)},console.log("rewardTimes :",+(e==null?void 0:e.times)),console.log("contributes :",z.contributes),console.log("sumTickets :",+(e==null?void 0:e.sumTickets)),console.log("votesInfo:",o.votesInfo[1]),s&&P(!1);const u=Math.floor(+await Te());P(!1),o.votesInfo[2]={total:+u,sumUsed:+(e==null?void 0:e.sumLp)}},oe=s=>{(s.key==="Enter"||s.key==="Escape")&&G.value.blur()};return Ue(()=>{window.removeEventListener("keydown",oe)}),Pe(async()=>{window.addEventListener("keydown",oe),Ee(),await z.fetchContributes(),Ne()}),(s,e)=>{const u=x("van-icon"),p=x("VanImage"),V=x("VanField"),v=x("VanLoading"),w=x("VanButton"),L=x("VanPopup");return i(),b(L,{show:f.show,"onUpdate:show":e[6]||(e[6]=D=>je(A)?A.value=D:null),teleport:f.teleport,onClickOverlay:Re(R,["stop"]),onClose:R,round:"",class:"bg-transparent position-center",style:{"min-width":"280px","max-width":"350px",width:"85%"}},{default:I(()=>[n("div",rt,[n("div",{class:"text-right text-b6 ml-auto text-lg font-bold h-6 flex items-start justify-end",onClick:R},[g(u,{name:"cross"})]),g(Ge,{width:"210",right:"26"},{default:I(()=>{var D,ne,ae,ie,le,ce,re,ue,de,fe,me,pe,he,ve,ge,ke,be;return[g(ct,{class:"absolute right-1.5 top-1.5 -z-20",type:(D=r.value)==null?void 0:D.type},null,8,["type"]),n("div",ut,[n("div",dt,[n("div",ft,[g(p,{round:"",src:(((ne=r.value)==null?void 0:ne.logo)||"").split(",")[0],errorIcon:t(xe)("images/ranking/noPosition.png"),fit:"cover",width:"46px",height:"46px"},null,8,["src","errorIcon"]),n("div",mt,[pt,n("span",ht,"V"+a((ae=r.value)==null?void 0:ae.memberLevel),1)])]),n("div",vt,[n("div",gt,a((ie=r.value)==null?void 0:ie.storeName),1),n("div",kt,[n("span",null,a(t(Qe)((le=r.value)==null?void 0:le.shopAddress,"**",0,4)),1),(ce=r.value)!=null&&ce.authorizeAddress?(i(),c("img",{key:0,src:t(xe)("images/ranking/auth.svg"),class:"w-4 h-4"},null,8,bt)):N("",!0),_t,n("span",null,a(s.$t("ranking.battery"))+a(((re=r.value)==null?void 0:re.score)||0),1),n("div",{class:"text-newOrigin pl-1",onClick:e[0]||(e[0]=l=>t(Y)(!t(Q)))},a(s.$t("user.feedbackDetail")),1)])])]),n("div",{class:_(["bg-[#FF88121F] text-newOrigin rounded px-2 flex items-center justify-between overflow-hidden transition-all duration-300",t(Q)?"h-[36px] border border-newOrigin mt-1":"h-0 mt-0"]),onClick:e[1]||(e[1]=l=>t(Y)(!1))},[n("div",null,a(+((ue=r.value)==null?void 0:ue.pointTicket))+a(s.$t("ranking.points_ticket"))+" x "+a(t(Ye)((de=r.value)==null?void 0:de.coefficient))+a(s.$t("ranking.coefficient"))+" = "+a((fe=r.value)==null?void 0:fe.score)+a(s.$t("ranking.battery")),1),n("div",null,[g(u,{name:"cross"})])],2),n("div",wt,[n("div",xt,[n("div",{class:_(["absolute w-[50%] h-full bg-b1 rounded-full left-0 transition-all duration-300",`w-[${100/t(C).length}%] left-${t(C).findIndex(l=>l.id===t(o).tab)||0}/${t(C).length}`])},null,2),n("div",yt,[(i(!0),c(y,null,_e(t(C),l=>(i(),c("div",{class:"w-[50%] h-full flex items-center justify-center overflow-hidden",onClick:j=>Le(l.id),key:l.id},[n("span",{class:_(["text-sm text-center line-clamp-1 transition-all duration-300",[t(o).tab===l.id?"text-b6 font-semibold":"text-b3 font-normal"]])},a(l.text),3)],8,It))),128))])])]),n("div",Bt,[g(V,{type:"digit",modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=l=>d.value=l),placeholder:"0",ref:(l,j)=>{j.amountInputRef=l,G.value=l}},null,8,["modelValue"]),n("div",Ct,[t(o).tab===1?(i(),c(y,{key:0},_e(Ve,l=>n("div",{class:"shrink-0 w-fit text-newOrigin px-0.5",key:l,onClick:j=>W(l)},a(l*100)+"% ",9,Ft)),64)):N("",!0),n("div",{class:"shrink-0 w-fit text-newOrigin",onClick:e[3]||(e[3]=l=>W(1))}," MAX ")])]),n("div",$t,[+t(o).tab==2&&((me=t(o).estimateInfo)==null?void 0:me.tickets)>0?(i(),c("div",Tt,[n("div",Vt,[Lt,Dt,t(T)?(i(),b(v,{key:0,size:"12"})):(i(),c("span",Et,a(ee((pe=t(o).estimateInfo)==null?void 0:pe.coefficientLikeBudget,(he=t(o).estimateInfo)==null?void 0:he.coefficient,"+")),1)),St,t(T)?(i(),b(v,{key:2,size:"12"})):(i(),c("span",Mt,a((ve=t(o).estimateInfo)==null?void 0:ve.likeDiffer),1))]),n("div",Nt,[At,zt,t(T)?(i(),b(v,{key:0,size:"12"})):(i(),c("span",Ot,a(ee((ge=t(o).estimateInfo)==null?void 0:ge.coefficientNotLikeBudget,(ke=t(o).estimateInfo)==null?void 0:ke.coefficient,"-")),1)),Ut,t(T)?(i(),b(v,{key:2,size:"12"})):(i(),c("span",Pt,a((be=t(o).estimateInfo)==null?void 0:be.notlikeDiffer),1))])])):(i(),c("div",Rt,[m(a(s.$t("ranking.remain_ticket")),1),t(h)?(i(),b(v,{key:0,size:"10"})):(i(),c(y,{key:1},[m(a(t(U)),1)],64)),m(a(t(o).tab===1?s.$t("ranking.points_ticket"):s.$t("ranking.lp_ticket")),1)])),t(o).tab===2&&d.value>0?(i(),c("div",{key:2,class:"pl-1.5 ml-auto text-newOrigin",onClick:te},qt)):N("",!0)]),n("div",Kt,[t(o).tab===1?(i(),b(w,{key:0,class:_(["btn-yellow w-full h-[46px] rounded-full border-none text-base font-semibold",{"opacity-60":t(h)}]),onClick:Me,disabled:t(h),loading:t($)},{default:I(()=>[m(a(s.$t("ranking.power")),1)]),_:1},8,["class","disabled","loading"])):(i(),c(y,{key:1},[g(w,{class:_(["bg-error text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold",{"opacity-60":t(h)}]),icon:t(ye)("discharge.svg"),disabled:t(h),loading:t($),onClick:e[4]||(e[4]=l=>se(400))},{default:I(()=>[Xt]),_:1},8,["class","icon","disabled","loading"]),g(w,{class:_(["bg-success text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold",{"opacity-60":t(h)}]),icon:t(ye)("charge.svg"),disabled:t(h),loading:t($),onClick:e[5]||(e[5]=l=>se(200))},{default:I(()=>[m(a(s.$t("ranking.power")),1)]),_:1},8,["class","icon","disabled","loading"])],64))])])]}),_:1})])]),_:1},8,["show","teleport","onClickOverlay"])}}}),os=Ie(Gt,[["__scopeId","data-v-63077a26"]]);export{os as S,ct as a};
