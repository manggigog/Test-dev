import{_ as Pe,y as ve,l as Ee,x as ot,E as ee,K,G as u,N as D,H as p,F as h,P as l,a0 as x,Q as d,I as te,O as P,a2 as A,w as nt,bn as j,r as _,a1 as rt,bf as lt,D as ut,J as he,X as ct,$ as it,T as X,B as N,a7 as pt}from"./vendor-CjApaIpB.js";import{_ as dt}from"./AddressInfo-C21RjxfH.js";import{_ as ke}from"./EmptyTipsPop-C0Qo2Er1.js";import{_ as yt}from"./OrderGoodsCartBox-D3l-PqaF.js";import{_ as mt,R as ft,o as ht,i as vt,f as bt,d as L,q as Z,r as gt,a1 as Tt,b1 as wt,s as Be,B as _t}from"./index-lKIcPnY0.js";import{P as c}from"./order-B5BGKYED.js";import{c as At,q as Ct}from"./address-DOt9lULg.js";import{m as xe,t as St,u as kt,r as Bt}from"./order-C6QNLrKu.js";import{u as xt}from"./useSelectAddress-CgNt0r_o.js";import{c as $t}from"./cart-CFO7zzai.js";import{P as b}from"./flashSale-DDyqLyYN.js";import{_ as $e}from"./SubmitApprove-BFAJaOWw.js";import{p as Pt}from"./piggyBank-C8fQvxR9.js";import"./mall-BNNzTN-n.js";import"./OrderGoods-CdqWSRed.js";import"./MCOIN-BcbOHmhy.js";import"./BoutiqueLable-BYJxmIGq.js";import"./shop-CeqcS6K2.js";import"./ShopMaskTips-DfjY93ZI.js";import"./useShipTemplate-DGyxlJb1.js";import"./enums-DlE-aiss.js";const Et={class:"py-8 text-base text-center text-black"},Rt={key:0,class:"flex justify-center"},Nt={key:1,class:"flex justify-center"},Lt=ve({props:{show:{type:Boolean},lableType:null,card:null,cardBuy:{type:Boolean},paySource:null,payToken:null},emits:["close"],setup(C,{emit:J}){const M=C,W=Ee(),Y=ot(()=>{var y,$,E;return($=(y=M.card)==null?void 0:y.stores)!=null&&$.storeName?`「${(E=M.card)==null?void 0:E.stores.storeName}」`:""}),le=y=>{y?W.push(y):W.replace("/")},G=()=>{var y;le(`/storedValue-recharge?cardId=${(y=M.card)==null?void 0:y.id}`),J("close")},ae=()=>{J("close","change")};return(y,$)=>{const E=ee("van-button");return u(),K(mt,{width:"90%",show:C.show,name:y.$t("common.tip"),onClose:$[0]||($[0]=()=>{J("close")})},{default:D(()=>{var se,oe;return[p("div",Et,[Number(C.lableType)===1&&+C.paySource==+l(c).PIGGY_BANK?(u(),h(te,{key:0},[x(d(y.$t("piggy.recharge_tip",{num:`${l(Y)} ${(se=C.card)==null?void 0:se.symbol}`})),1)],64)):(u(),h(te,{key:1},[x(d(y.$t("piggy.change_the_method",{num:C.payToken===1?l(Y)+" Mcoin":`${l(Y)} ${(oe=C.card)==null?void 0:oe.symbol}`})),1)],64))]),Number(C.lableType)===1&&+C.paySource==+l(c).PIGGY_BANK?(u(),h("div",Rt,[P(E,{class:"w-1/2 mx-2.5 btn-orange btn-shadow text-white font-semibold",onClick:G},{default:D(()=>[x(d(y.$t("piggy.goRechart")),1)]),_:1})])):(u(),h("div",Nt,[C.payToken!==1?(u(),K(E,{key:0,class:"plain-btn w-1/2 mx-2.5 text-[#FEA021] font-semibold",onClick:G},{default:D(()=>[x(d(y.$t("piggy.goRechart")),1)]),_:1})):A("",!0),P(E,{class:"w-1/2 mx-2.5 btn-orange btn-shadow text-white font-semibold",onClick:ae},{default:D(()=>[x(d(C.paySource===1?y.$t("piggy.Switch_piggy_payment"):y.$t("piggy.Switch_mc_payment")),1)]),_:1})]))]}),_:1},8,["show","name"])}}}),Gt=Pe(Lt,[["__scopeId","data-v-1f3cb9b6"]]),Ot={key:0,class:"p-2.5"},It={class:"text-xl font-semibold"},Kt={class:"bg-white py-2.5 mx-2.5 flex items-center justify-between gap-2 border-b border-[#f5f5f5] border-solid"},Dt={class:"flex-1"},Mt=["onClick"],Wt={class:"bg-white mt-2.5 rounded-xl p-2.5"},Yt={class:"flex items-baseline justify-between mt-1"},qt={class:"opacity-60"},Vt={class:"text-right"},Ft={class:"text-base font-semibold"},jt={key:0},Jt={key:1},zt={key:0},Ht={class:"opacity-60"},Ut={class:"bg-white mt-2.5 rounded-xl p-2.5"},Qt={class:"flex items-baseline justify-between mt-1"},Xt={class:"opacity-60 break-keep"},Zt={class:"text-right"},ea={class:"text-base font-semibold text-primary"},ta={key:0},aa={key:0},sa={key:0},oa={class:"opacity-60"},na={class:"flex flex-col items-center my-[50px] relative"},ra={class:"p-2.5 pb-[150px]"},la={class:"relative text-center mb-2.5"},ua=ve({name:"SubmitOrderCart"});function ca(C){const{getUserDhKey:J,encryptAddressKey:M,formatAddressData:W,generateKey:Y,decryptAddressKey:le}=ft(),{t:G}=nt(),[ae,y]=j(!1),{loadingToggle:$}=gt(),{getAddress:E,setAddress:se}=xt(),{submit:oe}=ht(),Re=vt(1),{tradeContributeSelfRate:Ne}=bt(),[Le,ue]=j(!1),z=Ee(),[Ge,be]=j(!1),[ce,ie]=j(!1),[Oe,Ie]=j(!0),[pe,g]=j(!1),de=_([]),v=_(),S=_([]),Ke=_(0),ye=_({remark:""}),De=_(0),ge=async()=>{if(E()){v.value=E(),se(null);return}const a=z.currentRoute.value.path,e=await Ct();if(!e.success)return;de.value=e.data;const n=de.value.find(s=>s.isDefault===1)||de.value[0],o=await Y("user",a);if(n!=null&&n.encryptFlag&&o){v.value=le(n,o);return}v.value=n},Me=async()=>{const a=await(await Re).allowance(Z.order);Ke.value=a.result},R=rt(),We=async()=>{var e;const a=await Bt({type:((e=R==null?void 0:R.query)==null?void 0:e.type)??2});if(!a.success){setTimeout(()=>{z.back()},1500);return}S.value=(a.data.ordersInfos||[]).map(n=>{let o=1;return n.orderGoods.forEach(s=>{+s.payType==3&&(o=2),s.paySource=c.WALLET}),{...n,goods:n.orderGoods,totalAmount:0,totalCardAmount:0,integral:0,remark:"",payType:o,paySource:c.WALLET,storeJudge:!1}}),De.value=a.data.totalAmount||0},Ye=async(a,e,n)=>{a.number=e,n.storeJudge=!1,$(!0);const o=await $t({goodsId:a.goodsId,number:e});await Ae(),$(!1),o.success},qe=async a=>{ye.value=a,ie(!0)};let O=_(!1);const i=_({payType:2,paySource:c.WALLET,id:"",payToken:1}),Ve=async()=>{let a=0;for(let e of S.value){if(i.value=e,!e.storeJudge&&e.fmStoredCard&&e.fmStoredCard.contract&&+T(e).totalCardAmount>0){const o=+await Be(e.fmStoredCard.contract).balanceOf(),s=+U.value[e.fmStoredCard.id]||0;e.walletBalance=+o,e.piggyBalance=+s,e.symbol=e.fmStoredCard.symbol,i.value=e,i.value.id=e.fmStoredCard.id;let f=0,t=o;if(e.goods.forEach(r=>{let m=+r.cardPrice*r.number;(r.payType===b.STORE_CARD||e.payType===b.STORE_CARD&&r.payType!==b.MC)&&(t>=m?t=+N(t).minus(m):f=+N(f).plus(m))}),T(e).totalCardAmount<=e.walletBalance||e.paySource===c.PIGGY_BANK&&f<=e.piggyBalance){O.value=!1;let r=o;e.storeJudge=!0,e.paySource=c.WALLET,T(e).totalCardAmount<=e.walletBalance?e.goods.forEach(m=>{(m.payType===b.STORE_CARD||e.payType===b.STORE_CARD&&m.payType!==b.MC)&&(m.paySource=c.WALLET)}):e.goods.forEach(m=>{let k=+m.cardPrice*m.number;(m.payType===b.STORE_CARD||e.payType===b.STORE_CARD&&m.payType!==b.MC)&&(r>=k?(m.paySource=c.WALLET,r=pt.subtract(r,k),r=+N(r).minus(k)):m.paySource=c.PIGGY_BANK)})}else return f<=e.piggyBalance?(i.value.payToken=2,O.value=!0,g(!1),y(!0)):(i.value.payToken=2,i.value.paySource=c.PIGGY_BANK,e.payToken=2,e.paySource=c.PIGGY_BANK,O.value=!0,g(!1),y(!0))}let n=V.value;if(e.goods.forEach(o=>{let s=+o.price*o.number;(+o.payType===b.MC||+o.payType!==b.STORE_CARD&&+e.payType!==b.STORE_CARD)&&(n>=s?n=+N(n).minus(s):a=+N(a).plus(s))}),T(e).totalAmount<=+V.value||e.paySource===c.PIGGY_BANK&&a<=+U.value[0]){O.value=!1;let o=+V.value;e.goods.forEach(s=>{if(s.payType===b.MC||e.payType===b.MC&&s.payType!==b.STORE_CARD){let f=+s.price*s.number;o>=+f?(s.paySource=c.WALLET,o=+N(o).minus(f),V.value=+N(V.value).minus(f)):s.paySource=c.PIGGY_BANK}})}else return a<=(+U.value[0]||0)?(i.value.payToken=1,i.value=e,O.value=!0,g(!1),y(!0)):(O.value=!0,g(!1),X(G("order.insufficient balance")))}},Fe=async a=>{y(!1),a==="change"&&(+i.value.payType==2&&i.value.paySource===c.WALLET?i.value.paySource=c.PIGGY_BANK:+i.value.payType==2&&i.value.paySource===c.PIGGY_BANK?(i.value.payType=1,i.value.paySource=i.value.payToken===1?c.WALLET:i.value.paySource===c.PIGGY_BANK?c.WALLET:c.PIGGY_BANK):i.value.paySource=c.PIGGY_BANK),g(!1)},je=_(null),H=_(0),Je=async()=>{var f,t,r,m;if(!v.value)return X(G("order.setAddress"));if((f=v.value)!=null&&f.encryptFlag&&!((t=v.value)!=null&&t.success))return X(G("order.reconfirm the information"));if(!Tt(v.value.telNumber))return X(G("address.number was identified"));const a=z.currentRoute.value.path;if(g(!0),await Te(),await we(),await Ve(),O.value)return;g(!0);let e=[],n=[];if(S.value.forEach(k=>{k.goods.forEach(w=>{if(w.number>w.stock&&+w.goodsTypes!=2){let F=w.goodsName;w.goodsName.length>10&&(F=w.goodsName.slice(0,10)+"..."),n.push(F)}const ne=w.payType===3?k.payType===1?1:2:w.payType===10?1:w.payType||1;e.push({goodsId:w.goodsId,num:w.number,payType:ne,paySource:w.paySource})})}),n.length>0)return g(!1),X(n.join()+"  "+G("order.Insufficient stock"));const o=await Y("user",a);let s;o&&!v.value.encryptFlag&&(s=M(v.value,o),await At({...s,isDefault:v.value.isDefault?1:0}));try{let k=[];if(S.value)for(let fe=0;fe<S.value.length;fe++){const I=S.value[fe];let B={};if(I.encryption){const Se=await J(I.stores.id,(r=I.encryption)==null?void 0:r.publicKey);Se?(B=W(B,{...v.value,postscript:I.remark},1),B=M(B,Se),B.submitHash=B.hash):B=W(B,{...v.value,postscript:I.remark},0)}else B=W(B,{...v.value,postscript:I.remark},0);k.push({storeId:I.stores.id,...B})}const w={type:((m=R==null?void 0:R.query)==null?void 0:m.type)??2,addressId:v.value.id,postscripts:k,detailList:e,voucherAmount:0},ne=await xe(w);if(!ne.success){g(!1);return}const{allOrderId:F,merchants:et,discounts:tt,amounts:at,sources:st,id2s:pa,amount2s:da,source2s:ya}=ne.data,Q=await oe(F,et,tt,at,st);if(!Q.success){St({allOrderId:F}),g(!1);return}if(await kt({allOrderId:F,hash:Q.result.hash}),je.value=Q.result.hash,!Q.result.hash){g(!1);return}let re;const Ce=async()=>{if(H.value>=5){g(!1),be(!0),H.value=0;return}if(re=await wt(Q.result.hash),(re==null?void 0:re.status)===1){g(!1),ue(!0),H.value=0,ze();return}setTimeout(async()=>{H.value++,Ce()},5e3)};Ce()}catch{g(!1),H.value=0}},ze=()=>{setTimeout(()=>{ue(!1),z.replace({path:"buyerOrderList",query:{active:1}})},1500)},me=_(1),He=async()=>{me.value=await Ne()},T=a=>{let e=0,n=0,o=0;return a.orderGoods.forEach(s=>{+a.payType==1&&+s.payType==3||+s.payType!=2&&+s.payType!=3?(e+=s.price*s.number,n+=s.price*s.number*(s.discountRatio/100)):o+=s.cardPrice*s.number}),{totalAmount:L(e),integral:L(n),totalCardAmount:L(o)}},q=()=>{let a=0,e=0,n=0;return S.value.forEach(o=>{o.orderGoods.forEach(s=>{+o.payType==1&&+s.payType==3||+s.payType!=2&&+s.payType!=3?(a+=s.price*s.number,e+=s.price*s.number*(s.discountRatio/100)):n+=s.cardPrice*s.number})}),{totalAmount:a,integral:e,totalCardAmount:n}},V=_(null),Te=async()=>{const{balanceOf:a}=Be(Z.MCOIN),e=await a();V.value=+e},U=_({}),{userMerchantCashs:Ue,userTotalAmount:Qe}=Pt(),we=async()=>{const{success:a,result:e}=await Ue();if(!a)return;let n=0;const o=+await Qe(),s=e.amounts.map(t=>_t(t));e.cashIds.map(t=>+t).forEach((t,r)=>{U.value[t]=s[r],t!==0&&(n=+N(n).plus(s[r]||0).toString())}),U.value[0]=+N(o).minus(n)},_e=_([]),Ae=async()=>{var o,s;let a=[];S.value.forEach(f=>{f.goods.forEach(t=>{const r=t.payType===3?f.payType===1?1:2:t.payType===10?1:t.payType||1;a.push({goodsId:t.goodsId,num:t.number,payType:r,paySource:t.paySource})})});const e={type:((o=R==null?void 0:R.query)==null?void 0:o.type)??2,addressId:(s=v.value)==null?void 0:s.id,detailList:a,genOrder:!1},n=await xe(e);n.success&&(_e.value=n.data.goodsList||[])},Xe=async()=>{$(!0),We(),Te(),He(),we(),await Me(),await ge(),await Ae(),$(!1),Ie(!1)},Ze=a=>{z.push(a)};return lt(()=>{ge()}),ut(()=>{Xe()}),(a,e)=>{const n=ee("van-icon"),o=ee("VanButton"),s=ee("van-field"),f=ee("van-popup");return l(Oe)?A("",!0):(u(),h("div",Ot,[p("header",It,d(a.$t("order.submitOrder")),1),P(dt,{class:"mt-2.5",defaultAddress:v.value,onClick:e[0]||(e[0]=t=>Ze("/userAddress"))},null,8,["defaultAddress"]),(u(!0),h(te,null,he(S.value,(t,r)=>(u(),h("div",{key:r,class:"bg-white rounded-xl"},[P(yt,{orderInfo:t,payType:t.payType,expressGoodsList:_e.value,onChangeNumber:(m,k)=>Ye(m,k,t)},null,8,["orderInfo","payType","expressGoodsList","onChangeNumber"]),p("div",Kt,[p("div",Dt,d(a.$t("order.remark")),1),p("div",{class:"flex-1 text-right line-clamp-1 opacity-60 whitespace-nowrap",onClick:m=>qe(t)},[x(d(t.remark?t.remark:a.$t("order.noRemark"))+" ",1),P(n,{name:"arrow"})],8,Mt)]),p("div",Wt,[p("div",Yt,[p("div",qt,d(a.$t("order.total")),1),p("div",Vt,[p("div",Ft,[T(t).totalAmount>0?(u(),h("span",jt,d(l(L)(T(t).totalAmount||0))+"Mcoin",1)):A("",!0),T(t).totalCardAmount>0?(u(),h("span",Jt,[T(t).totalAmount>0?(u(),h("span",zt,"+")):A("",!0),x(" "+d(l(L)(T(t).totalCardAmount||0))+" "+d(t.fmStoredCard&&t.fmStoredCard.symbol),1)])):A("",!0)]),p("div",Ht,d(a.$t("order.getContribution",{num:l(L)(T(t).integral*me.value||0)})),1)])])])]))),128)),p("div",Ut,[p("div",null,d(a.$t("order.priceDetail")),1),p("div",Qt,[p("div",Xt,d(a.$t("order.total")),1),p("div",Zt,[p("div",ea,[q().totalAmount>0?(u(),h("span",ta,d(l(L)(q().totalAmount||0))+"Mcoin",1)):A("",!0),(u(!0),h(te,null,he(S.value,(t,r)=>(u(),h("span",{key:r},[T(t).totalCardAmount>0?(u(),h("span",aa,[r===0&&q().totalAmount>0||r!==0?(u(),h("span",sa,"+ ")):A("",!0),x(d(l(L)(T(t).totalCardAmount||0))+" "+d(t.fmStoredCard&&t.fmStoredCard.symbol),1)])):A("",!0)]))),128))]),p("div",oa,d(a.$t("order.getContribution",{num:l(L)(q().integral*me.value||0)})),1)])])]),p("div",na,[q().totalAmount>0?(u(),K($e,{key:0,class:"approve-btn btn-orange btn-shadow w-[150px] h-[40px] text-white z-10",contract:l(Z).order,token:l(Z).MCOIN,symbol:"Mcoin",approveAmount:q().totalAmount,loading:l(pe)},null,8,["contract","token","approveAmount","loading"])):A("",!0),(u(!0),h(te,null,he(S.value,(t,r)=>(u(),h("div",{class:"approve-btn btn-orange btn-shadow w-[150px] h-[40px] text-white",key:r},[t.fmStoredCard&&t.fmStoredCard.contract&&T(t).totalCardAmount>0?(u(),K($e,{class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",key:r,style:ct({"z-index":10+r}),contract:l(Z).order,token:t.fmStoredCard&&t.fmStoredCard.contract,symbol:t.fmStoredCard&&t.fmStoredCard.symbol,approveAmount:T(t).totalCardAmount,loading:l(pe)},null,8,["style","contract","token","symbol","approveAmount","loading"])):A("",!0)]))),128)),P(o,{class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",loading:l(pe),onClick:Je},{default:D(()=>[x(d(a.$t("common.pay")),1)]),_:1},8,["loading"])]),P(f,{show:l(ce),"onUpdate:show":e[4]||(e[4]=t=>it(ce)?ce.value=t:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:D(()=>[p("div",ra,[p("div",la,[x(d(a.$t("order.submitOrder"))+" ",1),p("div",{class:"absolute right-0 bottom-[-2px] text-lg",onClick:e[1]||(e[1]=t=>l(ie)(!1))},[P(n,{name:"cross"})])]),P(s,{modelValue:ye.value.remark,"onUpdate:modelValue":e[2]||(e[2]=t=>ye.value.remark=t),rows:"5",autosize:"",type:"textarea",maxlength:"200",placeholder:a.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"])]),P(o,{class:"mb-[50px] inline-block btn-orange btn-shadow w-[150px] h-[40px] text-white",onClick:e[3]||(e[3]=t=>l(ie)(!1))},{default:D(()=>[x(d(a.$t("common.confirm")),1)]),_:1})]),_:1},8,["show"]),l(Le)?(u(),K(ke,{key:0,onClose:e[5]||(e[5]=t=>l(ue)(!1)),text:a.$t("common.pay success")},null,8,["text"])):A("",!0),l(Ge)?(u(),K(ke,{key:1,isError:!0,onClose:e[6]||(e[6]=t=>l(be)(!1)),text:a.$t("order.fail")},null,8,["text"])):A("",!0),l(ae)?(u(),K(Gt,{key:2,card:i.value,lableType:i.value.payType,paySource:i.value.paySource,payToken:i.value.payToken,cardBuy:!0,show:l(ae),onClose:Fe},null,8,["card","lableType","paySource","payToken","show"])):A("",!0)]))}}const ia=ve({...ua,setup:ca}),Ga=Pe(ia,[["__scopeId","data-v-50af7f19"]]);export{Ga as default};
