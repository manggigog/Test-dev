import{y as fe,w as Ue,E as B,F as p,G as c,H as t,K as S,Q as s,I as ee,J as te,a2 as oe,O as b,N as w,a0 as x,R as he,_ as Ee,r as g,bd as me,bc as Oe,z as qe,x as pe,B as je,D as He,l as ze,P as n,Y as Ke,Z as Qe}from"./vendor-D6JO6WHW.js";import{E as Ye}from"./EcologyHeader-j6VKc9-q.js";import{_ as Ze}from"./BgBox-CV7Siw6X.js";import{d as $,s as D,q as E,B as W,a7 as ve,a8 as ge,a9 as X,c as Ge}from"./index-koYZVdtr.js";import{u as Je}from"./lendingPoolContract-Cq3H2qul.js";import{e as We}from"./exchangeContract-BW7F2v6G.js";import"./UserLevel-D6WuCJQi.js";import"./avatarRing-DpEnkbQ2.js";import"./UserAsset-B_vWsVTT.js";import"./TokenBalance-CGpNFX40.js";import"./bg-dot-BdvI4GrL.js";const Xe="/Test-dev/static/images/list_icon-DDBlyCQZ.svg",et="/Test-dev/static/images/help-qWKu9klx.png",tt={class:"bg-[#FFFDF8] rounded-2xl shadow-inset-2 px-2 py-4 mt-[10px]"},ot={class:"text-base font-semibold flex-start"},st={key:1,class:"pt-6 pb-4 text-center"},at={key:2},nt={class:"flex justify-between items-center border-line pb-[10px]"},lt={class:"text-sm mb-[5px]"},it={class:"opacity-60"},ct={class:"flex-center-bw mb-[10px] mt-[10px]"},dt={class:"text-sm"},ut={class:"font-semibold"},rt={class:"flex-center-bw mb-[10px]"},mt={class:"text-sm"},pt={class:"font-semibold"},vt={class:"flex-center-bw mb-[10px]"},gt={class:"text-sm"},ft={class:"font-semibold"},ht={key:0,class:"flex-center-bw"},yt={class:"text-sm"},_t={class:"font-semibold"},bt={key:1,class:"gap-4 mt-5 font-semibold text-white flex-center"},wt=fe({props:{list:null,authMusdLoading:null,authMusd:null,musdAllowance:null,loading:null},emits:["approveMusd","rollover","repay"],setup(m,{emit:C}){const{t:A}=Ue(),O=async()=>{C("approveMusd")},q=(i,v)=>{C("rollover",i,v)},j=(i,v)=>{C("repay",i,v)},H=i=>{let v="";switch(+i.loanStatus){case 1:v=A("ecology.ongoing");break;case 2:v=A("ecology.overdue");break;case 3:v=A("ecology.Cleared");break}return v};return(i,v)=>{const z=B("van-skeleton"),M=B("VanButton");return c(),p("div",tt,[t("div",ot,s(i.$t("ecology.my loan history")),1),m.list.length===0&&m.loading?(c(),S(z,{key:0,row:3,class:"py-4"})):m.list.length===0?(c(),p("div",st,s(i.$t("common.No data yet")),1)):(c(),p("div",at,[(c(!0),p(ee,null,te(m.list,(l,F)=>(c(),p("div",{class:"bg-[#fff9f0] mt-3 rounded-lg p-4",key:l.loanId},[t("div",nt,[t("div",null,[t("div",lt,s(i.$t("ecology.flow id"))+" "+s(l.loanId),1),t("div",it,s(l.startTime),1)]),b(M,{class:he(["btn",{"opacity-30":l.loanStatus===3}])},{default:w(()=>[x(s(H(l)),1)]),_:2},1032,["class"])]),t("div",ct,[t("div",dt,s(i.$t("ecology.loanAmount")),1),t("div",ut,s(l.loanAmount)+" MUSD",1)]),t("div",rt,[t("div",mt,s(i.$t("ecology.initial stake amount")),1),t("div",pt,s(l.collateralAmount)+" MAI",1)]),t("div",vt,[t("div",gt,s(i.$t("ecology.morgage date")),1),t("div",ft,s(l.endTime),1)]),l.loanStatus!==3?(c(),p("div",ht,[t("div",yt,s(i.$t("ecology.Current amount due")),1),t("div",_t,s(l.overdueAmount)+" MUSD",1)])):oe("",!0),l.loanStatus!==3?(c(),p("div",bt,[b(M,{class:"btn-item h-[35px] min-w-[100px] px-4",loading:l.rolloverLoading,disabled:+l.pid==0,onClick:K=>q(l.loanId,F)},{default:w(()=>[x(s(i.$t("ecology.relloverLoan")),1)]),_:2},1032,["loading","disabled","onClick"]),m.authMusd&&m.musdAllowance>=l.overdueAmount?(c(),S(M,{key:0,class:"btn-item h-[35px] min-w-[100px] px-4",disabled:!m.authMusd,onClick:K=>j(l.loanId,F),loading:l.loanLoading},{default:w(()=>[x(s(i.$t("ecology.repayLoan")),1)]),_:2},1032,["disabled","onClick","loading"])):(c(),S(M,{key:1,class:"btn-item h-[35px] min-w-[100px] px-4",onClick:O,loading:m.authMusdLoading},{default:w(()=>[x(s(i.$t("assets.auth"))+" MUSD",1)]),_:1},8,["loading"]))])):oe("",!0)]))),128))]))])}}}),ye=m=>(Ke("data-v-e5142d92"),m=m(),Qe(),m),xt={class:"relative h-full"},At={class:"bg-[#FFFDF8] rounded-2xl shadow-inset-2 px-2 py-4"},$t={class:"text-base font-semibold mb-[10px] flex justify-between"},Mt=ye(()=>t("img",{src:Xe,class:"w-3 h-auto mr-1.5"},null,-1)),kt={class:"text-[#3D1A00] text-sm font-semibold"},Lt={key:1,class:"grid grid-cols-3 gap-4"},Ct={key:2,class:"flex-start w-full rounded-[10px] bg-[#fff9f0] p-[10px] mt-[10px] mb-[18px]"},Rt=ye(()=>t("img",{class:"w-[18px] mr-[10px]",src:et},null,-1)),It={class:"opacity-60 default"},Dt={class:"flex-center-bw"},Bt={class:"text-base font-semibold flex-start"},St={class:"bg-[#fff9f0] mt-3 rounded-lg p-2"},Ft={class:"flex items-center justify-end gap-2 mt-2"},Pt=["onClick"],Tt={class:"mt-[20px]"},Nt={class:"text-base font-semibold"},Vt={class:"flex-center-bw mb-[10px] mt-[10px]"},Ut={class:"font-semibold"},Et={class:"font-medium"},Ot={class:"flex-center-bw mb-[10px] mt-[10px]"},qt={class:"font-semibold"},jt={class:"font-medium"},Ht={class:"flex-center-bw mb-[10px]"},zt={class:"font-semibold"},Kt={class:"font-medium"},Qt={class:"flex-center-bw mb-[10px]"},Yt={class:"font-semibold"},Zt={class:"font-medium"},Gt={class:"flex-center-bw"},Jt={class:"font-semibold"},Wt={class:"font-medium"},Xt={class:"mt-5 font-semibold text-white flex-center"},eo=fe({setup(m){const C=ze(),{maiAddress:A,rollover:O,repay:q,loans:j,getLoanIds:H,borrow:i,musdAddress:v,poolInfo:z,ONE_DAY:M,poolLength:l,tokenCollateralRates:F,overdueTimes:K,getPenaltyAmount:_e}=Je(),{lastPrice:be}=We(),f=g(null),a=me({percents:[{name:"25%",value:.25},{name:"50%",value:.5},{name:"75%",value:.75},{name:"MAX",value:1}],token0:"USDT",token1:"MUSD",balance0:0,balance1:0,resouceAmount:null,allowanceAmount:0,toAmount:0,authLoading:!1,isAuth:!1,exchangeLoading:!1,maiBalance:null,isAuthMai:!1,isAuthMusd:!1,authMusdLoading:!1,tokenCollateralRates:2.572}),[to,se]=Oe(!1),we=me({7:0,90:15,180:30,365:65});qe(()=>f.value,e=>{a.isAuthMai=+a.allowanceAmount>=+e&&a.allowanceAmount>0},{immediate:!0,deep:!0});const xe=e=>{C.push(e)},ae=e=>Math.ceil(e*1e5)/1e5,Ae=e=>{f.value=$(e*re.value/a.tokenCollateralRates)},ne=g(0),le=async()=>{const e=await(await D(await v())).allowance(E.lendingPool);a.isAuthMusd=+e.result>0,ne.value=e.result||0},ie=async()=>{const e=await await D(await A()).allowance(E.lendingPool);a.isAuthMai=+e.result>0,a.allowanceAmount=e.result||0},$e=async()=>{a.authLoading=!0;const e=await D(await A()).approve(E.lendingPool);a.authLoading=!1,e.success&&ie()},Me=async()=>{a.authMusdLoading=!0;const{approve:e}=D(await v()),o=await e(E.lendingPool);a.authMusdLoading=!1,o.success&&le()},ce=async()=>{se(!0),a.maiBalance=+await D(await A()).balanceOf(),re.value=a.maiBalance,se(!1)},P=g(1),de=g(1),h=g([]),ke=async()=>{const e=await l();h.value=[];let o=[];for(let u=0;u<e.result;u++){const r=await Ce(u);o.push(r)}h.value=o.sort((u,r)=>u.pid-r.pid),P.value=h.value[1].pid},R=pe(()=>h.value[de.value]),Q=g(null),Le=async()=>{Q.value=+await M()},Ce=async e=>{const o=await z(e);if(o.success)return{pid:e,duration:o.result.duration,interestRate:o.result.interestRate/1e3,penaltyRate:o.result.penaltyRate/1e3,rowInterestRate:o.result.interestRate,rowPenaltyRate:o.result.penaltyRate}},Re=(e,o)=>{P.value=e.pid,de.value=o},ue=g(0),Ie=async()=>{ue.value=+await be()},re=g(0),Y=g(!1),De=pe(()=>{const e=new je(a.maiBalance||0).div(a.tokenCollateralRates);return $(e)}),Be=async()=>{Y.value=!0;const e=await i(P.value,f.value);Y.value=!1,e.success&&(f.value=null,ce(),N())};let k=g([]);const Z=g([]),T=g(!0),N=async()=>{T.value=!0;const e=await H();if(Z.value=[],!e.success||!e.result.length){T.value=!1;return}for(let o=0;o<e.result.length;o++){const u=e.result[o],r=await Se(u);Z.value.push(r)}k.value=Z.value,T.value=!1},G=e=>{let o=Math.ceil(e*1e3)/1e3;return o=+o.toFixed(3),o},Se=async e=>{const o=await j(e);if(!o.success)return;const u=h.value.findIndex(_=>_.pid===+o.result.pid),r=+(o.result.dueTime||0),J=r-h.value[u].duration,d=h.value[u],L=await K(+o.result.pid),I=new Date().getTime()/1e3;let V=null;+o.result.status==2?V=3:V=new Date().getTime()<r*1e3?1:2;let U=0;const y=Number(W(o.result.loanAmount));if(I<r-Number(L)){const _=2*(y*d.rowInterestRate)/1e5;U=+e<1595?y:+G(y+_)}else if(I>=r-Number(L)&&V===1){const _=Number(y*d.rowInterestRate)/1e5;U=+e<1595?y:+G(y+_)}else if(I>r){const{result:_}=await _e(o.result.loanAmount.toString(),o.result.dueTime.toString(),Math.ceil(I),d.rowPenaltyRate),Ve=y+Number(y*d.rowInterestRate/1e5)+Number(W(_));U=+e<1595?y+Number(W(_)):+G(Ve)}return{interestRate:d.interestRate,loanId:e,...o.result,loanAmount:$(ge(o.result.loanAmount)),collateralAmount:$(ge(o.result.collateralAmount)),startTime:ve(J),endTime:ve(r),loanStatus:V,loanLoading:!1,rolloverLoading:!1,overdueAmount:U}},Fe=async(e,o)=>{k.value[o].loanLoading=!0;const u=await q(e);k.value[o].loanLoading=!1,u.success&&N()},Pe=async(e,o)=>{k.value[o].rolloverLoading=!0;const u=await O(e);k.value[o].rolloverLoading=!1,u.success&&N()},Te=async()=>{a.tokenCollateralRates=await F()},Ne=async()=>{ce(),await Le(),ie(),le(),Te(),await Ie(),await ke(),N()};return He(async()=>{Ne()}),(e,o)=>{const u=B("van-skeleton"),r=B("VanButton"),J=B("VanField");return c(),p("div",xt,[b(Ye),b(Ze,{icon:"images/ecology/stake.png",text:e.$t("ecology.calculateCurrency")},{default:w(()=>[t("div",At,[t("div",$t,[x(s(e.$t("ecology.lendingDuration"))+" ",1),t("div",{onClick:o[0]||(o[0]=d=>xe("/ecology-liquidation")),class:"flex items-center py-1 pl-3 pr-1 bg-[#FED73A] rounded-l-xl -mr-2"},[Mt,t("span",kt,s(e.$t("ecology.Loans to be liquidated")),1)])]),h.value.length===0?(c(),S(u,{key:0,class:"mb-3",row:3})):(c(),p("div",Lt,[(c(!0),p(ee,null,te(h.value.slice(1),(d,L)=>(c(),S(r,{class:he(["text-sm font-medium h-[35px] px-4 rounded pool-btn",{"hover-bg":d.pid===P.value}]),key:L,onClick:I=>Re(d,L+1)},{default:w(()=>[x(s((Q.value?n(X)(d.duration/Q.value,!0):n(X)(d.duration))+e.$t("ecology.day")),1)]),_:2},1032,["class","onClick"]))),128))])),n(R)?(c(),p("div",Ct,[Rt,t("div",It,[t("div",null,s(e.$t("ecology.borrowingCosts"))+"："+s(n($)(n(R).interestRate)||"-")+"% ",1),t("div",null,s(e.$t("ecology.Overdue penalty interest"))+"："+s(n(R).penaltyRate||"-")+"% ",1),t("div",null,s(e.$t("ecology.Additional",{day:n(we)[n(X)(n(R).duration)]||0}))+"："+s(n($)(n(R).interestRate)||"-")+"% ",1),t("div",null,s(e.$t("ecology.borrowingfeesreturn")),1)])])):oe("",!0),t("section",null,[t("div",Dt,[t("div",Bt,s(e.$t("ecology.loanAmount")),1)]),t("div",St,[b(J,{class:"text-[18px] bg-[#fff9f0] font-bold","input-align":"left",modelValue:f.value,"onUpdate:modelValue":o[1]||(o[1]=d=>f.value=d),type:"number",placeholder:e.$t("ecology.maxLoanAmount",{amount:n(De)||0})+"MUSD"},null,8,["modelValue","placeholder"]),t("div",Ft,[(c(!0),p(ee,null,te(n(a).percents,d=>(c(),p("div",{class:"text-xs text-oriange1 border border-solid border-oriange1 rounded-md px-1 py-[2px] hover:bg-[#ffcd89]",key:d.value,onClick:L=>Ae(d.value)},s(d.name),9,Pt))),128))])])]),t("div",Tt,[t("span",Nt,s(e.$t("ecology.loan preview")),1),t("div",Vt,[t("div",Ut,s(e.$t("ecology.collateralAssets")),1),t("div",Et,s(ae(f.value*n(a).tokenCollateralRates||0))+" MAI ",1)]),t("div",Ot,[t("div",qt,s(e.$t("ecology.mortgageable assets")),1),t("div",jt,s(n(Ge)(n($)(n(a).maiBalance||0)))+" MAI ",1)]),t("div",Ht,[t("div",zt,s(e.$t("ecology.collateralPrice")),1),t("div",Kt,s(ae((f.value||0)*n(a).tokenCollateralRates*ue.value))+" MUSD ",1)]),t("div",Qt,[t("div",Yt,s(e.$t("ecology.loanAmount")),1),t("div",Zt,s(f.value||0)+" MUSD",1)]),t("div",Gt,[t("div",Jt,s(e.$t("ecology.actualArrival")),1),t("div",Wt,s(f.value||0)+" MUSD",1)])]),t("div",Xt,[b(r,{class:"btn h-[35px] min-w-[100px] px-4 mr-4",disabled:n(a).isAuthMai,loading:n(a).authLoading,onClick:$e},{default:w(()=>[x(s(e.$t("assets.auth"))+" MAI",1)]),_:1},8,["disabled","loading"]),b(r,{class:"btn h-[35px] min-w-[100px] px-4",loading:Y.value,disabled:!n(a).isAuthMai||n(a).authLoading,onClick:Be},{default:w(()=>[x(s(e.$t("ecology.submitApplication")),1)]),_:1},8,["loading","disabled"])])]),b(wt,{list:n(k),loading:T.value,authMusd:n(a).isAuthMusd,musdAllowance:ne.value,authMusdLoading:n(a).authMusdLoading,onApproveMusd:Me,onRepay:Fe,onRollover:Pe},null,8,["list","loading","authMusd","musdAllowance","authMusdLoading"])]),_:1},8,["text"])])}}}),go=Ee(eo,[["__scopeId","data-v-e5142d92"]]);export{go as default};
