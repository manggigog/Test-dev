import{_ as pe,y as ie,w as he,bc as Q,o as G,x as ve,r as D,bd as ae,E as b,F as L,G as $,H as d,O as f,a3 as Ce,N as v,Q as T,bI as Se,P as r,I as le,J as we,R as te,a4 as re,$ as oe,Y as ye,Z as Te,l as De,a1 as $e,z as Ie,D as Ee,K as de,a2 as ue,a0 as Ve,t as Oe,T as _}from"./vendor-CjApaIpB.js";import{_ as Me,e as Re}from"./excel-BtFGf-Fb.js";import{C as Ae}from"./CommonVanProvider-B8cLU3Mi.js";import{_ as Pe}from"./OfflineGoods-BQw_DWhZ.js";import{_ as Ye}from"./OfflineConsumer-DkQFUnKu.js";import{_ as Ne}from"./search-Dwmdj_3F.js";import{_ as Le}from"./filter-B5MATEpa.js";import{a6 as U,e as se,u as Be,R as Fe,C as Ke,V as Ue,bc as me,l as ne,be as qe,bd as Ge}from"./index-DBW_ANsl.js";import{D as je}from"./goods-BVwS8oFG.js";import{B as He}from"./BetweenTab-B_wy4hnL.js";import{a as q,O as fe}from"./offlineGoods-Biq4pIIG.js";import"./BackIcon-D2Vm_lyR.js";import"./MCOIN-BcbOHmhy.js";import"./ImgBoutiqueLable-kFX5j2-1.js";import"./shop-CeqcS6K2.js";import"./avatarRing-DpEnkbQ2.js";const ge=g=>(ye("data-v-6a3e1f73"),g=g(),Te(),g),ze={class:"flex items-center p-3"},We={class:"flex-1 bg-white rounded-3xl search-input-box"},Je=ge(()=>d("div",null,[d("img",{src:Ne,class:"w-4 h-4"})],-1)),Qe=ge(()=>d("img",{src:Le,class:"w-full h-full"},null,-1)),Ze=[Qe],Xe={class:"px-5"},et={class:"mt-[18px] font-semibold text-base text-center"},tt={class:"text-sm font-semibold mt-4"},ot={class:"flex items-center gap-2 mt-3 overflow-x-auto"},st=["onClick"],nt={class:"mt-3 flex-start"},at={class:"mx-2"},lt={class:"pt-8 pb-4 flex-center-bw"},rt={class:"text-base font-normal"},it={class:"text-base font-semibold"},ct=ie({props:{modelValue:null,deliveryType:{default:je.online},shopType:null},emits:["update:modelValue","onSearch"],setup(g,{emit:k}){const{t:V}=he(),[I,C]=Q(!1),O=G().format("YYYY-MM-DD"),M=G().subtract("days",7).format("YYYY-MM-DD"),B=G().subtract("month",1).format("YYYY-MM-DD"),l=G().subtract("month",3).format("YYYY-MM-DD"),j=ve(()=>[{id:1,label:V("shop.Last 7 days")},{id:2,label:V("shop.last month")},{id:3,label:V("shop.last 3 months")}]),[R,A]=Q(!1),[P,Y]=Q(!1),h=D(new Date),n=D(new Date),m=D(new Date(new Date("2020/1/1").getTime())),E=D(new Date(new Date("2020/1/1").getTime())),u=ae({startTime:null,endTime:null}),N=D(null),H=()=>{k("onSearch"),N.value.blur()},F=()=>{u.startTime=null,u.endTime=null,S.value=null,h.value=null,n.value=null,t()},z=()=>{A(!1),Y(!1),(!u.startTime||!u.endTime)&&(u.endTime=null,u.startTime=null)},Z=e=>{h.value=new Date(U(e)),E.value=new Date(new Date(e).getTime()),u.startTime=U(h.value.toString()),S.value=null,A(!1),Y(!0)},X=e=>{n.value=new Date(U(e)),u.startTime=U(h.value.toString()),u.endTime=U(e),S.value=null,Y(!1)},S=D(null),W=e=>{if(S.value!==e){switch(n.value=new Date(O),u.endTime=O,e){case 1:u.startTime=M,h.value=new Date(M),E.value=new Date(new Date(M).getTime()+60*1e3);break;case 2:u.startTime=B,h.value=new Date(B),E.value=new Date(new Date(B).getTime()+60*1e3);break;case 3:u.startTime=l,h.value=new Date(l),E.value=new Date(new Date(l).getTime()+60*1e3);break}S.value=e}},t=()=>{const e={startTime:u.startTime?u.startTime+" 00:00:00":null,endTime:u.endTime?u.endTime+" 23:59:59":null};k("onSearch",e),C(!1)};return(e,s)=>{const i=b("VanField"),p=b("van-datetime-picker"),a=b("van-popup"),w=b("van-icon"),x=b("VanButton"),K=b("VanPopup");return $(),L(le,null,[d("div",ze,[d("div",We,[f(i,{ref:(c,y)=>{y.searchRef=c,N.value=c},onKeyup:Se(H,["enter"]),"model-value":g.modelValue,"onUpdate:modelValue":s[1]||(s[1]=c=>k("update:modelValue",c)),placeholder:e.$t("offline.searchTips"),class:"w-[100% - 20px] text-center bg-transparent items-center",clearable:"",enterkeyhint:"search"},{"left-icon":v(()=>[Je]),"right-icon":v(()=>[d("div",{onClick:s[0]||(s[0]=c=>k("onSearch")),class:"text-newOrigin font-semibold leading-5"},T(e.$t("common.search")),1)]),_:1},8,["onKeyup","model-value","placeholder"])]),d("div",{class:"flex-shrink-0 w-5 h-5 ml-2",onClick:s[2]||(s[2]=c=>r(C)(!0))},Ze),Ce(e.$slots,"default",{},void 0,!0)]),f(K,{teleport:"body",show:r(I),"onUpdate:show":s[9]||(s[9]=c=>oe(I)?I.value=c:null),round:"",position:"bottom",closeable:"",class:"sm:w-[375px]",style:{"min-height":"40%","min-width":"280px",left:"50%",transform:"translate3d(-50%, 0, 0)"},"close-on-click-overlay":"",onClickOverlay:s[10]||(s[10]=c=>r(C)(!1)),onClickCloseIcon:s[11]||(s[11]=c=>r(C)(!1))},{default:v(()=>[d("div",Xe,[d("div",et,T(e.$t("common.OrderScreening")),1),d("div",tt,T(e.$t("common.time")),1),d("div",ot,[($(!0),L(le,null,we(r(j),c=>($(),L("div",{class:te(["type-cell flex-1",{"cell-active":S.value==c.id}]),key:c.id,onClick:y=>W(c.id)},T(c.label),11,st))),128))]),d("div",nt,[d("div",{class:"van-cell p-0 flex justify-center type-cell",onClick:s[3]||(s[3]=re(c=>r(A)(!0),["stop"]))},[d("div",{class:te({"opacity-30":!r(u).startTime})},T(r(u).startTime||e.$t("goods.selectStartTime")),3)]),f(a,{show:r(R),"onUpdate:show":s[5]||(s[5]=c=>oe(R)?R.value=c:null),position:"bottom",round:"",style:{height:"50%"},"close-on-click-overlay":!1,teleport:"body"},{default:v(()=>[f(p,{modelValue:h.value,"onUpdate:modelValue":s[4]||(s[4]=c=>h.value=c),"min-date":m.value,type:"date",title:e.$t("goods.selectStartTime"),onCancel:z,onConfirm:Z},null,8,["modelValue","min-date","title"])]),_:1},8,["show"]),d("div",at,[f(w,{name:"minus"})]),d("div",{class:"van-cell p-0 flex justify-center type-cell",onClick:s[6]||(s[6]=re(c=>r(Y)(!0),["stop"]))},[d("div",{class:te({"opacity-30":!r(u).endTime})},T(r(u).endTime||e.$t("goods.selectEndTime")),3)]),f(a,{show:r(P),"onUpdate:show":s[8]||(s[8]=c=>oe(P)?P.value=c:null),position:"bottom",round:"",style:{height:"50%"},"close-on-click-overlay":!1,teleport:"body"},{default:v(()=>[f(p,{modelValue:n.value,"onUpdate:modelValue":s[7]||(s[7]=c=>n.value=c),onConfirm:X,"min-date":E.value,onCancel:z,type:"date",title:e.$t("goods.selectEndTime")},null,8,["modelValue","min-date","title"])]),_:1},8,["show"])]),d("div",lt,[f(x,{round:"",class:"!border-b4 text-b1 flex-1 h-[46px] mr-3",onClick:F},{default:v(()=>[d("span",rt,T(e.$t("common.reset")),1)]),_:1}),f(x,{round:"",class:"btn-yellow flex-1 h-[46px] border-0",onClick:t},{default:v(()=>[d("span",it,T(e.$t("common.confirm")),1)]),_:1})])])]),_:1},8,["show"])],64)}}}),dt=pe(ct,[["__scopeId","data-v-6a3e1f73"]]),ut=g=>(ye("data-v-0e018774"),g=g(),Te(),g),mt=["src"],ft={class:"text-b3"},pt=ut(()=>d("img",{src:Me,class:"w-5 h-5"},null,-1)),ht=[pt],vt={class:"mx-3 safe-body overflow-y-auto"},wt=["onClick"],yt={class:"text-b3"},Tt={key:0,class:"relative flex justify-end text-xs mt-3"},gt=ie({name:"MerchantOrders"});function xt(g){const{regionStore:k}=se(),{accountStore:V}=se(),{clerkStore:I}=se(),C=De(),O=$e(),{getCurrentStoreId:M}=Be(),B=D(null),{t:l}=he(),{getMerchantDhKey:j,decryptKey:R,cryptoAESWithSearch:A}=Fe(),P=ve(()=>[{label:l("order.wait"),value:q.PAYMENT_SUCCESS},{label:l("order.canceled"),value:q.CANCELLED},{label:l("order.completed"),value:q.COMPLETED},{label:l("common.all"),value:-1}]),[Y,h]=Q(!1),n=ae({status:-1,shopInfo:null,list:[],total:0,loading:!1,finished:!1}),m=ae({shopId:null,orderCustomerAddress:void 0,page:0,size:20,keywords:"",merchantEnsLike:void 0,orderStatus:-1,startTime:void 0,endTime:void 0,sortBy:"desc|create_time"}),E=t=>{n.status=t,C.replace({path:"offlineMerchantOrders",query:{status:t}}),H()},u=t=>{var e;return(e=P.value.find(s=>+s.value==+t))==null?void 0:e.label},N=t=>{C.push(t)},H=async t=>{t&&(m.startTime=(t==null?void 0:t.startTime)||void 0,m.endTime=(t==null?void 0:t.endTime)||void 0),n.finished=!1,n.total=0,n.list=[],m.page=0,F()},F=async()=>{var t,e;if(!((t=n.shopInfo)!=null&&t.id))return n.finished=!0;n.loading=!0,m.shopId=(e=n.shopInfo)==null?void 0:e.id,m.page+=1,await Z(),n.loading=!1},z=async t=>{const e=[];for(let s=0;s<t.length;s++){const i=t[s];if(i!=null&&i.orderRemark&&!i.merchantEns)try{let p=i.orderRemark;if(i!=null&&i.orderSubmitCustomerPubKey){const a=await j(i.merchantAddress,i.orderSubmitCustomerPubKey);if(a){const{decrypt:w}=R(i.orderRemark,a);p=w}}if(p){const a=await A(p);a&&e.push({orderId:i.orderId,merchantEns:a})}}catch(p){console.error("Decryption failed:",p)}}(e||[]).length&&qe(e)},Z=async()=>{const t=n.status;n.status<0?delete m.orderStatus:m.orderStatus=n.status,m.keywords?m.merchantEnsLike=await A(m.keywords):m.merchantEnsLike=void 0;const{success:e,data:s}=await me(m);if(n.loading=!1,!e){n.finished=!0;return}const{records:i,total:p,current:a,pages:w}=s;if(!p||!i||!(i!=null&&i.length)){n.finished=!0;return}n.total=p;const x=D([]);x.value=i.map(K=>({btnLoading:!1,...K})),z(x.value),t===n.status&&(n.list=m.page===1?x.value:n.list.concat(x.value)),+a>=+w&&(n.finished=!0)},X=t=>{if(V.isOnlyView)return _(l("order.Requires merchant account operation"));if(I.isClerk&&!I.clerkAuth)return _(l("order.Requires merchant account operation"));C.push({name:"offlineMerchantDetail",query:{id:t.orderId,quick:"deliver"}})},S=async()=>{var ce;const t=navigator.userAgent.toLowerCase(),e=/mobile|android|iphone|ipad|phone/i.test(t),s=/tablet|ipad/i.test(t),i=/webview|wv/i.test(t),p=/fbav|instagram|line|twitter|whatsapp/i.test(t),a=/metamask/i.test(t),w=/tokenpocket/i.test(t),x=(window==null?void 0:window.$onekey)||!1;if(Oe.isConnected()){h(!0);return}if(x){h(!0);return}if((e||s)&&(i||p||a||w||x)&&!window.chrome&&!window.safari){h(!0);return}const K={...m,page:1,size:99999};_.loading({duration:0,message:l("common.loading")});const{success:c,data:y}=await me(K);if(!c||!(y!=null&&y.records)||(y==null?void 0:y.records.length)===0){_.clear(),_(l("common.No data download"));return}const xe=y==null?void 0:y.records.map(o=>new Promise(async be=>{if(o!=null&&o.orderRemark&&(o!=null&&o.orderSubmitCustomerPubKey))try{const J=await j(o.merchantAddress,o.orderSubmitCustomerPubKey);if(J){const ke=R(o.orderRemark,J);o.orderRemark=ke.decrypt}}catch(J){console.error("解密失败:",J)}be([{text:o.orderId},{text:o.orderCustomerAddress},{text:o.orderTransactionHash||""},{text:`【${l(`offline.order_${fe[o==null?void 0:o.orderType]}`)}】${(o==null?void 0:o.relName)||""}`},{text:(o==null?void 0:o.relId)||""},{text:o==null?void 0:o.relNumber},{text:u(o.orderStatus)},{text:o.orderTotalAmount||0},{text:o.voucherAmount||0},{text:o.orderRealAmount},{text:o.orderDiscountRatio?o.orderDiscountRatio+"%":"0%"},{text:o.createTime?ne(o.createTime):""},{text:o.payTime?ne(o.payTime):""},{text:o.finishTime?ne(o.finishTime):""},{text:o.orderRemark||""},{text:o.cancelReason||""}])})),ee=await Promise.all(xe);if(!ee||ee.length===0){_.clear(),_(l("common.No data download"));return}const _e=[{text:l("order.export.orderId")},{text:l("order.export.buyerAddress")},{text:l("order.export.transactionHash")},{text:`【${l("common.category")}】${l("offline.order_STORE")}/${l("order.export.goodsName")} `},{text:`${l("offline.order_GOODS")}/${l("offline.order_STORE")}ID`},{text:l("order.export.goodsNumber")},{text:l("order.orderStatus")},{text:l("offline.order_price")},{text:l("voucher.voucher_deduction total")},{text:l("order.export.actualAmount total")},{text:l("common.ratio")},{text:l("order.createTime")},{text:l("order.export.paymentTime")},{text:l("order.Complete time")},{text:l("order.remark")},{text:l("offline.cancel_reason")}];try{const o=((ce=await M())==null?void 0:ce.storeName)+l("offline.main title")+"_"+G().format("YYYY-MM-DD HH:mm:ss");Re([_e,...ee],{excelName:o,worksheet:"sheet"}),_.clear()}catch{_.clear()}},W=()=>{h(!1)};return Ie(()=>O.path,async t=>{if(t==="/offlineMerchantOrders"){const e=sessionStorage.getItem("merchant_offline_refresh_chainOrderId");if(e){const s=n.list.findIndex(i=>i.orderId==e);if(s>-1&&n.status===q.PAYMENT_SUCCESS)n.list.splice(s,1);else if(s>-1&&n.status===-1){const i=await Ge({id:e});i.success&&(n.list[s]=i.data||{})}sessionStorage.removeItem("merchant_offline_refresh_chainOrderId")}}},{deep:!0}),Ee(async()=>{var t,e;(t=O.query)!=null&&t.status&&(n.status=Number((e=O.query)==null?void 0:e.status)),n.shopInfo=await M(),F(),I.checkClerkAuth()}),(t,e)=>{const s=b("VanButton"),i=b("VanList"),p=b("router-view");return $(),de(Ae,{title:t.$t("offline.main title"),class:"bg-gray1 font-Puhui font-normal relative shopGoodsPage","theme-vars":{"field-placeholder-text-color":"#A6A6A6"},ref:(a,w)=>{w.shopGoodsRef=a,B.value=a}},{right:v(()=>[d("img",{src:r(Ue)(`mall/${r(k).country}-flag.svg`),class:"w-5 h-auto mr-1"},null,8,mt),d("span",ft,T(t.$t(`country.${r(k).country}`))+T(r(k).country),1)]),default:v(()=>[f(He,{options:r(P),"label-key":"label","value-key":"value",modelValue:r(n).status,"onUpdate:modelValue":e[0]||(e[0]=a=>r(n).status=a),onChange:E},null,8,["options","modelValue"]),f(dt,{modelValue:r(m).keywords,"onUpdate:modelValue":e[1]||(e[1]=a=>r(m).keywords=a),onOnSearch:H},{default:v(()=>[d("div",{class:"flex-shrink-0 w-5 ml-3",onClick:S},ht)]),_:1},8,["modelValue"]),d("div",vt,[f(i,{loading:r(n).loading,"onUpdate:loading":e[2]||(e[2]=a=>r(n).loading=a),finished:r(n).finished,"immediate-check":!1,"finished-text":t.$t("common.noMore"),"loading-text":t.$t("common.loading"),onLoad:F},{default:v(()=>[($(!0),L(le,null,we(r(n).list,a=>($(),L("div",{class:"offline-crad-box mb-3",key:a.orderId,onClick:w=>N(`/offlineMerchantDetail?id=${a.orderId}`)},[f(Ye,{order:a,"show-status":"",status:u(a.orderStatus)},null,8,["order","status"]),f(Pe,{"show-order-type":"",class:"mt-3",goods:{goodsName:a.relName,goodsIcons:a.relIcons,orderType:a.orderType,goodsPrice:a.orderRealAmount},onImageClick:w=>a.orderType===r(fe).GOODS?N("/offlineMerchantOrders/offlineGoodsDetail?goodsId="+a.relId):N("/shop?shopId="+a.relId)},{"bottom-left":v(()=>[d("div",yt,T(t.$t("common.total"))+"：",1)]),_:2},1032,["goods","onImageClick"]),a.orderStatus===r(q).PAYMENT_SUCCESS?($(),L("section",Tt,[r(V).isOnlyView?ue("",!0):($(),de(s,{key:0,color:"#FED73A",round:"",class:"!text-b1 font-semibold h-[32px] rounded-md px-3",onClick:re(w=>X(a),["stop"])},{default:v(()=>[Ve(T(t.$t("order.Ship")),1)]),_:2},1032,["onClick"]))])):ue("",!0)],8,wt))),128))]),_:1},8,["loading","finished","finished-text","loading-text"])]),f(Ke,{show:r(Y),title:"导出账单",content:"请在PC端操作账单导出",showConfirm:!0,showReject:!1,confirmText:"我知道了",rejectText:"拒绝",onClose:W,onConfirm:W},null,8,["show"]),f(p,{class:"child-view bg-gray1"})]),_:1},8,["title"])}}const _t=ie({...gt,setup:xt}),Lt=pe(_t,[["__scopeId","data-v-0e018774"]]);export{Lt as default};
