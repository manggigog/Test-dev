import{_ as kt}from"./arrow-bottom-D85vJawE.js";import{z as ve,G as h,H as u,I as a,U as v,Q as i,O as t,a4 as X,J as Q,_ as St,x as xt,o as $t,q as Pt,bB as B,r as d,bV as Tt,y as _,bu as Ct,B as M,D as qe,ad as Rt,E as Lt,F as J,Z as $,$ as I,P as w,bw as Ue,N as Bt,a0 as It,n as Dt,X as Et,Y as Gt,T as S}from"./vendor-Dr_RpJ_Y.js";import{_ as Nt}from"./AddressInfo-2bPrVt2B.js";import{_ as He}from"./EmptyTipsPop-DFfFg0cQ.js";import{_ as je}from"./USDT-Dlu99aCg.js";import{_ as pe}from"./MCOIN-Bodfn-v1.js";import{_ as Ot}from"./FMCP-f3k58DsE.js";import{e as P,V as Vt,i as Ft,a as qt,g as D,w as Ut,a5 as Ht,bL as Mt}from"./index-7OiUoGXy.js";import{P as x,O as de}from"./order-H59PKTFP.js";import{P as Wt}from"./PaySwitchPop-jRKJee4g.js";import{C as jt}from"./CommonVanProvider-KZuKVOde.js";import{u as zt,_ as Kt,P as Jt}from"./usePayHelp-CaGzEK51.js";import{_ as Qt}from"./PayHelpSelector-DjBp2vZY.js";import{O as Xt}from"./OrderGoodsBox-5PjaZvBT.js";import{q as Yt,c as Zt}from"./address-iY9yI6tl.js";import{q as eo}from"./goods-BMcs_teV.js";import{p as Me,r as to,t as oo,u as ao}from"./order-D0_No2Ew.js";import{a as so,u as no}from"./useSelectAddress-CgNt0r_o.js";import{G as me}from"./goods-BVwS8oFG.js";import{_ as fe}from"./SubmitApprove-B3ByTMk_.js";import{S as lo}from"./shop-CeqcS6K2.js";import{u as ro}from"./useKeyboard-DcWqtm11.js";import{P as We}from"./payHelp-BuwJxNdC.js";import{u as uo}from"./usePaymentBalance-f4pIUpTg.js";import{P as io}from"./PaymentMethodSelector-Bpf0rZb7.js";import"./BackIcon-CDrGaEPo.js";import"./payHelp-CYFZHRwW.js";import"./mall-DLd1UK-E.js";import"./OrderGoods-C5ohlmD4.js";import"./BoutiqueLable-DDlxeK08.js";import"./flashSale-DDyqLyYN.js";import"./ShopMaskTips-ClYuWX9C.js";import"./enums-DlE-aiss.js";import"./piggyBank-DCQqbblx.js";import"./point-arrow-C6HCTn4p.js";import"./usePointRelase-CczR7Un0.js";const co={class:"bg-white mt-3 p-3 rounded-xl"},mo={class:"text-base font-semibold"},fo={class:"flex items-start justify-between mt-3"},vo={class:"text-b3"},po={class:"text-right"},yo={key:0,class:"flex items-center justify-end gap-1 font-semibold"},ho=a("img",{src:je,class:"w-4 h-4"},null,-1),go={key:1,class:"flex items-center justify-end gap-1 font-semibold"},bo=a("img",{src:pe,class:"w-4 h-4"},null,-1),_o={key:2,class:"text-xs text-b3 text-right"},wo={key:0,class:"actPrice flex items-baseline justify-between mt-3"},Ao={class:"text-b3 max-w-[100px] line-clamp-1"},ko={class:"text-right flex items-center justify-end gap-1"},So=X(" -"),xo=a("img",{src:pe,class:"w-4 h-4"},null,-1),$o=a("div",{class:"w-full h-[0.5px] bg-b4 my-3"},null,-1),Po={class:"flex items-center justify-between"},To={class:"text-b3"},Co={class:"flex-col"},Ro={class:"gap-1 text-right flex items-center justify-end text-b1 font-semibold"},Lo=a("img",{src:je,class:"w-4 h-4"},null,-1),Bo=a("img",{src:pe,class:"w-4 h-4"},null,-1),Io=X("+ "),Do=a("img",{src:Ot,class:"w-4 h-4"},null,-1),Eo={class:"text-b3 text-xs text-right mt-1"},Go=ve({props:{paySource:null,totalAmount:null,usdtAmount:null,voucherAmount:null,symbol:null,activityReduceAmount:null,fmGeneralActivity:null,actualAmount:null,integral:null},setup(l){return(T,ye)=>{var E;return u(),h("div",co,[a("div",mo,i(T.$t("order.totalPriceDetail")),1),a("div",fo,[a("div",vo,i(T.$t("order.goodsPrice")),1),a("div",po,[l.paySource===t(x).USDT_WALLET?(u(),h("div",yo,[ho,a("span",null,i(t(P)(l.usdtAmount||0)),1)])):(u(),h("div",go,[bo,a("span",null,i(t(P)(l.totalAmount||0)),1)])),l.usdtAmount>0?(u(),h("div",_o,i(`(${t(P)(l.usdtAmount||0)} USDT${T.$t("offline.auto_exchange")} ${l.actualAmount||0} MCOIN)`),1)):v("",!0)])]),l.activityReduceAmount&&l.fmGeneralActivity?(u(),h("div",wo,[a("div",Ao,i((E=l.fmGeneralActivity)==null?void 0:E.name),1),a("div",ko,[So,xo,a("span",null,i(t(P)(l.activityReduceAmount)),1)])])):v("",!0),$o,a("div",Po,[a("div",To,i(T.$t("common.actual_payment")),1),a("div",Co,[a("div",Ro,[l.usdtAmount>0?(u(),h(Q,{key:0},[Lo,a("span",null,i(t(P)(l.usdtAmount||0)),1)],64)):(u(),h(Q,{key:1},[Bo,a("span",null,i(t(P)(l.actualAmount)),1)],64)),l.voucherAmount?(u(),h(Q,{key:2},[Io,Do,X(i(t(P)(l.voucherAmount)),1)],64)):v("",!0)]),a("div",Eo,i(T.$t("order.getContribution",{num:l.integral})),1)])])])}}}),ze=l=>(Et("data-v-f8cb232a"),l=l(),Gt(),l),No={key:0,class:"page-body mt-3 overflow-y-auto"},Oo={class:"bg-white rounded-xl p-3 mt-3"},Vo={key:0},Fo={class:"bg-white overflow-hidden mt-3 py-3 border-y-[0.5px] border-b4 border-solid"},qo={class:"text-b3"},Uo={class:"bg-white myinput overflow-hidden py-3"},Ho={class:"text-b3"},Mo={class:"flex items-center"},Wo=ze(()=>a("img",{class:"w-[16px] h-[16px]",src:kt,alt:"",srcset:""},null,-1)),jo={class:"relative"},zo={class:"bg-white rounded-xl px-3 py-4 mt-3"},Ko={class:"flex items-center justify-between"},Jo={class:"text-b1 font-semibold"},Qo=ze(()=>a("div",{class:"h-10"},null,-1)),Xo=ve({name:"SubmitOrder"});function Yo(l){const{isKeyboardVisible:T}=ro(),{getUserDhKey:ye,encryptAddressKey:E,formatAddressData:he,generateKey:ge,decryptAddressKey:Ke}=Vt(),{t:g}=xt(),{loadingToggle:be}=Ut(),{getAddress:W,setAddress:Y}=no(),{getRemark:_e,setRemark:Je}=so(),{submit:Qe}=Ft(),j=$t(),G=Pt(),[Xe,Z]=B(!1),[we,ee]=B(!1),[Ye,Ae]=B(!0),[R,y]=B(!1),[Ze,ke]=B(!1),[et,Se]=B(!1),te=d([]),f=d(),r=d(),xe=d(),z=d(""),oe=d(0),k=d(""),A=Tt("number",1),$e=d([]),K=_(()=>{var e,o;return Number((o=(e=r.value)==null?void 0:e.goods)==null?void 0:o.type)!==lo.SD}),{balanceState:N,paymentOptions:tt,fetchAllBalances:Pe,autoSelectPaymentMethod:ot,checkSufficientBalance:at}=uo(K),Te=_(()=>[{value:0,text:g("common.no")},{value:1,text:g("common.yes")}]),Ce=d(null),Re=d(!1),st=e=>{oe.value=e.value};Ct(Ce,()=>{ee(!!k.value)});const ae=_(()=>{const e=Ee.value,o=V.value,n=e==null?void 0:e.fullAmount;return e&&typeof n=="number"&&typeof o=="number"&&o>=n&&e.reduceAmouint||0}),se=_(()=>new M(V.value).minus(ae.value||0).minus(F.value||0).toNumber()),nt=()=>{if(_e()){k.value=_e(),Y(null);return}},c=d(x.WALLET),O=e=>{R.value||(c.value=e)},V=_(()=>{var e;return+new M(P((e=r.value)==null?void 0:e.goods.price)).times(A.value||1)}),ne=_(()=>V.value-ae.value),Le=_(()=>c.value===x.USDT_WALLET?M(ne.value).dividedBy(N.usdtRate).toString():0);qe(K,()=>{K.value?O(x.WITHDRAW_POINTS):O(x.WALLET)},{immediate:!0});const Be=_(()=>new M(r.value.goods.discountRatio).times(ne.value||0).times(N.pointSelfRate).div(100).toString()),Ie=_(()=>Math.min(N.voucherBalance,new M(Be.value).div(N.pointSelfRate).times(.5).toNumber())),F=_(()=>c.value===x.WITHDRAW_POINTS?Ie.value:0),lt=async()=>{if(W()){f.value=W(),Y(null);return}const e=G.currentRoute.value.path,o=await Yt();if(!o.success)return;te.value=o.data;const n=te.value.find(b=>b.isDefault===1)||te.value[0],m=await ge("user",e);if(n!=null&&n.encryptFlag&&m){f.value=Ke(n,m);return}f.value=n},rt=_(()=>({remark:k.value,paySource:c.value})),le="submit_order_info",ut=()=>{try{W()&&(f.value=W(),Y(null));let e=sessionStorage.getItem(le);e&&(e=JSON.parse(e),e!=null&&e.remark&&(k.value=e.remark,ee(!0)),e!=null&&e.paySource&&(c.value=e.paySource),sessionStorage.removeItem(le))}catch{console.error("恢复数据失败")}},De=d(null),Ee=d(null),it=async()=>{var o,n,m;const e=await eo(+j.query.id);e.success&&(r.value=e.data,xe.value=e.data.fmStoredCard,De.value=e.data.fmGeneralActivity||null,Ee.value=e.data.fmGeneralActivityRule||null,(n=(o=e.data)==null?void 0:o.fmGeneralActivityGoods)!=null&&n.activityPrice&&(r.value.goods.price=e.data.fmGeneralActivityGoods.activityPrice),r.value.goods&&(r.value.goods.goodsType=(m=r.value.goods)==null?void 0:m.type))},re=d(!1),ct=e=>{let o=r.value.fmGeneralActivityGoods;o&&e>+(o==null?void 0:o.activityStock)?(re.value||S("当前加购超出活动库存将恢复原价"),re.value=!0):re.value=!1,e<1?A.value=1:A.value=e,Ge()},Ge=async()=>{var m,b;let e=[];e.push({goodsId:r.value.goods.id,num:A.value,payType:de.MC,paySource:c.value});const o={type:((m=j==null?void 0:j.query)==null?void 0:m.type)??1,addressId:(b=f.value)==null?void 0:b.id,detailList:e,genOrder:!1},n=await Me(o);n.success&&($e.value=n.data.goodsList||[])},Ne=()=>{var e,o;y(!0);try{if(!f.value)return S(g("order.setAddress")),!1;if(+r.value.goods.goodsTypes===me.RECHARGE&&!+z.value)return S(g("order.Please fill in your phone number")),!1;if(r.value.goods.stock<+A.value&&+r.value.goods.goodsTypes!=2)return S(g("order.Insufficient stock")),!1;if((e=f.value)!=null&&e.encryptFlag&&!((o=f.value)!=null&&o.success))return S(g("order.reconfirm the information")),!1;if(!Ht(f.value.telNumber))return S(g("address.number was identified")),!1}finally{y(!1)}return!0},dt=Ue(async()=>{if(await Ne()){if(y(!0),!at(c.value,se.value))return y(!1),ke(!0);vt()}},500),mt=d(null),q=d(0),ft=d(null),Oe=async()=>{try{const e=G.currentRoute.value.path;await oo({goodsId:r.value.goods.id,number:A.value}),await ao({type:1});let o=k.value;+r.value.goods.goodsTypes===me.RECHARGE&&(o=g("order.phoneNumber")+String(z.value).concat(oe.value===1?` ${g("order.Number Portabilit")} `:"").concat("，").concat(k.value));const n=await ye(r.value.stores.id),m=await ge("user",e);let b;m&&!f.value.encryptFlag&&(b=E(f.value,m),await Zt({...b,isDefault:f.value.isDefault?1:0}));let p={};return n?(p=he(p,{...f.value,postscript:o},1),p=E(p,n),p.submitHash=p.hash):p=he(p,{...f.value,postscript:o},0),{type:1,postscripts:[{storeId:r.value.stores.id,...p}],detailList:[{goodsId:r.value.goods.id,num:A.value,payType:de.MC,paySource:c.value}],voucherAmount:F.value||0}}catch{return!1}},vt=async()=>{var e;y(!0);try{const o=await Oe();if(!o)return;const n=await Me(o);if(!n.success){y(!1);return}const{allOrderId:m,merchants:b,discounts:p,amounts:U,sources:s,buyer:C}=n.data;try{const L=await Qe(m,b,p,U,s,C);if(!L.success){L.result.reason==="execution reverted: ERC20: transfer amount exceeds balance"&&S(g("errorMsg.transfer amount exceeds balance")),setTimeout(()=>{G.push({path:"/buyerOrderList",query:{active:0},replace:!0})},1e3);return}if(S.loading({message:g("order.wait block chain"),forbidClick:!0,duration:0}),await to({allOrderId:m,hash:L.result.hash}),S.clear(),mt.value=L.result.hash,!L.result.hash)return;let H;const Fe=async()=>{if(q.value>=5){y(!1),Se(!0),q.value=0;return}if(H=await Mt(L.result.hash),(H==null?void 0:H.status)===1){console.log("hash 查询 成功",H),Z(!0),q.value=0,pt(),y(!1);return}setTimeout(async()=>{q.value++,Fe()},5e3)};Fe()}catch{q.value=0,y(!1)}}catch{y(!1)}finally{(e=ft.value)==null||e.setpayValue(c==null?void 0:c.value.toString())}},pt=()=>{setTimeout(()=>{Z(!1),G.replace({path:"buyerOrderList",query:{active:1,type:1}})},1500)},{payBy:ue,payLink:ie,payHelpRef:ce,changeBy:yt,generatePayLink:ht,showChangeTip:gt}=zt(),bt=Ue(async()=>{var e;if(Ne()){y(!0);try{if(ie.value){(e=ce.value)==null||e.setShow(!0);return}const o=await Oe();if(!o)return;ht(o)}finally{y(!1)}}},500);qe([A,k],()=>{gt()});const{accountStore:_t}=qt(),wt=async()=>{if(_t.isLogin){be(!0),Ae(!0);try{await Promise.all([lt(),it(),Pe(),nt()]),Ge();const e=ot(se.value,Ie.value);O(e)}catch(e){console.error("Failed to initialize payment method:",e)}finally{be(!1),Ae(!1),await Dt(),ut()}}},Ve=d(!0),At=e=>{Ve.value=!1,G.push(e)};return Rt(()=>{Ve.value&&Je("")}),Lt(()=>{A.value=1,wt()}),(e,o)=>{const n=J("van-field"),m=J("van-popover"),b=J("VanButton"),p=J("VanField");return u(),$(jt,{title:e.$t("order.order"),class:"w-full h-full font-Puhui font-normal relative px-3",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent"}},{default:I(()=>{var U;return[w(Kt,{tab:t(ue),onChangeTab:t(yt)},null,8,["tab","onChangeTab"]),t(Ye)?v("",!0):(u(),h("div",No,[w(Nt,{defaultAddress:f.value,sessionSaveInfo:t(rt),sessionSaveKey:le,onHandleTo:At},null,8,["defaultAddress","sessionSaveInfo"]),a("div",Oo,[w(Xt,{orderInfo:r.value,number:t(A),payType:t(de).MC,card:xe.value,expressGoodsList:$e.value,onChangeNumber:ct},null,8,["orderInfo","number","payType","card","expressGoodsList"]),+((U=r.value.goods)==null?void 0:U.goodsTypes)===t(me).RECHARGE?(u(),h("div",Vo,[a("div",Fo,[w(n,{style:{padding:"0 !important"},"input-align":"right",type:"digit",autocomplete:"off",modelValue:z.value,"onUpdate:modelValue":o[0]||(o[0]=s=>z.value=s),placeholder:e.$t("shop.pleaseInput")},{label:I(()=>[a("div",qo,i(`${e.$t("order.Phone number")}`),1)]),_:1},8,["modelValue","placeholder"])]),a("div",Uo,[w(n,{style:{padding:"0 !important"},"input-align":"right",autocomplete:"off",label:`${e.$t("order.Whether to port your number")}`},{label:I(()=>[a("div",Ho,i(`${e.$t("order.Whether to port your number")}`),1)]),input:I(()=>[w(m,{show:Re.value,"onUpdate:show":o[1]||(o[1]=s=>Re.value=s),actions:t(Te),onSelect:st,placement:"top-end"},{reference:I(()=>{var s;return[a("div",Mo,[a("div",null,i(((s=t(Te).find(C=>C.value==oe.value))==null?void 0:s.text)||""),1),Wo])]}),_:1},8,["show","actions"])]),_:1},8,["label"])])])):v("",!0)]),t(ue)===t(We).OWNER?(u(),h(Q,{key:0},[w(io,{modelValue:c.value,"onUpdate:modelValue":o[2]||(o[2]=s=>c.value=s),"payment-options":t(tt),loading:t(N).loading,boutique:t(K),onChange:O,onGetPointBalance:t(Pe),class:"mt-3"},null,8,["modelValue","payment-options","loading","boutique","onGetPointBalance"]),w(Go,{"pay-source":c.value,"total-amount":t(V),"voucher-amount":t(F),"usdt-amount":t(Le),"actual-amount":t(se),symbol:c.value===t(x).USDT_WALLET?"USDT":"MCOIN","activity-reduce-amount":t(ae),"fm-general-activity":De.value,integral:t(Be)},null,8,["pay-source","total-amount","voucher-amount","usdt-amount","actual-amount","symbol","activity-reduce-amount","fm-general-activity","integral"]),a("div",{class:Bt(["fixed bottom-0 sm:left-1/2 sm:-translate-x-2/4 left-0 z-20 sm:w-[375px] w-full px-3 py-4 safe-btn-bottom-bottom",t(T)?"!hidden":"!fixed"])},[a("div",jo,[[t(x).WALLET].includes(c.value)?(u(),$(fe,{key:0,class:"absolute bg-yellow text-b1 font-semibold w-full h-[46px] z-10 rounded-full",contract:t(D).order,token:t(D).MCOIN,symbol:"MCOIN",loading:t(R),approveAmount:Number(t(ne))},null,8,["contract","token","loading","approveAmount"])):v("",!0),[t(x).USDT_WALLET].includes(c.value)?(u(),$(fe,{key:1,class:"absolute bg-yellow text-b1 font-semibold w-full h-[46px] z-10 rounded-full",contract:t(D).order,token:t(D).USDT,symbol:"USDT",loading:t(R),approveAmount:Number(t(Le))},null,8,["contract","token","loading","approveAmount"])):v("",!0),t(F)>0?(u(),$(fe,{key:2,class:"absolute bg-yellow text-b1 font-semibold w-full h-[46px] z-10 rounded-full",contract:t(D).order,token:t(D).FMCP,symbol:e.$t("voucher.voucher"),loading:t(R),approveAmount:Number(t(F))},null,8,["contract","token","symbol","loading","approveAmount"])):v("",!0),w(b,{class:"bg-yellow text-b1 font-semibold w-full h-[46px] rounded-full",loading:t(R),onClick:t(dt)},{default:I(()=>[X(i(e.$t("common.pay")),1)]),_:1},8,["loading","onClick"])])],2)],64)):v("",!0),a("div",zo,[a("div",Ko,[a("span",Jo,i(e.$t("order.buyerRemark")),1),t(we)?v("",!0):(u(),h("span",{key:0,class:"text-b3",onClick:o[3]||(o[3]=s=>t(ee)(!0))},i(e.$t("common.pleaseInput"))+i(e.$t("order.remark")),1))]),t(we)?(u(),$(p,{key:0,ref:(s,C)=>{C.remarkRef=s,Ce.value=s},modelValue:k.value,"onUpdate:modelValue":o[4]||(o[4]=s=>k.value=s),type:"textarea",maxlength:"100",class:"!bg-b5 rounded-lg mt-2 p-2 remark-box",rows:"1",autosize:""},null,8,["modelValue"])):v("",!0)]),Qo,t(ue)===t(We).OTHER?(u(),$(Jt,{key:1,"pay-link":t(ie),"btn-loading":t(R),onOnClick:t(bt)},null,8,["pay-link","btn-loading","onOnClick"])):v("",!0)])),t(Xe)?(u(),$(He,{key:1,onClose:o[5]||(o[5]=s=>t(Z)(!1)),text:e.$t("common.pay success")},null,8,["text"])):v("",!0),t(et)?(u(),$(He,{key:2,isError:!0,onClose:o[6]||(o[6]=s=>t(Se)(!1)),text:e.$t("order.fail")},null,8,["text"])):v("",!0),w(Wt,{paySource:c.value,show:t(Ze),onClose:o[7]||(o[7]=s=>t(ke)(!1)),onChangePay:o[8]||(o[8]=s=>O(s))},null,8,["paySource","show"]),w(Qt,{ref:(s,C)=>{C.payHelpRef=s,It(ce)&&(ce.value=s)},amount:t(V),link:t(ie)},null,8,["amount","link"])]}),_:1},8,["title"])}}const Zo=ve({...Xo,setup:Yo}),Ga=St(Zo,[["__scopeId","data-v-f8cb232a"]]);export{Ga as default};
