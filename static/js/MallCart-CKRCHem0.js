import{_ as z,z as q,x as U,F as _,G as p,H as m,I as d,P as b,Q as f,J as H,K as G,$ as S,aL as de,X as K,Y as Q,y as M,B as $,Z as J,U as N,O as r,a4 as te,N as Ie,bl as _e,q as Se,a2 as oe,bV as Ae,r as j,D as De,E as Me,ad as $e,T as se,n as Le}from"./vendor-Dr_RpJ_Y.js";import{_ as Re}from"./mall-C69gPh5W.js";import{O as Ee}from"./OrderGoods-GRYu2N4C.js";import{_ as Fe}from"./MCOIN-BOqZVkND.js";import{b as Ne,d as ne,e as P,ar as qe,a as Oe,w as Ve,bO as je,j as ae,g as ce,bP as le,bQ as Pe,bR as He,u as Ge}from"./index-CU2nzZe6.js";import{D as Je}from"./DividingLine-Dusl4c-B.js";import{_ as ze}from"./RecommendationFeed-D7SuZ6RS.js";import{c as Ue}from"./goods-CMFNhadQ.js";import{P as L}from"./flashSale-DDyqLyYN.js";import{S as re}from"./shop-CeqcS6K2.js";import"./BoutiqueLable-DDlxeK08.js";import"./ShopMaskTips-ClYuWX9C.js";import"./GoodsItem-BWjh4rbS.js";import"./buy-cart-DX6aL7m1.js";import"./goods-BVwS8oFG.js";import"./GoodsPrice-BO5T8eoh.js";import"./mall-COk3vM6s.js";import"./WaterFull-BoFTr9ol.js";/* empty css                                                              */import"./useShowActiveInfo-Bt4VVJoh.js";const Ke=s=>(K("data-v-443fa7c0"),s=s(),Q(),s),Qe=Ke(()=>d("img",{src:Re,class:"w-4 mr-1"},null,-1)),Xe={class:"text-base font-semibold"},Ye=q({props:{cartInfo:null,isManage:{type:Boolean}},emits:["changeNumber","handelDel","handleTo","handleRemove"],setup(s,{emit:g}){const k=s,{t:n}=U(),x=(i,C)=>{de.confirm({message:n("cart.remove"),confirmButtonText:n("common.confirm"),confirmButtonColor:"#FF507A",cancelButtonText:n("common.cancel")}).then(()=>{g("handelDel",k.cartInfo,i,C)}).catch(()=>{})},y=(i,C)=>{g("handelDel",k.cartInfo,i,C),g("handleRemove",k.cartInfo,i,C)};return(i,C)=>{const A=_("van-icon"),u=_("van-checkbox"),c=_("van-button"),T=_("VanSwipeCell");return m(),p("div",null,[d("div",{class:"flex-start mt-2.5",onClick:C[0]||(C[0]=h=>g("handleTo",`/category?deliveryType=1&shopId=${s.cartInfo.storeId}`))},[Qe,d("div",Xe,f(s.cartInfo.storeName||"-"),1),b(A,{name:"arrow",class:"ml-2"})]),(m(!0),p(H,null,G(s.cartInfo.goods,(h,D)=>(m(),p("div",{class:"bg-white mt-2.5 rounded-xl p-2.5",key:h.id},[b(T,null,{right:S(()=>[b(c,{square:"",class:"right-btn",color:"#FEA021",text:i.$t("cart.removeTo"),onClick:w=>y(h,D)},null,8,["text","onClick"]),b(c,{square:"",class:"right-btn",color:"#FF507A",text:i.$t("shop.delete"),onClick:w=>x(h,D)},null,8,["text","onClick"])]),default:S(()=>[b(u,{disabled:h.disabled&&!s.isManage,name:h,class:"min-w-min mr-0"},{default:S(()=>[b(Ee,{goods:h,payType:h.payType,card:h,number:h.number||1,shopType:h.shopType,class:"w-full flex-1 mb-2.5 last:mb-0 pl-0",onChangeNumber:w=>g("changeNumber",h,+w),onHandleTo:C[1]||(C[1]=w=>g("handleTo",w))},null,8,["goods","payType","card","number","shopType","onChangeNumber"])]),_:2},1032,["disabled","name"])]),_:2},1024)]))),128))])}}}),Ze=z(Ye,[["__scopeId","data-v-443fa7c0"]]),ie=s=>(K("data-v-283f3779"),s=s(),Q(),s),We={class:"w-full h-14 flex items-center justify-between pb-0.5 px-2 bg-white rounded-full sm:w-[355px] shadow-2 pointer-events-auto"},et={class:"opacity-70"},tt={key:0,class:"ml-2 text-sm text-default"},ot=ie(()=>d("span",{class:"opacity-70"},[d("span",{class:"mr-1 text-lg"},"≈")],-1)),st={class:"text-base font-semibold text-primary"},nt={key:1,class:"flex items-center justify-between flex-1 text-default dropdown-class"},at={key:0,class:"flex items-center justify-between flex-1 px-2.5"},ct={class:"text-sm text-default"},lt={class:"text-xs font-normal"},rt={class:"text-xs font-normal text-center"},dt={class:"text-right"},it={class:"flex items-center justify-end flex-1 w-full text-base font-semibold text-right"},ut=ie(()=>d("img",{class:"w-4 h-4 mr-1",src:Fe},null,-1)),ht={class:"text-base"},mt={key:0,class:"text-[#A45E00] text-xs"},gt={key:0},ft=q({props:{voucherBalance:null,goodsChecked:null,loading:{type:Boolean},isCheckAll:{type:Boolean},totalAmount:null,isManage:{type:Boolean},isCollect:{type:Boolean}},emits:["totalCheck","handleCartBuy","handleDelMult","typeChange"],setup(s,{emit:g}){const k=s,{checkRegisterAuth:n}=Ne(),{t:x}=U(),y=M(()=>k.goodsChecked.reduce((u,c)=>new $(u).plus(c.number),0)),i=M(()=>Math.min(k.voucherBalance,k.goodsChecked.reduce((u,c)=>c.goodsType>0?new $(u).plus(new $(c.number).multipliedBy(c.price).multipliedBy(c!=null&&c.goodsType?c==null?void 0:c.balanceDiscountRatio:(c==null?void 0:c.discountRatio)||0).div(100).multipliedBy(.5)):new $(u).plus(0),0)));function C(){de.confirm({messageAlign:"center",message:x("cart.delConfirm",{num:k.goodsChecked.length}),confirmButtonText:x("shop.delete"),confirmButtonColor:"#FF507A",cancelButtonText:x("cart.thinkAgain"),cancelButtonColor:"#2E2008"}).then(()=>{g("handleDelMult")}).catch(()=>{})}const A=async()=>{await n(!0)&&g("handleCartBuy")};return(u,c)=>{const T=_("VanRadio"),h=_("VanButton");return m(),p("div",{class:Ie(["fixed bottom-0 w-full px-2.5 safe-bottom sm:bottom-[0%] lg:bottom-[0%] z-20 cartbarBody pointer-events-none",s.isCollect?"":"safe-bottom-page"])},[d("div",We,[s.isManage||s.isCollect?(m(),p("div",{key:0,class:"flex items-center justify-between text-default",onClick:c[0]||(c[0]=D=>g("totalCheck"))},[b(T,{checked:s.isCheckAll,"checked-color":"#FEA021"},{default:S(()=>[d("span",et,f(u.$t("common.check all")),1)]),_:1},8,["checked"]),s.goodsChecked&&s.goodsChecked.length&&!s.isManage?(m(),p("div",tt,[ot,d("span",st,f(r(ne)(r(P)(s.totalAmount||0)))+"Mcoin",1)])):N("",!0)])):(m(),p("div",nt,[b(T,{checked:s.isCheckAll,"checked-color":"#FEA021",onClick:c[1]||(c[1]=D=>g("totalCheck"))},null,8,["checked"]),s.goodsChecked&&s.goodsChecked.length&&!s.isManage?(m(),p("div",at,[d("div",ct,[d("div",lt,f(u.$t("cart.hasChecked",{num:r(y)||0})),1),d("div",rt,f(u.$t("cart.count")),1)]),d("div",dt,[d("div",it,[ut,d("span",ht,f(r(ne)(r(P)(s.totalAmount||0))),1)]),r(i)?(m(),p("div",mt,f(u.$t("cart.VoucherAmount"))+f(r(P)(r(i))),1)):N("",!0)])])):N("",!0)])),s.isManage?(m(),J(h,{key:2,class:"btn-red btn-shadow px-8 h-[40px] text-white",loading:s.loading,disabled:!s.goodsChecked.length,onClick:C},{default:S(()=>[te(f(u.$t("shop.delete")),1)]),_:1},8,["loading","disabled"])):(m(),J(h,{key:3,class:"btn-orange btn-shadow px-8 h-[40px] text-white",loading:s.loading,disabled:!s.goodsChecked.length,onClick:A},{default:S(()=>[te(f(u.$t("cart.settle"))+" ",1),s.goodsChecked&&s.goodsChecked.length&&s.isCollect?(m(),p("span",gt,"("+f(s.goodsChecked.length||0)+")",1)):N("",!0)]),_:1},8,["loading","disabled"]))])],2)}}}),pt=z(ft,[["__scopeId","data-v-283f3779"]]),Ct=s=>(K("data-v-6d83067d"),s=s(),Q(),s),kt={class:"p-2.5"},yt={class:"text-xl font-semibold flex-center-bw"},bt=Ct(()=>d("div",{class:"safe-bottom-page"},null,-1)),vt=q({name:"MallCart"});function xt(s){const{t:g}=U(),k=qe(),n=_e({originList:[],oldList:[],list:[],goodsChecked:[],goodsType:0}),x=Se(),{loadingToggle:y}=Ve(),[i,C]=oe(!1),{orderGoodsStore:A}=Oe();Ae("cart_number",1);const u="mall_cart_scroll_position",c=5*60*1e3,T=()=>{const o={position:document.querySelector("#fm-page").scrollTop,timestamp:Date.now()};sessionStorage.setItem(u,JSON.stringify(o))},h=()=>{const t=sessionStorage.getItem(u);if(t){const{position:o,timestamp:e}=JSON.parse(t);Date.now()-e<c?Le(()=>{const a=document.querySelector("#fm-page");a&&setTimeout(()=>{a.scrollTo({top:o,behavior:"smooth"}),console.log("恢复滚动位置:",o,a.scrollTop)},100)}):sessionStorage.removeItem(u)}},D=()=>{i.value&&(n.goodsChecked=n.goodsChecked.filter(t=>!t.disabled)),C(!i.value)},w=t=>{console.log(t),A.setGoodsCheckedCache(t.map(o=>o.goodsId))},X=t=>{x.push(t)},O=j(null),Y=M(()=>n.list.reduce((t,o)=>t+o.stores.reduce((e,a)=>e+a.goods.length,0),0)),Z=M(()=>n.list.reduce((t,o)=>t+o.stores.reduce((e,a)=>e+a.goods.filter(l=>!l.disabled).length,0),0)),W=M(()=>i.value?Y.value===n.goodsChecked.length:Z.value===n.goodsChecked.length&&Z.value!==0),ue=M(()=>n.goodsChecked.reduce((t,o)=>+new $(t).plus(+new $(o.payType===L.STORE_CARD?o.cardPrice:o.price).times(o.number)),0)),he=async(t,o)=>{if(t.stock<o&&+t.goodsTypes!=2)return t.number=t.stock,se(g("order.Insufficient stock"));y(!0);const e=await Pe({goodsId:t.goodsId,number:o});y(!1),e.success&&(t.number=o)},me=()=>{W.value?ge():R()},R=()=>{O.value.toggleAll({checked:!0,skipDisabled:!0})},ge=()=>{O.value.toggleAll({skipDisabled:!0})},fe=async(t,o,e)=>{if(y(!0),!!(await le(o.goodsId)).success){t.goods.splice(e,1),k.getCartCount();for(let l=0;l<n.list.length;l++)n.list[l].stores=n.list[l].stores.filter(v=>v.goods&&v.goods.length>0);n.list=n.list.filter(l=>l.stores&&l.stores.length>0),n.goodsChecked=n.goodsChecked.filter(l=>l.id!==o.id),y(!1)}},pe=async(t,o)=>{y(!0);const e=await Ue({goodsIds:[o.goodsId],type:1,collectType:1});y(!1),e.success},Ce=j(null),ee=j(0),ke=async()=>{const{balanceOf:t}=ae(ce.MCOIN),o=await t();Ce.value=+o,ee.value=+await ae(ce.FMCP).balanceOf()},ye=t=>JSON.parse(JSON.stringify(t)),V=async()=>{y(!0);const t=await je();y(!1),!(!t.success||!t.data)&&(n.originList=t.data||[],E(n.originList),h())},E=t=>{const o=be(ye(t));n.list=o.map(e=>({goodsBoutiqueFlag:e[0].goodsType!==re.SD,stores:ve(e)}))},be=t=>{let o={};for(;t.length;){let e=t.shift();const a=e.goodsType?"true":"false";o[a]=o[a]||[],o[a].push(e)}return Object.keys(o).map(e=>o[e])},ve=t=>t.reduce((o,e)=>{const a=e.id,l=e.status!==1||!+e.stock&&e.goodsTypes!=2||+e.shopStatus==4||+e.shopStatus==0||+e.shopStatus==3;e.disabled=l,e.id=e.goodsId,e.icons=e.icon,l?n.goodsChecked=n.goodsChecked.filter(B=>B.id!==e.id):A.goodsCheckedCache.findIndex(B=>B===e.goodsId)!==-1&&n.goodsChecked.push(e);const v=o.findIndex(B=>B.storeId===e.storeId);return v!==-1?o[v].goods.push(e):o.push({id:a,storeId:e.storeId,storeName:e.storeName,goods:[e]}),o},[]),[xe,F]=oe(!1),Te=(...t)=>{let o=0;return t.forEach(e=>{e===!0&&o++}),o},we=async()=>{let t=n.goodsChecked.some(I=>I.goodsType!==re.SD),o=n.goodsChecked.some(I=>I.payType===L.MC),e=n.goodsChecked.some(I=>I.payType===L.STORE_CARD);const a=Te(t,o,e);if(a>2||a===2&&e)return se(g("cart.tips"));F(!0);let l=[];n.goodsChecked.forEach(I=>{l.push(I.id)});const v=await He(l.join(","));if(F(!1),!v.success)return;k.getCartCount();const B=Ge().getCurrentAccount();X({path:a===2||t||a===1&&o?"/submitOrderBoutiqueCart":"/submitOrderCart",query:{origin:"cart",owner:B}})},Be=async()=>{F(!0);let t=[];n.goodsChecked.forEach(e=>{t.push(e.id)});const o=await le(t.join(","));n.goodsChecked=[],F(!1),o.success&&(V(),k.getCartCount())};return De(()=>n.goodsType,async t=>{if(+t==0)E(n.originList),R();else if(+t==2){const o=n.originList.filter(e=>(e==null?void 0:e.goodsBoutiqueFlag)&&(e==null?void 0:e.payType)!==L.STORE_CARD);await E(o),R()}else if(+t==1){const o=n.originList.filter(e=>!(e!=null&&e.goodsBoutiqueFlag)||(e==null?void 0:e.payType)===L.STORE_CARD);await E(o),R()}},{deep:!0}),Me(()=>{V(),ke(),document.querySelector("#fm-page").addEventListener("scroll",T)}),$e(()=>{document.querySelector("#fm-page").removeEventListener("scroll",T)}),(t,o)=>{const e=_("van-checkbox-group");return m(),p("div",null,[d("div",kt,[b(e,{modelValue:r(n).goodsChecked,"onUpdate:modelValue":o[0]||(o[0]=a=>r(n).goodsChecked=a),onChange:w,ref:(a,l)=>{l.checkboxGroup=a,O.value=a},"checked-color":"#FEA021"},{default:S(()=>[d("div",yt,[d("span",null,f(t.$t("cart.cart"))+"("+f(r(Y))+")",1),d("div",{class:"text-sm font-normal text-primary",onClick:D},f(r(i)?t.$t("common.quteManage"):t.$t("common.manage")),1)]),(m(!0),p(H,null,G(r(n).list,a=>(m(),p("div",{class:"cart-list",key:a.goodsBoutiqueFlag},[b(Je,{goodsBoutiqueFlag:a.goodsBoutiqueFlag},null,8,["goodsBoutiqueFlag"]),(m(!0),p(H,null,G(a.stores,(l,v)=>(m(),J(Ze,{isManage:r(i),key:v,cartInfo:l,onChangeNumber:he,onHandelDel:fe,onHandleRemove:pe,onHandleTo:X},null,8,["isManage","cartInfo"]))),128))]))),128))]),_:1},8,["modelValue"])]),b(ze,{onSuccessAdd:V,"title-text":r(g)("common.recommend_for_you"),class:"p-2.5"},null,8,["title-text"]),bt,b(pt,{voucherBalance:ee.value,isManage:r(i),goodsChecked:r(n).goodsChecked,isCheckAll:r(W),totalAmount:r(ue),loading:r(xe),onTotalCheck:me,onHandleCartBuy:we,onHandleDelMult:Be},null,8,["voucherBalance","isManage","goodsChecked","isCheckAll","totalAmount","loading"])])}}const Tt=q({...vt,setup:xt}),zt=z(Tt,[["__scopeId","data-v-6d83067d"]]);export{zt as default};
