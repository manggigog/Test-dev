import{_ as Ce,y as Fe,F as c,G as a,a2 as A,P as t,I as y,a0 as m,Q as i,X as $e,R as b,w as Oe,x as q,r as M,bd as Re,bc as B,bh as Ue,D as Pe,E as x,K as _,N as C,H as n,O as g,J as xe,a4 as je,$ as qe,B as ye,Y as Xe,Z as Ke,T as N}from"./vendor-D6JO6WHW.js";import{_ as Ge}from"./member-BMygrgIC.js";import{S as He}from"./SkewCard-CGstOBqH.js";import{S as Je}from"./shop-CeqcS6K2.js";import{e as Qe,g as Ie,b as Ye,d as Ze,V as Be,r as We,aS as et}from"./index-Ds2hFbCb.js";import{b as tt}from"./beiExtRewardContract-DtOdv1Av.js";import{q as st,c as ot,d as nt}from"./beiRanking-yYYiCmLG.js";import{b as at}from"./beiConstContract--9OOQL--.js";const it="/Test-dev/static/images/reward-success-BRcmt2IX.png",lt={key:0},ct=m("普通店铺"),rt=Fe({props:{type:null,width:{default:125}},setup(f){return(k,z)=>(a(),c("div",{class:b(["tag-box text-right text-white font-semibold pr-5 pt-1 h-[75px] min-w-[120px]",`bg-${f.type||0}`]),style:$e({width:`${f.width}px`})},[f.type!==void 0?(a(),c("span",lt,[f.type===t(Je).SD?(a(),c(y,{key:0},[ct],64)):(a(),c(y,{key:1},[m(i(k.$t(`common.shop_type_${f.type}`))+"店铺",1)],64))])):A("",!0)],6))}}),ut=Ce(rt,[["__scopeId","data-v-ea5a823e"]]),I=f=>(Xe("data-v-c111f44c"),f=f(),Ke(),f),dt=I(()=>n("img",{src:it,class:"w-full h-auto"},null,-1)),ft=[dt],mt={key:1,class:"relative m-auto text-sm font-normal font-Puhui"},pt={class:"relative z-0 p-3"},ht={class:"flex items-center gap-x-2"},vt={class:"relative"},gt={class:"-mt-5 w-[40px] border-[1px] border-solid border-white flex-center bg-yellow rounded-3xl mx-auto relative z-10"},kt=I(()=>n("img",{src:Ge,class:"w-4 h-4"},null,-1)),_t={class:"text-sm"},bt={class:"flex flex-col gap-1 flex-1"},wt={class:"text-base font-semibold line-clamp-1 name-width"},xt={class:"text-b3 flex items-center"},yt=["src"],It=I(()=>n("span",{class:"mx-1"},"|",-1)),Bt={class:"w-full h-[40px] bg-b5 rounded-full p-0.5 mt-4"},Ct={class:"w-full h-full relative"},Ft={class:"absolute w-full h-full flex items-center justify-center left-0 top-0"},$t=["onClick"],Tt={class:"mt-4 flex items-center bg-b5 p-3 rounded-[10px]"},Vt={class:"flex items-center gap-x-3"},Lt=["onClick"],St={class:"text-b3 mt-1 flex items-center"},Dt={key:0,class:"text-left text-b3 font-normal"},Et={class:"flex items-center"},Mt=I(()=>n("span",{class:"text-success"},"充电：",-1)),Nt=m("预计系数"),At={key:1},zt=m("/电量+"),Ot={key:3},Rt={class:"flex items-center"},Ut=I(()=>n("span",{class:"text-error"},"放电：",-1)),Pt=m("预计系数"),jt={key:1},qt=m("/电量-"),Xt={key:3},Kt={key:1,class:"flex items-center"},Gt=I(()=>n("span",null,"测算结果",-1)),Ht=[Gt],Jt={class:"flex-center-bw mt-4 gap-x-3"},Qt=m("放电"),Yt=Fe({props:{show:{type:Boolean},shopId:null,teleport:null},emits:["close","voteSuccess","handleTo"],setup(f,{emit:k}){const{show:z,shopId:X,teleport:Zt}=f,{t:K}=Oe(),{contributesStore:O}=Qe(),{voteByLp:Te,userVoteDetailView:Ve,voteMonthTimestampView:Le}=tt(),{userTotalLp:Se}=at(),{loadingToggle:R}=We(),F=q(()=>[{id:1,text:K("ranking.points_ticket")},{id:2,text:K("ranking.lp_ticket")}]),r=M(null),De=[.25,.5,.75],o=Re({tab:1,votesInfo:{1:{total:0,sumUsed:0},2:{total:0,sumUsed:0}},estimateInfo:{coefficient:1,coefficientLikeBudget:1,coefficientNotLikeBudget:1,score:0,scoreLikeBudget:0,scoreNotLikeBudget:0,likeDiffer:0,notlikeDiffer:0,tickets:0},totalTimes:5,rewardTimes:5}),[G,Wt]=B(!1),$=q(()=>o==null?void 0:o.votesInfo[o.tab]),U=q(()=>{var s;return Math.max(((s=$.value)==null?void 0:s.total)-($==null?void 0:$.value.sumUsed),0)}),d=M(null),H=M(null),J=M(null),[h,P]=B(!0),[T,Q]=B(!1),[Y,Z]=B(!1),[V,W]=B(!1),ee=s=>{h.value||T.value||(d.value=Math.floor(new ye(U.value).times(s).toNumber()))},L=()=>{R(!1),k("close")},Ee=s=>{+o.tab!=+s&&(d.value=null,o.estimateInfo.tickets=0,o.tab=s)},te=(s,e,u)=>{const p=Math.abs(Number(new ye(s).minus(e)));return p<1e-4?"<0.0001":`${u}${p.toFixed(4)}`},Me=async()=>{const{result:s}=await Le();J.value=+s.thisMonthTime},Ne=async()=>{R(!0);const{success:s,data:e}=await st({shopId:X,month:et()});s&&(R(!1),r.value=e)},se=async()=>{var u,p;if(o.tab===1)return;if(d.value<=0){o.estimateInfo.tickets=0;return}W(!0);const{success:s,data:e}=await ot(X,d.value);s&&(o.estimateInfo=e,o.estimateInfo.tickets=d.value,o.estimateInfo.likeDiffer=Math.abs((e==null?void 0:e.scoreLikeBudget)-((u=r.value)==null?void 0:u.score)),o.estimateInfo.notlikeDiffer=Math.abs((e==null?void 0:e.scoreNotLikeBudget)-((p=r.value)==null?void 0:p.score)),W(!1))},oe=async()=>{var u;if(!Number(d.value)||+d.value<=0)return N({message:"请输入投票数",duration:2e3}),!1;if(+d.value>+U.value)return N({message:"超过可投数量",duration:2e3}),!1;const{success:s,data:e}=await nt((u=r.value)==null?void 0:u.shopId);return s||N({message:"网络异常～",duration:2e3}),s&&!e&&N({message:"当前店铺无法投票请联系店家确认",duration:2e3}),e},Ae=async()=>{var s;await oe()&&(console.log(+o.rewardTimes,+o.totalTimes),k("close"),k("voteSuccess",{direct:200,differ:d.value*((s=r.value)==null?void 0:s.coefficient)},+o.rewardTimes<+o.totalTimes))},ne=async s=>{var u,p,S,v,w,D;if(!await oe())return;Q(!0),((u=o.estimateInfo)==null?void 0:u.tickets)!==d.value&&await se();const{success:e}=await Te((p=r.value)==null?void 0:p.shopId,d.value,s);Q(!1),e&&(k("close"),k("voteSuccess",{direct:s,differ:s===200?(S=o.estimateInfo)==null?void 0:S.likeDiffer:(v=o.estimateInfo)==null?void 0:v.notlikeDiffer,score:s===200?(w=o.estimateInfo)==null?void 0:w.scoreLikeBudget:(D=o.estimateInfo)==null?void 0:D.scoreNotLikeBudget}))},ze=async()=>{P(!0),await Me();const{success:s,result:e}=await Ve(J.value);o.rewardTimes=+(e==null?void 0:e.times),o.votesInfo[1]={total:Math.min(Math.floor(O.contributes/1e3),500),sumUsed:+(e==null?void 0:e.sumTickets)},console.log("rewardTimes :",+(e==null?void 0:e.times)),console.log("contributes :",O.contributes),console.log("sumTickets :",+(e==null?void 0:e.sumTickets)),console.log("votesInfo:",o.votesInfo[1]),s&&P(!1);const u=Math.floor(+await Se());P(!1),o.votesInfo[2]={total:+u,sumUsed:+(e==null?void 0:e.sumLp)}},ae=s=>{(s.key==="Enter"||s.key==="Escape")&&H.value.blur()};return Ue(()=>{window.removeEventListener("keydown",ae)}),Pe(async()=>{window.addEventListener("keydown",ae),Ne(),await O.fetchContributes(),ze()}),(s,e)=>{const u=x("van-icon"),p=x("VanImage"),S=x("VanField"),v=x("VanLoading"),w=x("VanButton"),D=x("VanPopup");return a(),_(D,{show:f.show,"onUpdate:show":e[6]||(e[6]=E=>qe(z)?z.value=E:null),teleport:f.teleport,onClickOverlay:je(L,["stop"]),onClose:L,round:"",class:"bg-transparent position-center",style:$e(t(G)?"width: 100%; max-width: 375px":"min-width: 280px; max-width: 350px; width: 85%")},{default:C(()=>[t(G)?(a(),c("div",{key:0,onClick:L},ft)):(a(),c("div",mt,[n("div",{class:"text-right text-b6 ml-auto text-lg font-bold h-6 flex items-start justify-end",onClick:L},[g(u,{name:"cross"})]),g(He,{width:"210",right:"26"},{default:C(()=>{var E,ie,le,ce,re,ue,de,fe,me,pe,he,ve,ge,ke,_e,be,we;return[g(ut,{class:"absolute right-1.5 top-1.5 -z-20",type:(E=r.value)==null?void 0:E.type},null,8,["type"]),n("div",pt,[n("div",ht,[n("div",vt,[g(p,{round:"",src:(((ie=r.value)==null?void 0:ie.logo)||"").split(",")[0],errorIcon:t(Ie)("images/ranking/noPosition.png"),fit:"cover",width:"46px",height:"46px"},null,8,["src","errorIcon"]),n("div",gt,[kt,n("span",_t,"V"+i((le=r.value)==null?void 0:le.memberLevel),1)])]),n("div",bt,[n("div",wt,i((ce=r.value)==null?void 0:ce.storeName),1),n("div",xt,[n("span",null,i(t(Ye)((re=r.value)==null?void 0:re.shopAddress,"**",0,4)),1),(ue=r.value)!=null&&ue.authorizeAddress?(a(),c("img",{key:0,src:t(Ie)("images/ranking/auth.svg"),class:"w-4 h-4"},null,8,yt)):A("",!0),It,n("span",null,i(s.$t("ranking.battery"))+i(((de=r.value)==null?void 0:de.score)||0),1),n("div",{class:"text-newOrigin pl-1",onClick:e[0]||(e[0]=l=>t(Z)(!t(Y)))},i(s.$t("user.feedbackDetail")),1)])])]),n("div",{class:b(["bg-[#FF88121F] text-newOrigin rounded px-2 flex items-center justify-between overflow-hidden transition-all duration-300",t(Y)?"h-[36px] border border-newOrigin mt-1":"h-0 mt-0"]),onClick:e[1]||(e[1]=l=>t(Z)(!1))},[n("div",null,i(+((fe=r.value)==null?void 0:fe.pointTicket))+i(s.$t("ranking.points_ticket"))+" x "+i(t(Ze)((me=r.value)==null?void 0:me.coefficient))+i(s.$t("ranking.coefficient"))+" = "+i((pe=r.value)==null?void 0:pe.score)+i(s.$t("ranking.battery")),1),n("div",null,[g(u,{name:"cross"})])],2),n("div",Bt,[n("div",Ct,[n("div",{class:b(["absolute w-[50%] h-full bg-b1 rounded-full left-0 transition-all duration-300",`w-[${100/t(F).length}%] left-${t(F).findIndex(l=>l.id===t(o).tab)||0}/${t(F).length}`])},null,2),n("div",Ft,[(a(!0),c(y,null,xe(t(F),l=>(a(),c("div",{class:"w-[50%] h-full flex items-center justify-center overflow-hidden",onClick:j=>Ee(l.id),key:l.id},[n("span",{class:b(["text-sm text-center line-clamp-1 transition-all duration-300",[t(o).tab===l.id?"text-b6 font-semibold":"text-b3 font-normal"]])},i(l.text),3)],8,$t))),128))])])]),n("div",Tt,[g(S,{type:"digit",modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=l=>d.value=l),placeholder:"0",ref:(l,j)=>{j.amountInputRef=l,H.value=l}},null,8,["modelValue"]),n("div",Vt,[t(o).tab===1?(a(),c(y,{key:0},xe(De,l=>n("div",{class:"shrink-0 w-fit text-newOrigin px-0.5",key:l,onClick:j=>ee(l)},i(l*100)+"% ",9,Lt)),64)):A("",!0),n("div",{class:"shrink-0 w-fit text-newOrigin",onClick:e[3]||(e[3]=l=>ee(1))}," MAX ")])]),n("div",St,[+t(o).tab==2&&((he=t(o).estimateInfo)==null?void 0:he.tickets)>0?(a(),c("div",Dt,[n("div",Et,[Mt,Nt,t(V)?(a(),_(v,{key:0,size:"12"})):(a(),c("span",At,i(te((ve=t(o).estimateInfo)==null?void 0:ve.coefficientLikeBudget,(ge=t(o).estimateInfo)==null?void 0:ge.coefficient,"+")),1)),zt,t(V)?(a(),_(v,{key:2,size:"12"})):(a(),c("span",Ot,i((ke=t(o).estimateInfo)==null?void 0:ke.likeDiffer),1))]),n("div",Rt,[Ut,Pt,t(V)?(a(),_(v,{key:0,size:"12"})):(a(),c("span",jt,i(te((_e=t(o).estimateInfo)==null?void 0:_e.coefficientNotLikeBudget,(be=t(o).estimateInfo)==null?void 0:be.coefficient,"-")),1)),qt,t(V)?(a(),_(v,{key:2,size:"12"})):(a(),c("span",Xt,i((we=t(o).estimateInfo)==null?void 0:we.notlikeDiffer),1))])])):(a(),c("div",Kt,[m(i(s.$t("ranking.remain_ticket")),1),t(h)?(a(),_(v,{key:0,size:"10"})):(a(),c(y,{key:1},[m(i(t(U)),1)],64)),m(i(t(o).tab===1?s.$t("ranking.points_ticket"):s.$t("ranking.lp_ticket")),1)])),t(o).tab===2&&d.value>0?(a(),c("div",{key:2,class:"pl-1.5 ml-auto text-newOrigin",onClick:se},Ht)):A("",!0)]),n("div",Jt,[t(o).tab===1?(a(),_(w,{key:0,class:b(["btn-yellow w-full h-[46px] rounded-full border-none text-base font-semibold",{"opacity-60":t(h)}]),onClick:Ae,disabled:t(h),loading:t(T)},{default:C(()=>[m(i(s.$t("ranking.power")),1)]),_:1},8,["class","disabled","loading"])):(a(),c(y,{key:1},[g(w,{class:b(["bg-error text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold",{"opacity-60":t(h)}]),icon:t(Be)("discharge.svg"),disabled:t(h),loading:t(T),onClick:e[4]||(e[4]=l=>ne(400))},{default:C(()=>[Qt]),_:1},8,["class","icon","disabled","loading"]),g(w,{class:b(["bg-success text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold",{"opacity-60":t(h)}]),icon:t(Be)("charge.svg"),disabled:t(h),loading:t(T),onClick:e[5]||(e[5]=l=>ne(200))},{default:C(()=>[m(i(s.$t("ranking.power")),1)]),_:1},8,["class","icon","disabled","loading"])],64))])])]}),_:1})]))]),_:1},8,["show","teleport","onClickOverlay","style"])}}}),cs=Ce(Yt,[["__scopeId","data-v-c111f44c"]]);export{cs as S,ut as a};
