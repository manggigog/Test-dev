import{_ as $e,z as ve,q as Ee,y as rt,F as ee,Z as K,H as u,$ as M,I as p,G as h,O as l,a4 as x,Q as d,J as te,P as $,U as C,x as nt,bB as F,r as A,o as lt,bm as ut,E as ct,K as he,V as it,a0 as pt,T as Z,B as R,a9 as dt}from"./vendor-Dr_RpJ_Y.js";import{_ as yt}from"./AddressInfo-CeDTkKku.js";import{_ as ke}from"./EmptyTipsPop-DC2OBzZY.js";import{O as mt}from"./OrderGoodsCartBox-C_cmJTld.js";import{y as ft,V as ht,i as vt,l as bt,e as N,g as X,w as gt,bQ as Tt,a5 as wt,bL as At,j as Be,c as Ct,G as _t}from"./index-CU2nzZe6.js";import{P as c}from"./order-H59PKTFP.js";import{c as St,q as kt}from"./address-DDWZXZdL.js";import{p as xe,H as Bt,r as xt,u as Pt}from"./order-D4JYoGRo.js";import{u as $t}from"./useSelectAddress-CgNt0r_o.js";import{P as b}from"./flashSale-DDyqLyYN.js";import{_ as Pe}from"./SubmitApprove-pJjFZChP.js";import{p as Et}from"./piggyBank-ttfOTM2O.js";import"./mall-C69gPh5W.js";import"./OrderGoods-GRYu2N4C.js";import"./MCOIN-BOqZVkND.js";import"./BoutiqueLable-DDlxeK08.js";import"./shop-CeqcS6K2.js";import"./ShopMaskTips-ClYuWX9C.js";import"./useShipTemplate-DL0IJVAv.js";import"./enums-DlE-aiss.js";const Lt={class:"py-8 text-base text-center text-black"},Rt={key:0,class:"flex justify-center"},Nt={key:1,class:"flex justify-center"},Gt=ve({props:{show:{type:Boolean},lableType:null,card:null,cardBuy:{type:Boolean},paySource:null,payToken:null},emits:["close"],setup(_,{emit:z}){const D=_,W=Ee(),V=rt(()=>{var y,P,E;return(P=(y=D.card)==null?void 0:y.stores)!=null&&P.storeName?`「${(E=D.card)==null?void 0:E.stores.storeName}」`:""}),le=y=>{y?W.push(y):W.replace("/")},G=()=>{var y;le(`/storedValue-recharge?cardId=${(y=D.card)==null?void 0:y.id}`),z("close")},ae=()=>{z("close","change")};return(y,P)=>{const E=ee("van-button");return u(),K(ft,{width:"90%",show:_.show,name:y.$t("common.tip"),onClose:P[0]||(P[0]=()=>{z("close")})},{default:M(()=>{var se,oe;return[p("div",Lt,[Number(_.lableType)===1&&+_.paySource==+l(c).PIGGY_BANK?(u(),h(te,{key:0},[x(d(y.$t("piggy.recharge_tip",{num:`${l(V)} ${(se=_.card)==null?void 0:se.symbol}`})),1)],64)):(u(),h(te,{key:1},[x(d(y.$t("piggy.change_the_method",{num:_.payToken===1?l(V)+" Mcoin":`${l(V)} ${(oe=_.card)==null?void 0:oe.symbol}`})),1)],64))]),Number(_.lableType)===1&&+_.paySource==+l(c).PIGGY_BANK?(u(),h("div",Rt,[$(E,{class:"w-1/2 mx-2.5 btn-orange btn-shadow text-white font-semibold",onClick:G},{default:M(()=>[x(d(y.$t("piggy.goRechart")),1)]),_:1})])):(u(),h("div",Nt,[_.payToken!==1?(u(),K(E,{key:0,class:"plain-btn w-1/2 mx-2.5 text-[#FEA021] font-semibold",onClick:G},{default:M(()=>[x(d(y.$t("piggy.goRechart")),1)]),_:1})):C("",!0),$(E,{class:"w-1/2 mx-2.5 btn-orange btn-shadow text-white font-semibold",onClick:ae},{default:M(()=>[x(d(_.paySource===1?y.$t("piggy.Switch_piggy_payment"):y.$t("piggy.Switch_mc_payment")),1)]),_:1})]))]}),_:1},8,["show","name"])}}}),Ot=$e(Gt,[["__scopeId","data-v-1f3cb9b6"]]),It={key:0,class:"p-2.5"},Kt={class:"text-xl font-semibold"},Mt={class:"bg-white py-2.5 mx-2.5 flex items-center justify-between gap-2 border-b border-[#f5f5f5] border-solid"},Dt={class:"flex-1"},Wt=["onClick"],Vt={class:"bg-white mt-2.5 rounded-xl p-2.5"},Yt={class:"flex items-baseline justify-between mt-1"},qt={class:"opacity-60"},jt={class:"text-right"},Ft={class:"text-base font-semibold"},zt={key:0},Jt={key:1},Ht={key:0},Ut={class:"opacity-60"},Qt={class:"bg-white mt-2.5 rounded-xl p-2.5"},Zt={class:"flex items-baseline justify-between mt-1"},Xt={class:"opacity-60 break-keep"},ea={class:"text-right"},ta={class:"text-base font-semibold text-primary"},aa={key:0},sa={key:0},oa={key:0},ra={class:"opacity-60"},na={class:"flex flex-col items-center my-[50px] relative"},la={class:"p-2.5 pb-[150px]"},ua={class:"relative text-center mb-2.5"},ca=ve({name:"SubmitOrderCart"});function ia(_){const{getUserDhKey:z,encryptAddressKey:D,formatAddressData:W,generateKey:V,decryptAddressKey:le}=ht(),{t:G}=nt(),[ae,y]=F(!1),{loadingToggle:P}=gt(),{getAddress:E,setAddress:se}=$t(),{submit:oe}=vt(),Le=bt(1),{tradeContributeSelfRate:Re}=Ct(),[Ne,ue]=F(!1),J=Ee(),[Ge,be]=F(!1),[ce,ie]=F(!1),[Oe,Ie]=F(!0),[pe,g]=F(!1),de=A([]),v=A(),S=A([]),Ke=A(0),ye=A({remark:""}),Me=A(0),ge=async()=>{if(E()){v.value=E(),se(null);return}const a=J.currentRoute.value.path,e=await kt();if(!e.success)return;de.value=e.data;const r=de.value.find(s=>s.isDefault===1)||de.value[0],o=await V("user",a);if(r!=null&&r.encryptFlag&&o){v.value=le(r,o);return}v.value=r},De=async()=>{const a=await(await Le).allowance(X.order);Ke.value=a.result},L=lt(),We=async()=>{var e;const a=await Pt({type:((e=L==null?void 0:L.query)==null?void 0:e.type)??2});if(!a.success){setTimeout(()=>{J.back()},1500);return}S.value=(a.data.ordersInfos||[]).map(r=>{let o=1;return r.orderGoods.forEach(s=>{+s.payType==3&&(o=2),s.paySource=c.WALLET}),{...r,goods:r.orderGoods,totalAmount:0,totalCardAmount:0,integral:0,remark:"",payType:o,paySource:c.WALLET,storeJudge:!1}}),Me.value=a.data.totalAmount||0},Ve=async(a,e,r)=>{a.number=e,r.storeJudge=!1,P(!0);const o=await Tt({goodsId:a.goodsId,number:e});await Ce(),P(!1),o.success},Ye=async a=>{ye.value=a,ie(!0)};let O=A(!1);const i=A({payType:2,paySource:c.WALLET,id:"",payToken:1}),qe=async()=>{let a=0;for(let e of S.value){if(i.value=e,!e.storeJudge&&e.fmStoredCard&&e.fmStoredCard.contract&&+T(e).totalCardAmount>0){const o=+await Be(e.fmStoredCard.contract).balanceOf(),s=+U.value[e.fmStoredCard.id]||0;e.walletBalance=+o,e.piggyBalance=+s,e.symbol=e.fmStoredCard.symbol,i.value=e,i.value.id=e.fmStoredCard.id;let f=0,t=o;if(e.goods.forEach(n=>{let m=+n.cardPrice*n.number;(n.payType===b.STORE_CARD||e.payType===b.STORE_CARD&&n.payType!==b.MC)&&(t>=m?t=+R(t).minus(m):f=+R(f).plus(m))}),T(e).totalCardAmount<=e.walletBalance||e.paySource===c.PIGGY_BANK&&f<=e.piggyBalance){O.value=!1;let n=o;e.storeJudge=!0,e.paySource=c.WALLET,T(e).totalCardAmount<=e.walletBalance?e.goods.forEach(m=>{(m.payType===b.STORE_CARD||e.payType===b.STORE_CARD&&m.payType!==b.MC)&&(m.paySource=c.WALLET)}):e.goods.forEach(m=>{let k=+m.cardPrice*m.number;(m.payType===b.STORE_CARD||e.payType===b.STORE_CARD&&m.payType!==b.MC)&&(n>=k?(m.paySource=c.WALLET,n=dt.subtract(n,k),n=+R(n).minus(k)):m.paySource=c.PIGGY_BANK)})}else return f<=e.piggyBalance?(i.value.payToken=2,O.value=!0,g(!1),y(!0)):(i.value.payToken=2,i.value.paySource=c.PIGGY_BANK,e.payToken=2,e.paySource=c.PIGGY_BANK,O.value=!0,g(!1),y(!0))}let r=q.value;if(e.goods.forEach(o=>{let s=+o.price*o.number;(+o.payType===b.MC||+o.payType!==b.STORE_CARD&&+e.payType!==b.STORE_CARD)&&(r>=s?r=+R(r).minus(s):a=+R(a).plus(s))}),T(e).totalAmount<=+q.value||e.paySource===c.PIGGY_BANK&&a<=+U.value[0]){O.value=!1;let o=+q.value;e.goods.forEach(s=>{if(s.payType===b.MC||e.payType===b.MC&&s.payType!==b.STORE_CARD){let f=+s.price*s.number;o>=+f?(s.paySource=c.WALLET,o=+R(o).minus(f),q.value=+R(q.value).minus(f)):s.paySource=c.PIGGY_BANK}})}else return a<=(+U.value[0]||0)?(i.value.payToken=1,i.value=e,O.value=!0,g(!1),y(!0)):(O.value=!0,g(!1),Z(G("order.insufficient balance")))}},je=async a=>{y(!1),a==="change"&&(+i.value.payType==2&&i.value.paySource===c.WALLET?i.value.paySource=c.PIGGY_BANK:+i.value.payType==2&&i.value.paySource===c.PIGGY_BANK?(i.value.payType=1,i.value.paySource=i.value.payToken===1?c.WALLET:i.value.paySource===c.PIGGY_BANK?c.WALLET:c.PIGGY_BANK):i.value.paySource=c.PIGGY_BANK),g(!1)},Fe=A(null),H=A(0),ze=async()=>{var f,t,n,m;if(!v.value)return Z(G("order.setAddress"));if((f=v.value)!=null&&f.encryptFlag&&!((t=v.value)!=null&&t.success))return Z(G("order.reconfirm the information"));if(!wt(v.value.telNumber))return Z(G("address.number was identified"));const a=J.currentRoute.value.path;if(g(!0),await Te(),await we(),await qe(),O.value)return;g(!0);let e=[],r=[];if(S.value.forEach(k=>{k.goods.forEach(w=>{if(w.number>w.stock&&+w.goodsTypes!=2){let j=w.goodsName;w.goodsName.length>10&&(j=w.goodsName.slice(0,10)+"..."),r.push(j)}const re=w.payType===3?k.payType===1?1:2:w.payType===10?1:w.payType||1;e.push({goodsId:w.goodsId,num:w.number,payType:re,paySource:w.paySource})})}),r.length>0)return g(!1),Z(r.join()+"  "+G("order.Insufficient stock"));const o=await V("user",a);let s;o&&!v.value.encryptFlag&&(s=D(v.value,o),await St({...s,isDefault:v.value.isDefault?1:0}));try{let k=[];if(S.value)for(let fe=0;fe<S.value.length;fe++){const I=S.value[fe];let B={};if(I.encryption){const Se=await z(I.stores.id,(n=I.encryption)==null?void 0:n.publicKey);Se?(B=W(B,{...v.value,postscript:I.remark},1),B=D(B,Se),B.submitHash=B.hash):B=W(B,{...v.value,postscript:I.remark},0)}else B=W(B,{...v.value,postscript:I.remark},0);k.push({storeId:I.stores.id,...B})}const w={type:((m=L==null?void 0:L.query)==null?void 0:m.type)??2,addressId:v.value.id,postscripts:k,detailList:e,voucherAmount:0},re=await xe(w);if(!re.success){g(!1);return}const{allOrderId:j,merchants:et,discounts:tt,amounts:at,sources:st,buyer:ot}=re.data,Q=await oe(j,et,tt,at,st,ot);if(!Q.success){Bt({allOrderId:j}),g(!1);return}if(await xt({allOrderId:j,hash:Q.result.hash}),Fe.value=Q.result.hash,!Q.result.hash){g(!1);return}let ne;const _e=async()=>{if(H.value>=5){g(!1),be(!0),H.value=0;return}if(ne=await At(Q.result.hash),(ne==null?void 0:ne.status)===1){g(!1),ue(!0),H.value=0,Je();return}setTimeout(async()=>{H.value++,_e()},5e3)};_e()}catch{g(!1),H.value=0}},Je=()=>{setTimeout(()=>{ue(!1),J.replace({path:"buyerOrderList",query:{active:1}})},1500)},me=A(1),He=async()=>{me.value=await Re()},T=a=>{let e=0,r=0,o=0;return a.orderGoods.forEach(s=>{+a.payType==1&&+s.payType==3||+s.payType!=2&&+s.payType!=3?(e+=s.price*s.number,r+=s.price*s.number*(s.discountRatio/100)):o+=s.cardPrice*s.number}),{totalAmount:N(e),integral:N(r),totalCardAmount:N(o)}},Y=()=>{let a=0,e=0,r=0;return S.value.forEach(o=>{o.orderGoods.forEach(s=>{+o.payType==1&&+s.payType==3||+s.payType!=2&&+s.payType!=3?(a+=s.price*s.number,e+=s.price*s.number*(s.discountRatio/100)):r+=s.cardPrice*s.number})}),{totalAmount:a,integral:e,totalCardAmount:r}},q=A(null),Te=async()=>{const{balanceOf:a}=Be(X.MCOIN),e=await a();q.value=+e},U=A({}),{userMerchantCashs:Ue,userTotalAmount:Qe}=Et(),we=async()=>{const{success:a,result:e}=await Ue();if(!a)return;let r=0;const o=+await Qe(),s=e.amounts.map(t=>_t(t));e.cashIds.map(t=>+t).forEach((t,n)=>{U.value[t]=s[n],t!==0&&(r=+R(r).plus(s[n]||0).toString())}),U.value[0]=+R(o).minus(r)},Ae=A([]),Ce=async()=>{var o,s;let a=[];S.value.forEach(f=>{f.goods.forEach(t=>{const n=t.payType===3?f.payType===1?1:2:t.payType===10?1:t.payType||1;a.push({goodsId:t.goodsId,num:t.number,payType:n,paySource:t.paySource})})});const e={type:((o=L==null?void 0:L.query)==null?void 0:o.type)??2,addressId:(s=v.value)==null?void 0:s.id,detailList:a,genOrder:!1},r=await xe(e);r.success&&(Ae.value=r.data.goodsList||[])},Ze=async()=>{P(!0),We(),Te(),He(),we(),await De(),await ge(),await Ce(),P(!1),Ie(!1)},Xe=a=>{J.push(a)};return ut(()=>{ge()}),ct(()=>{Ze()}),(a,e)=>{const r=ee("van-icon"),o=ee("VanButton"),s=ee("van-field"),f=ee("van-popup");return l(Oe)?C("",!0):(u(),h("div",It,[p("header",Kt,d(a.$t("order.submitOrder")),1),$(yt,{class:"mt-2.5",defaultAddress:v.value,onClick:e[0]||(e[0]=t=>Xe("/userAddress"))},null,8,["defaultAddress"]),(u(!0),h(te,null,he(S.value,(t,n)=>(u(),h("div",{key:n,class:"bg-white rounded-xl"},[$(mt,{orderInfo:t,payType:t.payType,expressGoodsList:Ae.value,onChangeNumber:(m,k)=>Ve(m,k,t)},null,8,["orderInfo","payType","expressGoodsList","onChangeNumber"]),p("div",Mt,[p("div",Dt,d(a.$t("order.remark")),1),p("div",{class:"flex-1 text-right line-clamp-1 opacity-60 whitespace-nowrap",onClick:m=>Ye(t)},[x(d(t.remark?t.remark:a.$t("order.noRemark"))+" ",1),$(r,{name:"arrow"})],8,Wt)]),p("div",Vt,[p("div",Yt,[p("div",qt,d(a.$t("order.total")),1),p("div",jt,[p("div",Ft,[T(t).totalAmount>0?(u(),h("span",zt,d(l(N)(T(t).totalAmount||0))+"Mcoin",1)):C("",!0),T(t).totalCardAmount>0?(u(),h("span",Jt,[T(t).totalAmount>0?(u(),h("span",Ht,"+")):C("",!0),x(" "+d(l(N)(T(t).totalCardAmount||0))+" "+d(t.fmStoredCard&&t.fmStoredCard.symbol),1)])):C("",!0)]),p("div",Ut,d(a.$t("order.getContribution",{num:l(N)(T(t).integral*me.value||0)})),1)])])])]))),128)),p("div",Qt,[p("div",null,d(a.$t("order.priceDetail")),1),p("div",Zt,[p("div",Xt,d(a.$t("order.total")),1),p("div",ea,[p("div",ta,[Y().totalAmount>0?(u(),h("span",aa,d(l(N)(Y().totalAmount||0))+"Mcoin",1)):C("",!0),(u(!0),h(te,null,he(S.value,(t,n)=>(u(),h("span",{key:n},[T(t).totalCardAmount>0?(u(),h("span",sa,[n===0&&Y().totalAmount>0||n!==0?(u(),h("span",oa,"+ ")):C("",!0),x(d(l(N)(T(t).totalCardAmount||0))+" "+d(t.fmStoredCard&&t.fmStoredCard.symbol),1)])):C("",!0)]))),128))]),p("div",ra,d(a.$t("order.getContribution",{num:l(N)(Y().integral*me.value||0)})),1)])])]),p("div",na,[Y().totalAmount>0?(u(),K(Pe,{key:0,class:"approve-btn btn-orange btn-shadow w-[150px] h-[40px] text-white z-10",contract:l(X).order,token:l(X).MCOIN,symbol:"Mcoin",approveAmount:Y().totalAmount,loading:l(pe)},null,8,["contract","token","approveAmount","loading"])):C("",!0),(u(!0),h(te,null,he(S.value,(t,n)=>(u(),h("div",{class:"approve-btn btn-orange btn-shadow w-[150px] h-[40px] text-white",key:n},[t.fmStoredCard&&t.fmStoredCard.contract&&T(t).totalCardAmount>0?(u(),K(Pe,{class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",key:n,style:it({"z-index":10+n}),contract:l(X).order,token:t.fmStoredCard&&t.fmStoredCard.contract,symbol:t.fmStoredCard&&t.fmStoredCard.symbol,approveAmount:T(t).totalCardAmount,loading:l(pe)},null,8,["style","contract","token","symbol","approveAmount","loading"])):C("",!0)]))),128)),$(o,{class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",loading:l(pe),onClick:ze},{default:M(()=>[x(d(a.$t("common.pay")),1)]),_:1},8,["loading"])]),$(f,{show:l(ce),"onUpdate:show":e[4]||(e[4]=t=>pt(ce)?ce.value=t:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:M(()=>[p("div",la,[p("div",ua,[x(d(a.$t("order.submitOrder"))+" ",1),p("div",{class:"absolute right-0 bottom-[-2px] text-lg",onClick:e[1]||(e[1]=t=>l(ie)(!1))},[$(r,{name:"cross"})])]),$(s,{modelValue:ye.value.remark,"onUpdate:modelValue":e[2]||(e[2]=t=>ye.value.remark=t),rows:"5",autosize:"",type:"textarea",maxlength:"200",placeholder:a.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"])]),$(o,{class:"mb-[50px] inline-block btn-orange btn-shadow w-[150px] h-[40px] text-white",onClick:e[3]||(e[3]=t=>l(ie)(!1))},{default:M(()=>[x(d(a.$t("common.confirm")),1)]),_:1})]),_:1},8,["show"]),l(Ne)?(u(),K(ke,{key:0,onClose:e[5]||(e[5]=t=>l(ue)(!1)),text:a.$t("common.pay success")},null,8,["text"])):C("",!0),l(Ge)?(u(),K(ke,{key:1,isError:!0,onClose:e[6]||(e[6]=t=>l(be)(!1)),text:a.$t("order.fail")},null,8,["text"])):C("",!0),l(ae)?(u(),K(Ot,{key:2,card:i.value,lableType:i.value.payType,paySource:i.value.paySource,payToken:i.value.payToken,cardBuy:!0,show:l(ae),onClose:je},null,8,["card","lableType","paySource","payToken","show"])):C("",!0)]))}}const pa=ve({...ca,setup:ia}),La=$e(pa,[["__scopeId","data-v-6c81dd10"]]);export{La as default};
