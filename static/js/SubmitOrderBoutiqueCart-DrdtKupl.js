import{_ as ke}from"./MCOIN-BcbOHmhy.js";import{_ as pt}from"./FMCP-CFalj3L2.js";import{y as Te,_ as mt,x as te,B as d,r as P,be as Qt,z as Je,D as ft,E as q,F as R,G as h,O as m,N as y,K as ae,a2 as C,P as t,H as s,Q as r,a4 as Zt,a0 as oe,Y as ht,Z as yt,I as De,w as Xt,bw as fe,l as eo,a1 as to,bh as oo,J as ut,R as so,$ as ao,T as le}from"./vendor-BUT0HZ5j.js";import{_ as no}from"./AddressInfo-CgO24TCv.js";import{_ as it}from"./EmptyTipsPop-_FH8A6A8.js";import{_ as lo}from"./OrderGoodsCartBox-DKawsLBg.js";import{P as ro}from"./PaySwitchPop-D7egWITX.js";import{_ as uo}from"./point-arrow-BVnEJLj4.js";import{_ as vt}from"./USDT-BFPkoPAz.js";import{e as gt,d as S,_ as io,R as co,o as po,i as mo,f as ct,q as Y,r as fo,a1 as ho,bu as yo,s as Ye,B as vo}from"./index-BvL8wS8a.js";import{P as xe}from"./flashSale-DDyqLyYN.js";import{u as go}from"./usePointRelase-Eosk-IA3.js";import{P as $}from"./order-H59PKTFP.js";import{_ as bo}from"./DividingLine-9-ITJMKz.js";import{_ as Qe}from"./SubmitApprove-xYwuBpoC.js";import{B as _o}from"./BackIcon-biFt6cm7.js";import{c as wo,q as Ao}from"./address-DRxoJInl.js";import{m as dt,t as $o,u as So,r as xo}from"./order-5h45IqlB.js";import{u as ko}from"./useSelectAddress-CgNt0r_o.js";import{c as To}from"./cart-9He7F13A.js";import{G as re}from"./goods-BVwS8oFG.js";import{p as Po}from"./piggyBank-DmnJvorA.js";import{S as Se}from"./shop-CeqcS6K2.js";import{u as Co}from"./useKeyboard-BQnXF61Y.js";import"./mall-BNNzTN-n.js";import"./OrderGoods-DJU_6rWX.js";import"./BoutiqueLable-r45nG6V6.js";import"./ShopMaskTips-dKZ6_BUi.js";import"./useShipTemplate-SAWfRcmZ.js";import"./enums-DlE-aiss.js";const Ro=Te({props:{num:{type:Number,default:0},amount:{type:Number,default:0},fee:{type:Number,default:0}},setup(i){return(B,U)=>null}}),Bo="/Test-dev/static/images/pay_points-DuQgheHY.png",No="/Test-dev/static/images/pay_wallet-CtEhTDcc.png",Eo="/Test-dev/static/images/pay_piggy-1jarwiJl.png",Pe=i=>(ht("data-v-3da12dec"),i=i(),yt(),i),Do={class:"pay-switch rounded-xl overflow-hidden"},Lo=Pe(()=>s("img",{src:Bo,class:"w-6 h-6 mx-3"},null,-1)),Oo={class:"custom-title flex items-center justify-start gap-2"},Fo=["onClick"],Io=Pe(()=>s("img",{src:uo,class:"w-4 h-4 mx-3"},null,-1)),Wo={class:"text-xs text-b3"},Vo=Pe(()=>s("img",{src:No,class:"w-6 h-6 mx-3"},null,-1)),Go={class:"custom-title"},Uo={class:"text-xs text-b3"},Mo=Pe(()=>s("img",{src:Eo,class:"w-6 h-6 mx-3"},null,-1)),Ho={class:"custom-title"},jo={class:"text-xs text-b3"},qo=Pe(()=>s("img",{src:vt,class:"w-6 h-6 mx-3"},null,-1)),Ko={class:"custom-title"},zo={class:"text-xs text-b3"},Jo={class:"text-sm text-b2 my-4 leading-5"},Yo={class:"flex justify-center gap-x-2"},Qo=Te({props:{checked:{default:"3"},clickable:{type:Boolean,default:!0},payType:{default:1},paySymbol:{default:"MCOIN"},walletBalance:null,pointBalance:null,piggyBalance:null,usdtBalance:null,boutique:{type:Boolean,default:!1},payAmount:{default:0},usdtRate:null,voucherAmount:null},emits:["onChange","getPointBalance"],setup(i,{expose:B,emit:U}){const b=i,{contributesStore:x}=gt(),he=te(()=>+d(b.pointBalance).times(.9)),Le=te(()=>[{source:$.WITHDRAW_POINTS,amount:he.value},{source:$.WALLET,amount:b.walletBalance},{source:$.PIGGY_BANK,amount:b.piggyBalance},{source:$.USDT_WALLET,amount:b.usdtBalance*b.usdtRate}]),{handleNaturePointsToast:ye}=go(),N=P(b.checked),[Re,K]=Qt(!1),ue=u=>{N.value=u},ve=()=>{let u=[...Le.value];!b.boutique&&u[0].source===$.WITHDRAW_POINTS&&u.shift();const f=u.find(V=>V.source===$.WITHDRAW_POINTS?+V.amount>=+b.payAmount-(+b.voucherAmount||0):+V.amount>=+b.payAmount);f&&f.source!==+N.value?U("onChange",f.source):!f&&+u[0].source&&U("onChange",u[0].source)},Oe=()=>{var u,f,V,H;(u=x.releaseData)!=null&&u.remainTotal&&+((f=x.releaseData)==null?void 0:f.remainTotal)>0&&(!((V=x.releaseData)!=null&&V.nextSubmitDate)||new Date().getTime()>=+((H=x.releaseData)==null?void 0:H.nextSubmitDate))?ye(Be):K(!0)},Be=()=>{let u=0;const f=async()=>{U("getPointBalance"),x.fetchContributes(),await Promise.all([x.fetchUserRelase(),x.getNaturalReleaseTimes()]),u++,u<3&&setTimeout(f,3e3)};f()},Fe=()=>{K(!1),ye(Be)};return Je(()=>b.checked,u=>{N.value=u},{immediate:!0,deep:!0}),Je(()=>b.boutique,u=>{u&&(x.fetchContributes(),x.fetchUserRelase(),x.getNaturalReleaseTimes())},{immediate:!0,deep:!0}),Je(()=>b.voucherAmount,u=>{u&&ve()},{immediate:!0,deep:!0}),ft(()=>{ve()}),B({setpayValue:ue}),(u,f)=>{const V=q("van-radio"),H=q("van-cell"),se=q("van-cell-group"),Ie=q("van-radio-group"),ge=q("VanButton");return h(),R("div",Do,[m(Ie,{modelValue:N.value,"onUpdate:modelValue":f[4]||(f[4]=ne=>N.value=ne)},{default:y(()=>[m(se,null,{default:y(()=>[i.payType===t(xe).MC&&i.boutique?(h(),ae(H,{key:0,center:"",title:u.$t("order.payPoints"),clickable:"",onClick:f[0]||(f[0]=()=>U("onChange",4))},{icon:y(()=>[Lo]),title:y(()=>[s("div",Oo,[s("span",null,r(u.$t("order.payPoints")),1),t(S)(t(x).freeRelease)>0?(h(),R("div",{key:0,class:"text-xs font-normal text-newOrigin flex-center",onClick:Zt(Oe,["stop"])},[oe(r(u.$t("integral.keshifang",{num:t(S)(t(x).freeRelease)})),1),Io],8,Fo)):C("",!0)]),s("div",Wo,r(u.$t("huabei.nowCanUse"))+" "+r(t(S)(i.pointBalance))+"/"+r(u.$t("integral.order_can_use"))+r(t(S)(t(he))),1)]),"right-icon":y(()=>[m(V,{name:"4","checked-color":"#FEA021"})]),_:1},8,["title"])):C("",!0),m(H,{center:"",title:u.$t("order.payWallet"),clickable:"",onClick:f[1]||(f[1]=()=>U("onChange",1))},{icon:y(()=>[Vo]),title:y(()=>[s("div",Go,r(u.$t("order.payWallet")),1),s("div",Uo,r(u.$t("huabei.nowCanUse"))+" "+r(t(S)(i.walletBalance)),1)]),"right-icon":y(()=>[m(V,{name:"1","checked-color":"#FEA021"})]),_:1},8,["title"]),m(H,{center:"",title:u.$t("order.payPiggy"),clickable:"",onClick:f[2]||(f[2]=()=>U("onChange",2))},{icon:y(()=>[Mo]),title:y(()=>[s("div",Ho,r(u.$t("order.payPiggy")),1),s("div",jo,r(u.$t("huabei.nowCanUse"))+r(t(S)(i.piggyBalance)),1)]),"right-icon":y(()=>[m(V,{name:"2","checked-color":"#FEA021"})]),_:1},8,["title"]),i.payType!==t(xe).STORE_CARD?(h(),ae(H,{key:1,center:"",title:u.$t("order.USDT payment"),clickable:"",onClick:f[3]||(f[3]=()=>U("onChange",5))},{icon:y(()=>[qo]),title:y(()=>[s("div",Ko,r(u.$t("order.USDT payment")),1),s("div",zo,r(u.$t("huabei.nowCanUse",{symbol:"(USDT)"}))+r(t(S)(i.usdtBalance)),1)]),"right-icon":y(()=>[m(V,{name:"5","checked-color":"#FEA021"})]),_:1},8,["title"])):C("",!0)]),_:1})]),_:1},8,["modelValue"]),m(io,{show:t(Re),name:u.$t("common.tip"),onClose:f[6]||(f[6]=ne=>t(K)(!1))},{default:y(()=>[s("div",Jo,r(u.$t("integral.relaseTip")),1),s("div",Yo,[m(ge,{type:"primary",class:"flex-1 min-w-[130px] h-[46px] rounded-full border border-solid border-b4 bg-white text-b2 text-base font-semibold",onClick:f[5]||(f[5]=ne=>t(K)(!1))},{default:y(()=>[oe(r(u.$t("common.cancel")),1)]),_:1}),m(ge,{class:"bg-btnOrBg rounded-full w-full text-b1 font-semibold",onClick:Fe},{default:y(()=>[oe(r(u.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show","name"])])}}}),Zo=mt(Qo,[["__scopeId","data-v-3da12dec"]]),Xo={class:"bg-white mt-3 p-3 rounded-xl"},es={class:"text-base font-semibold"},ts={class:"flex items-start justify-between mt-3"},os={class:"text-b3"},ss={class:"text-right"},as={key:0,class:"flex items-center justify-end gap-1 font-semibold"},ns=s("img",{src:ke,class:"w-4 h-4"},null,-1),ls={key:1,class:"flex items-center justify-end gap-1 font-semibold"},rs=s("img",{src:vt,class:"w-4 h-4"},null,-1),us={key:0,class:"actPrice flex items-baseline justify-between mt-3"},is={class:"text-b3 max-w-[100px] line-clamp-1"},cs={class:"text-right flex items-center justify-end gap-1"},ds=s("img",{src:ke,class:"w-4 h-4"},null,-1),ps=s("div",{class:"w-full h-[1px] bg-[#F6F6F5] my-3"},null,-1),ms={class:"flex items-center justify-between"},fs={class:"text-b3"},hs={class:"gap-1 text-right flex-center"},ys=s("img",{src:ke,class:"w-4 h-4"},null,-1),vs=oe("+ "),gs=s("img",{src:pt,class:"w-4 h-4"},null,-1),bs={key:1,class:"text-xs text-b3 text-right"},_s=Te({props:{totalPrice:null,usdtPrice:null,originalUsdtPrice:null,showTotalPrice:null,voucherPrice:null,useVoucherAmount:null,symbol:null,activityReduceAmount:null,fmGeneralActivity:null},setup(i){const B=i,U=te(()=>{if(B.usdtPrice<=0)return"";const b=new d(B.usdtPrice),x=new d(B.showTotalPrice||0).minus(B.totalPrice).minus(B.activityReduceAmount||0).minus(B.useVoucherAmount||0).toNumber();return console.log("props.showTotalPrice",B.showTotalPrice,"props.totalPrice",B.totalPrice,"props.voucherPrice",B.voucherPrice,"props.activityReduceAmount",B.activityReduceAmount,"props.fmGeneralActivity",B.fmGeneralActivity),`(${S(b)} USDT将自动闪兑为${S(x)} Mcoin)`});return(b,x)=>(h(),R("div",Xo,[s("div",es,r(b.$t("order.totalPriceDetail")),1),s("div",ts,[s("div",os,r(b.$t("order.goodsPrice")),1),s("div",ss,[i.totalPrice>0?(h(),R("div",as,[ns,s("span",null,r(t(S)(i.totalPrice)),1)])):C("",!0),i.originalUsdtPrice>0?(h(),R("div",ls,[rs,s("span",null,r(t(S)(i.originalUsdtPrice)),1)])):C("",!0)])]),i.activityReduceAmount&&i.fmGeneralActivity?(h(),R("div",us,[s("div",is,r(i.fmGeneralActivity.name),1),s("div",cs,[ds,s("span",null,"-"+r(t(S)(i.activityReduceAmount)),1)])])):C("",!0),ps,s("div",ms,[s("div",fs,r(b.$t("common.actual_payment")),1),s("div",hs,[ys,s("span",null,r(t(S)(i.showTotalPrice-i.voucherPrice-(i.activityReduceAmount||0))),1),i.voucherPrice?(h(),R(De,{key:0},[vs,gs,oe(r(t(S)(i.voucherPrice)),1)],64)):C("",!0)])]),i.usdtPrice>0?(h(),R("div",bs,r(t(U)),1)):C("",!0)]))}}),Ce=i=>(ht("data-v-66f28252"),i=i(),yt(),i),ws={key:0,class:"p-3 pb-[50px] font-Puhui"},As={class:"text-lg font-semibold"},$s={class:"mt-3 flex items-center justify-between gap-2 pb-3 border-b border-[#f5f5f5] border-solid"},Ss={class:"flex-1 text-b3"},xs=["onClick"],ks={key:0},Ts={class:"bg-white overflow-hidden py-3 border-b border-b5 border-solid"},Ps={class:"text-b3"},Cs={class:"bg-white myinput overflow-hidden py-3 border-b border-b5 border-solid"},Rs={class:"text-b3"},Bs={class:"bg-white mt-3 rounded-xl"},Ns={class:"flex items-baseline justify-between mt-1"},Es={class:"text-b3"},Ds={class:"text-right"},Ls={class:"text-base font-semibold"},Os={key:0},Fs={class:"text-b3 mt-1"},Is={class:"bg-white mt-2.5 rounded-xl p-2.5"},Ws={class:"text-sm font-bold"},Vs={class:"flex items-baseline justify-between mt-1"},Gs={class:"break-keep"},Us={class:"text-right"};const Ms={key:1,class:"flex flex-wrap items-center justify-end text-base font-semibold text-primary"},Hs={key:0,class:"justify-end flex-center"},js=Ce(()=>s("img",{src:ke,class:"w-4 h-4 mr-1"},null,-1)),qs={class:"opacity-60"},Ks=Ce(()=>s("div",{class:"h-10"},null,-1)),zs={class:"text-left text-sm text-b3"},Js={class:"flex-center gap-2.5"},Ys={class:"flex-end gap-1 font-bold text-base"},Qs=Ce(()=>s("img",{src:ke,class:"w-4 h-4"},null,-1)),Zs=Ce(()=>s("span",null,"+",-1)),Xs=Ce(()=>s("img",{src:pt,class:"w-4 h-4"},null,-1)),ea={class:"relative"},ta={class:"p-3 pb-10 remark"},oa={class:"relative text-center text-lg font-bold mb-3"},sa=Te({name:"SubmitOrderBoutiqueCart"});function aa(i){var lt;const{isKeyboardVisible:B}=Co(),{getUserDhKey:U,encryptAddressKey:b,formatAddressData:x,generateKey:he,decryptAddressKey:Le}=co(),{accountStore:ye}=gt();ye.account||((lt=ye.sign)==null||lt.address);const{t:N}=Xt(),[Re,K]=fe(!1),{loadingToggle:ue}=fo(),{getAddress:ve,setAddress:Oe}=ko(),{submit:Be}=po(),Fe=mo(1),{tradeContributeSelfRate:u,mcoinRate:f}=ct(),[V,H]=fe(!1),se=eo(),[Ie,ge]=fe(!1),[ne,We]=fe(!1),[bt,_t]=fe(!0),[ie,z]=fe(!1),Ve=P([]),E=P(),O=P([]),wt=P(0),be=P({remark:""}),At=te(()=>[{value:0,text:N("common.no")},{value:1,text:N("common.yes")}]),Ze=async()=>{if(ve()){E.value=ve(),Oe(null);return}const e=se.currentRoute.value.path,o=await Ao();if(!o.success)return;Ve.value=o.data;const a=Ve.value.find(c=>c.isDefault===1)||Ve.value[0],n=await he("user",e);if(a!=null&&a.encryptFlag&&n){E.value=Le(a,n);return}E.value=a},$t=async()=>{const e=await(await Fe).allowance(Y.order);wt.value=e.result},Q=to(),g=te(()=>qe()),Xe=P([]),Ge=async()=>{var n,c;let e=[];O.value.forEach(k=>{k.ordersInfos.forEach(w=>{w.goods.forEach(F=>{e.push({goodsId:F.goodsId,num:F.number,payType:xe.MC,paySource:k.paySource})})})});const o={type:((n=Q==null?void 0:Q.query)==null?void 0:n.type)??2,addressId:(c=E.value)==null?void 0:c.id,detailList:e,genOrder:!1,voucherAmount:0},a=await dt(o);a.success&&(Xe.value=a.data.goodsList||[])},et=async()=>{var a;const e=await xo({type:((a=Q==null?void 0:Q.query)==null?void 0:a.type)??2});if(!e.success){setTimeout(()=>{se.back()},1500);return}const o=O.value.map(n=>n.paySource);O.value=(e.data.ordersInfos||[]).map((n,c)=>{let k=xe.MC;return{...n,goods:n.orderGoods,totalAmount:0,integral:0,remark:"",payType:k,paySource:o[c]||$.WALLET}}),St()},St=()=>{const e=O.value.map(n=>n.paySource),o=O.value.reduce((n,c)=>(c.goods.forEach(k=>{n.push({...c,goods:k,storeId:c.stores.id,cardNo:"",isPortability:0})}),n),[]),a=kt(o);O.value=a.map((n,c)=>{var M;const k=(M=n[0])==null?void 0:M.goods,w=(k==null?void 0:k.goodsType)!==Se.SD,F=e[c]||(w?$.WITHDRAW_POINTS:$.WALLET),J=xt(n);return{goodsBoutiqueFlag:w,paySource:F,ordersInfos:J}})},xt=e=>e.reduce((o,a)=>{const n=o.findIndex(c=>c.storeId===a.storeId);return n!==-1?(o[n].goods.push(a.goods),+a.goods.goodsTypes===re.RECHARGE&&(o[n].goodTypes=re.RECHARGE)):o.push({...a,goods:[a.goods],goodTypes:+a.goods.goodsTypes===re.RECHARGE?re.RECHARGE:null}),o},[]),kt=e=>{let o={};for(;e.length;){let a=e.shift();const n=a.goods.goodsType?"true":"false";o[n]=o[n]||[],o[n].push(a)}return Object.keys(o).map(a=>o[a])},Tt=async(e,o)=>{e.number=o,ue(!0);const a=await To({goodsId:e.goodsId,number:o});await Ge(),await et(),ue(!1),a.success},Pt=async e=>{be.value=e,We(!0)},Ct=()=>{O.value.forEach(e=>{e.ordersInfos.forEach(o=>{var a,n;o.storeId===((a=be.value)==null?void 0:a.storeId)&&(o.remark=(n=be.value)==null?void 0:n.remark)})})},Rt=P($.WITHDRAW_POINTS),Bt=(e,o)=>{ie.value||(o.paySource=e,o.boutiqueIntegral=qe([{ordersInfos:o.ordersInfos,paySource:o.paySource}]),Ge())};let Z=P(!1);const Nt=async()=>{const e=O.value.reduce((o,a)=>{const n=o.findIndex(c=>c.storeId===a.paySource);return n!==-1?o[n].totalAmount+=a.totalAmount-a.voucherAmount:o.push({paySource:a.paySource,totalAmount:a.totalAmount-a.voucherAmount}),o},[]);for(let o=0;o<e.length;o++){const a=e[o],{totalAmount:n}=a,{paySource:c}=a;+c===$.WITHDRAW_POINTS?await Lt(n):+c===$.PIGGY_BANK?await It(n):+c===$.WALLET?await Wt(n):+c===$.USDT_WALLET&&await Et(n)}},Et=async e=>{if(+He.value<+e*ze.value)return Z.value=!0,K(!0);Z.value=!1},la=te(()=>S(+new d(qe(O.value.filter(e=>e.goodsBoutiqueFlag)).totalAmount).div(.9))),Ne=P(0),{pointBalances:Dt}=ct(),Ue=async()=>{Ne.value=+await Dt(),console.log("pointBalance:",Ne.value)},Lt=async e=>{if(await Ue(),+ +d(Ne.value).times(.9)<+e)return Z.value=!0,K(!0);Z.value=!1},Ee=P([]),{userMerchantCashs:Ot,userTotalAmount:Ft}=Po(),tt=async()=>{const{success:e,result:o}=await Ot();if(!e)return;let a=0;const n=+await Ft(),c=o.amounts.map(w=>vo(w));o.cashIds.map(w=>+w).forEach((w,F)=>{Ee.value[w]=c[F],w!==0&&(a=+d(a).plus(c[F]||0).toString())}),Ee.value[0]=+d(n).minus(a)},ot=te(()=>Ee.value.length&&+Ee.value[0]||0),It=async e=>{if(+ot.value<+e)return Z.value=!0,K(!0);Z.value=!1},Me=P(0),st=P(0),He=P(0),at=async()=>{const{balanceOf:e}=Ye(Y.MCOIN),o=await e();Me.value=+o,st.value=+await Ye(Y.FMCP).balanceOf(),He.value=+await Ye(Y.USDT).balanceOf()},Wt=async e=>{if(+Me.value<+e)return Z.value=!0,K(!0);Z.value=!1},Vt=P(null),_e=P(0),Gt=async()=>{var w,F,J,M,X;if(!E.value)return le(N("order.setAddress"));if((w=E.value)!=null&&w.encryptFlag&&!((F=E.value)!=null&&F.success))return le(N("order.reconfirm the information"));if(!ho(E.value.telNumber))return le(N("address.number was identified"));const e=se.currentRoute.value.path;if(z(!0),await at(),await tt(),await Nt(),Z.value){z(!1);return}if(Re.value){z(!1);return}z(!0);let o=[],a=[],n=!1;if(O.value.forEach(I=>{I.ordersInfos.forEach(W=>{W.goodTypes===re.RECHARGE&&(+W.cardNo||(n=!0)),W.goods.forEach(A=>{if(A.number>A.stock&&+A.goodsTypes!=2){let p=A.goodsName;A.goodsName.length>10&&(p=A.goodsName.slice(0,10)+"..."),a.push(p)}o.push({goodsId:A.goodsId,num:A.number,payType:xe.MC,paySource:I.paySource})})})}),n)return z(!1),le(N("order.Please fill in your phone number"));if(a.length>0)return z(!1),le(a.join()+"  "+N("order.Insufficient stock"));const c=await he("user",e);let k;c&&!E.value.encryptFlag&&(k=b(E.value,c),await wo({...k,isDefault:E.value.isDefault?1:0}));try{let I=[];for(let ce=0;ce<O.value.length;ce++){const Ae=O.value[ce];for(let de=0;de<Ae.ordersInfos.length;de++){const l=Ae.ordersInfos[de];let pe=l.remark;if(+l.goodTypes===re.RECHARGE&&(pe=N("order.phoneNumber")+String(l.cardNo).concat(l.isPortability===1?` ${N("order.Number Portabilit")} `:"").concat("，").concat(l.remark)),I.findIndex(L=>L.storeId===l.storeId)===-1){let L={};if(l.encryption){const $e=await U(l.stores.id,(J=l.encryption)==null?void 0:J.publicKey);$e?(L=x(L,{...E.value,postscript:pe},1),L=b(L,$e),L.submitHash=L.hash):L=x(L,{...E.value,postscript:pe},0)}else L=x(L,{...E.value,postscript:pe},0);I.push({storeId:l.storeId,...L})}}}const W={type:((M=Q==null?void 0:Q.query)==null?void 0:M.type)??2,addressId:E.value.id,postscripts:I,detailList:o,genOrder:!0,voucherAmount:((X=g.value)==null?void 0:X.voucherAmount)||0},A=await dt(W);if(!A.success){z(!1);return}const{allOrderId:p,merchants:_,discounts:v,amounts:G,sources:ee}=A.data,D=await Be(p,_,v,G,ee);if(!D.success){$o({allOrderId:p}),setTimeout(()=>{se.push({path:"/buyerOrderList",query:{active:0},replace:!0})},1e3);return}if(le.loading({message:N("order.wait block chain"),forbidClick:!0,duration:0}),await So({allOrderId:p,hash:D.result.hash}),le.clear(),Vt.value=D.result.hash,!D.result.hash)return;let j;const we=async()=>{if(_e.value>=5){z(!1),ge(!0),_e.value=0;return}if(j=await yo(D.result.hash),(j==null?void 0:j.status)===1){z(!1),H(!0),_e.value=0,Mt();return}setTimeout(async()=>{_e.value++,we()},5e3)};we()}catch{z(!1),_e.value=0}finally{O.value.forEach((I,W)=>{var A;nt.value[`paySwitch${W}`].setpayValue((A=I.paySource)==null?void 0:A.toString())})}},nt=P({}),Ut=(e,o)=>{e&&(nt.value[`paySwitch${o}`]=e)},Mt=()=>{setTimeout(()=>{H(!1),se.replace({path:"buyerOrderList",query:{active:1}})},1500)},je=P(1),Ht=async()=>{je.value=await u()},qe=e=>{let o=0,a=0,n=0,c=0,k=0,w=0,F=0,J=0,M=0,X=0,I=st.value,W=0,A=null;return(e||O.value).forEach(p=>{p.totalAmount=0,p.integral=0,p.totalNum=0,p.voucherAmount=0,p.pointFee=0,p.ordersInfos.forEach(_=>{_.fmGeneralActivity&&!A&&(A=_.fmGeneralActivity),_.totalAmount=0,_.integral=0,_.totalNum=0,_.voucherAmount=0,_.pointFee=0,_.goods.forEach(v=>{F+=+v.number;const G=+new d(v.price).times(v.number),ee=+new d(new d(v.price).times(v.number).minus(v.goodsActivityReduceAmount||0).times(p.paySource===$.WITHDRAW_POINTS&&v.balanceDiscountRatio||v.discountRatio)).div(100);W=new d(W).plus(v.goodsActivityReduceAmount||0).toNumber();const D=p.paySource===$.WITHDRAW_POINTS?Math.min(I,v.goodsType>0?+new d(ee).times(.5):0):0,j=[Se.SL,Se.PR].indexOf(v.goodsType)!==-1&&Number(v.discountRatio)>(v.goodsType===Se.SL?9:19)||v.goodsType===Se.ST?d(G).times(.5):0;o=+new d(o).plus(G),p.paySource===$.USDT_WALLET?(n=+new d(n).plus(new d(G).times(ze.value)),a=+new d(a).plus(new d(G).minus(D||0).minus(v.goodsActivityReduceAmount||0).times(ze.value)),M=+new d(M).plus(D)):(p.paySource!==$.PIGGY_BANK&&p.paySource!==$.WITHDRAW_POINTS&&(k=+new d(c).plus(G)),c=+new d(c).plus(G)),_.totalAmount=+new d(_.totalAmount).plus(G),p.totalAmount=+new d(p.totalAmount).plus(G),w=+new d(w).plus(ee),_.integral=+new d(_.integral).plus(ee),p.integral=+new d(p.integral).plus(ee),I-=D,J+=D,v.voucherAmount=D,_.voucherAmount=+new d(_.voucherAmount).plus(D),p.voucherAmount=+new d(p.voucherAmount).plus(D),X=+new d(X).plus(j),_.pointFee=+new d(_.pointFee).plus(j),p.pointFee=+new d(p.pointFee).plus(j),_.totalNum+=v.number,p.totalNum+=v.number})})}),{totalAmount:o,usdtAmount:a,originalUsdtAmount:n,mcAmount:c,integral:w,totalNum:F,voucherAmount:J,useVoucherAmount:M,pointFee:X,approveMcAmount:k,activityReduceAmount:W,fmGeneralActivity:A}},Ke=P(null),jt=async()=>{Ke.value=await f()},ze=te(()=>1/Ke.value),qt=te(()=>{const e=new d(g.value.totalAmount).minus(g.value.activityReduceAmount||0).minus(g.value.voucherAmount||0);return S(e)}),Kt=async()=>{ue(!0),et(),at(),Ht(),tt(),Ue(),await jt(),await $t(),await Ze(),await Ge(),ue(!1),_t(!1)};oo(()=>{Ze()});const zt=e=>{se.push(e)};return ft(()=>{Kt()}),(e,o)=>{var J,M,X,I,W,A,p,_,v,G,ee,D,j,we,ce,Ae,de;const a=q("van-icon"),n=q("van-field"),c=q("van-dropdown-item"),k=q("van-dropdown-menu"),w=q("VanButton"),F=q("van-popup");return t(bt)?C("",!0):(h(),R("div",ws,[s("header",As,[m(_o,null,{default:y(()=>[s("span",null,r(e.$t("order.submitOrder")),1)]),_:1})]),m(no,{class:"mt-3",defaultAddress:E.value,onClick:o[0]||(o[0]=l=>zt("/userAddress"))},null,8,["defaultAddress"]),(h(!0),R(De,null,ut(O.value,(l,pe)=>{var L,$e,rt;return h(),R("div",{key:l.goodsBoutiqueFlag},[m(bo,{goodsBoutiqueFlag:l.goodsBoutiqueFlag},null,8,["goodsBoutiqueFlag"]),(h(!0),R(De,null,ut(l.ordersInfos,(T,Jt)=>(h(),R("div",{key:Jt,class:"bg-white rounded-xl p-3 mt-3"},[m(lo,{orderInfo:T,expressGoodsList:Xe.value,payType:T.payType,onChangeNumber:o[1]||(o[1]=(me,Yt)=>Tt(me,Yt))},null,8,["orderInfo","expressGoodsList","payType"]),s("div",$s,[s("div",Ss,r(e.$t("order.remark")),1),s("div",{class:"flex-1 flex items-center justify-end",onClick:me=>Pt(T)},[s("div",null,r(T.remark?T.remark:e.$t("order.noRemark")),1),m(a,{name:"arrow"})],8,xs)]),+(T==null?void 0:T.goodTypes)===t(re).RECHARGE?(h(),R("div",ks,[s("div",Ts,[m(n,{style:{padding:"0 !important"},"input-align":"right",type:"digit",autocomplete:"off",modelValue:T.cardNo,"onUpdate:modelValue":me=>T.cardNo=me,placeholder:e.$t("shop.pleaseInput")},{label:y(()=>[s("div",Ps,r(`${e.$t("order.Phone number")}`),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])]),s("div",Cs,[m(n,{style:{padding:"0 !important"},"input-align":"right",autocomplete:"off",label:`${e.$t("order.Whether to port your number")}`},{label:y(()=>[s("div",Rs,r(`${e.$t("order.Whether to port your number")}`),1)]),input:y(()=>[m(k,{"active-color":"#FEA021"},{default:y(()=>[m(c,{modelValue:T.isPortability,"onUpdate:modelValue":me=>T.isPortability=me,options:t(At)},null,8,["modelValue","onUpdate:modelValue","options"])]),_:2},1024)]),_:2},1032,["label"])])])):C("",!0),s("div",Bs,[s("div",Ns,[s("div",Es,r(e.$t("order.total")),1),s("div",Ds,[s("div",Ls,[T.totalAmount>0?(h(),R("span",Os,r(t(S)(T.totalAmount||0))+"Mcoin",1)):C("",!0)]),s("div",Fs,r(e.$t("order.getContribution",{num:t(S)(+new t(d)(T.integral).times(je.value||0))})),1)])])])]))),128)),s("div",Is,[s("div",Ws,r(e.$t("order.priceDetail")),1),s("div",Vs,[s("div",Gs,r(e.$t("order.sumtotal")),1),s("div",Us,[(l.paySource,t($).WITHDRAW_POINTS,h(),R("div",Ms,[(l==null?void 0:l.totalAmount)>0?(h(),R("div",Hs,[js,oe(" "+r(t(S)((l==null?void 0:l.totalAmount)||0)),1)])):C("",!0)])),s("div",qs,r(e.$t("order.getContribution",{num:t(S)(+new t(d)(l==null?void 0:l.integral).times(je.value||0))})),1)])]),l.paySource===t($).WITHDRAW_POINTS&&((L=t(g))==null?void 0:L.pointFee)>0?(h(),ae(Ro,{key:0,num:l==null?void 0:l.totalNum,amount:l==null?void 0:l.totalAmount,fee:($e=t(g))==null?void 0:$e.pointFee},null,8,["num","amount","fee"])):C("",!0)]),m(Zo,{ref:T=>Ut(T,pe),boutique:l.goodsBoutiqueFlag,class:"bg-white mt-2.5 rounded-xl",checked:(rt=l.paySource)==null?void 0:rt.toString(),clickable:!t(ie),"point-balance":Ne.value,"wallet-balance":Me.value,piggyBalance:t(ot),usdtBalance:He.value,payAmount:l==null?void 0:l.totalAmount,usdtRate:Ke.value,onOnChange:T=>Bt(T,l),onGetPointBalance:Ue},null,8,["boutique","checked","clickable","point-balance","wallet-balance","piggyBalance","usdtBalance","payAmount","usdtRate","onOnChange"])])}),128)),m(_s,{totalPrice:(J=t(g))==null?void 0:J.mcAmount,"usdt-price":(M=t(g))==null?void 0:M.usdtAmount,"original-usdt-price":(X=t(g))==null?void 0:X.originalUsdtAmount,showTotalPrice:(I=t(g))==null?void 0:I.totalAmount,"voucher-price":(W=t(g))==null?void 0:W.voucherAmount,"use-voucher-amount":(A=t(g))==null?void 0:A.useVoucherAmount,"activity-reduce-amount":(p=t(g))==null?void 0:p.activityReduceAmount,"fm-general-activity":(_=t(g))==null?void 0:_.fmGeneralActivity,symbol:"Mcoin"},null,8,["totalPrice","usdt-price","original-usdt-price","showTotalPrice","voucher-price","use-voucher-amount","activity-reduce-amount","fm-general-activity"]),Ks,s("div",{class:so(["fixed bottom-0 sm:left-1/2 sm:-translate-x-2/4 left-0 z-20 sm:w-[375px] w-full bg-white box-shadow safe-bottom p-2.5 flex-center-bw",t(B)?"!hidden":"!fixed"])},[s("div",zs,[s("div",null,r(e.$t("order.quantity",{number:(v=t(g))==null?void 0:v.totalNum})),1),s("div",null,r(e.$t("order.sumtotal")),1)]),s("div",Js,[s("div",Ys,[Qs,s("span",null,r(t(qt)),1),(G=t(g))!=null&&G.voucherAmount?(h(),R(De,{key:0},[Zs,Xs,s("span",null,r(t(S)((ee=t(g))==null?void 0:ee.voucherAmount)),1)],64)):C("",!0)]),s("div",ea,[(D=t(g))!=null&&D.usdtAmount?(h(),ae(Qe,{key:0,class:"absolute btn-orange btn-shadow w-[120px] h-[40px] text-white z-10",contract:t(Y).order,token:t(Y).USDT,symbol:"USDT",loading:t(ie),approveAmount:Number((j=t(g))==null?void 0:j.usdtAmount)},null,8,["contract","token","loading","approveAmount"])):C("",!0),(we=t(g))!=null&&we.approveMcAmount?(h(),ae(Qe,{key:1,class:"absolute btn-orange btn-shadow w-[120px] h-[40px] text-white z-10",contract:t(Y).order,token:t(Y).MCOIN,symbol:"mcoin",loading:t(ie),approveAmount:Number((ce=t(g))==null?void 0:ce.approveMcAmount)},null,8,["contract","token","loading","approveAmount"])):C("",!0),(Ae=t(g))!=null&&Ae.voucherAmount?(h(),ae(Qe,{key:2,class:"absolute btn-orange btn-shadow w-[120px] h-[40px] text-white z-10",contract:t(Y).order,token:t(Y).FMCP,symbol:e.$t("voucher.voucher"),loading:t(ie),approveAmount:Number((de=t(g))==null?void 0:de.voucherAmount)},null,8,["contract","token","symbol","loading","approveAmount"])):C("",!0),m(w,{type:"primary",class:"btn-orange btn-shadow w-[120px] h-[40px] text-white text-red-600 px-4 py-2 bg-gray3",loading:t(ie),onClick:Gt},{default:y(()=>[oe(r(e.$t("common.pay")),1)]),_:1},8,["loading"])])])],2),m(F,{onClose:Ct,show:t(ne),"onUpdate:show":o[5]||(o[5]=l=>ao(ne)?ne.value=l:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:y(()=>[s("div",ta,[s("div",oa,[oe(r(e.$t("order.submitOrder"))+" ",1),s("div",{class:"absolute right-0 bottom-[-2px]",onClick:o[2]||(o[2]=l=>t(We)(!1))},[m(a,{name:"cross"})])]),m(n,{modelValue:be.value.remark,"onUpdate:modelValue":o[3]||(o[3]=l=>be.value.remark=l),rows:"4",autosize:"",type:"textarea",maxlength:"200",placeholder:e.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"]),m(w,{class:"mt-4 bg-btnOrBg w-full h-[46px] text-b1 rounded-full text-base font-semibold",onClick:o[4]||(o[4]=l=>t(We)(!1))},{default:y(()=>[oe(r(e.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show"]),t(V)?(h(),ae(it,{key:0,onClose:o[6]||(o[6]=l=>t(H)(!1)),text:e.$t("common.pay success")},null,8,["text"])):C("",!0),t(Ie)?(h(),ae(it,{key:1,isError:!0,onClose:o[7]||(o[7]=l=>t(ge)(!1)),text:e.$t("order.fail")},null,8,["text"])):C("",!0),m(ro,{paySource:Rt.value,show:t(Re),onClose:o[8]||(o[8]=l=>t(K)(!1))},null,8,["paySource","show"])]))}}const na=Te({...sa,setup:aa}),Fa=mt(na,[["__scopeId","data-v-66f28252"]]);export{Fa as default};
