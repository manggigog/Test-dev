import{bf as W,x as U,B as S}from"./vendor-BUT0HZ5j.js";import{f as _,B as A,q as o,s as p}from"./index-hbwLMIYO.js";import{p as L}from"./piggyBank-DIfLFOiI.js";import{P as s}from"./order-H59PKTFP.js";function Y(T){const e=W({pointBalance:0,walletBalance:0,piggyBalance:0,usdtBalance:0,usdtRate:1,voucherBalance:0,pointSelfRate:5,loading:!1}),i=U(()=>{const a=[{source:s.WITHDRAW_POINTS,name:"order.payPoints",icon:"images/huabei/pay_points.png",symbol:"MCOIN",balance:e.pointBalance,availableBalance:+S(e.pointBalance).times(.9),description:`可用积分: ${e.pointBalance}`},{source:s.WALLET,name:"order.payWallet",icon:"images/huabei/pay_wallet.png",symbol:"MCOIN",balance:e.walletBalance,availableBalance:e.walletBalance,description:""},{source:s.PIGGY_BANK,name:"order.payPiggy",icon:"images/huabei/pay_piggy.png",symbol:"MCOIN",balance:e.piggyBalance,availableBalance:e.piggyBalance,description:""},{source:s.USDT_WALLET,name:"order.USDT payment",icon:"images/tokens/USDT.png",symbol:"USDT",balance:e.usdtBalance,availableBalance:+S(e.usdtBalance).times(e.usdtRate),description:`汇率: 1 USDT = ${e.usdtRate} MCOIN`}];return T.value?a:a.filter(n=>n.source!==s.WITHDRAW_POINTS)});let g,B,m,v,y;try{const a=L();g=a.userTotalAmount,y=a.userMerchantCashs;const n=_();B=n.pointBalances,m=n.mcoinRate,v=n.tradeContributeSelfRate}catch(a){console.warn("合约初始化失败:",a),g=()=>Promise.resolve(0),y=()=>Promise.resolve([]),B=()=>Promise.resolve(0),m=()=>Promise.resolve(1)}const O=a=>{const n=i.value.find(t=>t.source===a);return n||null},d=async a=>{var n;try{const t=((n=o)==null?void 0:n.MCOIN)||"",c=a||t;if(!c){console.warn("The token contract address is empty, skipping...");return}return await p(c).balanceOf()}catch(t){return console.error("获取钱包余额失败:",t),0}},C=async()=>{var a;e.walletBalance=+await d((a=o)==null?void 0:a.MCOIN)},I=async()=>{var a;e.usdtBalance=+await d((a=o)==null?void 0:a.USDT)},R=async()=>{var a;e.voucherBalance=+await d((a=o)==null?void 0:a.vourcher)},w=async a=>{var n,t,c;try{const l=((n=o)==null?void 0:n.MCOIN)||"",u=a||l;if(!u){console.warn("代币合约地址为空，跳过钱包余额获取");return}const r=[];r.push(p(u).balanceOf().catch(()=>0)),(t=o)!=null&&t.USDT?r.push(p(o.USDT).balanceOf().catch(()=>0)):r.push(Promise.resolve(0)),(c=o)!=null&&c.FMCP?r.push(p(o.FMCP).balanceOf().catch(()=>0)):r.push(Promise.resolve(0));const[N,k,D]=await Promise.all(r);e.walletBalance=+N||0,e.usdtBalance=+k||0,e.voucherBalance=+D||0}catch(l){console.error("获取钱包余额失败:",l),e.walletBalance=0,e.usdtBalance=0,e.voucherBalance=0}},h=async()=>{try{e.pointBalance=+await B()||0}catch(a){console.error("获取积分余额失败:",a),e.pointBalance=0}},b=async()=>{try{const{success:a,result:n}=await y();if(!a)return;const t=((n==null?void 0:n.cashIds)||[]).findIndex(c=>+c==0);t!==-1&&(e.piggyBalance=+A(((n==null?void 0:n.amounts)||[])[t]))}catch(a){throw console.error("获取闪电宝余额失败:",a),a}},f=async()=>{try{e.usdtRate=await m()||1}catch(a){console.error("获取汇率失败:",a),e.usdtRate=1}},M=async()=>{e.pointSelfRate=await v()},P=async a=>{e.loading=!0;try{await Promise.allSettled([w(a),h(),b(),f(),M()])}catch(n){console.error("Failed to obtain balance data:",n)}finally{e.loading=!1}};return{balanceState:e,paymentOptions:i,getPaymentBySource:O,fetchAllBalances:P,refreshBalance:async a=>{try{switch(a){case"wallet":await C();break;case"point":await h();break;case"piggy":await b();break;case"usdt":await I();break;case"vourcher":await R();break;case"rate":await f();break;case"all":await P();break}}catch(n){throw console.error(`刷新${a}余额失败:`,n),n}},checkSufficientBalance:(a,n)=>{const t=i.value.find(c=>c.source===a);return t?+t.availableBalance>=+n:!1},getPaymentOptions:(a,n=!0)=>{const t=[];if(n){const u=e.pointBalance*.9;t.push({source:s.WITHDRAW_POINTS,name:"order.payPoints",icon:"@/assets/images/huabei/pay_points.png",symbol:"MCOIN",balance:u,available:u>=a,description:`可用积分: ${e.pointBalance}`,availableBalance:0})}t.push({source:s.WALLET,name:"order.payWallet",icon:"@/assets/images/huabei/pay_wallet.png",symbol:"MCOIN",balance:e.walletBalance,available:e.walletBalance>=a,availableBalance:0});const c=e.piggyBalance||0;t.push({source:s.PIGGY_BANK,name:"order.payPiggy",icon:"@/assets/images/huabei/pay_piggy.png",symbol:"MCOIN",balance:c,available:c>=a,availableBalance:0});const l=a*e.usdtRate;return t.push({source:s.USDT_WALLET,name:"order.USDT payment",icon:"@/assets/images/tokens/USDT.png",symbol:"USDT",balance:e.usdtBalance,available:e.usdtBalance>=l,description:`汇率: 1 USDT = ${e.usdtRate} MCOIN`,availableBalance:0}),t},autoSelectPaymentMethod:(a,n)=>{const t=i.value.find(c=>c.source===s.WITHDRAW_POINTS?c.availableBalance>=a-n:c.availableBalance>=a);return t?t.source:i.value[0].source},fetchWalletBalance:w,fetchPointBalance:h,fetchPiggyBankBalance:b,fetchusdtRate:f}}export{Y as u};
