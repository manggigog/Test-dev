import{_ as uo}from"./arrow-bottom-D85vJawE.js";import{_ as _e}from"./MCOIN-Bodfn-v1.js";import{_ as _t}from"./FMCP-f3k58DsE.js";import{z as Ae,_ as At,y as Z,B as m,r as C,a2 as io,D as Je,E as St,F as z,G as T,H as f,P as g,$ as w,Z as M,U as k,O as t,I as s,Q as l,a3 as co,a4 as ee,X as kt,Y as xt,J as Ne,x as po,bB as fe,q as mo,o as fo,bm as ho,K as yt,N as yo,bw as vo,a0 as vt,n as go,T as le}from"./vendor-Dr_RpJ_Y.js";import{a as bo,e as P,y as wo,V as _o,i as Ao,l as So,g as K,u as ko,ad as xo,w as Po,bQ as $o,c as gt,bL as To,j as Ye,G as Co,a5 as Ro}from"./index-7OiUoGXy.js";import{_ as Bo}from"./AddressInfo-2bPrVt2B.js";import{_ as bt}from"./EmptyTipsPop-DFfFg0cQ.js";import{O as No}from"./OrderGoodsCartBox-ZjY-tKZc.js";import{P as Eo}from"./PaySwitchPop-jRKJee4g.js";import{_ as Do}from"./point-arrow-C6HCTn4p.js";import{_ as Pt}from"./USDT-Dlu99aCg.js";import{P as we}from"./flashSale-DDyqLyYN.js";import{u as Lo}from"./usePointRelase-CczR7Un0.js";import{P as $}from"./order-H59PKTFP.js";import{C as Oo}from"./CommonVanProvider-KZuKVOde.js";import{u as Io,_ as Fo,P as Wo}from"./usePayHelp-CaGzEK51.js";import{_ as Go}from"./PayHelpSelector-DjBp2vZY.js";import{D as Uo}from"./DividingLine-Dusl4c-B.js";import{_ as Qe}from"./SubmitApprove-B3ByTMk_.js";import{q as Vo,c as Ho}from"./address-iY9yI6tl.js";import{p as wt,r as Mo,u as jo}from"./order-D0_No2Ew.js";import{u as qo}from"./useSelectAddress-CgNt0r_o.js";import{G as re}from"./goods-BVwS8oFG.js";import{p as Ko}from"./piggyBank-DCQqbblx.js";import{S as ge}from"./shop-CeqcS6K2.js";import{u as zo}from"./useKeyboard-DcWqtm11.js";import{P as be}from"./payHelp-BuwJxNdC.js";import"./mall-DLd1UK-E.js";import"./OrderGoods-C5ohlmD4.js";import"./BoutiqueLable-DDlxeK08.js";import"./ShopMaskTips-ClYuWX9C.js";import"./useShipTemplate-VxaDU85Q.js";import"./enums-DlE-aiss.js";import"./BackIcon-CDrGaEPo.js";import"./payHelp-CYFZHRwW.js";const Jo=Ae({props:{num:{type:Number,default:0},amount:{type:Number,default:0},fee:{type:Number,default:0}},setup(d){return(L,U)=>null}}),Yo=""+new URL("../images/pay_points-DuQgheHY.png",import.meta.url).href,Qo=""+new URL("../images/pay_wallet-CtEhTDcc.png",import.meta.url).href,Xo=""+new URL("../images/pay_piggy-1jarwiJl.png",import.meta.url).href,Se=d=>(kt("data-v-1fd1be50"),d=d(),xt(),d),Zo={class:"pay-switch rounded-xl overflow-hidden"},es=Se(()=>s("img",{src:Yo,class:"w-6 h-6 mx-3"},null,-1)),ts={class:"custom-title flex items-center justify-start gap-2"},os=["onClick"],ss=Se(()=>s("img",{src:Do,class:"w-4 h-4 mx-3"},null,-1)),as={class:"text-xs text-b3"},ns=Se(()=>s("img",{src:Qo,class:"w-6 h-6 mx-3"},null,-1)),ls={class:"custom-title"},rs={class:"text-xs text-b3"},us=Se(()=>s("img",{src:Xo,class:"w-6 h-6 mx-3"},null,-1)),is={class:"custom-title"},cs={class:"text-xs text-b3"},ds=Se(()=>s("img",{src:Pt,class:"w-6 h-6 mx-3"},null,-1)),ps={class:"custom-title"},ms={class:"text-xs text-b3"},fs={class:"text-sm text-b2 my-4 leading-5"},hs={class:"flex justify-center gap-x-2"},ys=Ae({props:{checked:{default:"3"},clickable:{type:Boolean,default:!0},payType:{default:1},paySymbol:{default:"MCOIN"},walletBalance:null,pointBalance:null,piggyBalance:null,usdtBalance:null,boutique:{type:Boolean,default:!1},payAmount:{default:0},usdtRate:null,voucherAmount:null},emits:["onChange","getPointBalance"],setup(d,{expose:L,emit:U}){const x=d,{contributesStore:R}=bo(),he=Z(()=>+m(x.pointBalance).times(.9)),Ee=Z(()=>[{source:$.WITHDRAW_POINTS,amount:he.value},{source:$.WALLET,amount:x.walletBalance},{source:$.PIGGY_BANK,amount:x.piggyBalance},{source:$.USDT_WALLET,amount:x.usdtBalance*x.usdtRate}]),{handleNaturePointsToast:G}=Lo(),te=C(x.checked),[se,J]=io(!1),ue=r=>{te.value=r},ye=()=>{let r=[...Ee.value];!x.boutique&&r[0].source===$.WITHDRAW_POINTS&&r.shift();const y=r.find(O=>O.source===$.WITHDRAW_POINTS?+O.amount>=+x.payAmount-(+x.voucherAmount||0):+O.amount>=+x.payAmount);y&&y.source!==+te.value?U("onChange",y.source):!y&&+r[0].source&&U("onChange",r[0].source)},De=()=>{var r,y,O,I;(r=R.releaseData)!=null&&r.remainTotal&&+((y=R.releaseData)==null?void 0:y.remainTotal)>0&&(!((O=R.releaseData)!=null&&O.nextSubmitDate)||new Date().getTime()>=+((I=R.releaseData)==null?void 0:I.nextSubmitDate))?G(xe):J(!0)},xe=()=>{let r=0;const y=async()=>{U("getPointBalance"),R.fetchContributes(),await Promise.all([R.fetchUserRelase(),R.getNaturalReleaseTimes()]),r++,r<3&&setTimeout(y,3e3)};y()},Le=()=>{J(!1),G(xe)};return Je(()=>x.checked,r=>{te.value=r},{immediate:!0,deep:!0}),Je(()=>x.boutique,r=>{r&&(R.fetchContributes(),R.fetchUserRelase(),R.getNaturalReleaseTimes())},{immediate:!0,deep:!0}),Je(()=>x.voucherAmount,r=>{r&&ye()},{immediate:!0,deep:!0}),St(()=>{ye()}),L({setpayValue:ue}),(r,y)=>{const O=z("van-radio"),I=z("van-cell"),Oe=z("van-cell-group"),Pe=z("van-radio-group"),ie=z("VanButton");return f(),T("div",Zo,[g(Pe,{modelValue:te.value,"onUpdate:modelValue":y[4]||(y[4]=ce=>te.value=ce)},{default:w(()=>[g(Oe,null,{default:w(()=>[d.payType===t(we).MC&&d.boutique?(f(),M(I,{key:0,center:"",title:r.$t("order.payPoints"),clickable:"",onClick:y[0]||(y[0]=()=>U("onChange",4))},{icon:w(()=>[es]),title:w(()=>[s("div",ts,[s("span",null,l(r.$t("order.payPoints")),1),t(P)(t(R).freeRelease)>0?(f(),T("div",{key:0,class:"text-xs font-normal text-newOrigin flex-center",onClick:co(De,["stop"])},[ee(l(r.$t("integral.keshifang",{num:t(P)(t(R).freeRelease)})),1),ss],8,os)):k("",!0)]),s("div",as,l(r.$t("huabei.nowCanUse"))+" "+l(t(P)(d.pointBalance))+"/"+l(r.$t("integral.order_can_use"))+l(t(P)(t(he))),1)]),"right-icon":w(()=>[g(O,{name:"4","checked-color":"#FEA021"})]),_:1},8,["title"])):k("",!0),g(I,{center:"",title:r.$t("order.payWallet"),clickable:"",onClick:y[1]||(y[1]=()=>U("onChange",1))},{icon:w(()=>[ns]),title:w(()=>[s("div",ls,l(r.$t("order.payWallet")),1),s("div",rs,l(r.$t("huabei.nowCanUse"))+" "+l(t(P)(d.walletBalance)),1)]),"right-icon":w(()=>[g(O,{name:"1","checked-color":"#FEA021"})]),_:1},8,["title"]),g(I,{center:"",title:r.$t("order.payPiggy"),clickable:"",onClick:y[2]||(y[2]=()=>U("onChange",2))},{icon:w(()=>[us]),title:w(()=>[s("div",is,l(r.$t("order.payPiggy")),1),s("div",cs,l(r.$t("huabei.nowCanUse"))+l(t(P)(d.piggyBalance)),1)]),"right-icon":w(()=>[g(O,{name:"2","checked-color":"#FEA021"})]),_:1},8,["title"]),d.payType!==t(we).STORE_CARD?(f(),M(I,{key:1,center:"",title:r.$t("order.USDT payment"),clickable:"",onClick:y[3]||(y[3]=()=>U("onChange",5))},{icon:w(()=>[ds]),title:w(()=>[s("div",ps,l(r.$t("order.USDT payment")),1),s("div",ms,l(r.$t("huabei.nowCanUse",{symbol:"(USDT)"}))+l(t(P)(d.usdtBalance)),1)]),"right-icon":w(()=>[g(O,{name:"5","checked-color":"#FEA021"})]),_:1},8,["title"])):k("",!0)]),_:1})]),_:1},8,["modelValue"]),g(wo,{show:t(se),name:r.$t("common.tip"),onClose:y[6]||(y[6]=ce=>t(J)(!1))},{default:w(()=>[s("div",fs,l(r.$t("integral.relaseTip")),1),s("div",hs,[g(ie,{type:"primary",class:"flex-1 min-w-[130px] h-[46px] rounded-full border border-solid border-b4 bg-white text-b2 text-base font-semibold",onClick:y[5]||(y[5]=ce=>t(J)(!1))},{default:w(()=>[ee(l(r.$t("common.cancel")),1)]),_:1}),g(ie,{class:"bg-btnOrBg rounded-full w-full text-b1 font-semibold",onClick:Le},{default:w(()=>[ee(l(r.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show","name"])])}}}),vs=At(ys,[["__scopeId","data-v-1fd1be50"]]),gs={class:"bg-white mt-3 p-3 rounded-xl"},bs={class:"text-base font-semibold"},ws={class:"flex items-start justify-between mt-3"},_s={class:"text-b3"},As={class:"text-right"},Ss={key:0,class:"flex items-center justify-end gap-1 font-semibold"},ks=s("img",{src:_e,class:"w-4 h-4"},null,-1),xs={key:1,class:"flex items-center justify-end gap-1 font-semibold"},Ps=s("img",{src:Pt,class:"w-4 h-4"},null,-1),$s={key:0,class:"actPrice flex items-baseline justify-between mt-3"},Ts={class:"text-b3 max-w-[100px] line-clamp-1"},Cs={class:"text-right flex items-center justify-end gap-1"},Rs=s("img",{src:_e,class:"w-4 h-4"},null,-1),Bs=s("div",{class:"w-full h-[0.5px] bg-b4 my-3"},null,-1),Ns={class:"flex items-center justify-between"},Es={class:"text-b3"},Ds={class:"gap-1 text-right flex-center"},Ls=s("img",{src:_e,class:"w-4 h-4"},null,-1),Os=ee("+ "),Is=s("img",{src:_t,class:"w-4 h-4"},null,-1),Fs={key:1,class:"text-xs text-b3 text-right"},Ws=Ae({props:{totalPrice:null,usdtPrice:null,originalUsdtPrice:null,showTotalPrice:null,voucherPrice:null,useVoucherAmount:null,symbol:null,activityReduceAmount:null,fmGeneralActivity:null},setup(d){const L=d,U=Z(()=>{if(L.usdtPrice<=0)return"";const x=new m(L.usdtPrice),R=new m(L.showTotalPrice||0).minus(L.totalPrice).minus(L.activityReduceAmount||0).minus(L.useVoucherAmount||0).toNumber();return console.log("props.showTotalPrice",L.showTotalPrice,"props.totalPrice",L.totalPrice,"props.voucherPrice",L.voucherPrice,"props.activityReduceAmount",L.activityReduceAmount,"props.fmGeneralActivity",L.fmGeneralActivity),`(${P(x)} USDT将自动闪兑为${P(R)} Mcoin)`});return(x,R)=>(f(),T("div",gs,[s("div",bs,l(x.$t("order.totalPriceDetail")),1),s("div",ws,[s("div",_s,l(x.$t("order.goodsPrice")),1),s("div",As,[d.totalPrice>0?(f(),T("div",Ss,[ks,s("span",null,l(t(P)(d.totalPrice)),1)])):k("",!0),d.originalUsdtPrice>0?(f(),T("div",xs,[Ps,s("span",null,l(t(P)(d.originalUsdtPrice)),1)])):k("",!0)])]),d.activityReduceAmount&&d.fmGeneralActivity?(f(),T("div",$s,[s("div",Ts,l(d.fmGeneralActivity.name),1),s("div",Cs,[Rs,s("span",null,"-"+l(t(P)(d.activityReduceAmount)),1)])])):k("",!0),Bs,s("div",Ns,[s("div",Es,l(x.$t("common.actual_payment")),1),s("div",Ds,[Ls,s("span",null,l(t(P)(d.showTotalPrice-d.voucherPrice-(d.activityReduceAmount||0))),1),d.voucherPrice?(f(),T(Ne,{key:0},[Os,Is,ee(l(t(P)(d.voucherPrice)),1)],64)):k("",!0)])]),d.usdtPrice>0?(f(),T("div",Fs,l(t(U)),1)):k("",!0)]))}}),ke=d=>(kt("data-v-98f177f2"),d=d(),xt(),d),Gs={key:0,class:"page-body mt-3 overflow-y-auto"},Us={key:0},Vs={class:"bg-white overflow-hidden py-3 border-t-[0.5px] border-b4 border-solid"},Hs={class:"text-b3"},Ms={class:"bg-white myinput overflow-hidden py-3 border-t-[0.5px] border-b4 border-solid"},js={class:"text-b3"},qs={class:"flex items-center"},Ks=ke(()=>s("img",{class:"w-[16px] h-[16px]",src:uo,alt:"",srcset:""},null,-1)),zs={key:1,class:"flex items-baseline justify-between pt-3 border-t-[0.5px] border-b4 border-solid"},Js={class:"text-b3"},Ys={class:"text-right"},Qs={class:"text-base font-semibold"},Xs={key:0},Zs={class:"text-b3 mt-1"},ea={class:"bg-white mt-2.5 rounded-xl p-2.5"},ta={class:"text-sm font-bold"},oa={class:"flex items-baseline justify-between mt-1"},sa={class:"break-keep"},aa={class:"text-right"};const na={key:1,class:"flex flex-wrap items-center justify-end text-base font-semibold text-primary"},la={key:0,class:"justify-end flex-center"},ra=ke(()=>s("img",{src:_e,class:"w-4 h-4 mr-1"},null,-1)),ua={class:"opacity-60"},ia=ke(()=>s("div",{class:"h-10"},null,-1)),ca={class:"text-b3 text-base"},da={class:"flex items-center justify-end gap-x-2"},pa={class:"flex flex-col"},ma={class:"flex items-center gap-x-1"},fa={class:"text-sm text-b2"},ha=ke(()=>s("img",{src:_e,class:"w-4 h-4"},null,-1)),ya={class:"text-b1 text-lg font-BebasNeue"},va={key:0,class:"flex items-center justify-end gap-x-1 text-sm text-b2"},ga=ke(()=>s("img",{src:_t,class:"w-4 h-4"},null,-1)),ba={class:"relative"},wa={class:"p-3 pb-10 remark"},_a={class:"relative text-center text-lg font-bold mb-3"},Aa=Ae({name:"SubmitOrderBoutiqueCart"});function Sa(d){const{isKeyboardVisible:L}=zo(),{getUserDhKey:U,encryptAddressKey:x,formatAddressData:R,generateKey:he,decryptAddressKey:Ee}=_o(),{t:G}=po(),[te,se]=fe(!1),{loadingToggle:J}=Po(),{getAddress:ue,setAddress:ye}=qo(),{submit:De}=Ao(),xe=So(1),{tradeContributeSelfRate:Le,mcoinRate:r}=gt(),[y,O]=fe(!1),I=mo(),[Oe,Pe]=fe(!1),[ie,ce]=fe(!1),[$t,Tt]=fe(!0),[oe,F]=fe(!1),Ie=C([]),D=C(),N=C([]),Ct=C(0),$e=C({remark:""}),Te=C([]),Xe=Z(()=>[{value:0,text:G("common.no")},{value:1,text:G("common.yes")}]),Rt=(o,e)=>{e.isPortability=o.value},Ze=async()=>{if(ue()){D.value=ue(),ye(null);return}const o=I.currentRoute.value.path,e=await Vo();if(!e.success)return;Ie.value=e.data;const a=Ie.value.find(u=>u.isDefault===1)||Ie.value[0],n=await he("user",o);if(a!=null&&a.encryptFlag&&n){D.value=Ee(a,n);return}D.value=a},Fe="submit_order_infos",Bt=()=>{var o;try{ue()&&(D.value=ue(),ye(null));let e=sessionStorage.getItem(Fe);e&&(e=JSON.parse(e),N.value=e,(o=N.value)==null||o.forEach((a,n)=>{var u;(u=a.ordersInfos)==null||u.forEach((S,v)=>{var h;S.remark&&((h=Te.value[n][v])==null||h.setRemarkShow(!0))})}),sessionStorage.removeItem(Fe))}catch{console.error("恢复数据失败")}},Nt=async()=>{const o=await(await xe).allowance(K.order);Ct.value=o.result},V=fo(),_=Z(()=>Me()),et=C([]),We=async()=>{var n,u;let o=[];N.value.forEach(S=>{S.ordersInfos.forEach(v=>{v.goods.forEach(h=>{o.push({goodsId:h.goodsId,num:h.number,payType:we.MC,paySource:S.paySource})})})});const e={type:((n=V==null?void 0:V.query)==null?void 0:n.type)??2,addressId:(u=D.value)==null?void 0:u.id,detailList:o,genOrder:!1,voucherAmount:0},a=await wt(e);a.success&&(et.value=a.data.goodsList||[])},Et=async()=>{var a;const o=await jo({type:((a=V==null?void 0:V.query)==null?void 0:a.type)??2});if(!o.success){setTimeout(()=>{I.back()},1500);return}const e=N.value.map(n=>n.paySource);N.value=(o.data.ordersInfos||[]).map((n,u)=>{let S=we.MC;return{...n,goods:n.orderGoods,totalAmount:0,integral:0,remark:"",payType:S,paySource:e[u]||$.WALLET}}),Dt()},Dt=()=>{const o=N.value.map(n=>n.paySource),e=N.value.reduce((n,u)=>(u.goods.forEach(S=>{n.push({...u,goods:S,storeId:u.stores.id,cardNo:"",isPortability:0})}),n),[]),a=Ot(e);N.value=a.map((n,u)=>{var B;const S=(B=n[0])==null?void 0:B.goods,v=(S==null?void 0:S.goodsType)!==ge.SD,h=o[u]||(v?$.WITHDRAW_POINTS:$.WALLET),A=Lt(n);return{goodsBoutiqueFlag:v,paySource:h,ordersInfos:A}})},Lt=o=>o.reduce((e,a)=>{const n=e.findIndex(u=>u.storeId===a.storeId);return n!==-1?(e[n].goods.push(a.goods),+a.goods.goodsTypes===re.RECHARGE&&(e[n].goodTypes=re.RECHARGE)):e.push({...a,goods:[a.goods],goodTypes:+a.goods.goodsTypes===re.RECHARGE?re.RECHARGE:null}),e},[]),Ot=o=>{let e={};for(;o.length;){let a=o.shift();const n=a.goods.goodsType?"true":"false";e[n]=e[n]||[],e[n].push(a)}return Object.keys(e).map(a=>e[a])},It=async(o,e)=>{o.number=+e,J(!0),await $o({goodsId:o.goodsId,number:+e}),await We(),J(!1),ao()},Ft=()=>{N.value.forEach(o=>{o.ordersInfos.forEach(e=>{var a,n;e.storeId===((a=$e.value)==null?void 0:a.storeId)&&(e.remark=(n=$e.value)==null?void 0:n.remark)})})},Wt=C($.WITHDRAW_POINTS),Gt=(o,e)=>{oe.value||(e.paySource=o,e.boutiqueIntegral=Me([{ordersInfos:e.ordersInfos,paySource:e.paySource}]),We())};let Y=C(!1);const Ut=async()=>{const o=N.value.reduce((e,a)=>{const n=e.findIndex(u=>u.storeId===a.paySource);return n!==-1?e[n].totalAmount+=a.totalAmount-a.voucherAmount:e.push({paySource:a.paySource,totalAmount:a.totalAmount-a.voucherAmount}),e},[]);for(let e=0;e<o.length;e++){const a=o[e],{totalAmount:n}=a,{paySource:u}=a;+u===$.WITHDRAW_POINTS?await Mt(n):+u===$.PIGGY_BANK?await Kt(n):+u===$.WALLET?await zt(n):+u===$.USDT_WALLET&&await Vt(n)}},Vt=async o=>{if(+Ve.value<+o*qe.value)return Y.value=!0,se(!0);Y.value=!1},xa=Z(()=>P(+new m(Me(N.value.filter(o=>o.goodsBoutiqueFlag)).totalAmount).div(.9))),Ce=C(0),{pointBalances:Ht}=gt(),Ge=async()=>{Ce.value=+await Ht(),console.log("pointBalance:",Ce.value)},Mt=async o=>{if(await Ge(),+ +m(Ce.value).times(.9)<+o)return Y.value=!0,se(!0);Y.value=!1},Re=C([]),{userMerchantCashs:jt,userTotalAmount:qt}=Ko(),tt=async()=>{const{success:o,result:e}=await jt();if(!o)return;let a=0;const n=+await qt(),u=e.amounts.map(v=>Co(v));e.cashIds.map(v=>+v).forEach((v,h)=>{Re.value[v]=u[h],v!==0&&(a=+m(a).plus(u[h]||0).toString())}),Re.value[0]=+m(n).minus(a)},ot=Z(()=>Re.value.length&&+Re.value[0]||0),Kt=async o=>{if(+ot.value<+o)return Y.value=!0,se(!0);Y.value=!1},Ue=C(0),st=C(0),Ve=C(0),at=async()=>{const{balanceOf:o}=Ye(K.MCOIN),e=await o();Ue.value=+e,st.value=+await Ye(K.FMCP).balanceOf(),Ve.value=+await Ye(K.USDT).balanceOf()},zt=async o=>{if(+Ue.value<+o)return Y.value=!0,se(!0);Y.value=!1},Jt=C(null),ve=C(0),nt=()=>{var o,e;F(!0);try{if(!D.value)return le(G("order.setAddress")),!1;if((o=D.value)!=null&&o.encryptFlag&&!((e=D.value)!=null&&e.success))return le(G("order.reconfirm the information")),!1;if(!Ro(D.value.telNumber))return le(G("address.number was identified")),!1}finally{F(!1)}return!0},lt=async()=>{var n,u,S;let o=[],e=[],a=!1;if(N.value.forEach(v=>{v.ordersInfos.forEach(h=>{h.goodTypes===re.RECHARGE&&(+h.cardNo||(a=!0)),h.goods.forEach(A=>{if(A.number>A.stock&&+A.goodsTypes!=2){let B=A.goodsName;A.goodsName.length>10&&(B=A.goodsName.slice(0,10)+"..."),e.push(B)}o.push({goodsId:A.goodsId,num:A.number,payType:we.MC,paySource:v.paySource})})})}),a)return F(!1),le(G("order.Please fill in your phone number")),!1;if(e.length>0)return F(!1),le(e.join()+"  "+G("order.Insufficient stock")),!1;try{const v=I.currentRoute.value.path,h=await he("user",v);let A;h&&!D.value.encryptFlag&&(A=x(D.value,h),await Ho({...A,isDefault:D.value.isDefault?1:0}));let B=[];for(let Q=0;Q<N.value.length;Q++){const X=N.value[Q];for(let j=0;j<X.ordersInfos.length;j++){const p=X.ordersInfos[j];let b=p.remark;if(+p.goodTypes===re.RECHARGE&&(b=G("order.phoneNumber")+String(p.cardNo).concat(p.isPortability===1?` ${G("order.Number Portabilit")} `:"").concat("，").concat(p.remark)),B.findIndex(c=>c.storeId===p.storeId)===-1){let c={};if(p.encryption){const W=await U(p.stores.id,(n=p.encryption)==null?void 0:n.publicKey);W?(c=R(c,{...D.value,postscript:b},1),c=x(c,W),c.submitHash=c.hash):c=R(c,{...D.value,postscript:b},0)}else c=R(c,{...D.value,postscript:b},0);B.push({storeId:p.storeId,...c})}}}return{type:((u=V==null?void 0:V.query)==null?void 0:u.type)??2,addressId:D.value.id,postscripts:B,detailList:o,genOrder:!0,voucherAmount:((S=_.value)==null?void 0:S.voucherAmount)||0}}catch{return!1}},Yt=async()=>{if(!oe.value&&await nt()){if(F(!0),await at(),await tt(),await Ut(),Y.value){F(!1);return}if(te.value){F(!1);return}F(!0);try{const o=await lt();if(!o)return;const e=await wt(o);if(!e.success){F(!1);return}const{allOrderId:a,merchants:n,discounts:u,amounts:S,sources:v}=e.data,h=await De(a,n,u,S,v);if(!h.success){setTimeout(()=>{I.push({path:"/buyerOrderList",query:{active:0},replace:!0})},1e3);return}if(le.loading({message:G("order.wait block chain"),forbidClick:!0,duration:0}),await Mo({allOrderId:a,hash:h.result.hash}),le.clear(),Jt.value=h.result.hash,!h.result.hash)return;let A;const B=async()=>{if(ve.value>=5){F(!1),Pe(!0),ve.value=0;return}if(A=await To(h.result.hash),(A==null?void 0:A.status)===1){F(!1),O(!0),ve.value=0,Xt();return}setTimeout(async()=>{ve.value++,B()},5e3)};B()}catch{F(!1),ve.value=0}finally{N.value.forEach((o,e)=>{var a;rt.value[`paySwitch${e}`].setpayValue((a=o.paySource)==null?void 0:a.toString())})}}},rt=C({}),Qt=(o,e)=>{o&&(rt.value[`paySwitch${e}`]=o)},Xt=()=>{setTimeout(()=>{O(!1),I.replace({path:"buyerOrderList",query:{active:1}})},1500)},He=C(1),Zt=async()=>{He.value=await Le()},Me=o=>{let e=0,a=0,n=0,u=0,S=0,v=0,h=0,A=0,B=0,ae=0,Q=st.value,X=0,j=null;return(o||N.value).forEach(p=>{p.totalAmount=0,p.integral=0,p.totalNum=0,p.voucherAmount=0,p.pointFee=0,p.ordersInfos.forEach(b=>{b.fmGeneralActivity&&!j&&(j=b.fmGeneralActivity),b.totalAmount=0,b.integral=0,b.totalNum=0,b.voucherAmount=0,b.pointFee=0,b.goods.forEach(c=>{h+=+c.number;const W=+new m(c.price).times(c.number),ne=+new m(new m(c.price).times(c.number).minus(c.goodsActivityReduceAmount||0).times(p.paySource===$.WITHDRAW_POINTS&&c.balanceDiscountRatio||c.discountRatio)).div(100);X=new m(X).plus(c.goodsActivityReduceAmount||0).toNumber();const q=p.paySource===$.WITHDRAW_POINTS?Math.min(Q,c.goodsType>0?+new m(ne).times(.5):0):0,pe=[ge.SL,ge.PR].indexOf(c.goodsType)!==-1&&Number(c.discountRatio)>(c.goodsType===ge.SL?9:19)||c.goodsType===ge.ST?m(W).times(.5):0;e=+new m(e).plus(W),p.paySource===$.USDT_WALLET?(n=+new m(n).plus(new m(W).times(qe.value)),a=+new m(a).plus(new m(W).minus(q||0).minus(c.goodsActivityReduceAmount||0).times(qe.value)),B=+new m(B).plus(q)):(p.paySource!==$.PIGGY_BANK&&p.paySource!==$.WITHDRAW_POINTS&&(S=+new m(u).plus(W)),u=+new m(u).plus(W)),b.totalAmount=+new m(b.totalAmount).plus(W),p.totalAmount=+new m(p.totalAmount).plus(W),v=+new m(v).plus(ne),b.integral=+new m(b.integral).plus(ne),p.integral=+new m(p.integral).plus(ne),Q-=q,A+=q,c.voucherAmount=q,b.voucherAmount=+new m(b.voucherAmount).plus(q),p.voucherAmount=+new m(p.voucherAmount).plus(q),ae=+new m(ae).plus(pe),b.pointFee=+new m(b.pointFee).plus(pe),p.pointFee=+new m(p.pointFee).plus(pe),b.totalNum+=c.number,p.totalNum+=c.number})})}),{totalAmount:e,usdtAmount:a,originalUsdtAmount:n,mcAmount:u,integral:v,totalNum:h,voucherAmount:A,useVoucherAmount:B,pointFee:ae,approveMcAmount:S,activityReduceAmount:X,fmGeneralActivity:j}},je=C(null),eo=async()=>{je.value=await r()},qe=Z(()=>1/je.value),to=Z(()=>{const o=new m(_.value.totalAmount).minus(_.value.activityReduceAmount||0).minus(_.value.voucherAmount||0);return P(o)}),{payBy:de,payLink:Ke,payHelpRef:Be,changeBy:oo,generatePayLink:so,showChangeTip:ao}=Io(),no=vo(async()=>{var o;if(nt()){F(!0);try{if(Ke.value){Be.value&&((o=Be.value)==null||o.setShow(!0));return}const e=await lt();if(!e)return;so(e)}finally{F(!1)}}},500),lo=async()=>{var a;const o=ko().getCurrentAccount(),e=((a=V==null?void 0:V.query)==null?void 0:a.owner)||"";if(e&&!xo(o,e)){console.warn(`不属于${o}的订单流程，已返回购物车`),I.replace({path:"mallCart"});return}J(!0),Et(),at(),Zt(),tt(),Ge(),await eo(),await Nt(),await Ze(),await We(),J(!1),Tt(!1),await go(),Bt()};ho(()=>{Ze()});const ro=o=>{I.push(o)};return St(()=>{lo()}),(o,e)=>{const a=z("van-field"),n=z("van-popover"),u=z("VanButton"),S=z("van-icon"),v=z("van-popup");return f(),M(Oo,{title:o.$t("order.order"),class:"h-full font-Puhui font-normal relative px-3",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent"}},{default:w(()=>{var h,A,B,ae,Q,X,j,p,b,c,W,ne,q,pe,ut,it,ct,dt;return[g(Fo,{tab:t(de),onChangeTab:t(oo)},null,8,["tab","onChangeTab"]),t($t)?k("",!0):(f(),T("div",Gs,[g(Bo,{class:"mt-3",defaultAddress:D.value,sessionSaveInfo:N.value,sessionSaveKey:Fe,onClick:e[0]||(e[0]=i=>ro("/userAddress"))},null,8,["defaultAddress","sessionSaveInfo"]),(f(!0),T(Ne,null,yt(N.value,(i,me)=>{var pt,mt,ft;return f(),T("div",{key:i.goodsBoutiqueFlag},[g(Uo,{goodsBoutiqueFlag:i.goodsBoutiqueFlag},null,8,["goodsBoutiqueFlag"]),(f(!0),T(Ne,null,yt(i.ordersInfos,(E,ht)=>(f(),T("div",{key:ht,class:"bg-white rounded-xl p-3 mt-3"},[g(No,{ref:H=>{Te.value[me]=Te.value[me]||[],Te.value[me][ht]=H},orderInfo:E,expressGoodsList:et.value,payType:E.payType,onChangeNumber:e[1]||(e[1]=(H,ze)=>It(H,ze))},null,8,["orderInfo","expressGoodsList","payType"]),+(E==null?void 0:E.goodTypes)===t(re).RECHARGE?(f(),T("div",Us,[s("div",Vs,[g(a,{style:{padding:"0 !important"},"input-align":"right",type:"digit",autocomplete:"off",modelValue:E.cardNo,"onUpdate:modelValue":H=>E.cardNo=H,placeholder:o.$t("shop.pleaseInput")},{label:w(()=>[s("div",Hs,l(`${o.$t("order.Phone number")}`),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])]),s("div",Ms,[g(a,{style:{padding:"0 !important"},"input-align":"right",autocomplete:"off",label:`${o.$t("order.Whether to port your number")}`},{label:w(()=>[s("div",js,l(`${o.$t("order.Whether to port your number")}`),1)]),input:w(()=>[g(n,{show:E.showPopover,"onUpdate:show":H=>E.showPopover=H,actions:t(Xe),onSelect:H=>Rt(H,E),placement:"top-end"},{reference:w(()=>{var H;return[s("div",qs,[s("div",null,l(((H=t(Xe).find(ze=>ze.value==E.isPortability))==null?void 0:H.text)||""),1),Ks])]}),_:2},1032,["show","onUpdate:show","actions","onSelect"])]),_:2},1032,["label"])])])):k("",!0),t(de)===t(be).OWNER?(f(),T("div",zs,[s("div",Js,l(o.$t("order.total")),1),s("div",Ys,[s("div",Qs,[E.totalAmount>0?(f(),T("span",Xs,l(t(P)(E.totalAmount||0))+"Mcoin",1)):k("",!0)]),s("div",Zs,l(o.$t("order.getContribution",{num:t(P)(+new t(m)(E.integral).times(He.value||0))})),1)])])):k("",!0)]))),128)),t(de)===t(be).OWNER?(f(),T(Ne,{key:0},[s("div",ea,[s("div",ta,l(o.$t("order.priceDetail")),1),s("div",oa,[s("div",sa,l(o.$t("order.sumtotal")),1),s("div",aa,[(i.paySource,t($).WITHDRAW_POINTS,f(),T("div",na,[(i==null?void 0:i.totalAmount)>0?(f(),T("div",la,[ra,ee(" "+l(t(P)((i==null?void 0:i.totalAmount)||0)),1)])):k("",!0)])),s("div",ua,l(o.$t("order.getContribution",{num:t(P)(+new t(m)(i==null?void 0:i.integral).times(He.value||0))})),1)])]),i.paySource===t($).WITHDRAW_POINTS&&((pt=t(_))==null?void 0:pt.pointFee)>0?(f(),M(Jo,{key:0,num:i==null?void 0:i.totalNum,amount:i==null?void 0:i.totalAmount,fee:(mt=t(_))==null?void 0:mt.pointFee},null,8,["num","amount","fee"])):k("",!0)]),g(vs,{ref:E=>Qt(E,me),boutique:i.goodsBoutiqueFlag,class:"bg-white mt-2.5 rounded-xl",checked:(ft=i.paySource)==null?void 0:ft.toString(),clickable:!t(oe),"point-balance":Ce.value,"wallet-balance":Ue.value,piggyBalance:t(ot),usdtBalance:Ve.value,payAmount:i==null?void 0:i.totalAmount,usdtRate:je.value,onOnChange:E=>Gt(E,i),onGetPointBalance:Ge},null,8,["boutique","checked","clickable","point-balance","wallet-balance","piggyBalance","usdtBalance","payAmount","usdtRate","onOnChange"])],64)):k("",!0)])}),128)),t(de)===t(be).OWNER?(f(),M(Ws,{key:0,totalPrice:(h=t(_))==null?void 0:h.mcAmount,"usdt-price":(A=t(_))==null?void 0:A.usdtAmount,"original-usdt-price":(B=t(_))==null?void 0:B.originalUsdtAmount,showTotalPrice:(ae=t(_))==null?void 0:ae.totalAmount,"voucher-price":(Q=t(_))==null?void 0:Q.voucherAmount,"use-voucher-amount":(X=t(_))==null?void 0:X.useVoucherAmount,"activity-reduce-amount":(j=t(_))==null?void 0:j.activityReduceAmount,"fm-general-activity":(p=t(_))==null?void 0:p.fmGeneralActivity,symbol:"Mcoin"},null,8,["totalPrice","usdt-price","original-usdt-price","showTotalPrice","voucher-price","use-voucher-amount","activity-reduce-amount","fm-general-activity"])):k("",!0),ia,t(de)===t(be).OWNER?(f(),T("div",{key:1,class:yo(["fixed bottom-0 sm:left-1/2 sm:-translate-x-2/4 left-0 z-20 sm:w-[375px] w-full bg-b6 px-3 py-4 safe-btn-bottom-bottom flex-center-bw border-t border-solid border-b5",t(L)?"!hidden":"!fixed"])},[s("div",ca,l(o.$t("order.quantity",{number:(b=t(_))==null?void 0:b.totalNum})),1),s("div",da,[s("div",pa,[s("div",ma,[s("span",fa,l(o.$t("order.sumtotal"))+":",1),ha,s("span",ya,l(t(P)(t(to))),1)]),(c=t(_))!=null&&c.voucherAmount?(f(),T("div",va,[s("span",null,l(o.$t("voucher.deduction"))+":",1),ga,s("span",null,l(t(P)((W=t(_))==null?void 0:W.voucherAmount)),1)])):k("",!0)]),s("div",ba,[(ne=t(_))!=null&&ne.usdtAmount?(f(),M(Qe,{key:0,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:t(K).order,token:t(K).USDT,symbol:"USDT",loading:t(oe),approveAmount:Number((q=t(_))==null?void 0:q.usdtAmount)},null,8,["contract","token","loading","approveAmount"])):k("",!0),(pe=t(_))!=null&&pe.approveMcAmount?(f(),M(Qe,{key:1,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:t(K).order,token:t(K).MCOIN,symbol:"mcoin",loading:t(oe),approveAmount:Number((ut=t(_))==null?void 0:ut.approveMcAmount)},null,8,["contract","token","loading","approveAmount"])):k("",!0),(it=t(_))!=null&&it.voucherAmount?(f(),M(Qe,{key:2,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:t(K).order,token:t(K).FMCP,symbol:o.$t("voucher.voucher"),loading:t(oe),approveAmount:Number((ct=t(_))==null?void 0:ct.voucherAmount)},null,8,["contract","token","symbol","loading","approveAmount"])):k("",!0),g(u,{class:"bg-yellow text-b1 font-semibold w-[120px] h-[46px] rounded-full",loading:t(oe),onClick:Yt},{default:w(()=>[ee(l(o.$t("common.pay")),1)]),_:1},8,["loading"])])])],2)):t(de)===t(be).OTHER?(f(),M(Wo,{key:2,"pay-link":t(Ke),"btn-loading":t(oe),onOnClick:t(no)},null,8,["pay-link","btn-loading","onOnClick"])):k("",!0),g(v,{onClose:Ft,show:t(ie),"onUpdate:show":e[5]||(e[5]=i=>vt(ie)?ie.value=i:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:w(()=>[s("div",wa,[s("div",_a,[ee(l(o.$t("order.submitOrder"))+" ",1),s("div",{class:"absolute right-0 bottom-[-2px]",onClick:e[2]||(e[2]=i=>t(ce)(!1))},[g(S,{name:"cross"})])]),g(a,{modelValue:$e.value.remark,"onUpdate:modelValue":e[3]||(e[3]=i=>$e.value.remark=i),rows:"4",autosize:"",type:"textarea",maxlength:"200",placeholder:o.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"]),g(u,{class:"mt-4 bg-btnOrBg w-full h-[46px] text-b1 rounded-full text-base font-semibold",onClick:e[4]||(e[4]=i=>t(ce)(!1))},{default:w(()=>[ee(l(o.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show"]),t(y)?(f(),M(bt,{key:3,onClose:e[6]||(e[6]=i=>t(O)(!1)),text:o.$t("common.pay success")},null,8,["text"])):k("",!0),t(Oe)?(f(),M(bt,{key:4,isError:!0,onClose:e[7]||(e[7]=i=>t(Pe)(!1)),text:o.$t("order.fail")},null,8,["text"])):k("",!0),g(Eo,{paySource:Wt.value,show:t(te),onClose:e[8]||(e[8]=i=>t(se)(!1))},null,8,["paySource","show"])])),g(Go,{ref:(i,me)=>{me.payHelpRef=i,vt(Be)&&(Be.value=i)},amount:(dt=t(_))==null?void 0:dt.totalAmount,link:t(Ke)},null,8,["amount","link"])]}),_:1},8,["title"])}}const ka=Ae({...Aa,setup:Sa}),rn=At(ka,[["__scopeId","data-v-98f177f2"]]);export{rn as default};
