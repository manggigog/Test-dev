import{_ as Z}from"./MCOIN-BcbOHmhy.js";import{_ as Ve}from"./FMCP-CFalj3L2.js";import{y as ve,F as b,G as m,H as s,a2 as p,Q as a,P as t,a0 as B,I as me,_ as vt,w as pt,a1 as ft,l as yt,bw as L,r as d,bN as ht,x,B as W,z as bt,bj as gt,D as _t,E as D,O as c,K as j,N as k,bO as wt,R as xt,$ as At,Y as $t,Z as St,T as $}from"./vendor-BUT0HZ5j.js";import{_ as kt}from"./AddressInfo-CgO24TCv.js";import{_ as Ee}from"./EmptyTipsPop-_FH8A6A8.js";import{P as Ct}from"./PaySwitchPop-mXZNlI36.js";import{_ as Fe}from"./USDT-BFPkoPAz.js";import{d as g,R as Pt,o as Tt,e as Rt,q as I,r as Lt,a1 as Dt,bu as It}from"./index-DDhEkd_5.js";import{P as S,O as ie}from"./order-H59PKTFP.js";import{O as Bt}from"./OrderGoodsBox-Bl5qzppE.js";import{B as Nt}from"./BackIcon-biFt6cm7.js";import{q as Gt,c as Et}from"./address-bbWsHk9x.js";import{q as Ot}from"./goods-BN-I6ngE.js";import{m as Oe,p as Vt,r as Ft,t as qt,u as Mt}from"./order-Cwtc0PLp.js";import{a as Ut,u as Wt}from"./useSelectAddress-CgNt0r_o.js";import{G as de}from"./goods-BVwS8oFG.js";import{_ as ce}from"./SubmitApprove-Dc2UKvrT.js";import{S as jt}from"./shop-CeqcS6K2.js";import{u as zt}from"./useKeyboard-BQnXF61Y.js";import{u as Ht}from"./usePaymentBalance-BjDbB2s2.js";import{P as Kt}from"./PaymentMethodSelector-BNlWm5_K.js";import"./mall-BNNzTN-n.js";import"./OrderGoods-6Orhet_M.js";import"./BoutiqueLable-r45nG6V6.js";import"./flashSale-DDyqLyYN.js";import"./ShopMaskTips-dKZ6_BUi.js";import"./enums-DlE-aiss.js";import"./piggyBank-CZvVqYBn.js";import"./point-arrow-BVnEJLj4.js";import"./usePointRelase-wWF_EDK_.js";const Qt={class:"bg-white mt-3 p-3 rounded-xl"},Yt={class:"text-base font-semibold"},Zt={class:"flex items-start justify-between mt-3"},Jt={class:"text-b3"},Xt={class:"text-right"},es={key:0,class:"flex items-center justify-end gap-1 font-semibold"},ts=s("img",{src:Fe,class:"w-4 h-4"},null,-1),ss={key:1,class:"flex items-center justify-end gap-1 font-semibold"},os=s("img",{src:Z,class:"w-4 h-4"},null,-1),as={key:0,class:"actPrice flex items-baseline justify-between mt-3"},ns={class:"text-b3 max-w-[100px] line-clamp-1"},ls={class:"text-right flex items-center justify-end gap-1"},rs=B(" -"),us=s("img",{src:Z,class:"w-4 h-4"},null,-1),is=s("div",{class:"w-full h-[1px] bg-[#F6F6F5] my-3"},null,-1),ds={class:"flex items-center justify-between"},cs={class:"text-b3"},ms={class:"gap-1 text-right flex-center text-b1 font-semibold"},vs=s("img",{src:Fe,class:"w-4 h-4"},null,-1),ps=s("span",{class:"text-b3"},"(",-1),fs=s("img",{src:Z,class:"w-4 h-4"},null,-1),ys={key:1,class:"text-b3"},hs=B("+ "),bs=s("img",{src:Ve,class:"w-4 h-4"},null,-1),gs={key:1,class:"text-xs text-b3 text-right"},_s=ve({props:{paySource:null,totalAmount:null,usdtAmount:null,voucherAmount:null,symbol:null,activityReduceAmount:null,fmGeneralActivity:null,actualAmount:null},setup(l){return(T,pe)=>{var N;return m(),b("div",Qt,[s("div",Yt,a(T.$t("order.totalPriceDetail")),1),s("div",Zt,[s("div",Jt,a(T.$t("order.goodsPrice")),1),s("div",Xt,[l.paySource===t(S).USDT_WALLET?(m(),b("div",es,[ts,s("span",null,a(t(g)(l.usdtAmount||0)),1)])):(m(),b("div",ss,[os,s("span",null,a(t(g)(l.totalAmount||0)),1)]))])]),l.activityReduceAmount&&l.fmGeneralActivity?(m(),b("div",as,[s("div",ns,a((N=l.fmGeneralActivity)==null?void 0:N.name),1),s("div",ls,[rs,us,s("span",null,a(t(g)(l.activityReduceAmount)),1)])])):p("",!0),is,s("div",ds,[s("div",cs,a(T.$t("common.actual_payment")),1),s("div",ms,[l.usdtAmount>0?(m(),b(me,{key:0},[vs,s("span",null,a(t(g)(l.usdtAmount||0)),1),ps],64)):p("",!0),fs,s("span",null,a(t(g)(l.actualAmount)),1),l.usdtAmount>0?(m(),b("span",ys,")")):p("",!0),l.voucherAmount?(m(),b(me,{key:2},[hs,bs,B(a(t(g)(l.voucherAmount)),1)],64)):p("",!0)])]),l.usdtAmount>0?(m(),b("div",gs,a(`(${t(g)(l.usdtAmount||0)} USDT${T.$t("offline.auto_exchange")} ${l.actualAmount||0} MCOIN)`),1)):p("",!0)])}}}),J=l=>($t("data-v-1e349a2c"),l=l(),St(),l),ws={key:0,class:"relative w-full h-full p-3 font-Puhui safe-bottom-page"},xs={class:"text-lg font-semibold"},As={class:"bg-white rounded-xl p-3 mt-3"},$s={class:"mt-3 flex items-center justify-between gap-2"},Ss={class:"flex-1 text-b3"},ks={class:"text-b1 text-right line-clamp-1"},Cs={key:0},Ps={class:"bg-white overflow-hidden mt-3 py-3 border-y border-b5 border-solid"},Ts={class:"text-b3"},Rs={class:"bg-white myinput overflow-hidden py-3"},Ls={class:"text-b3"},Ds={class:"bg-white my-3 rounded-xl p-3"},Is={class:"text-base font-semibold"},Bs={class:"flex items-baseline justify-between"},Ns={class:"text-b3 whitespace-nowrap"},Gs={class:"text-right"},Es={class:"text-base font-semibold"},Os={class:"text-b3 text-right mt-1"},Vs=J(()=>s("div",{class:"h-10"},null,-1)),Fs={class:"text-left text-sm text-b3"},qs={class:"flex-center gap-3"},Ms={class:"flex-end gap-1 font-bold text-base"},Us=J(()=>s("img",{src:Z,class:"w-4 h-4"},null,-1)),Ws=J(()=>s("span",null,"+",-1)),js=J(()=>s("img",{src:Ve,class:"w-4 h-4"},null,-1)),zs={class:"relative"},Hs={class:"p-3 pb-10 remark"},Ks={class:"relative text-center text-lg font-bold mb-3"},Qs=ve({name:"SubmitOrder"});function Ys(l){var Ne;const{isKeyboardVisible:T}=zt(),{getUserDhKey:pe,encryptAddressKey:N,formatAddressData:fe,generateKey:ye,decryptAddressKey:qe}=Pt(),{t:h}=pt(),{loadingToggle:he}=Lt(),{getAddress:be,setAddress:ge}=Wt(),{getRemark:_e,setRemark:we}=Ut(),{submit:Me}=Tt(),z=ft(),G=yt(),[Ue,X]=L(!1),[ee,te]=L(!1),[We,xe]=L(!0),[E,_]=L(!1),[je,Ae]=L(!1),[ze,$e]=L(!1),se=d([]),v=d(),u=d(),Se=d(),H=d(""),oe=d(0),C=d(""),w=ht("number",1),ke=d([]),K=x(()=>{var e,o;return Number((o=(e=u.value)==null?void 0:e.goods)==null?void 0:o.type)!==jt.SD}),{balanceState:O,paymentOptions:He,fetchAllBalances:Ce,autoSelectPaymentMethod:Ke,checkSufficientBalance:Qe}=Ht(K),Ye=x(()=>[{value:0,text:h("common.no")},{value:1,text:h("common.yes")}]),ae=x(()=>{const e=De.value,o=F.value,r=e==null?void 0:e.fullAmount;return e&&typeof r=="number"&&typeof o=="number"&&o>=r&&e.reduceAmouint||0}),Q=x(()=>new W(F.value).minus(ae.value||0).minus(P.value||0).toNumber()),Ze=e=>{we(e)},Je=()=>{if(_e()){C.value=_e(),ge(null);return}},i=d(S.WALLET),V=e=>{E.value||(i.value=e)},F=x(()=>{var e;return+new W(g((e=u.value)==null?void 0:e.goods.price)).times(w.value||1)}),ne=x(()=>F.value-ae.value),Pe=x(()=>i.value===S.USDT_WALLET?W(ne.value).dividedBy(O.usdtRate).toString():0);bt(K,()=>{K.value?V(S.WITHDRAW_POINTS):V(S.WALLET)},{immediate:!0});const Te=x(()=>new W(u.value.goods.discountRatio).times(ne.value||0).times(O.pointSelfRate).div(100).toString()),Re=x(()=>Math.min(O.voucherBalance,new W(Te.value).div(O.pointSelfRate).times(.5).toNumber())),P=x(()=>i.value===S.WITHDRAW_POINTS?Re.value:0),Xe=async()=>{if(be()){v.value=be(),ge(null);return}const e=G.currentRoute.value.path,o=await Gt();if(!o.success)return;se.value=o.data;const r=se.value.find(A=>A.isDefault===1)||se.value[0],f=await ye("user",e);if(r!=null&&r.encryptFlag&&f){v.value=qe(r,f);return}v.value=r},Le=d(null),De=d(null),et=async()=>{var o,r;const e=await Ot(+z.query.id);e.success&&(u.value=e.data,Se.value=e.data.fmStoredCard,Le.value=e.data.fmGeneralActivity||null,De.value=e.data.fmGeneralActivityRule||null,(r=(o=e.data)==null?void 0:o.fmGeneralActivityGoods)!=null&&r.activityPrice&&(u.value.goods.price=e.data.fmGeneralActivityGoods.activityPrice))},le=d(!1),tt=e=>{let o=u.value.fmGeneralActivityGoods;o&&e>+(o==null?void 0:o.activityStock)?(le.value||$("当前加购超出活动库存将恢复原价"),le.value=!0):le.value=!1,e<1?w.value=1:w.value=e,Ie()},Ie=async()=>{var f,A;let e=[];e.push({goodsId:u.value.goods.id,num:w.value,payType:ie.MC,paySource:i.value});const o={type:((f=z==null?void 0:z.query)==null?void 0:f.type)??2,addressId:(A=v.value)==null?void 0:A.id,detailList:e,genOrder:!1},r=await Oe(o);r.success&&(ke.value=r.data.goodsList||[])},st=wt(async()=>{var e,o;_(!0);try{if(!v.value)return $(h("order.setAddress"));if(+u.value.goods.goodsTypes===de.RECHARGE&&!+H.value)return $(h("order.Please fill in your phone number"));if(u.value.goods.stock<+w.value&&+u.value.goods.goodsTypes!=2)return $(h("order.Insufficient stock"));if((e=v.value)!=null&&e.encryptFlag&&!((o=v.value)!=null&&o.success))return $(h("order.reconfirm the information"));if(!Dt(v.value.telNumber))return $(h("address.number was identified"))}finally{_(!1)}if(_(!0),!Qe(i.value,Q.value))return _(!1),Ae(!0);nt()},500),ot=d(null),q=d(0),at=d(null),nt=async()=>{var e;_(!0);try{const o=G.currentRoute.value.path;await Vt({goodsId:u.value.goods.id,number:w.value}),await Ft({type:1});let r=C.value;+u.value.goods.goodsTypes===de.RECHARGE&&(r=h("order.phoneNumber")+String(H.value).concat(oe.value===1?` ${h("order.Number Portabilit")} `:"").concat("，").concat(C.value));const f=await pe(u.value.stores.id),A=await ye("user",o);let Y;A&&!v.value.encryptFlag&&(Y=N(v.value,A),await Et({...Y,isDefault:v.value.isDefault?1:0}));let y={};f?(y=fe(y,{...v.value,postscript:r},1),y=N(y,f),y.submitHash=y.hash):y=fe(y,{...v.value,postscript:r},0);let ue={type:1,postscripts:[{storeId:u.value.stores.id,...y}],detailList:[{goodsId:u.value.goods.id,num:w.value,payType:ie.MC,paySource:i.value}],voucherAmount:P.value||0};const M=await Oe(ue);if(!M.success){_(!1);return}const{allOrderId:n,merchants:it,discounts:dt,amounts:ct,sources:mt}=M.data;try{const R=await Me(n,it,dt,ct,mt);if(!R.success){qt({allOrderId:n}),R.result.reason==="execution reverted: ERC20: transfer amount exceeds balance"&&$(h("errorMsg.transfer amount exceeds balance")),setTimeout(()=>{G.push({path:"/buyerOrderList",query:{active:0},replace:!0})},1e3);return}if($.loading({message:h("order.wait block chain"),forbidClick:!0,duration:0}),await Mt({allOrderId:n,hash:R.result.hash}),$.clear(),ot.value=R.result.hash,!R.result.hash)return;let U;const Ge=async()=>{if(q.value>=5){_(!1),$e(!0),q.value=0;return}if(U=await It(R.result.hash),(U==null?void 0:U.status)===1){console.log("hash 查询 成功",U),X(!0),q.value=0,lt(),_(!1);return}setTimeout(async()=>{q.value++,Ge()},5e3)};Ge()}catch{q.value=0,_(!1)}}catch{_(!1)}finally{(e=at.value)==null||e.setpayValue(i==null?void 0:i.value.toString())}},lt=()=>{setTimeout(()=>{X(!1),G.replace({path:"buyerOrderList",query:{active:1,type:1}})},1500)},{accountStore:re}=Rt();re.account||((Ne=re.sign)==null||Ne.address);const rt=async()=>{if(re.isLogin){he(!0),xe(!0);try{await Promise.all([Xe(),et(),Ce(),Je()]),Ie();const e=Ke(Q.value,Re.value);V(e)}catch(e){console.error("Failed to initialize payment method:",e)}finally{he(!1),xe(!1)}}},Be=d(!0),ut=e=>{Be.value=!1,G.push(e)};return gt(()=>{Be.value&&we("")}),_t(()=>{w.value=1,rt()}),(e,o)=>{var M;const r=D("van-icon"),f=D("van-field"),A=D("van-dropdown-item"),Y=D("van-dropdown-menu"),y=D("VanButton"),ue=D("VanPopup");return t(We)?p("",!0):(m(),b("div",ws,[s("header",xs,[c(Nt,null,{default:k(()=>[s("span",null,a(e.$t("order.submitOrder")),1)]),_:1})]),c(kt,{class:"mt-3",defaultAddress:v.value,onClick:o[0]||(o[0]=n=>ut("/userAddress"))},null,8,["defaultAddress"]),s("div",As,[c(Bt,{orderInfo:u.value,number:t(w),payType:t(ie).MC,card:Se.value,expressGoodsList:ke.value,onChangeNumber:tt},null,8,["orderInfo","number","payType","card","expressGoodsList"]),s("div",$s,[s("div",Ss,a(e.$t("order.remark")),1),s("div",{class:"flex-1 flex items-center justify-end",onClick:o[1]||(o[1]=n=>t(te)(!0))},[s("div",ks,a(C.value?C.value:e.$t("order.noRemark")),1),c(r,{name:"arrow"})])]),+((M=u.value.goods)==null?void 0:M.goodsTypes)===t(de).RECHARGE?(m(),b("div",Cs,[s("div",Ps,[c(f,{style:{padding:"0 !important"},"input-align":"right",type:"digit",autocomplete:"off",modelValue:H.value,"onUpdate:modelValue":o[2]||(o[2]=n=>H.value=n),placeholder:e.$t("shop.pleaseInput")},{label:k(()=>[s("div",Ts,a(`${e.$t("order.Phone number")}`),1)]),_:1},8,["modelValue","placeholder"])]),s("div",Rs,[c(f,{style:{padding:"0 !important"},"input-align":"right",autocomplete:"off",label:`${e.$t("order.Whether to port your number")}`},{label:k(()=>[s("div",Ls,a(`${e.$t("order.Whether to port your number")}`),1)]),input:k(()=>[c(Y,{"active-color":"#FEA021"},{default:k(()=>[c(A,{modelValue:oe.value,"onUpdate:modelValue":o[3]||(o[3]=n=>oe.value=n),options:t(Ye)},null,8,["modelValue","options"])]),_:1})]),_:1},8,["label"])])])):p("",!0)]),s("div",Ds,[s("div",Is,a(e.$t("order.priceDetail")),1),s("div",Bs,[s("div",Ns,a(e.$t("order.total")),1),s("div",Gs,[s("div",Es,a(t(g)(t(F)))+"MCOIN ",1)])]),s("div",Os,a(e.$t("order.getContribution",{num:t(Te)})),1)]),c(Kt,{modelValue:i.value,"onUpdate:modelValue":o[4]||(o[4]=n=>i.value=n),"payment-options":t(He),loading:t(O).loading,boutique:t(K),onChange:V,onGetPointBalance:t(Ce)},null,8,["modelValue","payment-options","loading","boutique","onGetPointBalance"]),c(_s,{"pay-source":i.value,"total-amount":t(F),"voucher-amount":t(P),"usdt-amount":t(Pe),"actual-amount":t(Q),symbol:i.value===t(S).USDT_WALLET?"USDT":"MCOIN","activity-reduce-amount":t(ae),"fm-general-activity":Le.value},null,8,["pay-source","total-amount","voucher-amount","usdt-amount","actual-amount","symbol","activity-reduce-amount","fm-general-activity"]),Vs,s("div",{class:xt(["fixed bottom-0 sm:left-1/2 sm:-translate-x-2/4 left-0 z-20 sm:w-[375px] w-full bg-white box-shadow safe-bottom p-3 flex-center-bw",t(T)?"!hidden":"!fixed"])},[s("div",Fs,[s("div",null,a(e.$t("order.quantity",{number:t(w)})),1),s("div",null,a(e.$t("order.sumtotal")),1)]),s("div",qs,[s("div",Ms,[Us,s("span",null,a(t(g)(t(Q))),1),t(P)?(m(),b(me,{key:0},[Ws,js,s("span",null,a(t(g)(t(P))),1)],64)):p("",!0)]),s("div",zs,[[t(S).WALLET].includes(i.value)?(m(),j(ce,{key:0,class:"absolute btn-orange btn-shadow w-[120px] h-[40px] text-white z-10",contract:t(I).order,token:t(I).MCOIN,symbol:"MCOIN",loading:t(E),approveAmount:Number(t(ne))},null,8,["contract","token","loading","approveAmount"])):p("",!0),[t(S).USDT_WALLET].includes(i.value)?(m(),j(ce,{key:1,class:"absolute btn-orange btn-shadow w-[120px] h-[40px] text-white z-10",contract:t(I).order,token:t(I).USDT,symbol:"USDT",loading:t(E),approveAmount:Number(t(Pe))},null,8,["contract","token","loading","approveAmount"])):p("",!0),t(P)>0?(m(),j(ce,{key:2,class:"absolute btn-orange btn-shadow w-[120px] h-[40px] text-white z-10",contract:t(I).order,token:t(I).FMCP,symbol:e.$t("voucher.voucher"),loading:t(E),approveAmount:Number(t(P))},null,8,["contract","token","symbol","loading","approveAmount"])):p("",!0),c(y,{type:"primary",class:"btn-orange btn-shadow w-[120px] h-[40px] text-white text-red-600 px-4 py-2 bg-gray3",loading:t(E),onClick:t(st)},{default:k(()=>[B(a(e.$t("common.pay")),1)]),_:1},8,["loading","onClick"])])])],2),c(ue,{show:t(ee),"onUpdate:show":o[8]||(o[8]=n=>At(ee)?ee.value=n:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:k(()=>[s("div",Hs,[s("div",Ks,[B(a(e.$t("order.submitOrder"))+" ",1),s("div",{class:"absolute right-0 bottom-[-2px] text-lg",onClick:o[5]||(o[5]=n=>t(te)(!1))},[c(r,{name:"cross"})])]),c(f,{"onUpdate:modelValue":[Ze,o[6]||(o[6]=n=>C.value=n)],modelValue:C.value,rows:"4",autosize:"",type:"textarea",maxlength:"200",placeholder:e.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"]),c(y,{class:"mt-4 bg-btnOrBg w-full h-[46px] text-b1 rounded-full text-base font-semibold",onClick:o[7]||(o[7]=n=>t(te)(!1))},{default:k(()=>[B(a(e.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show"]),t(Ue)?(m(),j(Ee,{key:0,onClose:o[9]||(o[9]=n=>t(X)(!1)),text:e.$t("common.pay success")},null,8,["text"])):p("",!0),t(ze)?(m(),j(Ee,{key:1,isError:!0,onClose:o[10]||(o[10]=n=>t($e)(!1)),text:e.$t("order.fail")},null,8,["text"])):p("",!0),c(Ct,{paySource:i.value,show:t(je),onClose:o[11]||(o[11]=n=>t(Ae)(!1)),onChangePay:o[12]||(o[12]=n=>V(n))},null,8,["paySource","show"])]))}}const Zs=ve({...Qs,setup:Ys}),To=vt(Zs,[["__scopeId","data-v-1e349a2c"]]);export{To as default};
