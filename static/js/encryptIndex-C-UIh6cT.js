import{_ as _export_sfc,y as defineComponent,r as ref,z as watch,E as resolveComponent,K as createBlock,G as openBlock,N as withCtx,H as createBaseVNode,O as createVNode,Q as toDisplayString,a4 as withModifiers,$ as isRef,be as useToggle,w as useI18n_1,x as computed,D as onMounted,l as useRouter,a1 as useRoute,F as createElementBlock,a2 as createCommentVNode,P as unref,t as tp,T as Toast,bi as vue3QrReader_commonExports,a0 as createTextVNode,Y as pushScopeId,Z as popScopeId}from"./vendor-BUT0HZ5j.js";import{u as useAccount,e as useStore,R as useCrypto,ag as toLowerCase,_ as _sfc_main$3,r as useLoading,W as queryShopInfoById}from"./index-BvL8wS8a.js";import{b as browser}from"./browser-DFlSdkZC.js";import{_ as _sfc_main$2}from"./EvalHeader-CWDe7Hp8.js";import{q as queryVsageUserInfo}from"./user--UTTr-sL.js";import"./BackIcon-biFt6cm7.js";const _hoisted_1$1={class:"bg-[#F6F6F5] text-black rounded-t-2xl pb-[244px]"},_hoisted_2$1={class:"flex justify-between items-center border-b border-solid border-[#E1E1E1] p-2.5"},_hoisted_3$1={class:"flex items-center text-lg font-semibold"},_hoisted_4$1={class:"text-sm mt-2.5 px-2.5"},_hoisted_5$1={class:"px-4 pt-6"},_sfc_main$1=defineComponent({props:{show:null,text:null,title:null},emits:["close","setValue"],setup(e,{emit:o}){const s=e,l=ref(""),c=ref(!0);return watch(()=>s.show,r=>{r&&(l.value="")},{deep:!0}),watch(()=>l.value,r=>{r&&r.length===4&&(o("setValue",r),o("close"))},{deep:!0}),(r,a)=>{const n=resolveComponent("van-icon"),i=resolveComponent("van-password-input"),u=resolveComponent("van-number-keyboard"),p=resolveComponent("VanPopup");return openBlock(),createBlock(p,{position:"bottom",show:e.show,"onUpdate:show":a[2]||(a[2]=d=>isRef(show)?show.value=d:null),teleport:"body",style:{background:"transparent"},"close-on-click-overlay":!0,onClickOverlay:a[3]||(a[3]=()=>o("close"))},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1$1,[createBaseVNode("div",_hoisted_2$1,[createBaseVNode("div",_hoisted_3$1,toDisplayString(e.title||r.$t("encryption.Signature settings")),1),createVNode(n,{name:"cross",size:"18",onClick:a[0]||(a[0]=withModifiers(()=>o("close"),["stop"]))})]),createBaseVNode("div",_hoisted_4$1,toDisplayString(e.text||r.$t("encryption.protect the privacy")+r.$t("encryption.key information")),1),createBaseVNode("div",_hoisted_5$1,[createVNode(i,{length:4,gutter:"30",value:l.value,focused:c.value},null,8,["value","focused"])]),createVNode(u,{"hide-on-click-outside":!1,modelValue:l.value,"onUpdate:modelValue":a[1]||(a[1]=d=>l.value=d),show:c.value},null,8,["modelValue","show"])])]),_:1},8,["show"])}}}),PwdPop=_export_sfc(_sfc_main$1,[["__scopeId","data-v-726c6b8a"]]),_withScopeId=e=>(pushScopeId("data-v-a205b4cc"),e=e(),popScopeId(),e),_hoisted_1={class:"px-2.5 font-normal"},_hoisted_2={class:"bg-white text-black rounded-xl min-h-[calc(100vh-44px)] px-2.5"},_hoisted_3={class:"flex mt-5"},_hoisted_4={class:"flex-1 ml-2 text-xs leading-5 text-black-400"},_hoisted_5={key:0,class:"fixed top-0 bottom-0 left-0 right-0 z-50 min-h-screen min-w-screen"},_hoisted_6=_withScopeId(()=>createBaseVNode("div",{style:{color:"red"},class:"frame"},null,-1)),_hoisted_7={key:0,class:"pt-4 pb-6 text-sm leading-6 text-center text-black"},_hoisted_8={key:1,class:"pt-4 pb-6 text-sm leading-6 text-center text-black"},_hoisted_9={class:"flex justify-center"},_hoisted_10={class:"px-2.5 pb-[150px]"},_hoisted_11={class:"relative justify-center h-[44px] flex items-center"},_sfc_main=defineComponent({setup(__props){const{getCurrentStoreId}=useAccount(),{loadingToggle}=useLoading(),{useCryptoStore,accountStore}=useStore(),{decryptKey,generateKey}=useCrypto(),[pwdShow,setPwdShow]=useToggle(!1),[codePwdShow,setCodePwdShow]=useToggle(!1),[show,setShow]=useToggle(!1),[codeInputShow,setCodeInputShow]=useToggle(!1),router=useRouter(),route=useRoute(),{t}=useI18n_1(),setValue=e=>{router.push(`/encryption/code?code=${e}&type=${route.query.type}`)},[scanShow,setScanShow]=useToggle(!1),handleInvokeScan=async()=>{if(!tp.isConnected()||!browser.versions.android)return setScanShow(!0);tp.invokeQRScanner().then(e=>{onDecode(e)})},logErrors=e=>{e.catch(()=>{Toast(t("common.scanError")),setScanShow(!1)})},isError=ref(!1),codeInfo=ref(null),onDecode=data=>{var e,o,s;isError.value=!1,setScanShow(!1);try{codeInfo.value=eval(`(${data})`)}catch(error){const str=data.replace(/([a-zA-Z0-9]+)(:)([^}{]+?)(?=,|})/g,'"$1": "$3"');codeInfo.value=eval(`(${str})`)}if(codeInfo.value.type){if(+codeInfo.value.type==2&&+((e=userInfo.value)==null?void 0:e.id)!=+((o=codeInfo.value)==null?void 0:o.id)&&((s=codeInfo.value)!=null&&s.id)){isError.value=!0,setShow(!0);return}setCodePwdShow(!0)}},shopInfo=ref(null),setCodeKey=async e=>{const o=decryptKey(codeInfo.value.encrypt,e);if(o.hash===codeInfo.value.hash)if(+codeInfo.value.type==2)useCryptoStore.changeUserKey(o.decrypt),setShow(!0);else if(+codeInfo.value.type==1){if(useCryptoStore.changeMerchantKey(o.decrypt,+codeInfo.value.id),codeInfo.value.id){loadingToggle(!0);const s=await queryShopInfoById(codeInfo.value.id);loadingToggle(!1),s.success&&(shopInfo.value=s.data)}setShow(!0)}else return Toast(t("encryption.Please enter the correct key"));else Toast(t("encryption.wrong password"));setCodePwdShow(!1),setCodeInputShow(!1)},keyCode=ref(""),setCodeKeyInput=async()=>{var e,o,s;const data=keyCode.value;isError.value=!1,setScanShow(!1);try{codeInfo.value=eval(`(${data})`)}catch(error){try{const str=data.replace(/([a-zA-Z0-9]+)(:)([^}{]+?)(?=,|})/g,'"$1": "$3"');codeInfo.value=eval(`(${str})`)}catch(l){return Toast(t("encryption.Please enter the correct key"))}}if(codeInfo.value.type){if(+codeInfo.value.type==2&&+((e=userInfo.value)==null?void 0:e.id)!=+((o=codeInfo.value)==null?void 0:o.id)&&((s=codeInfo.value)!=null&&s.id)){isError.value=!0,setShow(!0);return}setCodePwdShow(!0);return}Toast(t("encryption.Please enter the correct key"))},userInfo=ref(null),_queryVsageUserInfo=async()=>{const{success:e,data:o}=await queryVsageUserInfo();e&&(userInfo.value=o)},isOwn=computed(()=>useCryptoStore.lost==="user"?!0:!shopAddress.value||!accountStore.account?!1:toLowerCase(shopAddress.value)===toLowerCase(accountStore.account)),shopAddress=ref(null);return onMounted(async()=>{var o;const e=router.currentRoute.value.path;await _queryVsageUserInfo(),!route.query.noGenerate&&(+route.query.type==2?generateKey("user",e):+route.query.type==1&&(shopAddress.value=(o=await getCurrentStoreId())==null?void 0:o.merchant,generateKey("merchant",e)))}),(e,o)=>{const s=resolveComponent("van-icon"),l=resolveComponent("van-button"),c=resolveComponent("van-field"),r=resolveComponent("VanButton"),a=resolveComponent("van-popup");return openBlock(),createElementBlock("div",_hoisted_1,[createVNode(_sfc_main$2,{title:e.$t("encryption.delivery management")},null,8,["title"]),createBaseVNode("div",_hoisted_2,[(+unref(route).query.type==2?unref(useCryptoStore).BKBBOUBJPYTFU:unref(useCryptoStore).BKBBOUBJPYTFM)&&unref(isOwn)?(openBlock(),createElementBlock("div",{key:0,class:"flex py-3 text-sm line items-center justify-between border-b border-solid border-[#EBEDF0]",onClick:o[0]||(o[0]=n=>unref(setPwdShow)(!0))},[createBaseVNode("span",null,toDisplayString(e.$t("encryption.Exporting Keys")),1),createVNode(s,{name:"arrow",size:"18",color:"#87837E"})])):createCommentVNode("",!0),unref(isOwn)?createCommentVNode("",!0):(openBlock(),createElementBlock("div",{key:1,class:"flex py-3 text-sm line items-center justify-between border-b border-solid border-[#EBEDF0]",onClick:handleInvokeScan},[createBaseVNode("span",null,toDisplayString(e.$t("encryption.Scan to import")),1),createVNode(s,{name:"arrow",size:"18",color:"#87837E"})])),unref(isOwn)?createCommentVNode("",!0):(openBlock(),createElementBlock("div",{key:2,class:"flex py-3 text-sm line items-center justify-between border-b border-solid border-[#EBEDF0]",onClick:o[1]||(o[1]=n=>unref(setCodeInputShow)(!0))},[createBaseVNode("span",null,toDisplayString(e.$t("encryption.Importing plaintext keys")),1),createVNode(s,{name:"arrow",size:"18",color:"#87837E"})])),createBaseVNode("div",_hoisted_3,[createVNode(s,{class:"mt-0.5",name:"warning-o",size:"20",color:"#4076f6"}),createBaseVNode("div",_hoisted_4,toDisplayString(e.$t("encryption.protect the privacy")),1)])]),unref(scanShow)?(openBlock(),createElementBlock("div",_hoisted_5,[createBaseVNode("div",{class:"absolute z-50 text-white top-2 left-2",onClick:o[2]||(o[2]=n=>unref(setScanShow)(!1))},[createVNode(s,{name:"arrow-left"})]),createVNode(unref(vue3QrReader_commonExports.QrStream),{onDecode,onInit:logErrors},{default:withCtx(()=>[_hoisted_6]),_:1})])):createCommentVNode("",!0),createVNode(PwdPop,{show:unref(pwdShow),onClose:o[3]||(o[3]=n=>unref(setPwdShow)(!1)),onSetValue:setValue},null,8,["show"]),createVNode(PwdPop,{text:e.$t("encryption.securityPasswordTips"),title:e.$t("encryption.Signature verification"),show:unref(codePwdShow),onClose:o[4]||(o[4]=n=>unref(setCodePwdShow)(!1)),onSetValue:setCodeKey},null,8,["text","title","show"]),createVNode(_sfc_main$3,{width:"70%",noClose:!0,noHeader:!0,show:unref(show),teleport:"body"},{default:withCtx(()=>[isError.value?(openBlock(),createElementBlock("div",_hoisted_8,toDisplayString(e.$t("encryption.original device key")),1)):(openBlock(),createElementBlock("div",_hoisted_7,toDisplayString(codeInfo.value&&+codeInfo.value.type==1?e.$t("encryption.information shop",{shopName:shopInfo.value&&shopInfo.value.storeName||"--"}):e.$t("encryption. information user")),1)),createBaseVNode("div",_hoisted_9,[createVNode(l,{class:"plain-btn w-1/2 mx-2.5 text-[#FEA021] font-semibold",onClick:o[5]||(o[5]=n=>unref(setShow)(!1))},{default:withCtx(()=>[createTextVNode(toDisplayString(e.$t("common.I_see")),1)]),_:1})])]),_:1},8,["show"]),createVNode(a,{show:unref(codeInputShow),"onUpdate:show":o[8]||(o[8]=n=>isRef(codeInputShow)?codeInputShow.value=n:null),position:"bottom",round:"",style:{"text-align":"center"},onClose:o[9]||(o[9]=()=>{keyCode.value=""})},{default:withCtx(()=>[createBaseVNode("div",_hoisted_10,[createBaseVNode("div",_hoisted_11,[createTextVNode(toDisplayString(e.$t("encryption.Importing plaintext keys"))+" ",1),createBaseVNode("div",{class:"absolute right-0 text-lg -translate-y-1/2 top-1/2",onClick:o[6]||(o[6]=n=>unref(setCodeInputShow)(!1))},[createVNode(s,{name:"cross"})])]),createVNode(c,{modelValue:keyCode.value,"onUpdate:modelValue":o[7]||(o[7]=n=>keyCode.value=n),rows:"5",autosize:"",type:"textarea",placeholder:e.$t("encryption.Please enter a plaintext key")},null,8,["modelValue","placeholder"])]),createVNode(r,{disabled:!keyCode.value,class:"mb-[50px] inline-block btn-orange btn-shadow w-[150px] h-[40px] text-white",onClick:setCodeKeyInput},{default:withCtx(()=>[createTextVNode(toDisplayString(e.$t("common.confirm")),1)]),_:1},8,["disabled"])]),_:1},8,["show"])])}}}),encryptIndex=_export_sfc(_sfc_main,[["__scopeId","data-v-a205b4cc"]]);export{encryptIndex as default};
