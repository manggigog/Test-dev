import{_ as co,z as Ue,o as mo,q as po,x as fo,y as C,r as R,a2 as re,bl as Ve,bu as yo,B as he,D as be,E as go,ad as ho,F as ve,Z as v,H as d,$ as ae,U as O,G as Y,P as S,O as o,I as c,bv as De,Q as q,J as Ee,N as bo,bw as vo,a4 as So,a0 as ko,X as Po,Y as wo,T as j,a9 as Fe}from"./vendor-Dr_RpJ_Y.js";import{_ as Co}from"./MCOIN-Bodfn-v1.js";import{C as Oo}from"./CommonVanProvider-KZuKVOde.js";import{_ as _o}from"./OfflineGoods-DKMaiwr2.js";import{_ as Ao}from"./OfflineStore-D-5bM32y.js";import{_ as No}from"./OfflineTotalPriceDetail-DqnMHkSW.js";import{_ as Io}from"./OfflineConsumer-CFKdyJq4.js";import{a as Ro,b as To,i as xo,V as qo,g as $,y as $o,W as Bo,X as Vo,Y as Do,w as Eo,Z as Fo,$ as Lo,t as Le,a0 as Go,a1 as Mo}from"./index-LRhcxFAI.js";import{P as se}from"./order-H59PKTFP.js";import{O as l,a as Ge}from"./offlineGoods-DvT2Go6q.js";import{P as Uo}from"./PaymentMethodSelector-GVMC43bd.js";import{u as Ho}from"./usePaymentBalance-BUYNiWb-.js";import{_ as Se}from"./SubmitApprove-D43sSLMC.js";import{P as Ko}from"./PaySwitchPop-CSZXaiqX.js";import{S as ne}from"./shop-CeqcS6K2.js";import{T as zo,P as Wo}from"./profileEnum-CXsMKuND.js";import{u as Yo,_ as jo,P as Xo}from"./usePayHelp-BtsFMq0p.js";import{P as Me}from"./payHelp-BuwJxNdC.js";import{_ as Zo}from"./PayHelpSelector-7y7_OGxM.js";import"./BackIcon-CDrGaEPo.js";import"./ImgBoutiqueLable-B-2xCcw4.js";import"./USDT-Dlu99aCg.js";import"./FMCP-f3k58DsE.js";import"./avatarRing-CLGxkH-F.js";import"./arrow-newOrigin-BFyZPNch.js";import"./point-arrow-C6HCTn4p.js";import"./usePointRelase-CmObHy9j.js";import"./piggyBank-CpEOuPx1.js";import"./useKeyboard-DcWqtm11.js";import"./payHelp-D3qS7LGk.js";const Jo=X=>(Po("data-v-36502e24"),X=X(),wo(),X),Qo={class:"bg-white rounded-xl p-3"},et={class:"flex items-center justify-end gap-x-[1px]"},ot={class:"input-wrapper"},tt={key:3,class:"bg-[#FFF8EC] rounded-[10px] p-3 flex items-center justify-between mt-3"},rt=Jo(()=>c("div",{class:"flex items-center min-w-fit"},[c("img",{src:Co,class:"w-[22px] h-[22px] mr-1.5"}),c("span",{class:"text-b1"},"MCOIN")],-1)),at={class:"bg-white rounded-xl px-3 py-4 mt-3"},st={class:"flex items-center justify-between"},nt={class:"text-b1 font-semibold"},lt={key:1,class:"relative mx-3 py-4"},ut={class:"font-Puhui"},it={class:"text-b1 font-semibold text-center"},dt=Ue({name:"offlineSubmitOrder"});function ct(X){const u=mo(),le=po(),{t:Z}=fo(),y=C(()=>{var t;return Number((t=u.query)==null?void 0:t.orderType)}),B=C(()=>{var t;return(t=u.query)==null?void 0:t.key}),{accountStore:_,regionStore:He,orderGoodsStore:k}=Ro(),{loadingToggle:ke}=Eo(),{checkLoginAuth:Pe,checkRegisterAuth:Ke}=To(),{submitOffline:ze}=xo(),{getUserDhKey:We,encryptKey:Ye}=qo(),J=R(null),Q=R(null),[V,T]=re(!1),[je,we]=re(!1),[Xe,Ce]=re(!1),e=Ve({goodsNumber:1,inputAmount:null,remark:"",goods:{goodsPrice:0,goodsDiscountRatio:20,goodsType:ne.SD,shopId:null,storeName:null},shop:{logo:"",storeName:"",discountRatio:20,merchant:"",type:ne.SD,id:null},dhKey:null});let s=Ve({region:He.country,orderType:null,orderPaySource:null,shopId:void 0,goodsId:void 0,goodsNumber:void 0,price:0,discountRatio:20,orderCustomerAddress:_.account,orderPayAddress:_.account,merchantAddress:null,orderCashierAddress:void 0,orderRemarkEnsFlag:!1,storeId:null,storeName:null});const ue=R(null),D=R(!1),{balanceState:x,paymentOptions:Ze,getPaymentBySource:Je,fetchAllBalances:Oe,autoSelectPaymentMethod:Qe,checkSufficientBalance:eo}=Ho(D),g=R(se.WITHDRAW_POINTS),ie=C(()=>Je(g.value)),[_e,Ae]=re(!1),Ne=R(null);yo(Ne,()=>{Ae(!!e.remark)});const oo=t=>{let r=t.replace(/[^\d.]/g,"");return r=r.replace(/(\..*)\./g,"$1"),r=r.replace(/^(\d*\.?\d{0,4}).*$/,"$1"),r},w=C(()=>{var t;return y.value===l.GOODS?he((t=e==null?void 0:e.goods)==null?void 0:t.goodsPrice).times(e.goodsNumber||0).toNumber():e.inputAmount}),Ie=C(()=>new he(s.discountRatio).times(w.value||0).times(x.pointSelfRate).div(100).toString()),Re=C(()=>Math.min(x.voucherBalance,new he(Ie.value).div(x.pointSelfRate).times(.5).toNumber())),de=C(()=>g.value===se.WITHDRAW_POINTS?Re.value:0),ce=t=>{e.goodsNumber=t},me=t=>{g.value=t},to=async()=>{var t,r,i,n,m,f;if(B.value){if((t=k.orderOfflineInfo)!=null&&t.goods&&((r=k.orderOfflineInfo)!=null&&r.goods.goodsId)&&((i=k.orderOfflineInfo)==null?void 0:i.goods.goodsId)===B.value)e.goods=(n=k.orderOfflineInfo)==null?void 0:n.goods;else{const{success:h,data:b}=await Mo({id:B.value.toString()});if(!h)return;e.goods=b}(m=e.goods)!=null&&m.shopId&&await Te((f=e.goods)==null?void 0:f.shopId)}},Te=async t=>{var r,i,n,m,f,h,b;if(t){if((r=k.orderOfflineInfo)!=null&&r.shop&&((n=(i=k.orderOfflineInfo)==null?void 0:i.shop)!=null&&n.id)&&+((f=(m=k.orderOfflineInfo)==null?void 0:m.shop)==null?void 0:f.id)==+t)e.shop=(h=k.orderOfflineInfo)==null?void 0:h.shop;else{const{success:A,data:N}=await Go(t);if(!A)return;e.shop=N}s.shopId=t,s.merchantAddress=(b=e.shop)==null?void 0:b.merchant}},ee=[[],[4,30],[10,80],[20,80]],xe=async()=>{var t,r,i,n,m,f,h,b,A,N,E,F,L,G,M,U,H,K,z;if(+((t=u.query)==null?void 0:t.amount)>0&&(e.inputAmount=Number(u.query.amount)),!y.value&&((r=u.query)!=null&&r.address)){let I,W;const{success:te,data:P}=await Lo((i=u.query)==null?void 0:i.address);if(!te)return;const a=Le(u.fullPath,"address"),p=Le(u.fullPath,"caddr");P!=null&&P.id?(W=P==null?void 0:P.id,I=p&&Fe.toLower(p)!==Fe.toLower(a)?l.CPC.toString():l.MPC.toString()):I=l.PPC.toString(),le.replace({path:"/offlineSubmit",query:{...u.query,orderType:I,key:W}}),setTimeout(()=>{xe()});return}switch(y.value){case l.GOODS:await to(),s.discountRatio=(n=e==null?void 0:e.goods)==null?void 0:n.goodsDiscountRatio,D.value=((m=e==null?void 0:e.goods)==null?void 0:m.goodsType)>ne.SD;break;case l.PPC:s.discountRatio=Number(((f=u.query)==null?void 0:f.ratio)||.2)*100,s.merchantAddress=(((h=u.query)==null?void 0:h.address)||"").toString(),e.shop.merchant=(((b=u.query)==null?void 0:b.address)||"").toString(),D.value=!1;break;case l.MPC:case l.CPC:case l.STORE:await Te(B.value),s.discountRatio=Number((A=u.query)==null?void 0:A.ratio)>0?Number(((N=u.query)==null?void 0:N.ratio)||.2)*100:(E=e==null?void 0:e.shop)==null?void 0:E.discountRatio,((F=e==null?void 0:e.shop)==null?void 0:F.type)>ne.SD&&((G=ee[(L=e==null?void 0:e.shop)==null?void 0:L.type])!=null&&G.length)&&(console.log(ee[(M=e==null?void 0:e.shop)==null?void 0:M.type],s.discountRatio),D.value=s.discountRatio>=ee[(U=e==null?void 0:e.shop)==null?void 0:U.type][0]&&s.discountRatio<=ee[(H=e==null?void 0:e.shop)==null?void 0:H.type][1]);break}y.value!==l.PPC&&((K=e.shop)!=null&&K.id)&&_.isLogin&&(e.dhKey=await We((z=e.shop)==null?void 0:z.id))},qe=async()=>{var t,r;switch(s.orderCustomerAddress=_.account,s.orderPayAddress=_.account,s.orderType=y.value,s.price=w.value,s.orderPaySource=g.value,s.orderRemark=e.remark,s.merchantEns=void 0,y.value){case l.GOODS:s.goodsId=B.value.toString(),s.goodsNumber=e.goodsNumber,s.orderRemark=e.remark||void 0;break;case l.PPC:break;case l.MPC:break;case l.CPC:s.orderCashierAddress=(((t=u.query)==null?void 0:t.caddr)||"").toString();break;case l.STORE:break}if(y.value!==l.PPC&&((r=e.shop)!=null&&r.id)&&e.remark&&e.dhKey){const{encrypt:i}=Ye(e.remark,e.dhKey);s.orderRemark=i,s.orderRemarkEnsFlag=!0}},ro=async()=>{var t,r;if(Pe(!0)&&await Ke(!0)){if(w.value<=0)return j.fail(Z("offline.input_pay_amount"));if(!eo((t=ie.value)==null?void 0:t.source,(r=J.value)==null?void 0:r.realTotalAmountShow))return we(!0);T(!0);try{await qe(),s.payFlag=!0;const{success:i,data:n}=await Bo(s);if(!i){T(!1);return}const{success:m}=await ze(s.merchantAddress,n.orderTotalAmount,s.discountRatio,s.orderPaySource,n.isScanFlag,n.allId);if(!m){T(!1);return}j.loading({message:Z("order.wait block chain"),forbidClick:!0,duration:0}),await Vo({id:n==null?void 0:n.orderId,currentOrderStatus:Ge.PAYING}),j.clear(),n.isScanFlag?Ce(!0):(j({message:Z("common.pay success"),icon:Do("toast-success.svg"),duration:3e3,overlay:!0,overlayClass:"toastOverlay",className:"toastCard"}),setTimeout(()=>{le.replace({path:"/offlineConsumerorders",query:{status:Ge.PAYMENT_SUCCESS}})},3e3))}finally{T(!1)}}},ao=()=>{le.replace({path:"profile",query:{path:Wo.CONSUMER,tab:zo.OFFLINE}})},$e=R(0),oe=C(()=>[l.GOODS,l.STORE].includes(+y.value)),{payBy:pe,changeBy:so,payLink:fe,payHelpRef:ye,generateOfflinePayLink:no,showChangeTip:lo}=Yo(),uo=vo(async()=>{var t;if(w.value<=0)return j.fail(Z("offline.input_pay_amount"));try{if(fe.value){(t=ye.value)==null||t.setShow(!0);return}$e.value=w.value,T(!0),await qe(),s.orderPayAddress=null,s.payFlag=!1,await no(s)}finally{T(!1)}},500);be([e],()=>{lo()});const Be=()=>{var t;Q.value&&((t=Q.value)==null||t.blur())},io=async()=>{ke(!0);try{await Promise.all([xe(),Oe()]);const t=Qe(w.value,Re.value);me(t)}catch(t){console.error("Failed to initialize payment method:",t)}finally{ke(!1)}if(u.query.storeId){s.storeId=u.query.storeId.toString();const t=await Fo({id:u.query.storeId});if(!(t!=null&&t.success))return;ue.value=t.data}},ge=()=>{Pe(!0)&&io()};return be(()=>_.isLogin,t=>{t||ge()},{immediate:!1,deep:!0}),be(()=>_.isRegister,t=>{t&&ge()},{immediate:!1,deep:!0}),go(async()=>{ge()}),ho(()=>{k.changeOfflineInfo(null)}),(t,r)=>{const i=ve("van-button"),n=ve("VanField"),m=ve("VanButton");return d(),v(Oo,{title:t.$t("order.order"),class:"h-full font-Puhui font-normal relative",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent",fieldInputTextColor:"#585654"}},{default:ae(()=>{var f,h,b,A,N,E,F,L,G,M,U,H,K,z,I,W,te,P;return[o(oe)?(d(),v(jo,{key:0,tab:o(pe),onChangeTab:o(so),class:"mb-3 mx-3"},null,8,["tab","onChangeTab"])):O("",!0),(f=o(e).goods)!=null&&f.goodsPrice||(h=o(e).shop)!=null&&h.merchant?(d(),Y(Ee,{key:1},[c("div",{class:bo(["px-3 pb-3 overflow-y-auto relative",o(oe)?"safe-page-body-help":"safe-page-body"])},[c("div",Qo,[o(y)===o(l).PPC?(d(),v(Io,{key:0,order:{orderCustomerAddress:(A=(b=o(e))==null?void 0:b.shop)==null?void 0:A.merchant},showStatus:!1},null,8,["order"])):(d(),v(Ao,{key:1,shop:{images:(E=(N=o(e))==null?void 0:N.shop)==null?void 0:E.logo,name:(L=(F=o(e))==null?void 0:F.shop)==null?void 0:L.storeName}},null,8,["shop"])),o(y)===o(l).GOODS?(d(),v(_o,{key:2,class:"mt-3",goods:{...(G=o(e))==null?void 0:G.goods,storeName:((U=(M=o(e))==null?void 0:M.goods)==null?void 0:U.storeName)||((H=ue.value)==null?void 0:H.storeName),areaExtName2:(K=ue.value)==null?void 0:K.areaExtName2},"show-goods-type":!0},{"bottom-right":ae(()=>[c("div",et,[S(i,{icon:"minus",size:"mini",type:"primary",class:"num-btn w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-l",disabled:+o(e).goodsNumber<=1,onClick:r[0]||(r[0]=a=>ce(+o(e).goodsNumber-1))},null,8,["disabled"]),c("div",ot,[S(n,{class:"text-center rounded input-box",type:"digit",modelValue:o(e).goodsNumber,"onUpdate:modelValue":[r[1]||(r[1]=a=>o(e).goodsNumber=a),ce],ref:(a,p)=>{p.numberRef=a,Q.value=a},enterkeyhint:"done",onKeyup:r[2]||(r[2]=De(a=>Be(),["enter"]))},null,8,["modelValue"])]),S(i,{icon:"plus",size:"mini",type:"primary",class:"w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-r",onClick:r[3]||(r[3]=a=>ce(+o(e).goodsNumber+1))})])]),_:1},8,["goods"])):(d(),Y("div",tt,[rt,S(n,{"input-align":"right",placeholder:t.$t("offline.input_pay_amount"),class:"py-0 pr-0 bg-[transparent]",modelValue:o(e).inputAmount,"onUpdate:modelValue":r[4]||(r[4]=a=>o(e).inputAmount=a),type:"number",formatter:oo,readonly:+(((z=o(u).query)==null?void 0:z.amount)||0)>0,ref:(a,p)=>{p.numberRef=a,Q.value=a},enterkeyhint:"done",onKeyup:r[5]||(r[5]=De(a=>Be(),["enter"]))},null,8,["placeholder","modelValue","readonly"])]))]),c("div",at,[c("div",st,[c("span",nt,q(t.$t("order.buyerRemark")),1),o(_e)?O("",!0):(d(),Y("span",{key:0,class:"text-b3",onClick:r[6]||(r[6]=a=>o(Ae)(!0))},q(t.$t("common.pleaseInput"))+q(t.$t("order.remark")),1))]),o(_e)?(d(),v(n,{key:0,ref:(a,p)=>{p.remarkRef=a,Ne.value=a},modelValue:o(e).remark,"onUpdate:modelValue":r[7]||(r[7]=a=>o(e).remark=a),type:"textarea",maxlength:"100",class:"!bg-b5 rounded-lg mt-2 p-2"},null,8,["modelValue"])):O("",!0)]),o(pe)===o(Me).OWNER||!o(oe)?(d(),Y(Ee,{key:0},[S(Uo,{class:"mt-3",modelValue:g.value,"onUpdate:modelValue":r[8]||(r[8]=a=>g.value=a),"payment-options":o(Ze),loading:o(x).loading,boutique:D.value,onChange:me,onGetPointBalance:o(Oe)},null,8,["modelValue","payment-options","loading","boutique","onGetPointBalance"]),S(No,{ref:(a,p)=>{p.priceDetailRedf=a,J.value=a},totalAmount:o(w),"usdt-rate":o(x).usdtRate,"voucher-price":o(x).voucherBalance,integral:o(Ie),voucherAmount:o(de),paySource:g.value,class:"mb-2.5"},null,8,["totalAmount","usdt-rate","voucher-price","integral","voucherAmount","paySource"])],64)):O("",!0)],2),o(pe)===o(Me).OTHER&&o(oe)?(d(),v(Xo,{key:0,"pay-link":o(fe),"btn-loading":o(V),onOnClick:o(uo)},null,8,["pay-link","btn-loading","onOnClick"])):(d(),Y("div",lt,[[o(se).WALLET].includes(g.value)?(d(),v(Se,{key:0,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o($).order,token:o($).MCOIN,symbol:((I=o(ie))==null?void 0:I.symbol)||"MCOIN",loading:o(V),approveAmount:Number(((W=J.value)==null?void 0:W.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):O("",!0),[o(se).USDT_WALLET].includes(g.value)?(d(),v(Se,{key:1,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o($).order,token:o($).USDT,symbol:((te=o(ie))==null?void 0:te.symbol)||"USDT",loading:o(V),approveAmount:Number(((P=J.value)==null?void 0:P.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):O("",!0),o(de)>0?(d(),v(Se,{key:2,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o($).order,token:o($).FMCP,symbol:t.$t("voucher.voucher"),loading:o(V),approveAmount:Number(o(de))},null,8,["contract","token","symbol","loading","approveAmount"])):O("",!0),S(m,{round:"",class:"pay-btn btn-yellow w-full h-[46px]",loading:o(V),disabled:!o(w),onClick:ro},{default:ae(()=>[So(q(t.$t("common.pay")),1)]),_:1},8,["loading","disabled"])]))],64)):O("",!0),S(Ko,{"pay-source":g.value,show:o(je),onClose:r[9]||(r[9]=a=>o(we)(!1)),onChangePay:r[10]||(r[10]=a=>me(a))},null,8,["pay-source","show"]),S($o,{show:o(Xe),noClose:"",onClose:r[11]||(r[11]=a=>o(Ce)(!1))},{default:ae(()=>[c("div",ut,[c("div",it,q(t.$t("common.pay success")),1),c("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:ao},q(t.$t("common.I_see")),1)])]),_:1},8,["show"]),S(Zo,{ref:(a,p)=>{p.payHelpRef=a,ko(ye)&&(ye.value=a)},amount:$e.value,link:o(fe)},null,8,["amount","link"])]}),_:1},8,["title"])}}const mt=Ue({...dt,setup:ct}),Ut=co(mt,[["__scopeId","data-v-36502e24"]]);export{Ut as default};
