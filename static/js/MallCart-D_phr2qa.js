import{_ as W,y as P,w as ee,E as w,F as v,G as C,H as y,O as p,Q as q,I as $,J as H,N as M,aH as ye,Y as oe,Z as te,bd as ke,l as ve,bc as K,bK as be,r as R,x as L,B as U,z as _e,D as Te,bh as Ie,P as i,K as Se,T as Y,n as we}from"./vendor-CjApaIpB.js";import{_ as Be}from"./mall-BNNzTN-n.js";import{O as De}from"./OrderGoods-CdqWSRed.js";import{C as xe}from"./CartSubmitBar-CK8Yx6nT.js";import{e as Ae,r as Le,s as z,q as Q}from"./index-lKIcPnY0.js";import{_ as qe}from"./DividingLine-DVrrU6zb.js";import{_ as Me}from"./RecommendationFeed-BqK7fkzf.js";import{a as Ee,b as X,c as Fe,d as Ne}from"./cart-CFO7zzai.js";import{c as Oe}from"./goods-PvW3o_91.js";import{P as S}from"./flashSale-DDyqLyYN.js";import{S as Z}from"./shop-CeqcS6K2.js";import"./MCOIN-BcbOHmhy.js";import"./BoutiqueLable-BYJxmIGq.js";import"./ShopMaskTips-DfjY93ZI.js";import"./GoodsList-7fiqrIew.js";import"./buy-cart-3M2I0Qjc.js";import"./goods-BVwS8oFG.js";import"./GoodsPrice-6cXbNaVi.js";import"./mall-1rXHNG0u.js";import"./useShowActiveInfo-lv65b4f_.js";import"./festivalActivities-DbAdwSpI.js";const Re=c=>(oe("data-v-27a50109"),c=c(),te(),c),$e=Re(()=>y("img",{src:Be,class:"w-4 mr-1"},null,-1)),He={class:"text-base font-semibold"},Pe=P({props:{cartInfo:null,isManage:{type:Boolean}},emits:["changeNumber","handelDel","handleTo","handleRemove"],setup(c,{emit:d}){const s=c,{t:_}=ee(),u=(m,l)=>{ye.confirm({message:_("cart.remove"),confirmButtonText:_("common.confirm"),confirmButtonColor:"#FF507A",cancelButtonText:_("common.cancel")}).then(()=>{d("handelDel",s.cartInfo,m,l)}).catch(()=>{})},f=(m,l)=>{d("handelDel",s.cartInfo,m,l),d("handleRemove",s.cartInfo,m,l)};return(m,l)=>{const T=w("van-icon"),E=w("van-checkbox"),I=w("van-button"),F=w("VanSwipeCell");return C(),v("div",null,[y("div",{class:"flex-start mt-2.5",onClick:l[0]||(l[0]=r=>d("handleTo",`/category?deliveryType=1&shopId=${c.cartInfo.storeId}`))},[$e,y("div",He,q(c.cartInfo.storeName||"-"),1),p(T,{name:"arrow",class:"ml-2"})]),(C(!0),v($,null,H(c.cartInfo.goods,(r,B)=>(C(),v("div",{class:"bg-white mt-2.5 rounded-xl p-2.5",key:r.id},[p(F,null,{right:M(()=>[p(I,{square:"",class:"right-btn",color:"#FEA021",text:m.$t("cart.removeTo"),onClick:g=>f(r,B)},null,8,["text","onClick"]),p(I,{square:"",class:"right-btn",color:"#FF507A",text:m.$t("shop.delete"),onClick:g=>u(r,B)},null,8,["text","onClick"])]),default:M(()=>[p(E,{disabled:r.disabled&&!c.isManage,name:r,class:"min-w-min mr-0"},{default:M(()=>[p(De,{goods:r,payType:r.payType,card:r,number:r.number||1,shopType:r.shopType,class:"w-full flex-1 mb-2.5 last:mb-0 pl-0",onChangeNumber:g=>d("changeNumber",r,g),onHandleTo:l[1]||(l[1]=g=>d("handleTo",g))},null,8,["goods","payType","card","number","shopType","onChangeNumber"])]),_:2},1032,["disabled","name"])]),_:2},1024)]))),128))])}}}),Ve=W(Pe,[["__scopeId","data-v-27a50109"]]),Ge=c=>(oe("data-v-34ea774f"),c=c(),te(),c),Je={class:"p-2.5"},je={class:"text-xl font-semibold flex-center-bw"},Ke=Ge(()=>y("div",{class:"safe-bottom-page"},null,-1)),Ue=P({name:"MallCart"});function Ye(c){const{t:d}=ee(),s=ke({originList:[],oldList:[],list:[],goodsChecked:[],goodsType:0}),_=ve(),{loadingToggle:u}=Le(),[f,m]=K(!1),{orderGoodsStore:l}=Ae();be("cart_number",1);const T="mall_cart_scroll_position",E=5*60*1e3,I=()=>{const t={position:document.querySelector("#fm-page").scrollTop,timestamp:Date.now()};sessionStorage.setItem(T,JSON.stringify(t))},F=()=>{const o=sessionStorage.getItem(T);if(o){const{position:t,timestamp:e}=JSON.parse(o);Date.now()-e<E?we(()=>{const a=document.querySelector("#fm-page");a&&setTimeout(()=>{a.scrollTo({top:t,behavior:"smooth"}),console.log("恢复滚动位置:",t,a.scrollTop)},100)}):sessionStorage.removeItem(T)}},r=()=>{f.value&&(s.goodsChecked=s.goodsChecked.filter(o=>!o.disabled)),m(!f.value)},B=o=>{console.log(o),l.setGoodsCheckedCache(o.map(t=>t.goodsId))},g=o=>{_.push(o)},N=R(null),V=L(()=>s.list.reduce((o,t)=>o+t.stores.reduce((e,a)=>e+a.goods.length,0),0)),G=L(()=>s.list.reduce((o,t)=>o+t.stores.reduce((e,a)=>e+a.goods.filter(n=>!n.disabled).length,0),0)),J=L(()=>f.value?V.value===s.goodsChecked.length:G.value===s.goodsChecked.length&&G.value!==0),se=L(()=>s.goodsChecked.reduce((o,t)=>+new U(o).plus(+new U(t.payType===S.STORE_CARD?t.cardPrice:t.price).times(t.number)),0)),ae=async(o,t)=>{if(o.stock<t&&+o.goodsTypes!=2)return o.number=o.stock,Y(d("order.Insufficient stock"));u(!0);const e=await Fe({goodsId:o.goodsId,number:t});u(!1),e.success&&(o.number=t)},ne=()=>{J.value?ce():D()},D=()=>{N.value.toggleAll({checked:!0,skipDisabled:!0})},ce=()=>{N.value.toggleAll({skipDisabled:!0})},re=async(o,t,e)=>{if(u(!0),!!(await X(t.goodsId)).success){o.goods.splice(e,1);for(let n=0;n<s.list.length;n++)s.list[n].stores=s.list[n].stores.filter(h=>h.goods&&h.goods.length>0);s.list=s.list.filter(n=>n.stores&&n.stores.length>0),s.goodsChecked=s.goodsChecked.filter(n=>n.id!==t.id),u(!1)}},le=async(o,t)=>{u(!0);const e=await Oe({goodsId:t.goodsId,type:1,collectType:1});u(!1),e.success},ie=R(null),j=R(0),de=async()=>{const{balanceOf:o}=z(Q.MCOIN),t=await o();ie.value=+t,j.value=+await z(Q.FMCP).balanceOf()},ue=o=>JSON.parse(JSON.stringify(o)),O=async()=>{u(!0);const o=await Ee();u(!1),!(!o.success||!o.data)&&(s.originList=o.data||[],x(s.originList),F())},x=o=>{const t=pe(ue(o));s.list=t.map(e=>({goodsBoutiqueFlag:e[0].goodsType!==Z.SD,stores:me(e)}))},pe=o=>{let t={};for(;o.length;){let e=o.shift();const a=e.goodsType?"true":"false";t[a]=t[a]||[],t[a].push(e)}return Object.keys(t).map(e=>t[e])},me=o=>o.reduce((t,e)=>{const a=e.id,n=e.status!==1||!+e.stock&&e.goodsTypes!=2||+e.shopStatus==4||+e.shopStatus==0||+e.shopStatus==3;e.disabled=n,e.id=e.goodsId,e.icons=e.icon,n?s.goodsChecked=s.goodsChecked.filter(b=>b.id!==e.id):l.goodsCheckedCache.findIndex(b=>b===e.goodsId)!==-1&&s.goodsChecked.push(e);const h=t.findIndex(b=>b.storeId===e.storeId);return h!==-1?t[h].goods.push(e):t.push({id:a,storeId:e.storeId,storeName:e.storeName,goods:[e]}),t},[]),[he,A]=K(!1),fe=(...o)=>{let t=0;return o.forEach(e=>{e===!0&&t++}),t},ge=async()=>{let o=s.goodsChecked.some(k=>k.goodsType!==Z.SD),t=s.goodsChecked.some(k=>k.payType===S.MC),e=s.goodsChecked.some(k=>k.payType===S.STORE_CARD);const a=fe(o,t,e);if(a>2||a===2&&e)return Y(d("cart.tips"));A(!0);let n=[];s.goodsChecked.forEach(k=>{n.push(k.id)});const h=await Ne(n.join(","));if(A(!1),!h.success)return;g(a===2||o||a===1&&t?"/submitOrderBoutiqueCart":"/submitOrderCart")},Ce=async()=>{A(!0);let o=[];s.goodsChecked.forEach(e=>{o.push(e.id)});const t=await X(o.join(","));s.goodsChecked=[],A(!1),t.success&&O()};return _e(()=>s.goodsType,async o=>{if(+o==0)x(s.originList),D();else if(+o==2){const t=s.originList.filter(e=>(e==null?void 0:e.goodsBoutiqueFlag)&&(e==null?void 0:e.payType)!==S.STORE_CARD);await x(t),D()}else if(+o==1){const t=s.originList.filter(e=>!(e!=null&&e.goodsBoutiqueFlag)||(e==null?void 0:e.payType)===S.STORE_CARD);await x(t),D()}},{deep:!0}),Te(()=>{O(),de(),document.querySelector("#fm-page").addEventListener("scroll",I)}),Ie(()=>{document.querySelector("#fm-page").removeEventListener("scroll",I)}),(o,t)=>{const e=w("van-checkbox-group");return C(),v("div",null,[y("div",Je,[p(e,{modelValue:i(s).goodsChecked,"onUpdate:modelValue":t[0]||(t[0]=a=>i(s).goodsChecked=a),onChange:B,ref:(a,n)=>{n.checkboxGroup=a,N.value=a},"checked-color":"#FEA021"},{default:M(()=>[y("div",je,[y("span",null,q(o.$t("cart.cart"))+"("+q(i(V))+")",1),y("div",{class:"text-sm font-normal text-primary",onClick:r},q(i(f)?o.$t("common.quteManage"):o.$t("common.manage")),1)]),(C(!0),v($,null,H(i(s).list,a=>(C(),v("div",{class:"cart-list",key:a.goodsBoutiqueFlag},[p(qe,{goodsBoutiqueFlag:a.goodsBoutiqueFlag},null,8,["goodsBoutiqueFlag"]),(C(!0),v($,null,H(a.stores,(n,h)=>(C(),Se(Ve,{isManage:i(f),key:h,cartInfo:n,onChangeNumber:ae,onHandelDel:re,onHandleRemove:le,onHandleTo:g},null,8,["isManage","cartInfo"]))),128))]))),128))]),_:1},8,["modelValue"])]),p(Me,{onSuccessAdd:O,"title-text":i(d)("common.recommend_for_you"),class:"p-2.5"},null,8,["title-text"]),Ke,p(xe,{voucherBalance:j.value,isManage:i(f),goodsChecked:i(s).goodsChecked,isCheckAll:i(J),totalAmount:i(se),loading:i(he),onTotalCheck:ne,onHandleCartBuy:ge,onHandleDelMult:Ce},null,8,["voucherBalance","isManage","goodsChecked","isCheckAll","totalAmount","loading"])])}}const ze=P({...Ue,setup:Ye}),yo=W(ze,[["__scopeId","data-v-34ea774f"]]);export{yo as default};
