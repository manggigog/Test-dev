import{_ as ce}from"./MCOIN-BcbOHmhy.js";import{y as me,x as w,B as L,F as k,G as d,H as r,Q as c,a2 as O,P as o,I as xe,_ as He,a1 as Ye,l as Qe,w as Xe,r as ee,be as oe,bf as Ce,bp as Ze,D as Je,bj as eo,E as ie,K as I,N as te,O as P,a0 as oo,a7 as Te,Y as to,Z as so,T as se}from"./vendor-BUT0HZ5j.js";import{C as ro}from"./CommonVanProvider-BpsZUrD3.js";import{_ as ao}from"./OfflineGoods-BjltvH3M.js";import{_ as no}from"./OfflineStore-CFe1JKHJ.js";import{_ as $e}from"./USDT-BFPkoPAz.js";import{_ as lo}from"./FMCP-CFalj3L2.js";import{d as Y,e as uo,o as io,R as co,r as mo,q as V,_ as fo,S as po,n as Ie,T as yo,U as go,V as ho,W as vo,X as bo}from"./index-hbwLMIYO.js";import{P as C}from"./order-H59PKTFP.js";import{_ as So}from"./OfflineConsumer-DYUtC3ei.js";import{O as i,a as Oe}from"./offlineGoods-DvT2Go6q.js";import{P as _o}from"./PaymentMethodSelector-DGtJLOmf.js";import{u as wo}from"./usePaymentBalance-sMNcNxkw.js";import{_ as de}from"./SubmitApprove-dtpMOaFi.js";import{P as ko}from"./PaySwitchPop-tsgWrntJ.js";import{S as re}from"./shop-CeqcS6K2.js";import{T as Ao,P as Po}from"./profileEnum-CXsMKuND.js";import"./BackIcon-biFt6cm7.js";import"./ImgBoutiqueLable-BF5Xoxsv.js";import"./avatarRing-DpEnkbQ2.js";import"./point-arrow-BVnEJLj4.js";import"./usePointRelase-3focXSC4.js";import"./piggyBank-DIfLFOiI.js";const Co={class:"bg-white mt-3 p-3 rounded-xl"},To={class:"text-base font-semibold"},Io={class:"flex items-start justify-between mt-3"},Oo={class:"text-b3 min-w-fit"},xo={class:"text-right"},$o={class:"flex items-center justify-end gap-1 font-semibold"},No={key:0,src:$e,class:"w-4 h-4"},Ro={key:1,src:ce,class:"w-4 h-4"},qo={key:0,class:"text-b3 text-xs"},Do=r("div",{class:"w-full h-[1px] bg-[#F6F6F5] my-3"},null,-1),Bo={class:"flex items-center justify-between"},Vo={class:"text-b3 min-w-fit"},Lo={class:"text-right"},Eo={class:"flex items-center justify-end gap-1 font-semibold"},Fo={key:0,src:$e,class:"w-4 h-4"},Uo={key:1,src:ce,class:"w-4 h-4"},Mo=r("span",{class:"text-b3"},"+",-1),Wo=r("img",{src:lo,class:"w-4 h-4"},null,-1),Go={class:"text-b3 text-xs"},jo=me({props:{totalAmount:null,usdtRate:null,integral:null,voucherAmount:null,paySource:null},setup(y,{expose:l}){const m=y,N=w(()=>m.totalAmount<=0?0:m.paySource===C.USDT_WALLET?L(m.totalAmount).dividedBy(m.usdtRate):m.totalAmount),p=w(()=>m.voucherAmount>0?L(m.totalAmount).minus(m.voucherAmount).toString():m.totalAmount),T=w(()=>p.value<=0?"":m.paySource===C.USDT_WALLET?L(p.value).dividedBy(m.usdtRate).toString():p.value);return l({realTotalAmount:p,realTotalAmountShow:T}),(g,fe)=>(d(),k("div",Co,[r("div",To,c(g.$t("order.totalPriceDetail")),1),r("div",Io,[r("div",Oo,c(g.$t("offline.order_price")),1),r("div",xo,[r("div",$o,[y.paySource===o(C).USDT_WALLET?(d(),k("img",No)):(d(),k("img",Ro)),r("span",null,c(o(Y)(o(N)||0)),1)]),y.paySource===o(C).USDT_WALLET?(d(),k("div",qo,c(`(${o(Y)(o(N)||0)} USDT${g.$t("offline.auto_exchange")} ${y.totalAmount||0} MCOIN)`),1)):O("",!0)])]),Do,r("div",Bo,[r("div",Vo,c(g.$t("common.actual_payment")),1),r("div",Lo,[r("div",Eo,[y.paySource===o(C).USDT_WALLET?(d(),k("img",Fo)):(d(),k("img",Uo)),r("span",null,c(o(Y)(o(T)||0)),1),y.voucherAmount>0?(d(),k(xe,{key:2},[Mo,Wo,r("span",null,c(o(Y)(y.voucherAmount||0)),1)],64)):O("",!0)]),r("div",Go,c(g.$t("ecology.estimated get"))+c(o(Y)(y.integral||0))+c(g.$t("common.credit")),1)])])]))}}),Ko=y=>(to("data-v-2ff46501"),y=y(),so(),y),zo={class:"px-3 pb-3 overflow-y-auto relative safe-page-body"},Ho={class:"bg-white rounded-xl p-3"},Yo={class:"flex items-center justify-end gap-x-[1px]"},Qo={class:"input-wrapper"},Xo={key:3,class:"bg-[#FFF8EC] rounded-[10px] p-3 flex items-center justify-between mt-3"},Zo=Ko(()=>r("div",{class:"flex items-center min-w-fit"},[r("img",{src:ce,class:"w-[22px] h-[22px] mr-1.5"}),r("span",{class:"text-b1"},"MCOIN")],-1)),Jo={class:"bg-white rounded-xl px-3 py-4 mt-3"},et={class:"flex items-center justify-between"},ot={class:"text-b1 font-semibold"},tt={class:"relative py-4"},st={class:"font-Puhui"},rt={class:"text-b1 font-semibold text-center"},at=me({name:"offlineSubmitOrder"});function nt(y){const l=Ye(),m=Qe(),{t:N}=Xe(),p=w(()=>{var t;return Number((t=l.query)==null?void 0:t.orderType)}),T=w(()=>{var t;return(t=l.query)==null?void 0:t.key}),{accountStore:g,regionStore:fe,orderGoodsStore:A}=uo(),{loadingToggle:pe}=mo(),{submitOffline:Ne}=io(),{getUserDhKey:Re,encryptKey:qe}=co(),Q=ee(null),[X,Z]=oe(!1),[De,ye]=oe(!1),[Be,ge]=oe(!1),e=Ce({goodsNumber:1,inputAmount:null,remark:"",goods:{goodsPrice:0,goodsDiscountRatio:20,goodsType:re.SD,shopId:null},store:{logo:"",storeName:"",discountRatio:20,merchant:"",type:re.SD,id:null},dhKey:null});let a=Ce({region:fe.country,orderType:null,orderPaySource:null,shopId:void 0,goodsId:void 0,goodsNumber:void 0,price:0,discountRatio:20,orderCustomerAddress:g.account,orderPayAddress:g.account,merchantAddress:null,orderCashierAddress:void 0,orderRemarkEnsFlag:!1});const E=ee(!1),{balanceState:R,paymentOptions:Ve,getPaymentBySource:Le,fetchAllBalances:he,autoSelectPaymentMethod:Ee,checkSufficientBalance:Fe}=wo(E),b=ee(C.WITHDRAW_POINTS),ae=w(()=>Le(b.value)),[ve,be]=oe(!1),Se=ee(null);Ze(Se,()=>{be(!!e.remark)});const Ue=t=>{let s=t.replace(/[^\d.]/g,"");return s=s.replace(/(\..*)\./g,"$1"),s=s.replace(/^(\d*\.?\d{0,4}).*$/,"$1"),s},q=w(()=>{var t;return p.value===i.GOODS?L((t=e==null?void 0:e.goods)==null?void 0:t.goodsPrice).times(e.goodsNumber||0).toNumber():e.inputAmount}),_e=w(()=>new L(a.discountRatio).times(q.value||0).times(R.pointSelfRate).div(100).toString()),we=w(()=>Math.min(R.voucherBalance,new L(_e.value).div(R.pointSelfRate).times(.5).toNumber())),ne=w(()=>b.value===C.WITHDRAW_POINTS?we.value:0),le=t=>{e.goodsNumber=t},ue=t=>{b.value=t},Me=async()=>{var t,s,f,u,h,v;if(T.value){if((t=A.orderOfflineInfo)!=null&&t.goods&&((s=A.orderOfflineInfo)!=null&&s.goods.goodsId)&&((f=A.orderOfflineInfo)==null?void 0:f.goods.goodsId)===T.value)e.goods=(u=A.orderOfflineInfo)==null?void 0:u.goods;else{const{success:S,data:_}=await bo(T.value.toString());if(!S)return;e.goods=_}(h=e.goods)!=null&&h.shopId&&await ke((v=e.goods)==null?void 0:v.shopId)}},ke=async t=>{var s,f,u,h,v,S,_;if(t){if((s=A.orderOfflineInfo)!=null&&s.store&&((u=(f=A.orderOfflineInfo)==null?void 0:f.store)!=null&&u.id)&&+((v=(h=A.orderOfflineInfo)==null?void 0:h.store)==null?void 0:v.id)==+t)e.store=(S=A.orderOfflineInfo)==null?void 0:S.store;else{const{success:x,data:$}=await vo(t);if(!x)return;e.store=$}a.shopId=t,a.merchantAddress=(_=e.store)==null?void 0:_.merchant}},J=[[],[4,30],[10,80],[20,80]],Ae=async()=>{var t,s,f,u,h,v,S,_,x,$,F,U,M,W,G,j,K,z,H;if(+((t=l.query)==null?void 0:t.amount)>0&&(e.inputAmount=Number(l.query.amount)),!p.value&&((s=l.query)!=null&&s.address)){let n,D;const{success:Ke,data:B}=await po((f=l.query)==null?void 0:f.address);if(!Ke)return;const ze=Ie(l.fullPath,"address"),Pe=Ie(l.fullPath,"caddr");B!=null&&B.id?(D=B==null?void 0:B.id,n=Pe&&Te.toLower(Pe)!==Te.toLower(ze)?i.CPC.toString():i.MPC.toString()):n=i.PPC.toString(),m.replace({path:"/offlineSubmit",query:{...l.query,orderType:n,key:D}}),setTimeout(()=>{Ae()});return}switch(p.value){case i.GOODS:await Me(),a.discountRatio=(u=e==null?void 0:e.goods)==null?void 0:u.goodsDiscountRatio,E.value=((h=e==null?void 0:e.goods)==null?void 0:h.goodsType)>re.SD;break;case i.PPC:a.discountRatio=Number(((v=l.query)==null?void 0:v.ratio)||.2)*100,a.merchantAddress=(((S=l.query)==null?void 0:S.address)||"").toString(),e.store.merchant=(((_=l.query)==null?void 0:_.address)||"").toString(),E.value=!1;break;case i.MPC:case i.CPC:case i.STORE:await ke(T.value),a.discountRatio=Number((x=l.query)==null?void 0:x.ratio)>0?Number((($=l.query)==null?void 0:$.ratio)||.2)*100:(F=e==null?void 0:e.store)==null?void 0:F.discountRatio,((U=e==null?void 0:e.store)==null?void 0:U.type)>re.SD&&((W=J[(M=e==null?void 0:e.store)==null?void 0:M.type])!=null&&W.length)&&(console.log(J[(G=e==null?void 0:e.store)==null?void 0:G.type],a.discountRatio),E.value=a.discountRatio>=J[(j=e==null?void 0:e.store)==null?void 0:j.type][0]&&a.discountRatio<=J[(K=e==null?void 0:e.store)==null?void 0:K.type][1]);break}p.value!==i.PPC&&((z=e.store)!=null&&z.id)&&g.isLogin&&(e.dhKey=await Re((H=e.store)==null?void 0:H.id))},We=async()=>{var t,s;switch(a.orderCustomerAddress=g.account,a.orderPayAddress=g.account,a.orderType=p.value,a.price=q.value,a.orderPaySource=b.value,a.orderRemark=e.remark,a.merchantEns=void 0,p.value){case i.GOODS:a.goodsId=T.value.toString(),a.goodsNumber=e.goodsNumber,a.orderRemark=e.remark||void 0;break;case i.PPC:break;case i.MPC:break;case i.CPC:a.orderCashierAddress=(((t=l.query)==null?void 0:t.caddr)||"").toString();break;case i.STORE:break}if(p.value!==i.PPC&&((s=e.store)!=null&&s.id)&&e.remark&&e.dhKey){const{encrypt:f}=qe(e.remark,e.dhKey);a.orderRemark=f,a.orderRemarkEnsFlag=!0}l.query.storeId&&(a.storeId=l.query.storeId)},Ge=async()=>{var t,s;if(q.value<=0)return se.fail(N("offline.input_pay_amount"));if(!Fe((t=ae.value)==null?void 0:t.source,(s=Q.value)==null?void 0:s.realTotalAmountShow))return ye(!0);Z(!0);try{await We();const{success:f,data:u}=await yo(a);if(!f){Z(!1);return}const{success:h}=await Ne(a.merchantAddress,u.orderTotalAmount,a.discountRatio,a.orderPaySource,u.isScanFlag,u.allId);if(!h){Z(!1);return}se.loading({message:N("order.wait block chain"),forbidClick:!0,duration:0}),await go({id:u==null?void 0:u.orderId,currentOrderStatus:Oe.PAYING}),se.clear(),u.isScanFlag?ge(!0):(se({message:N("common.pay success"),icon:ho("toast-success.svg"),duration:3e3,overlay:!0,overlayClass:"toastOverlay",className:"toastCard"}),setTimeout(()=>{m.replace({path:"offlineConsumerorders",query:{status:Oe.PAYMENT_SUCCESS}})},3e3))}finally{Z(!1)}},je=()=>{m.replace({path:"profile",query:{path:Po.CONSUMER,tab:Ao.OFFLINE}})};return Je(async()=>{pe(!0);try{await Promise.all([Ae(),he()]);const t=Ee(q.value,we.value);ue(t)}catch(t){console.error("Failed to initialize payment method:",t)}finally{pe(!1)}}),eo(()=>{A.changeOfflineInfo(null)}),(t,s)=>{const f=ie("van-button"),u=ie("VanField"),h=ie("VanButton");return d(),I(ro,{title:t.$t("order.order"),class:"h-full font-Puhui font-normal relative",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent",fieldInputTextColor:"#585654"}},{default:te(()=>{var v,S,_,x,$,F,U,M,W,G,j,K,z,H;return[(v=o(e).goods)!=null&&v.goodsPrice||(S=o(e).store)!=null&&S.merchant?(d(),k(xe,{key:0},[r("div",zo,[r("div",Ho,[o(p)===o(i).PPC?(d(),I(So,{key:0,order:{orderCustomerAddress:(x=(_=o(e))==null?void 0:_.store)==null?void 0:x.merchant},showStatus:!1},null,8,["order"])):(d(),I(no,{key:1,store:{images:(F=($=o(e))==null?void 0:$.store)==null?void 0:F.logo,name:(M=(U=o(e))==null?void 0:U.store)==null?void 0:M.storeName}},null,8,["store"])),o(p)===o(i).GOODS?(d(),I(ao,{key:2,class:"mt-3",goods:(W=o(e))==null?void 0:W.goods},{"bottom-right":te(()=>[r("div",Yo,[P(f,{icon:"minus",size:"mini",type:"primary",class:"num-btn w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-l",disabled:+o(e).goodsNumber<=1,onClick:s[0]||(s[0]=n=>le(+o(e).goodsNumber-1))},null,8,["disabled"]),r("div",Qo,[P(u,{class:"text-center rounded input-box",type:"digit",modelValue:o(e).goodsNumber,"onUpdate:modelValue":[s[1]||(s[1]=n=>o(e).goodsNumber=n),le]},null,8,["modelValue"])]),P(f,{icon:"plus",size:"mini",type:"primary",class:"w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-r",onClick:s[2]||(s[2]=n=>le(+o(e).goodsNumber+1))})])]),_:1},8,["goods"])):(d(),k("div",Xo,[Zo,P(u,{"input-align":"right",placeholder:t.$t("offline.input_pay_amount"),class:"py-0 pr-0 bg-[transparent]",modelValue:o(e).inputAmount,"onUpdate:modelValue":s[3]||(s[3]=n=>o(e).inputAmount=n),type:"number",formatter:Ue,readonly:+(((G=o(l).query)==null?void 0:G.amount)||0)>0},null,8,["placeholder","modelValue","readonly"])]))]),r("div",Jo,[r("div",et,[r("span",ot,c(t.$t("order.buyerRemark")),1),o(ve)?O("",!0):(d(),k("span",{key:0,class:"text-b3",onClick:s[4]||(s[4]=n=>o(be)(!0))},c(t.$t("common.pleaseInput"))+c(t.$t("order.remark")),1))]),o(ve)?(d(),I(u,{key:0,ref:(n,D)=>{D.remarkRef=n,Se.value=n},modelValue:o(e).remark,"onUpdate:modelValue":s[5]||(s[5]=n=>o(e).remark=n),type:"textarea",maxlength:"100",class:"!bg-b5 rounded-lg mt-2 p-2"},null,8,["modelValue"])):O("",!0)]),P(_o,{class:"mt-3",modelValue:b.value,"onUpdate:modelValue":s[6]||(s[6]=n=>b.value=n),"payment-options":o(Ve),loading:o(R).loading,boutique:E.value,onChange:ue,onGetPointBalance:o(he)},null,8,["modelValue","payment-options","loading","boutique","onGetPointBalance"]),P(jo,{ref:(n,D)=>{D.priceDetailRedf=n,Q.value=n},totalAmount:o(q),"usdt-rate":o(R).usdtRate,"voucher-price":o(R).voucherBalance,integral:o(_e),voucherAmount:o(ne),paySource:b.value,class:"mb-2.5"},null,8,["totalAmount","usdt-rate","voucher-price","integral","voucherAmount","paySource"])]),r("div",tt,[[o(C).WALLET].includes(b.value)?(d(),I(de,{key:0,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(V).order,token:o(V).MCOIN,symbol:((j=o(ae))==null?void 0:j.symbol)||"MCOIN",loading:o(X),approveAmount:Number(((K=Q.value)==null?void 0:K.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):O("",!0),[o(C).USDT_WALLET].includes(b.value)?(d(),I(de,{key:1,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(V).order,token:o(V).USDT,symbol:((z=o(ae))==null?void 0:z.symbol)||"USDT",loading:o(X),approveAmount:Number(((H=Q.value)==null?void 0:H.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):O("",!0),o(ne)>0?(d(),I(de,{key:2,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(V).order,token:o(V).FMCP,symbol:t.$t("voucher.voucher"),loading:o(X),approveAmount:Number(o(ne))},null,8,["contract","token","symbol","loading","approveAmount"])):O("",!0),P(h,{round:"",class:"pay-btn btn-yellow w-full h-[46px]",loading:o(X),disabled:!o(q),onClick:Ge},{default:te(()=>[oo(c(t.$t("common.pay")),1)]),_:1},8,["loading","disabled"])])],64)):O("",!0),P(ko,{"pay-source":b.value,show:o(De),onClose:s[7]||(s[7]=n=>o(ye)(!1)),onChangePay:s[8]||(s[8]=n=>ue(n))},null,8,["pay-source","show"]),P(fo,{show:o(Be),noClose:"",onClose:s[9]||(s[9]=n=>o(ge)(!1))},{default:te(()=>[r("div",st,[r("div",rt,c(t.$t("common.pay success")),1),r("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:je},c(t.$t("common.I_see")),1)])]),_:1},8,["show"])]}),_:1},8,["title"])}}const lt=me({...at,setup:nt}),$t=He(lt,[["__scopeId","data-v-2ff46501"]]);export{$t as default};
