import{_ as Te,y as E,F as L,Z as k,H as O,$ as U,I as e,U as N,P as p,Q as R,O as o,bs as De,a0 as ne,X as Se,Y as $e,br as Ie,a2 as d,r as v,E as ke,ab as Oe,a3 as Ue,a4 as Le,N as Ne,bj as Re,bt as Me,T as u,u as Fe}from"./vendor-Dr_RpJ_Y.js";import{g as je}from"./tqyz-Chzw8p51.js";import{S as Pe}from"./Switch-DuYcYVSQ.js";import{C as ze}from"./CommonVanProvider-D__Wy38-.js";import{u as ae,f as Be,h as He,C as q,ab as qe,ac as Ee}from"./index-CU2nzZe6.js";import{a as Ge}from"./activityContract-BYX-PliU.js";import{g as Qe}from"./utils-DPKQXUBz.js";import{_ as Xe}from"./copy-w-Dr8nkqKW.js";import{_ as oe}from"./EmptyTipsPop-DC2OBzZY.js";import"./BackIcon-CDrGaEPo.js";const G=h=>(Se("data-v-455a8eb7"),h=h(),$e(),h),Ye={class:"w-[335px] max-w-[335px] bg-[#f5f5f5] rounded-[16px] overflow-hidden font-Puhui",id:"saveHtml"},Ze={class:"relative px-4 py-4 text-center border-b border-[#F5F5F5]"},Je=G(()=>e("div",{class:"text-base font-bold text-b1"},"新验证地址授权",-1)),Ke={class:"p-4 pt-0"},We=G(()=>e("div",{class:"scan-tips rounded-lg p-2 mb-4"},[e("p",{class:"text-sm text-[#7D3619] font-normal"}," 请使用钱包扫码或进入下方链使用刚才添加的验证地址进行签名确认添加地址 ")],-1)),es={class:"bg-white rounded-lg flex-col justify-center items-center w-full p-3"},ss={class:"flex-col justify-center items-center"},ts={class:"text-sm text-b1 font-normal mx-auto text-center"},os={class:"flex items-center justify-center mt-1"},ns={class:"flex-1 text-sm text-b3 font-normal line-clamp-1 max-w-[160px]"},as=G(()=>e("img",{src:Xe,class:"w-5 h-5",alt:""},null,-1)),rs=[as],ls={class:"flex justify-center mt-3",id:"qr-code-container"},is={props:{show:{type:Boolean,default:!1},newAddress:{type:String,required:!0},qrForm:{type:[Object],default:()=>({owner:"",address:"",messageHash:"",signature:"",url:""})}},emits:["close","update:show"],setup(h,{emit:D}){const S=h,{getCurrentAccount:x}=ae(),y=E(()=>{const I=x()||"",r=S.qrForm||{},f=Date.now().toString(),a=btoa(encodeURIComponent(r.owner||I)),l=btoa(encodeURIComponent(r.address)),C=btoa(encodeURIComponent(r.messageHash)),g=btoa(encodeURIComponent(r.signature)),w=btoa(encodeURIComponent(f)),A=window.location.origin+"/#/securityAddAddressVerify",M=new URLSearchParams({myad:a,newad:l,h:C,s:g,t:w,type:"addAddressVerify"});return`${A}?${M.toString()}`});E(()=>`【帮我添加多重验证地址】:${S.newAddress}`);const b=()=>{D("update:show",!1),D("close")},$=()=>{He(y.value,"链接已复制")};return(I,r)=>{const f=L("van-icon"),a=L("VanPopup");return O(),k(a,{show:h.show,"onUpdate:show":r[4]||(r[4]=l=>ne(show)?show.value=l:null),"close-on-click-overlay":!0,onClose:b,style:{background:"transparent"}},{default:U(()=>[e("div",Ye,[e("div",Ze,[Je,p(f,{name:"cross",size:"20",class:"absolute right-4 top-1/2 -translate-y-1/2 cursor-pointer",onClick:b})]),e("div",Ke,[We,e("div",es,[e("div",ss,[e("p",ts,R(o(Be)(h.qrForm.owner,"...",4,4))+"正在添加多重验证地址 ",1),e("div",os,[e("p",ns,R(o(y)),1),e("div",{class:"min-w-fit ml-1",onClick:$},rs)])]),e("div",ls,[p(De,{value:o(y),size:239,level:"L"},null,8,["value"])])])])]),N("",!0),N("",!0)]),_:1},8,["show"])}}},cs=Te(is,[["__scopeId","data-v-455a8eb7"]]),ds={class:"py-3"},us={class:"mx-3 mb-3 bg-[#FFF9E6] rounded-lg px-4 py-3"},fs={class:"text-sm text-b2 font-normal"},ms={class:"bg-white rounded-[12px] px-3 py-4 flex items-center justify-between mx-3"},ps={class:"flex items-center flex-1 gap-2 flex-nowrap"},hs={class:"w-9 h-9"},vs=["src"],gs=["onClick"],ws=e("div",{class:"text-sm text-b1 font-normal whitespace-nowrap"},"安全验证",-1),_s={class:"flex items-center gap-2 flex-nowrap"},xs={class:"text-sm text-b3 font-normal line-clamp-1"},ys=e("span",null,"已添加",-1),bs=e("span",null,"个验证地址",-1),Cs={class:"w-full p-3 mx-auto fixed bottom-0 left-0 right-0 bg-gray1 safe-bottom"},As=Le(" 添加地址 "),Vs={class:""},Ts=e("p",{class:"text-sm text-b1 font-normal text-left"},"地址",-1),js={setup(h){const{isEqual:D,cloneDeep:S}=Ie,{secondConfirmView:x,closeSecondConfirm:y}=Ge(),[b,$]=d(!1),[I,r]=d(!1),f=v(!1),a=v(0),l=2,C=v(0),g=v(0),w=v([]),A=async()=>{try{r(!0);const s=await x();if(s.success){const{frozen:t,agreeExpired:i}=s.result||{};C.value=t.toNumber()||0,w.value=S(i)||[];const m=(i==null?void 0:i.length)||0;console.log("授权数量",m),f.value=m>0;const c=Math.floor(Date.now()/1e3),Ve=0,te=(i||[]).map(T=>T.toNumber()+Ve).filter(T=>(console.log("时间有效吗？",T,T>c?"是":"否"),T>c));a.value=m||0,te.length>0?g.value=Math.min(...te):g.value=0}else r(!1)}catch(s){console.error("获取验证状态失败:",s),f.value=!1,a.value=0,C.value=0,g.value=0}finally{r(!1)}},M=E(()=>l-a.value),re=async s=>{f.value?ce():J()},[le,Q]=d(!1),[X,Y]=d(!1),[ie,Z]=d(!1),ce=()=>{Q(!0)},F=()=>{Q(!1),Y(!1)},de=async()=>{Y(!0);const s=await y();s.success?(Z(!0),setTimeout(()=>{location.reload()},2e3)):u.fail(s.message||"关闭失败"),F()},[j,P]=d(!1),[ue,z]=d(!1),[B,fe]=d(!1),me=v(""),n=v({owner:"",address:"",messageHash:"",signature:""}),J=()=>{const s=Math.floor(Date.now()/1e3);if((C.value||0)>=s){u.fail("关闭期间内不允许添加地址！");return}if(a.value>=l){u.fail(`最多添加${l}个验证地址`);return}z(!0)},pe=()=>{z(!1),H(),n.value.address="",n.value.owner="",n.value.messageHash="",n.value.signature=""},he=async()=>{const s=ae().getCurrentAccount();if(n.value.address.trim()===""){u.fail("请输入地址");return}if(!Fe.isAddress(n.value.address)){u.fail("请输入正确的地址");return}if(n.value.address.trim().toLowerCase()===s.toLowerCase()){u.fail("不能添加自己的地址");return}if(a.value>=l){u.fail(`最多添加${l}个验证地址`);return}console.log("addAddressForm.value",n.value);try{if(P(!0),!s){u.fail("请先连接钱包");return}console.log("account",s);const t=Qe(),i=await qe(t);console.log("生成消息哈希通过",i.result);const m=await Ee(t);if(console.log("生成签名通过",m.result),!m.success){u.fail("签名失败"),P(!1);return}n.value.owner=s,n.value.address=n.value.address.trim(),n.value.messageHash=i.result||"",n.value.signature=m.result||"",fe(!0),z(!1),console.log("打开分享弹窗成功",n.value),ve()}catch(t){console.error("添加地址失败:",t),u.fail("添加地址失败")}finally{P(!1)}};let _=null;const ve=async()=>{try{const s=await x();if(s.success){const{agreeExpired:t}=s.result||{};w.value=t||[]}}catch(s){console.error("获取初始验证状态失败:",s),w.value=[]}_&&clearInterval(_),_=setInterval(()=>{ge()},3e3)},H=()=>{_&&(clearInterval(_),_=null),w.value=[]},ge=async()=>{try{const s=await x();if(s.success){const{agreeExpired:t}=s.result||{};D(w.value,t)||(_e(),H(),await A())}}catch(s){console.error("检查新地址验证失败:",s)}},[we,K]=d(!1),_e=()=>{K(!0)},xe=()=>{K(!1)},W=v(Math.floor(Date.now()/1e3));let V=null;const ye=()=>{V&&clearInterval(V),V=setInterval(()=>{W.value=Math.floor(Date.now()/1e3),g.value>0&&g.value<=W.value&&A()},1e3)},[be,ee]=d(!1),Ce=()=>{ee(!0)},se=()=>{ee(!1)},Ae=async()=>{try{$(!0),await A(),ye()}catch(s){console.error("初始化数据失败:",s)}finally{$(!1)}};return ke(()=>{Ae()}),Oe(()=>{V&&clearInterval(V),H()}),(s,t)=>{const i=L("van-icon"),m=L("VanButton");return O(),k(ze,{title:"安全验证",class:"font-Puhui font-normal relative pb-20 bg-gray1",themeVars:{navBarBackgroundColor:"#ffffff"}},{default:U(()=>[e("div",ds,[e("div",us,[e("p",fs," 当前最多添加"+R(o(M))+"个验证地址，关闭验证后多签地址将删除 ",1)]),e("div",ms,[e("div",ps,[e("div",hs,[e("img",{src:o(je),class:"w-full h-full",alt:"提取验证"},null,8,vs)]),e("div",{class:"flex-1 flex items-center gap-1",onClick:Ue(Ce,["stop"])},[ws,p(i,{name:"info-o",color:"#999"})],8,gs)]),e("div",_s,[e("p",xs,[ys,e("span",null,R(a.value),1),bs]),p(Pe,{modelValue:f.value,"onUpdate:modelValue":t[0]||(t[0]=c=>f.value=c),"is-async":"",loading:o(I)||o(b),onClick:re},null,8,["modelValue","loading"])])])]),e("div",Cs,[p(m,{onClick:J,loading:o(j)||o(b),disabled:a.value>=l,class:Ne(["bg-btnOrBg w-full h-[46px] flex-center text-b1 text-base font-semibold z-50 rounded-3xl",{"!bg-[#D9D9D9] !opacity-100":a.value>=l}])},{default:U(()=>[As]),_:1},8,["loading","disabled","class"])]),p(q,{show:o(ue),title:"添加新验证地址",showConfirm:!0,showReject:!1,confirmText:"添加",loading:o(j),confirmDisabled:o(j),onClose:pe,onConfirm:he},{default:U(()=>[e("div",Vs,[e("div",null,[Ts,Re(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=c=>n.value.address=c),placeholder:"请输入新地址，请注意地址填写正确",class:"w-full h-[56px] rounded-lg bg-[#f5f5f5] p-2 text-b1 mt-1"},null,512),[[Me,n.value.address,void 0,{trim:!0}]])])])]),_:1},8,["show","loading","confirmDisabled"]),p(q,{show:o(le),content:"关闭多签验证后30天内无法进行提取操作，是否关闭",contentClass:"text-b1 !text-left text-sm font-semibold",showConfirm:!0,showReject:!0,noClose:!0,loading:o(X),confirmDisabled:o(X),"confirm-text":"关闭",onClose:F,onReject:F,onConfirm:de},null,8,["show","loading","confirmDisabled"]),o(ie)?(O(),k(oe,{key:0,onClose:t[2]||(t[2]=c=>o(Z)(!1)),text:"提交成功，将于30天后关闭"})):N("",!0),p(cs,{show:o(B),"onUpdate:show":t[3]||(t[3]=c=>ne(B)?B.value=c:null),newAddress:me.value,"qr-form":n.value},null,8,["show","newAddress","qr-form"]),o(we)?(O(),k(oe,{key:1,onClose:t[4]||(t[4]=c=>xe()),text:"对方验证成功"})):N("",!0),p(q,{show:o(be),title:"安全验证",content:"开启功能后,通证权益LP解押/MAI解押/抵押借贷的归还借贷功能需要多签授权才能操作",showConfirm:!0,showReject:!1,confirmText:"确认",onClose:se,onConfirm:se},null,8,["show"])]),_:1})}}};export{js as default};
