import{bP as Ee,T as R,i as et,z as ne,y as oe,bQ as $e,E as be,F as U,G as S,O as c,H as g,I as e,Q as P,a3 as G,U as J,P as $,_ as Ve,Z,$ as E,a4 as de,X as De,Y as Re,a2 as pe,x as ce,r as k,a1 as ge,ad as je,n as fe,aL as tt,bl as we,K as he,J as xe,N as me,B as ze,bR as st,D as Se,bv as ot,o as nt,q as at,bS as Ie,by as lt}from"./vendor-Dr_RpJ_Y.js";import{au as it,g as Oe,h as rt,y as ct,bx as Be,k as ut,ax as dt,ay as pt,e as vt,B as He,N as ft,Y as se,a as mt,s as Le}from"./index-LRhcxFAI.js";import{u as gt}from"./upload-AP7UGkIr.js";import{u as Ne}from"./useKeyboard-DcWqtm11.js";import{B as ht}from"./BackIcon-CDrGaEPo.js";import{_ as Ge}from"./mcoin-logo-1-Deho8IWN.js";import{_ as Ye}from"./MCOIN-Bodfn-v1.js";import{b as xt,d as wt,e as bt,f as _t,g as yt,h as kt}from"./innerService-ZG28S5gZ.js";import{_ as $t}from"./credit-EZuPIBEN.js";import{m as It}from"./order-CCndJpZE.js";const{t:Ct}=it.global,Pe=async(a,p,i)=>{console.log(a);try{const s=await Lt(a),L=await Pt(a);return{success:!0,content:{content:await St(L),extra:JSON.stringify({type:a.type,duration:0,fileSize:a.size,name:a.name,width:p,height:i}),thumbnail:s}}}catch(s){return console.error("处理图片失败",s),{success:!1,file:a,msg:s}}},St=a=>new Promise(async(p,i)=>{const s=await gt({file:a});if(s.msg!="SUCCESS")return R(Ct("comomn.Image upload failed")),i();p(Oe.imgUrl+s.data)}),Lt=(a,p=400)=>new Promise(i=>{const s=new FileReader;s.onload=L=>{const n=new Image;n.onload=()=>{const l=document.createElement("canvas"),r=l.getContext("2d"),I=p/n.width;l.width=p,l.height=n.height*I,r.drawImage(n,0,0,l.width,l.height);const u=l.toDataURL(a.type,.6).split(",")[1];i(u)},n.src=L.target.result},s.readAsDataURL(a)}),Pt=async a=>{const p=new Ee,i=a.name;p.file(i,a);const s=await p.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}});return new File([s],`${i}.zip`,{type:"application/zip"})},Ft=async a=>{try{const p=await Tt(a),i=await Ee.loadAsync(p);let s;for(let n in i.files){s=i.files[n];break}if(!s)throw new Error("压缩包内未找到对应图片");const L=await s.async("blob");return URL.createObjectURL(L)}catch(p){throw console.error("解压预览失败:",p),p}},Tt=async a=>{try{const i=(await et.get(Oe.baseUrl+"/file/download?path="+encodeURIComponent(a),{responseType:"blob",headers:{"Cache-Control":"no-cache"}})).data;if(i.size===0)throw new Error("文件为空");return i}catch(p){throw console.error("Axios 下载失败:",p),p}},At=""+new URL("../images/toast-warn-BKIYTzJC.svg",import.meta.url).href,Mt={class:"text-sm text-b1 font-normal break-all whitespace-pre-wrap"},Bt={key:0,class:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10 w-full h-full"},Ut={class:"w-full h-full bg-[rgba(0,0,0,0.5)] rounded-[4px] flex justify-center items-center cursor-pointer"},Et=["onClick"],Vt={class:"w-full"},Dt={class:"text-sm text-b1 font-semibold line-clamp-1"},Rt={class:"mt-[2px] text-xs leading-[18px] text-b3 font-normal line-clamp-1"},jt={key:0,class:"mt-[2px] text-xs text-b1 font-semibold leading-[18px] flex items-center gap-1"},zt=e("img",{src:Ge,class:"w-4 h-4",alt:""},null,-1),Ot=["onClick"],Ht={class:"w-full"},Nt={class:"flex items-center text-sm text-b1 font-semibold"},Gt={class:"line-clamp-1"},Yt={key:0,class:"shrink-0"},Kt={class:"mt-[2px] text-xs leading-[18px] text-b3 font-normal line-clamp-1"},Jt={key:0,class:"mt-[2px] text-xs text-b1 font-semibold leading-[18px] flex items-center gap-1"},Wt=e("img",{src:Ge,class:"w-4 h-4",alt:""},null,-1),qt={key:4,class:"p-3 bg-white rounded-lg"},Zt=e("span",{class:"text-sm text-b1 font-normal"}," [未知消息类型，请打开 MetaKey App 查看] ",-1),Qt=[Zt],Ue=ne({props:{messageId:null,content:null,createAt:null,isMe:{type:Boolean}},emits:["handleTo","previewImage"],setup(a,{emit:p}){const i=a,s=oe(()=>{let F;try{F=JSON.parse(i.content)}catch{F={}}return F}),L=oe(()=>{var u,t;return((t=(u=s.value.detail)==null?void 0:u.title)==null?void 0:t.split(","))||[]}),n=()=>{let F="";i.isMe?F=s.value.myUrl||"":F=s.value.otherUrl||"";const t=new URL(F).hash.slice(1);p("handleTo",t)},l=$e("initPreviewImgList",null),r=$e("getCurrentBigImgLoading",null),I=$e("getPreviewBase64Prefix",null);return be(()=>{s.value.type==2&&l({messageId:i.messageId,createAt:i.createAt,thumbnail:s.value.thumbnail,bigImage:"",loading:!1,open:!1,err:!1})}),(F,u)=>{var h,T,j,M,b,v,H,W,q;const t=U("VanLoading"),_=U("VanImage");return c(s).type==1?(g(),S("div",{key:0,class:"w-fit p-3 bg-white rounded-lg",onClick:u[0]||(u[0]=G(te=>c(rt)(c(s).content||""),["stop"]))},[e("span",Mt,P(c(s).content||""),1)])):c(s).type==2?(g(),S("div",{key:1,class:"w-fit max-w-[75%] flex justify-end relative",onClick:u[1]||(u[1]=G(te=>p("previewImage"),["stop"]))},[c(r)(a.messageId)?(g(),S("div",Bt,[e("div",Ut,[$(t,{color:"#999",size:"24"})])])):J("",!0),$(_,{class:"shrink-0 w-full max-h-[320px] object-cover",radius:4,src:c(I)()+c(s).thumbnail,fit:"cover"},null,8,["src"])])):c(s).type==5001?(g(),S("div",{key:2,class:"w-full p-3 bg-white rounded-lg flex items-start gap-2",onClick:G(n,["stop"])},[$(_,{class:"shrink-0 w-[40px] h-[40px]",radius:4,src:(h=c(s).detail)==null?void 0:h.image,fit:"cover"},null,8,["src"]),e("div",Vt,[e("div",Dt,P(((T=c(s).detail)==null?void 0:T.title)||""),1),e("div",Rt,P(((j=c(s).detail)==null?void 0:j.description)||""),1),(M=c(s).detail)!=null&&M.price?(g(),S("div",jt,[zt,e("span",null,P((b=c(s).detail)==null?void 0:b.price),1)])):J("",!0)])],8,Et)):c(s).type==5002?(g(),S("div",{key:3,class:"w-full p-3 bg-white rounded-lg flex items-start gap-2",onClick:G(n,["stop"])},[$(_,{class:"shrink-0 w-[40px] h-[40px]",radius:4,src:(v=c(s).detail)==null?void 0:v.image,fit:"cover"},null,8,["src"]),e("div",Ht,[e("div",Nt,[e("div",Gt,P(c(L)[0]),1),c(L).length>1?(g(),S("div",Yt,P(`等${c(L).length}个商品`),1)):J("",!0)]),e("div",Kt,P(((H=c(s).detail)==null?void 0:H.description)||""),1),(W=c(s).detail)!=null&&W.price?(g(),S("div",Jt,[Wt,e("span",null,P((q=c(s).detail)==null?void 0:q.price),1)])):J("",!0)])],8,Ot)):(g(),S("div",qt,Qt))}}}),Xt=a=>(De("data-v-268e54a0"),a=a(),Re(),a),es={class:"p-[4px]"},ts=Xt(()=>e("div",{class:"pb-6 text-[#2E2008] text-[14px] font-semibold text-center"}," 消息发送失败，是否重新发送？ ",-1)),ss={class:"w-full flex items-center gap-[12px]"},os=ne({props:{show:{type:Boolean}},emits:["close","confirm"],setup(a,{emit:p}){const i=()=>{p("confirm"),p("close")};return(s,L)=>{const n=U("van-button");return g(),Z(ct,{width:"90%",show:a.show,noClose:"",onClose:L[1]||(L[1]=()=>{p("close")})},{default:E(()=>[e("div",es,[ts,e("div",ss,[$(n,{class:"w-1/2 h-[46px] border-[1px] border-[#D9D9D9] border-solid rounded-[100px] text-[#2E2008] text-[16px] font-Puhui font-normal leading-[46px]",onClick:L[0]||(L[0]=()=>{p("close")})},{default:E(()=>[de(P(s.$t("common.cancel")),1)]),_:1}),$(n,{class:"w-1/2 h-[46px] bg-[#F44] border-none rounded-[100px] text-white text-[16px] font-Puhui font-semibold leading-[46px]",onClick:i},{default:E(()=>[de(P(s.$t("common.confirm")),1)]),_:1})])])]),_:1},8,["show"])}}}),ns=Ve(os,[["__scopeId","data-v-268e54a0"]]),as={key:0,class:"flex flex-col items-center"},ls={key:0,class:"text-xs leading-[18px] text-b3 font-normal mb-4"},is={class:"w-full flex items-start flex-row-reverse gap-2"},rs={class:"ml-[40px] w-full flex justify-end"},cs={class:"relative"},us={key:0,class:"absolute left-[-28px] top-1/2 -translate-y-1/2"},ds=e("img",{class:"w-5 h-5",src:At,alt:""},null,-1),ps=[ds],vs={key:1,class:"flex flex-col items-center"},fs={key:0,class:"text-xs leading-[18px] text-b3 font-normal mb-4"},ms={class:"w-full flex items-start gap-2"},gs={class:"mr-[40px] w-full flex justify-start"},hs=ne({props:{chat:null,last:null,index:null,length:null,storeLogo:null},emits:["resetSendMessage","handleTo","previewImage"],setup(a,{emit:p}){const i=a,[s,L]=pe(!1),n=oe(()=>!!(i.index===i.length-1||i.last&&i.chat.createAt-i.last.createAt>=3*60*1e3||(i.index+1)%30===0));return(l,r)=>{const I=U("VanImage"),F=U("VanLoading");return g(),S("div",null,[a.chat.isMe?(g(),S("div",as,[c(n)?(g(),S("div",ls,P(c(Be)(a.chat.createAt,{year:"YYYY年MM月DD日",month:"MM月DD日",time:"HH:mm"})),1)):J("",!0),e("div",is,[$(I,{class:"shrink-0 w-[32px] h-[32px]",radius:4,src:c(ut)("images/default-img.png"),fit:"cover"},null,8,["src"]),e("div",rs,[e("div",cs,[a.chat.status==="loading"?(g(),S("div",us,[$(F,{size:"20"})])):a.chat.status==="fail"?(g(),S("div",{key:1,class:"absolute left-[-28px] top-1/2 -translate-y-1/2",onClick:r[0]||(r[0]=G(u=>c(L)(!0),["stop"]))},ps)):J("",!0)]),$(Ue,{messageId:a.chat.messageId,content:a.chat.content,createAt:a.chat.createAt,isMe:"",onHandleTo:r[1]||(r[1]=u=>p("handleTo",u)),onPreviewImage:r[2]||(r[2]=u=>p("previewImage"))},null,8,["messageId","content","createAt"])])])])):(g(),S("div",vs,[c(n)?(g(),S("div",fs,P(c(Be)(a.chat.createAt,{year:"YYYY年MM月DD日",month:"MM月DD日",time:"HH:mm"})),1)):J("",!0),e("div",ms,[$(I,{class:"shrink-0 w-[32px] h-[32px]",radius:4,src:a.storeLogo,fit:"cover"},null,8,["src"]),e("div",gs,[$(Ue,{messageId:a.chat.messageId,content:a.chat.content,createAt:a.chat.createAt,onHandleTo:r[3]||(r[3]=u=>p("handleTo",u)),onPreviewImage:r[4]||(r[4]=u=>p("previewImage"))},null,8,["messageId","content","createAt"])])])])),$(ns,{show:c(s),onConfirm:r[5]||(r[5]=u=>p("resetSendMessage",a.chat)),onClose:r[6]||(r[6]=u=>c(L)(!1))},null,8,["show"])])}}}),xs=""+new URL("../images/add-line-GTaWweOa.svg",import.meta.url).href,ws=""+new URL("../images/add-close-line-6fv42zRf.svg",import.meta.url).href,bs={class:"w-[100vw] h-[100vh] relative flex flex-col justify-center"},_s=["src"],ys={class:"absolute top-[20px] left-6 right-[20px] flex justify-between items-center gap-[15px]"},ks={emits:["sendCamera"],setup(a,{emit:p}){const[i,s]=pe(!1),{t:L}=ce(),n=k(""),l=k(null),r=k(!1),I=h=>{const T=Array.isArray(h)?h:[h];if(T.length>4){R(L("service.image number limit",{val:4}));return}T.length!==0&&F(T[0].file)},F=h=>{l.value=h,n.value=URL.createObjectURL(h),s(!0)},u=()=>{s(!1),l.value=null,n.value=""},t=async()=>{var h,T,j;if(!r.value&&l.value){R.loading({forbidClick:!0,zIndex:3001,className:"preview-img-loading"}),r.value=!0;try{const M=await _(l.value),b=await Pe(l.value,M==null?void 0:M.width,M==null?void 0:M.height);s(!1),(h=b.content)!=null&&h.content&&((T=b.content)!=null&&T.extra)&&((j=b.content)!=null&&j.thumbnail)?(p("sendCamera",b),setTimeout(()=>{r.value=!1,R.clear()},500)):(r.value=!1,R(L("service.image send error")))}catch(M){r.value=!1,console.error(M)}}},_=h=>new Promise((T,j)=>{if(h.type.startsWith("image/")){const M=new FileReader;M.readAsDataURL(h),M.onload=b=>{const v=new Image;v.src=b.target.result,v.onload=()=>{console.log(`图片原始尺寸: ${v.width}x${v.height}`),T({width:v.width,height:v.height})},v.onerror=H=>{console.error("加载图片失败:",H),R(L("service.image load error")),j()}}}else j()});return(h,T)=>{const j=U("van-button"),M=U("van-uploader"),b=U("VanPopup");return g(),S("div",null,[$(M,{capture:"environment",accept:"image/*","after-read":I,class:"!w-fit !h-fit !border-none"},{default:E(()=>[$(j,{class:"!w-fit !h-fit !border-none"},{default:E(()=>[ge(h.$slots,"default")]),_:3})]),_:3}),$(b,{show:c(i),position:"center",style:{background:"#000","z-index":"2999"},"close-on-click-overlay":!1,teleport:"body"},{default:E(()=>[e("div",bs,[e("img",{src:n.value,class:"w-full h-full object-cover"},null,8,_s),e("div",ys,[e("div",{class:"text-white text-sm",onClick:u},P(h.$t("common.cancel")),1),$(j,{class:"w-fit h-[28px] text-sm bg-b1 border-none rounded-[4px]",type:"primary",onClick:t},{default:E(()=>[de(P(h.$t("service.send")),1)]),_:1})])])]),_:1},8,["show"])])}}},$s=a=>(De("data-v-2fca81b0"),a=a(),Re(),a),Is={class:"w-[100vw] h-[100vh] relative flex flex-col"},Cs={class:"absolute bottom-[40px] left-0 right-0 flex justify-around items-center"},Ss=$s(()=>e("div",{class:"shutter-inner"},null,-1)),Ls=[Ss],Ps={class:"w-[100vw] h-[100vh] relative flex flex-col justify-center"},Fs=["src"],Ts={class:"absolute top-[20px] left-6 right-[20px] flex justify-between items-center gap-[15px]"},As={emits:["sendCamera"],setup(a,{emit:p}){const[i,s]=pe(!1),[L,n]=pe(!1),{t:l}=ce(),r=k(!1),I=k(null),F=k(""),u=k(0),t=k(0),_=k(null),h=k(null);let T=null,j="environment";const M=async()=>{if(!r.value){r.value=!0;try{const m=await navigator.mediaDevices.getUserMedia({video:{facingMode:j,width:{ideal:4096},height:{ideal:2160}},audio:!1});v(m)}catch(m){console.error("Camera Permission Failed:",m),b(m)}finally{r.value=!1}}},b=m=>{let V=l("service.camera error default"),A=l("service.auth tips");m.name==="NotAllowedError"||m.name==="PermissionDeniedError"?(A=l("service.camera auth disbled"),V=l("service.camera error please open")):m.name==="NotFoundError"?V=l("service.camera error no camera"):m.name==="NotReadableError"&&(V=l("service.camera error close other app")),tt.alert({title:A,message:V,theme:"round-button",confirmButtonColor:"#000",confirmButtonText:l("service.know")})},v=m=>{T=m,s(!0),fe(()=>{_.value&&(_.value.srcObject=m,_.value.play().catch(V=>console.log("Auto-play blocked",V)))})},H=async()=>{if(!_.value)return;const m=_.value;if(window.ImageCapture)try{const w=await new ImageCapture(videoTrack).takePhoto(),O=new File([w],`cam_${Date.now()}.jpg`,{type:"image/jpeg"});I.value=O,F.value=URL.createObjectURL(O),u.value=m.videoWidth,t.value=m.videoHeight,n(!0);return}catch(x){console.warn("ImageCapture 失败，降级使用 Canvas",x)}if(!h.value)return;const V=h.value,A=V.getContext("2d");V.width=m.videoWidth,V.height=m.videoHeight,A.drawImage(m,0,0,V.width,V.height),q(),s(!1),V.toBlob(x=>{const w=new File([x],`cam_${Date.now()}.jpg`,{type:"image/jpeg"});I.value=w,F.value=URL.createObjectURL(w),u.value=m.videoWidth,t.value=m.videoHeight,n(!0)},"image/jpeg",.95)},W=()=>{q(),j=j==="environment"?"user":"environment",M()},q=()=>{T&&(T.getTracks().forEach(m=>m.stop()),T=null)},te=()=>{q(),s(!1)},X=k(!1),ee=async()=>{var m,V,A;if(!X.value){X.value=!0,R.loading({forbidClick:!0,zIndex:3001,className:"preview-img-loading"});try{const x=await Pe(I.value,u.value,t.value);n(!1),(m=x.content)!=null&&m.content&&((V=x.content)!=null&&V.extra)&&((A=x.content)!=null&&A.thumbnail)&&p("sendCamera",x),setTimeout(()=>{X.value=!1,R.clear()},500)}catch{X.value=!1,console.error(error)}}},ae=()=>{n(!1)};return je(()=>{q()}),(m,V)=>{const A=U("van-button"),x=U("van-icon"),w=U("VanPopup");return g(),S("div",null,[$(A,{class:"!w-fit !h-fit !border-none",loading:r.value,onClick:M},{default:E(()=>[ge(m.$slots,"default",{},void 0,!0)]),_:3},8,["loading"]),$(w,{show:c(i),position:"center",style:{background:"#000","z-index":"2998"},"close-on-click-overlay":!1,teleport:"body"},{default:E(()=>[e("div",Is,[e("video",{ref:(O,Y)=>{Y.videoRef=O,_.value=O},autoplay:"",playsinline:"",muted:"",class:"w-full h-full object-cover"},null,512),e("canvas",{ref:(O,Y)=>{Y.canvasRef=O,h.value=O},style:{display:"none"}},null,512),e("div",Cs,[e("div",{class:"text-white text-base w-[60px] text-center",onClick:te},P(m.$t("common.cancel")),1),e("div",{class:"shutter-button",onClick:H},Ls),e("div",{class:"text-white text-base w-[60px] text-center",onClick:W},[$(x,{name:"replay",size:"24",color:"#fff"})])])])]),_:1},8,["show"]),$(w,{show:c(L),position:"center",style:{background:"#000","z-index":"2999"},"close-on-click-overlay":!1,teleport:"body"},{default:E(()=>[e("div",Ps,[e("img",{src:F.value,class:"w-full h-full object-cover"},null,8,Fs),e("div",Ts,[e("div",{class:"text-white text-sm",onClick:ae},P(m.$t("common.cancel")),1),$(A,{class:"w-fit h-[28px] text-sm bg-b1 border-none rounded-[4px]",type:"primary",onClick:ee},{default:E(()=>[de(P(m.$t("service.send")),1)]),_:1})])])]),_:1},8,["show"])])}}},Ms=Ve(As,[["__scopeId","data-v-2fca81b0"]]),Bs=ne({emits:["sendCamera"],setup(a,{emit:p}){const i=navigator.userAgent,s=/\(i[^;]+;( U;)? CPU.+Mac OS X/i.test(i);return(L,n)=>c(s)?(g(),Z(ks,{key:0,onSendCamera:n[0]||(n[0]=l=>p("sendCamera",l))},{default:E(()=>[ge(L.$slots,"default")]),_:3})):(g(),Z(Ms,{key:1,onSendCamera:n[1]||(n[1]=l=>p("sendCamera",l))},{default:E(()=>[ge(L.$slots,"default")]),_:3}))}}),Us={emits:["sendPhoto"],setup(a,{emit:p}){const{t:i}=ce(),s=async n=>{var I,F,u;const l=Array.isArray(n)?n:[n];if(l.length===0)return;if(l.length>4){R(i("service.image number limit",{val:4}));return}for(let t=0;t<l.length;t++){const _=l[t],h=dt(_.file);if(!h.valid)return R(h.tips);const T=pt(_.file);if(!T.valid)return R(T.tips)}R.loading({forbidClick:!0,zIndex:3001});let r=[];for(const t of l){const _=await L(t.file),h=await Pe(t.file,_==null?void 0:_.width,_==null?void 0:_.height);(I=h.content)!=null&&I.content&&((F=h.content)!=null&&F.extra)&&((u=h.content)!=null&&u.thumbnail)&&r.push(h)}R.clear(),r.length&&p("sendPhoto",r)},L=n=>new Promise((l,r)=>{if(n.type.startsWith("image/")){const I=new FileReader;I.readAsDataURL(n),I.onload=F=>{const u=new Image;u.src=F.target.result,u.onload=()=>{console.log(`图片原始尺寸: ${u.width}x${u.height}`),l({width:u.width,height:u.height})},u.onerror=t=>{console.error("加载图片失败:",t),R(i("service.image load error")),r()}}}else r()});return(n,l)=>{const r=U("van-button"),I=U("van-uploader");return g(),S("div",null,[$(I,{multiple:"",accept:"image/*","after-read":s,class:"!w-fit !h-fit !border-none"},{default:E(()=>[$(r,{class:"!w-fit !h-fit !border-none"},{default:E(()=>[ge(n.$slots,"default")]),_:3})]),_:3})])}}},Es={class:"shrink-0 flex flex-col items-center gap-2"},Vs={class:"shrink-0 w-[64px] h-[64px] bg-white rounded-lg flex justify-center items-center"},Ds={class:"text-sm text-b2 font-normal text-center line-clamp-1"},Ce=ne({props:{data:null},setup(a){return(p,i)=>{const s=U("VanImage");return g(),S("div",Es,[e("div",Vs,[$(s,{class:"shrink-0 w-[30px] h-[30px]",src:a.data.icon},null,8,["src"])]),e("div",Ds,P(a.data.name),1)])}}}),Rs={class:"text-center felx-1 relative pb-4"},js={class:"text-lg leading-[26px] text-b1 font-bold"},zs={class:"absolute right-0 top-0 px-2"},Os={class:"w-full flex items-center gap-2"},Hs={class:"w-full h-[80px] flex flex-col justify-between"},Ns={class:"text-sm text-b1 font-semibold line-clamp-1"},Gs={class:"text-sm text-b3 font-normal line-clamp-1"},Ys={class:"flex justify-between items-end"},Ks={class:"flex items-center gap-1"},Js={class:"text-sm text-b3 font-normal line-clamp-1"},Ws={class:"text-sm text-b1 font-semibold text-right flex items-center"},qs=e("div",{class:"shrink-0"},[e("img",{class:"w-4 h-4",src:Ye})],-1),Zs={class:"ml-1"},Qs={class:"text-sm text-b2 font-normal"},Xs=ne({props:{type:null,shopId:null},emits:["close","select"],setup(a,{emit:p}){const i=a,{t:s}=ce(),L=k(!0),n=()=>i.type==1?s("service.select goods"):i.type==2?s("service.browse record"):i.type==3?s("service.cart"):i.type==4?s("service.collect"):s("service.select goods"),l=we({total:0,loading:!1,finished:!1,list:[]}),r=we({page:0,size:10}),I=async()=>{l.loading=!0,r.page+=1,await F(),l.loading=!1},F=async()=>{const t=await xt({...r,shopId:i.shopId,type:i.type});if(t.msg!="SUCCESS"){l.finished=!0;return}if(!t||!t.total){l.finished=!0;return}l.total=t.total;let _=t.data||[];l.list=r.page===1?_:l.list.concat(_),l.list.length>=l.total&&(l.finished=!0)},u=t=>{p("select",t)};return be(async()=>{I()}),(t,_)=>{const h=U("van-icon"),T=U("VanImage"),j=U("VanButton"),M=U("VanList"),b=U("VanPopup");return g(),Z(b,{teleport:"body",show:L.value,position:"bottom",round:"","close-on-click-overlay":!1,onClickOverlay:_[3]||(_[3]=G(v=>t.$emit("close"),["stop"])),"overlay-class":"categoryOverlay",class:"sm:w-[375px] sm:left-[50%] sm:translate-x-[-50%]",style:{"min-height":"50%","border-radius":"16px 16px 0 0"}},{default:E(()=>[e("div",{class:"relative w-full py-4 px-3 bg-b6 rounded-t-[10px] overflow-hidden font-Puhui",onClick:_[2]||(_[2]=G(()=>{},["stop"]))},[e("header",Rs,[e("div",js,P(n()),1),e("div",zs,[$(h,{name:"cross",size:"24",onClick:_[0]||(_[0]=G(()=>{p("close")},["stop"]))})])]),$(M,{loading:c(l).loading,"onUpdate:loading":_[1]||(_[1]=v=>c(l).loading=v),finished:c(l).finished,"immediate-check":!1,"loading-text":t.$t("common.loading"),onLoad:I,class:"shopList overflow-y-auto h-[calc(100vh-200px)]"},{finished:E(()=>[c(l).list.length===0&&!c(l).loading?(g(),Z(He,{key:0,name:t.$t("common.No products")},null,8,["name"])):J("",!0)]),default:E(()=>[(g(!0),S(xe,null,he(c(l).list,v=>(g(),S("div",{key:v.id,class:"flex flex-row-reverse justify-between py-3 border-b border-b-b4 last:border-none"},[e("div",Os,[$(T,{class:"shrink-0",src:((v==null?void 0:v.icons)||"").split(",")[0],radius:"8px",width:"80px",height:"80px",fit:"cover"},null,8,["src"]),e("div",Hs,[e("div",null,[e("div",Ns,P(v.goodsName||" "),1),e("div",Gs,P(v.goodsDesc||""),1)]),e("div",Ys,[e("div",Ks,[e("div",Js,P(t.$t("flashSale.unitPrice"))+": ",1),e("div",Ws,[qs,e("div",Zs,P(c(vt)(v.price)),1)])]),$(j,{class:"w-fit h-[32px] px-3 rounded-md border-none bg-b5 flex items-center justify-center",onClick:G(H=>u(v),["stop"])},{default:E(()=>[e("span",Qs,P(t.$t("service.send")),1)]),_:2},1032,["onClick"])])])])]))),128))]),_:1},8,["loading","finished","loading-text"])])]),_:1},8,["show"])}}}),eo={class:"text-center felx-1 relative pb-4"},to={class:"text-lg leading-[26px] text-b1 font-bold"},so={class:"absolute right-0 top-0 px-2"},oo=["name","onClick"],no=["src"],ao={key:1,class:"w-4 h-4 border-[1px] border-b4 border-solid rounded-full"},lo={class:"w-full flex justify-between items-center"},io={class:"text-sm text-b3 font-normal line-clamp-1"},ro={class:"text-xs text-b3 font-normal line-clamp-1"},co={class:"w-full h-[80px] flex flex-col justify-between"},uo={class:"w-full flex justify-start items-center gap-1"},po={class:"text-sm text-b1 font-semibold line-clamp-1"},vo={key:0,class:"shrink-0 flex items-center text-xs text-[#34C2A9]"},fo=e("img",{src:$t,class:"w-5 h-5"},null,-1),mo={class:"text-sm text-b3 font-normal line-clamp-1"},go={class:"flex justify-between items-end"},ho={class:"text-sm text-b3 font-normal line-clamp-1"},xo={class:"text-sm text-b1 font-semibold text-right flex items-center"},wo=e("div",{class:"shrink-0"},[e("img",{class:"w-4 h-4",src:Ye})],-1),bo={class:"ml-1"},_o={key:0,class:"absolute bottom-0 left-1/2 -translate-x-1/2 w-full flex items-center gap-x-3 py-4 px-3 bg-b5"},yo=ne({props:{shopId:null},emits:["close","select"],setup(a,{emit:p}){const i=a,{t:s}=ce(),L=k(!0),n=we({total:0,loading:!1,finished:!1,list:[]}),l=we({page:0,size:10}),r=async()=>{n.loading=!0,l.page+=1,await I(),n.loading=!1},I=async()=>{const b=await It({...l,type:2,storeId:i.shopId});if(b.msg!="SUCCESS"){n.finished=!0;return}if(!b||!b.total){n.finished=!0;return}n.total=b.total;let v=b.data||[];n.list=l.page===1?v:n.list.concat(v),n.list.length>=n.total&&(n.finished=!0)},F=b=>new ze(b.price).times(b.number),u=k([]),t=k([]),_=k(null),h=(b,v)=>{var H;(H=t[v])==null||H.toggle(),T(b)},T=b=>{u.value=[b.id]},j=()=>{var v;if(!u.value.length)return M(s("service.please select order"));const b=(v=n.list||[])==null?void 0:v.find(H=>H.id===u.value[0]);p("select",b)},M=(b="",v="toast-warn.svg")=>{R({message:b,icon:se(v),duration:2e3,overlay:!0,overlayClass:"toastOverlay",className:"toastCard",type:"html"})};return be(async()=>{r()}),(b,v)=>{const H=U("van-icon"),W=U("van-checkbox"),q=U("van-checkbox-group"),te=U("VanImage"),X=U("VanList"),ee=U("VanButton"),ae=U("VanPopup");return g(),Z(ae,{teleport:"body",show:L.value,position:"bottom",round:"","close-on-click-overlay":!1,onClickOverlay:v[4]||(v[4]=G(m=>b.$emit("close"),["stop"])),"overlay-class":"categoryOverlay",class:"sm:w-[375px] sm:left-[50%] sm:translate-x-[-50%]",style:{"min-height":"50%","border-radius":"16px 16px 0 0"}},{default:E(()=>[e("div",{class:"relative w-full py-4 px-4 bg-b5 rounded-t-[10px] overflow-hidden font-Puhui",onClick:v[3]||(v[3]=G(()=>{},["stop"]))},[e("header",eo,[e("div",to,P(b.$t("service.select order")),1),e("div",so,[$(H,{name:"cross",size:"24",onClick:v[0]||(v[0]=G(()=>{p("close")},["stop"]))})])]),$(X,{loading:c(n).loading,"onUpdate:loading":v[2]||(v[2]=m=>c(n).loading=m),finished:c(n).finished,"immediate-check":!1,"loading-text":b.$t("common.loading"),onLoad:r,class:"shopList overflow-y-auto h-[calc(100vh-200px)] pb-[62px]"},{finished:E(()=>[c(n).list.length===0&&!c(n).loading?(g(),Z(He,{key:0})):J("",!0)]),default:E(()=>[(g(!0),S(xe,null,he(c(n).list,(m,V)=>(g(),S("div",{class:me(["p-3 mb-3 bg-white rounded-lg border-[1px] border-[transparent] border-solid last:mb-0 cursor-pointer",u.value.includes(m.id)?"!border-[#FF8812]":""]),key:m.id,name:m.id,onClick:G(A=>h(m,V),["stop"])},[$(q,{modelValue:u.value,"onUpdate:modelValue":v[1]||(v[1]=A=>u.value=A),ref:(A,x)=>{x.checkboxGroup=A,_.value=A},max:1},{default:E(()=>[$(W,{name:m.id,id:m.id,ref:A=>t.value[V]=A,"label-position":"left",class:"flex flex-row-reverse justify-between",onClick:G(A=>T(m),["stop"])},{icon:E(()=>[u.value.includes(m.id)?(g(),S("img",{key:0,class:"w-4 h-4",src:c(se)("innerService/checked.svg"),alt:""},null,8,no)):(g(),S("div",ao))]),default:E(()=>[e("div",lo,[e("div",io,P(b.$t("service.order number"))+": "+P(m.id),1),e("div",ro,P(c(ft)(m.createTime,"YYYY-MM-DD HH:mm")),1)])]),_:2},1032,["name","id","onClick"])]),_:2},1032,["modelValue"]),(g(!0),S(xe,null,he(m.orderGoods,A=>(g(),S("div",{key:A.id,class:"mt-3 flex items-center gap-2"},[$(te,{class:"shrink-0",src:((A==null?void 0:A.icons)||"").split(",")[0],radius:"8px",width:"80px",height:"80px",fit:"cover"},null,8,["src"]),e("div",co,[e("div",null,[e("div",uo,[e("div",po,P(A.goodsName||" "),1),m.creditFlag?(g(),S("div",vo,[fo,de(" "+P(b.$t("order.Credit Collection")),1)])):J("",!0)]),e("div",mo,P(b.$t("order.quantity",{number:A.number||0})),1)]),e("div",go,[e("div",ho,P(b.$t("common.total"))+": ",1),e("div",xo,[wo,e("div",bo,P(F(A)),1)])])])]))),128))],10,oo))),128))]),_:1},8,["loading","finished","loading-text"]),u.value.length?(g(),S("div",_o,[$(ee,{class:"submit-btn flex-1 bg-yellow text-b1 text-base font-semibold border-none h-[46px]",round:"",onClick:G(j,["stop"])},{default:E(()=>[de(P(b.$t("service.send")),1)]),_:1},8,["onClick"])])):J("",!0)])]),_:1},8,["show"])}}}),ko=["onClick"],$o={key:0,src:xs,class:"shrink-0 w-5 h-5"},Io={key:1,src:ws,class:"shrink-0 w-5 h-5"},Co={class:"px-3 pt-3 pb-4 flex flex-wrap gap-y-4"},So=["onClick"],Lo=ne({props:{readonly:{type:Boolean},shopId:null},emits:["sendMessage","setSendMessageScrollEnd","setFunctionShow","inputFocus"],setup(a,{expose:p,emit:i}){const{isKeyboardVisible:s}=Ne(),[L,n]=pe(!1),[l,r]=pe(!1),{t:I}=ce(),{accountStore:F}=mt(),u=k(""),t=()=>{u.value&&i("sendMessage",ee(1))},_=k(null),h=k(!1),T=k(!1),j=k([{name:I("service.camera"),key:"camera",icon:se("innerService/box-camera.svg"),clickFun:()=>{}},{name:I("service.photo"),key:"photo",icon:se("innerService/box-photo.svg"),clickFun:()=>{}},{name:I("service.order"),key:"order",icon:se("innerService/box-order.svg"),clickFun:()=>te()},{name:I("service.goods"),key:"goods",icon:se("innerService/box-goods.svg"),clickFun:()=>W(1)},{name:I("service.browse"),key:"browse",icon:se("innerService/box-browse.svg"),clickFun:()=>W(2)},{name:I("service.cart"),key:"cart",icon:se("innerService/box-cart.svg"),clickFun:()=>W(3)},{name:I("service.collect"),key:"collect",icon:se("innerService/box-collect.svg"),clickFun:()=>W(4)}]),M=()=>{T.value||(h.value=!h.value,T.value=!0,h.value?setTimeout(()=>{i("setSendMessageScrollEnd","auto"),T.value=!1},300):T.value=!1)};st(_,()=>{h.value&&(h.value=!1)}),Se(()=>h.value,x=>{i("setFunctionShow",x)},{immediate:!0,deep:!0});const b=x=>{console.log(x),i("sendMessage",ee(2,x.content))},v=x=>{console.log(x),x.forEach(w=>{i("sendMessage",ee(2,w.content))})},H=k(0),W=x=>{H.value=x,n(!0)},q=x=>{console.log(x),i("sendMessage",ee(5001,x)),n(!1)},te=()=>{r(!0)},X=x=>{console.log(x),i("sendMessage",ee(5002,x)),r(!1)},ee=(x,w)=>{var D;let O={address:F==null?void 0:F.account,nickname:"我",isMe:!0,readFlag:!1,createAt:new Date().getTime()},Y={};if(x==1&&(Y={content:u.value,type:1,extra:""},u.value=""),x==2&&(Y={content:w.content,type:2,extra:w.extra,version:1,thumbnail:w.thumbnail}),x==5001){const K=window.location.origin;Y={myUrl:K+"/#/goodsDetail?id="+w.id,otherUrl:K+"/#/goodsDetail?id="+w.id,type:5001,detail:{id:w.id,title:w.goodsName||"",description:w.goodsDesc||"",image:(w.icons||"").split(",")[0],price:w.price}}}if(x==5002){const K=window.location.origin;Y={myUrl:K+"/#/buyerOrderList/buyerOrderDetail?id="+w.id,otherUrl:K+"/#/sellerOrderDetail?id="+w.id,type:5002,detail:{id:w.id,title:((D=w.orderGoods.map(_e=>_e.goodsName))==null?void 0:D.join(","))||"",description:"订单号"+w.id,image:(w.orderGoods[0].icons||"").split(",")[0],price:ae(w)}}}return console.log(Y),{content:JSON.stringify(Y),...O}},ae=x=>{let w=0;return x.orderGoods.forEach(O=>{const Y=new ze(O.price).times(O.number);w+=Y.toNumber(),console.log(w)}),w},m=k(null),V=k(null);Se(()=>s.value,x=>{Le.versions.ios&&x&&A()},{immediate:!1});const A=()=>{var x;try{(x=m.value)==null||x.focus(),setTimeout(()=>{var w;(w=V.value)==null||w.focus()},50)}catch{console.error("iOS键盘滚动问题处理失败")}};return p({clickFunction:M}),(x,w)=>{const O=U("VanField"),Y=U("van-field");return g(),S("div",{ref:(D,K)=>{K.functionRef=D,_.value=D}},[e("div",{class:me(["w-full sm:w-[375px] fixed bottom-0 left-1/2 -translate-x-1/2 z-10 bg-gray1",h.value?"bottom-[228px] transition-all duration-[300ms]":"bottom-0"])},[e("div",{class:me(["p-3 flex items-center gap-3",h.value?"":"safe-bottom"])},[$(O,{ref:(D,K)=>{K.sendInputRef=D,V.value=D},class:"h-[44px] bg-white rounded-lg px-2 py-3 text-sm text-b1 font-normal",modelValue:u.value,"onUpdate:modelValue":w[0]||(w[0]=D=>u.value=D),onKeyup:ot(t,["enter"]),onFocus:w[1]||(w[1]=D=>i("inputFocus")),placeholder:x.$t("common.pleaseInput")+"...",readonly:a.readonly,enterkeyhint:"send"},null,8,["modelValue","onKeyup","placeholder","readonly"]),e("div",{class:"shrink-0 w-[44px] h-[44px] bg-white rounded-lg flex items-center justify-center",onClick:G(M,["stop"])},[h.value?(g(),S("img",Io)):(g(),S("img",$o))],8,ko)],2)],2),e("div",{class:me(["w-full sm:w-[375px] fixed bottom-0 left-1/2 -translate-x-1/2 z-10 bg-gray1 transition-all duration-[300ms]",h.value?"h-fit  translate-y-0":"h-0  translate-y-[228px]"])},[e("div",Co,[(g(!0),S(xe,null,he(j.value,D=>(g(),S("div",{class:"w-[25%] flex justify-center items-center",key:D.key,onClick:G(D.clickFun,["stop"])},[D.key==="camera"?(g(),Z(Bs,{key:0,onSendCamera:b},{default:E(()=>[$(Ce,{data:D},null,8,["data"])]),_:2},1024)):D.key==="photo"?(g(),Z(Us,{key:1,onSendPhoto:v},{default:E(()=>[$(Ce,{data:D},null,8,["data"])]),_:2},1024)):(g(),Z(Ce,{key:2,data:D},null,8,["data"]))],8,So))),128))])],2),c(L)?(g(),Z(Xs,{key:0,type:H.value,shopId:a.shopId,onSelect:q,onClose:w[2]||(w[2]=D=>c(n)(!1))},null,8,["type","shopId"])):J("",!0),c(l)?(g(),Z(yo,{key:1,shopId:a.shopId,onSelect:X,onClose:w[3]||(w[3]=D=>c(r)(!1))},null,8,["shopId"])):J("",!0),$(Y,{class:"!fixed !w-0 !h-0 !opacity-0",ref:(D,K)=>{K.virtualInputRef=D,m.value=D}},null,512)],512)}}}),Po={class:"w-full sm:w-[375px] h-[50px] px-4 bg-white flex justify-between items-center fixed top-0 left-1/2 -translate-x-1/2 z-10"},Fo={class:"flex flex-wrap items-center w-10"},To={class:"text-lg leading-[26px] font-bold text-b1 text-center"},Ao=e("div",{class:"w-10"},null,-1),Mo={key:0,class:"w-full py-4 flex justify-center items-center"},Bo={class:"pt-4 flex flex-col-reverse"},Uo=e("div",{id:"bottom"},null,-1),Yo=ne({setup(a){var Me;const{isKeyboardVisible:p}=Ne(),{t:i}=ce(),s=nt(),L=at(),n=navigator.userAgent.toLowerCase(),l=/mobile|android|iphone|ipad|phone/i.test(n),r=k(((Me=s.query)==null?void 0:Me.groupId)||""),I=oe(()=>{var o;return((o=s.query)==null?void 0:o.shopId)||""}),F=oe(()=>{var o;return((o=s.query)==null?void 0:o.storeName)||""}),u=oe(()=>{var o;return(o=s.query)!=null&&o.storeLogo?decodeURIComponent(s.query.storeLogo):""}),t=k([]),_=k(!1),h=k(!1),T=k(0),j=k(20),M=async()=>{r.value&&(h.value||_.value||(_.value=!0,T.value=t.value.length?t.value[t.value.length-1].createAt:0,await b(),_.value=!1))},b=async()=>{const o=T.value,f=await bt({groupId:r.value,cursor:o,limit:j.value});if(f.msg!=="SUCCESS"){h.value=!0;return}let C=f.data||[];if(C=te(C),!C.length){h.value=!0;return}const y=Q.value.scrollHeight;if(t.value=t.value.concat(C),t.value.length<=100)t.value=t.value.sort((d,B)=>B.createAt-d.createAt);else{let d=t.value.slice(0,t.value.length-100),B=t.value.slice(t.value.length-100);B=B.sort((N,re)=>re.createAt-N.createAt),t.value=d.concat(B)}if(await fe(),!o||o===0)le("auto"),setTimeout(()=>{le()},250);else{const d=Q.value.scrollHeight;Q.value.scrollTo({top:x.value+d-y,behavior:"auto"})}},v=k(null),H=k([]),W=async()=>{if(!r.value)return;const o=await _t({groupId:r.value});if(o.msg!=="SUCCESS")return;let f=o.data||[];if(f=te(f),!f.length)return;let C=!1;Q.value.scrollTop+Q.value.clientHeight>=Q.value.scrollHeight&&(C=!0),console.log(Q.value.scrollTop,Q.value.clientHeight,Q.value.scrollHeight),t.value=f.concat(t.value);let y=[];if(t.value.length<=100){let d=t.value;t.value=X(t.value,"messageId"),t.value=t.value.sort((B,N)=>N.createAt-B.createAt),y=t.value.filter(B=>!d.find(N=>B.messageId==N.messageId))}else{let d=t.value.slice(0,100),B=t.value.slice(100),N=d;d=X(d,"messageId"),d=d.sort((re,ue)=>ue.createAt-re.createAt),y=d.filter(re=>!N.find(ue=>re.messageId==ue.messageId)),t.value=d.concat(B)}await fe(),C?le():y.forEach(d=>{H.value.push(d.messageId)})},q=()=>{v.value&&(clearInterval(v.value),v.value=null)},te=o=>o.filter(f=>{let C={};try{C=JSON.parse(f.content);try{C.extra=JSON.parse(C==null?void 0:C.extra)}catch{C.extra={}}}catch{C={},C.extra={}}const{type:y,extra:d}=C;return!(!y||y==1&&(d!=null&&d.operate)||y==9||y==101||y==200||y==801||y==802||y==8001||y==8002)}),X=(o,f)=>{const C=new Map;return o.filter(y=>C.has(y[f])?!1:(C.set(y[f],!0),!0))},ee=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var f=Math.random()*16|0,C=o==="x"?f:f&3|8;return C.toString(16)}),ae=async o=>{var y;const f=ee();if(t.value.unshift({uuid:f,status:"send",...o}),le(),setTimeout(()=>{le()},250),!r.value&&I.value){const d=await yt({shopId:I.value});if(d.msg!=="SUCCESS"){R(i("service.netword error create group"));const B=t.value.findIndex(N=>N.uuid===f);t.value[B].status="fail";return}r.value=d.data.id}let C=o.content;setTimeout(()=>{const d=t.value.findIndex(B=>B.uuid===f);t.value[d].status!=="success"&&t.value[d].status!=="fail"&&(t.value[d].status="loading")},1e3);try{const d=await kt({groupId:r.value,content:C}),B=t.value.findIndex(N=>N.uuid===f);if(d.msg!=="SUCCESS"){t.value[B].status="fail";return}t.value[B].status="success",t.value[B]={...t.value[B],...d.data,content:(y=d.data)==null?void 0:y.content}}catch{R(i("service.network error send message"));const d=t.value.findIndex(B=>B.uuid===f);t.value[d].status="fail"}},m=(o,f)=>{t.value.splice(f,1);let C=o;delete C.uuid,delete C.status,ae(C)},V=k(null),A=k(!1),x=k(0),w=k(!1),O=k(null),Y=o=>{x.value=o.target.scrollTop,Le.versions.ios&&(w.value=!0,O.value&&(clearTimeout(O.value),O.value=null),O.value=setTimeout(()=>{w.value=!1},50)),!K.value&&Q.value.scrollHeight>Q.value.clientHeight+50&&x.value<50&&M()};Se(()=>p.value,o=>{Le.versions.ios&&o?le():le("auto")},{immediate:!1});const D=()=>{var o;l&&A.value&&((o=V.value)==null||o.clickFunction())},K=k(!1),_e=oe(()=>document.getElementById("bottom")),Q=oe(()=>document.getElementById("fm-page")),le=async(o="smooth")=>{await fe(),K.value=!0,Q.value.scrollTo({top:_e.value.offsetTop,behavior:o}),o==="smooth"?setTimeout(()=>{K.value=!1},250):K.value=!1},Ke=o=>{L.push(o)},Je="data:image/png;base64,",z=k([]),ye=oe(()=>z.value.sort((o,f)=>f.createAt-o.createAt).reverse()),Fe=k(null),ve=k(0),Te=async(o,f,C)=>{var d;let y=ie(o);if(z.value[y].open=!0,f&&!z.value[y].bigImage){C&&ke(o),await We(o),y=ie(o),z.value[y].bigImage&&z.value[y].open&&((d=Fe.value)==null||d.close(),fe(()=>{R.clear(),ke(o)}));return}ke(o)},ke=o=>{const f=ye.value.map(d=>d.bigImage||Ae()+d.thumbnail),C=qe(o),y=ie(o);ve.value=y,Fe.value=lt({images:f,startPosition:C,loop:!1,showIndex:!1,swipeDuration:300,className:"preview-van-popup",overlayClass:"preview-van-popup",onClose(){R.clear(),z.value[ve.value].open=!1},onChange(d){var re,ue;const B=(re=z.value[ve.value])==null?void 0:re.messageId,N=(ue=ye.value[d])==null?void 0:ue.messageId;if(B!==N&&(R.clear(),z.value[ve.value].open=!1,ve.value=d,!z.value[d].bigImage)){const Xe=ie(N);Te(N,!z.value[Xe].err,!1)}}})},We=async o=>{var C;let f=ie(o);if(z.value[f].loading){R.loading({duration:0,zIndex:3001,className:"preview-img-loading"});return}z.value[f].err=!1,setTimeout(()=>{f=ie(o),!z.value[f].bigImage&&!z.value[f].err&&(R.loading({duration:0,zIndex:3001,className:"preview-img-loading"}),z.value[f].loading=!0)},500);try{const y=((C=t.value.find(N=>N.messageId===o))==null?void 0:C.content)||"",d=JSON.parse(y),B=await Ft(d.content);f=ie(o),z.value[f].bigImage=B,z.value[f].loading=!1}catch{f=ie(o),z.value[f].err=!0,z.value[f].loading=!1,R.clear(),R(i("service.image load error"))}},ie=o=>z.value.findIndex(f=>f.messageId===o),qe=o=>ye.value.findIndex(f=>f.messageId===o),Ze=o=>{z.value.push(o)},Qe=o=>{const f=z.value.findIndex(C=>C.messageId===o);return f>-1?z.value[f].loading:!1},Ae=()=>Je;return Ie("initPreviewImgList",Ze),Ie("getCurrentBigImgLoading",Qe),Ie("getPreviewBase64Prefix",Ae),be(async()=>{if(!r.value&&I.value){const o=await wt({shopId:I.value});if(o.msg!=="SUCCESS")return;r.value=o.data||""}r.value&&(M(),v.value=setInterval(()=>{W()},5e3))}),je(()=>{q()}),(o,f)=>{const C=U("VanLoading");return g(),S("div",{class:"relative w-full h-full bg-gray1 font-Puhui",onScroll:Y},[e("header",Po,[e("div",Fo,[$(ht)]),e("p",To,P(c(F)||o.$t("service.chatMessage")),1),Ao]),e("div",{class:me(["w-full px-3 pt-[50px] transition-all",A.value?"pb-[calc(44px+12px+env(safe-area-inset-bottom)+20px+228px)]":"pb-[calc(44px+12px+env(safe-area-inset-bottom)+20px)]"])},[_.value?(g(),S("div",Mo,[$(C,{size:"24"})])):J("",!0),e("div",Bo,[(g(!0),S(xe,null,he(t.value,(y,d)=>(g(),Z(hs,{class:"mb-4",key:y.messageId||y.uuid,id:y.messageId,chat:y,last:d<t.value.length-1?t.value[d+1]:null,index:d,length:t.value.length,storeLogo:c(u),onResetSendMessage:B=>m(B,d),onHandleTo:Ke,onPreviewImage:B=>Te(y.messageId,!0,!0)},null,8,["id","chat","last","index","length","storeLogo","onResetSendMessage","onPreviewImage"]))),128))])],2),$(Lo,{ref:(y,d)=>{d.chatBox=y,V.value=y},readonly:w.value,shopId:c(I),onSendMessage:ae,onSetFunctionShow:f[0]||(f[0]=y=>A.value=y),onSetSendMessageScrollEnd:le,onInputFocus:D},null,8,["readonly","shopId"]),Uo],32)}}});export{Yo as default};
