import{_ as Q,z as Ve,G as r,H as n,U as x,O as e,J as _,a4 as m,Q as c,V as Ze,N as y,bn as He,y as v,r as D,bl as Je,a2 as V,B as F,bO as Qe,ad as We,E as et,F as $,Z as k,$ as Me,I as t,P as M,K as Be,a3 as tt,a0 as st,X as ot,Y as at,T as A}from"./vendor-Dr_RpJ_Y.js";import{_ as nt}from"./member-CkdtKF8y.js";import{S as it}from"./SkewCard-C0W1kxOf.js";import{S as lt}from"./shop-CeqcS6K2.js";import{a as ut,k as De,f as ct,Y as H,w as rt,bB as dt}from"./index-CU2nzZe6.js";import{b as pt}from"./beiExtRewardContract-B7mJr7nC.js";import{q as vt,c as ft}from"./beiRanking-B5hPI_dv.js";import{b as mt}from"./beiConstContract-BSRzZQRe.js";import{u as ht}from"./useKeyboard-DcWqtm11.js";const bt="/static/images/lp_reduce-BZy6POGd.svg",xt="/static/images/lp_add-BYW_jo0d.svg",_t={key:0},wt=m("普通店铺"),gt=Ve({props:{type:null,width:{default:125}},setup(p){return(w,O)=>(n(),r("div",{class:y(["tag-box text-right text-white font-semibold pr-5 pt-1 h-[75px] min-w-[120px]",`bg-${p.type||0}`]),style:Ze({width:`${p.width}px`})},[p.type!==void 0?(n(),r("span",_t,[p.type===e(lt).SD?(n(),r(_,{key:0},[wt],64)):(n(),r(_,{key:1},[m(c(w.$t(`common.shop_type_${p.type}`))+"店铺",1)],64))])):x("",!0)],6))}}),kt=Q(gt,[["__scopeId","data-v-ea5a823e"]]),yt={},Tt={class:"points_wrapper"},It=He('<i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i>',10),Ct=[It];function Lt(p,w){return n(),r("div",Tt,Ct)}const J=Q(yt,[["render",Lt],["__scopeId","data-v-66db05bc"]]),T=p=>(ot("data-v-285dd5e7"),p=p(),at(),p),Et=["id"],Ft={class:"relative z-0 p-3"},Mt={class:"flex items-center gap-x-2"},Bt={class:"relative"},Dt={class:"-mt-[17px] w-[40px] border-[1px] border-solid border-white flex-center bg-yellow rounded-3xl mx-auto relative z-10"},Vt=T(()=>t("img",{src:nt,class:"w-4 h-4"},null,-1)),$t={class:"text-sm"},Pt={class:"flex flex-col gap-1 flex-1"},St={class:"text-base font-semibold line-clamp-1 name-width"},Nt={class:"text-b3 flex items-center"},At=["src"],Ot=T(()=>t("span",{class:"mx-1"},"|",-1)),zt={class:"w-[235px]"},Ut={class:"pt-[6px] pb-[5px] border-b-[0.5px] border-solid border-b4 whitespace-nowrap overflow-x-auto"},jt={class:"text-newOrigin"},Rt=m(" 总电量"),Kt={class:"pt-[5px] pb-[6px] flex items-center whitespace-nowrap overflow-x-auto"},qt=T(()=>t("img",{src:bt,class:"w-[11px] h-2.5 mx-[2.5px]"},null,-1)),Yt=T(()=>t("img",{src:xt,class:"w-[11px] h-2.5 mx-[2.5px]"},null,-1)),Gt=T(()=>t("span",null,"*0.1",-1)),Xt={class:"w-4 text-newOrigin font-bold text-base"},Zt={class:"w-full h-[40px] bg-b5 rounded-full p-0.5 mt-4"},Ht={class:"w-full h-full relative"},Jt={class:"absolute w-full h-full flex items-center justify-center left-0 top-0"},Qt=["onClick"],Wt={class:"mt-3 flex items-center bg-b5 p-3 rounded-[10px]"},es={class:"flex items-center gap-x-3"},ts=["onClick"],ss={key:0,class:"text-b3 mt-1 text-xs leading-[18px] flex-start"},os=m(" 当前剩余"),as={key:1,class:"text-newOrigin font-semibold mx-0.5"},ns={key:1,class:"text-b3 mt-1 text-xs leading-[18px] flex-start gap-x-0.5"},is=T(()=>t("span",null,"放电预计电量",-1)),ls={class:"text-error font-semibold"},us=m("-"),cs=T(()=>t("span",null,"/",-1)),rs=T(()=>t("span",null,"充电预计电量",-1)),ds={class:"text-success font-semibold"},ps=m("+"),vs={class:"flex-center-bw mt-4 gap-x-3"},fs=["src"],ms=["src"],hs=["src"],bs=Ve({props:{show:{type:Boolean},shopId:null,teleport:null},emits:["close","voteSuccess","handleTo"],setup(p,{emit:w}){const{show:O,shopId:$e,teleport:xs}=p,{contributesStore:z}=ut(),{voteByPoint:Pe,voteByLp:Se,userVoteDetailView:Ne,voteMonthTimestampView:Ae}=pt(),{userTotalLp:Oe}=mt(),{loadingToggle:U}=rt(),{isKeyboardVisible:ze}=ht(),P=v(()=>[{id:1,text:"积分票"},{id:2,text:"LP票"}]),i=D(null),Ue=[.25,.5,.75],a=Je({tab:1,votesInfo:{1:{total:0,sumUsed:0},2:{total:0,sumUsed:0}},estimateInfo:{coefficient:.1,coefficientLikeBudget:.1,coefficientNotLikeBudget:.1,score:0,scoreLikeBudget:0,scoreNotLikeBudget:0,likeDiffer:0,notlikeDiffer:0,tickets:0},totalTimes:5,rewardTimes:5}),S=v(()=>a==null?void 0:a.votesInfo[a.tab]),B=v(()=>{var o;return Math.max(((o=S.value)==null?void 0:o.total)-(S==null?void 0:S.value.sumUsed),0)}),l=D(null),W=D(null),ee=D(null),[I,j]=V(!0),[d,g]=V(!1),[R,te]=V(!0),[se,oe]=V(!1),K=v(()=>{var o;return new F(((o=i.value)==null?void 0:o.lpNegativeTicket)||0).times(.2)}),q=v(()=>{var o;return new F(((o=i.value)==null?void 0:o.lpPositiveTicket)||0).times(.1)}),ae=v(()=>new F(Math.trunc(+K.value)).minus(Math.trunc(+q.value))),ne=v(()=>K.value.minus(q.value)),Y=v(()=>{var o;return Math.max(+new F((o=i.value)==null?void 0:o.pointTicket).minus(ne.value).div(.2),0)}),ie=v(()=>Math.min(Y.value,B.value||0)),le=v(()=>l.value&&l.value>ie.value),G=v(()=>Math.abs(Math.max(+new F(ne.value||0).div(.1),0))),ue=v(()=>Math.min(G.value,B.value||0)),ce=v(()=>l.value&&l.value>ue.value),je=v(()=>a.tab===1?"0":`LP投票上限:${ie.value}放电票/${ue.value}充电票`),h=D(null),re=o=>{I.value||d.value||(l.value=Math.floor(new F(B.value).times(o).toNumber()))},X=()=>{U(!1),w("close")},Re=o=>{+a.tab==+o||d.value||(l.value=null,a.estimateInfo.tickets=0,a.tab=o)},Ke=async()=>{const{result:o}=await Ae();ee.value=+o.thisMonthTime},[qe,de]=V(!0),Ye=async()=>{U(!0),de(!0);const{success:o,data:s}=await vt({shopId:$e,month:dt()});o&&(de(!1),U(!1),i.value=s)},pe=async()=>{var b,C,N,L;if(a.tab===1)return;if(l.value<=0){a.estimateInfo.tickets=0;return}oe(!0);const o=+l.value>=G.value?+G.value:+l.value,s=i.value.pointTicket-Math.trunc(+K.value)+Math.trunc((((b=i.value)==null?void 0:b.lpPositiveTicket)+o)*.1);a.estimateInfo.likeDiffer=Math.abs(s-((C=i.value)==null?void 0:C.score));const f=+l.value>=Y.value?+Y.value:+l.value,E=i.value.pointTicket-Math.trunc((+((N=i.value)==null?void 0:N.lpNegativeTicket)+f)*.2)+Math.trunc(+q.value);a.estimateInfo.tickets=+l.value,a.estimateInfo.notlikeDiffer=Math.abs(E-((L=i.value)==null?void 0:L.score))||0,oe(!1)};Qe(()=>{pe()});const ve=async()=>{var f;if(!Number(l.value)||+l.value<=0)return A({message:"请输入投票数",duration:2e3}),!1;if(+l.value>+B.value)return A({message:"超过可投数量",duration:2e3}),!1;const{success:o,data:s}=await ft((f=i.value)==null?void 0:f.shopId);return o||A({message:"网络异常～",duration:2e3}),o&&!s&&A({message:"当前店铺无法投票请联系店家确认",duration:2e3}),s},Ge=async()=>{var s;if(I.value||d.value)return;if(g(!0),!await ve()){g(!1);return}h.value=null,g(!0);const{success:o}=await Pe((s=i.value)==null?void 0:s.shopId,l.value);g(!1),o&&(console.log(+a.rewardTimes,+a.totalTimes),w("close"),w("voteSuccess",{direct:200,differ:+l.value},+a.rewardTimes<+a.totalTimes))},fe=async o=>{var f,E,b,C;if(I.value||d.value||o===200&&ce.value||o===400&&le.value)return;if(g(!0),!await ve()){g(!1);return}g(!0),h.value=o,((f=a.estimateInfo)==null?void 0:f.tickets)!==l.value&&await pe();const{success:s}=await Se((E=i.value)==null?void 0:E.shopId,l.value,o);g(!1),s&&(w("close"),w("voteSuccess",{direct:o,differ:o===200?(b=a.estimateInfo)==null?void 0:b.likeDiffer:(C=a.estimateInfo)==null?void 0:C.notlikeDiffer},+a.rewardTimes<+a.totalTimes))},Xe=async()=>{j(!0),await Ke();const{success:o,result:s}=await Ne(ee.value);a.rewardTimes=+(s==null?void 0:s.times),a.votesInfo[1]={total:Math.min(Math.floor(z.contributes/1e3),500),sumUsed:+(s==null?void 0:s.sumTickets)},console.log("rewardTimes :",+(s==null?void 0:s.times)),console.log("contributes :",z.contributes),console.log("sumTickets :",+(s==null?void 0:s.sumTickets)),console.log("votesInfo:",a.votesInfo[1]),o&&j(!1);const f=Math.floor(+await Oe());j(!1),a.votesInfo[2]={total:+f,sumUsed:+(s==null?void 0:s.sumLp)}},me=o=>{(o.key==="Enter"||o.key==="Escape")&&W.value.blur()};return We(()=>{window.removeEventListener("keydown",me)}),et(async()=>{window.addEventListener("keydown",me),Ye(),await z.fetchContributes(),Xe()}),(o,s)=>{const f=$("van-icon"),E=$("VanImage"),b=$("VanLoading"),C=$("VanField"),N=$("VanPopup");return n(),k(N,{show:p.show,"onUpdate:show":s[7]||(s[7]=L=>st(O)?O.value=L:null),teleport:p.teleport,onClickOverlay:tt(X,["stop"]),onClose:X,round:"",class:"bg-transparent",style:{width:"311px",height:"100%"}},{default:Me(()=>[t("div",{class:"relative m-auto text-sm font-normal font-Puhui ransition-all duration-300",id:e(ze)?"position-center":"position-center-top"},[t("div",{class:"text-right text-b6 ml-auto text-lg font-bold h-6 flex items-start justify-end",onClick:X},[M(f,{name:"cross"})]),M(it,{width:"210",right:"26"},{default:Me(()=>{var L,he,be,xe,_e,we,ge,ke,ye,Te,Ie,Ce,Le,Ee,Fe;return[M(kt,{class:"absolute right-1.5 top-1.5 -z-20",type:(L=i.value)==null?void 0:L.type},null,8,["type"]),t("div",Ft,[t("div",Mt,[t("div",Bt,[M(E,{round:"",src:(((he=i.value)==null?void 0:he.logo)||"").split(",")[0],errorIcon:e(De)("images/ranking/noPosition.png"),fit:"cover",width:"46px",height:"46px"},null,8,["src","errorIcon"]),t("div",Dt,[Vt,t("span",$t,"V"+c((be=i.value)==null?void 0:be.memberLevel),1)])]),t("div",Pt,[t("div",St,c((xe=i.value)==null?void 0:xe.storeName),1),t("div",Nt,[t("span",null,c(e(ct)((_e=i.value)==null?void 0:_e.shopAddress,"**",0,4)),1),(we=i.value)!=null&&we.authorizeAddress?(n(),r("img",{key:0,src:e(De)("images/ranking/auth.svg"),class:"w-4 h-4"},null,8,At)):x("",!0),Ot,t("span",null,c(((ge=i.value)==null?void 0:ge.score)||0)+" 电量",1),t("div",{class:"text-newOrigin pl-0.5",onClick:s[0]||(s[0]=u=>e(te)(!e(R)))},c(e(R)?"收起":"详情"),1)])])]),t("div",{class:y(["text-b2 font-semibold rounded-[10px] text-xs flex items-center justify-center gap-x-3 overflow-hidden transition-all duration-300",e(R)?"min-h-[60px] border border-newOrigin mt-2":"h-0 mt-0"]),onClick:s[1]||(s[1]=u=>e(te)(!1))},[t("div",zt,[t("div",Ut,[t("span",jt,[e(qe)?(n(),k(b,{key:0,class:"inline",color:"#ff8812",size:"14"})):(n(),r(_,{key:1},[m(c(Math.max((ke=i.value)==null?void 0:ke.score,0)),1)],64)),Rt]),m(" = "+c(+((ye=i.value)==null?void 0:ye.pointTicket)||0)+" 积分电量 - "+c(Math.trunc(Number(e(ae)||0)))+"LP 电量 ",1)]),t("div",Kt,[t("span",null,c(Math.trunc(Number(e(ae)||0)))+"LP 电量 = "+c(((Te=i.value)==null?void 0:Te.lpNegativeTicket)||0),1),qt,t("span",null,"*0.2 - "+c(((Ie=i.value)==null?void 0:Ie.lpPositiveTicket)||0),1),Yt,Gt])]),t("div",Xt,[M(f,{name:"cross"})])],2),t("div",Zt,[t("div",Ht,[t("div",{class:y(["absolute w-[50%] h-full bg-b1 rounded-full left-0 transition-all duration-300",`w-[${100/e(P).length}%] left-${e(P).findIndex(u=>u.id===e(a).tab)||0}/${e(P).length}`])},null,2),t("div",Jt,[(n(!0),r(_,null,Be(e(P),u=>(n(),r("div",{class:"w-[50%] h-full flex items-center justify-center overflow-hidden",onClick:Z=>Re(u.id),key:u.id},[t("span",{class:y(["text-sm text-center line-clamp-1 transition-all duration-300",[e(a).tab===u.id?"text-b6 font-semibold":"text-b3 font-normal"]])},c(u.text),3)],8,Qt))),128))])])]),t("div",Wt,[M(C,{type:"digit",modelValue:l.value,"onUpdate:modelValue":s[2]||(s[2]=u=>l.value=u),placeholder:e(je),ref:(u,Z)=>{Z.amountInputRef=u,W.value=u},class:y(`input_${e(a).tab}`)},null,8,["modelValue","placeholder","class"]),t("div",es,[e(a).tab===1?(n(),r(_,{key:0},[(n(),r(_,null,Be(Ue,u=>t("div",{class:"shrink-0 w-fit text-newOrigin px-0.5",key:u,onClick:Z=>re(u)},c(u*100)+"% ",9,ts)),64)),t("div",{class:"shrink-0 w-fit text-newOrigin",onClick:s[3]||(s[3]=u=>re(1))}," MAX ")],64)):x("",!0)])]),e(a).tab===1||e(a).tab===2&&!((Ce=e(a).estimateInfo)!=null&&Ce.tickets)?(n(),r("div",ss,[os,e(I)?(n(),k(b,{key:0,size:"10",class:"mx-0.5"})):(n(),r("span",as,c(e(B)),1)),m(c(e(a).tab===1?"积分票":"LP票"),1)])):+e(a).tab==2&&((Le=e(a).estimateInfo)==null?void 0:Le.tickets)>0?(n(),r("div",ns,[is,t("span",ls,[us,e(se)?(n(),k(b,{key:0,size:"12"})):(n(),r(_,{key:1},[m(c((Ee=e(a).estimateInfo)==null?void 0:Ee.notlikeDiffer),1)],64))]),cs,rs,t("span",ds,[ps,e(se)?(n(),k(b,{key:0,size:"12"})):(n(),r(_,{key:1},[m(c((Fe=e(a).estimateInfo)==null?void 0:Fe.likeDiffer),1)],64))])])):x("",!0),t("div",vs,[e(a).tab===1?(n(),r("div",{key:0,class:y(["btn-power text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold flex items-center justify-center",{"opacity-60":e(I)}]),onClick:s[4]||(s[4]=u=>Ge())},[e(d)?x("",!0):(n(),r("img",{key:0,src:e(H)("charge.svg"),class:"w-[18px] h-[18px]"},null,8,fs)),t("span",null,c(e(d)?"充电中":"充电"),1),e(d)?(n(),k(J,{key:1})):x("",!0)],2)):(n(),r(_,{key:1},[t("div",{class:y(["btn-discharge text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold flex items-center justify-center",{"opacity-60":e(le)||e(I)||e(d)&&+h.value!=400}]),onClick:s[5]||(s[5]=u=>fe(400))},[e(d)&&+h.value==400?x("",!0):(n(),r("img",{key:0,src:e(H)("discharge.svg"),class:"w-[18px] h-[18px]"},null,8,ms)),t("span",null,c(e(d)&&+h.value==400?"放电中":"放电"),1),e(d)&&+h.value==400?(n(),k(J,{key:1})):x("",!0)],2),t("div",{class:y(["btn-power text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold flex items-center justify-center",{"opacity-60":e(ce)||e(I)||e(d)&&+h.value!=200}]),onClick:s[6]||(s[6]=u=>fe(200))},[e(d)&&+h.value==200?x("",!0):(n(),r("img",{key:0,src:e(H)("charge.svg"),class:"w-[18px] h-[18px]"},null,8,hs)),t("span",null,c(e(d)&&+h.value==200?"充电中":"充电"),1),e(d)&&+h.value==200?(n(),k(J,{key:1})):x("",!0)],2)],64))])])]}),_:1})],8,Et)]),_:1},8,["show","teleport","onClickOverlay"])}}}),Es=Q(bs,[["__scopeId","data-v-285dd5e7"]]);export{Es as S,kt as a};
