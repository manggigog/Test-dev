import{_ as Me}from"./avatarRing2-Ckr5tuam.js";import{_ as Re}from"./information-BXOyO4i9.js";import{_ as we}from"./MCOIN-Bodfn-v1.js";import{_ as He,z as Fe,r as j,o as je,a2 as U,x as ze,bl as me,y as Z,E as Je,ab as Ke,Z as w,H as p,$ as x,V as Qe,O as s,B as N,F as de,G as _,U as g,P as A,I as r,J as B,a4 as ee,Q as m,K as ye,T as fe,X as Xe,Y as Ye}from"./vendor-Dr_RpJ_Y.js";import{H as Ze}from"./HelpEmpty-BswgK0_f.js";import{C as et}from"./CommonVanProvider-KZuKVOde.js";import{_ as tt}from"./OfflineGoods-DKMaiwr2.js";import{_ as ot}from"./OfflineTotalPriceDetail-DqnMHkSW.js";import{P as st}from"./PaySwitchPop-CSZXaiqX.js";import{D as nt}from"./DividingLine-Dusl4c-B.js";import{P as rt}from"./PaymentMethodSelector-GVMC43bd.js";import{u as at}from"./usePaymentBalance-BUYNiWb-.js";import{_ as te}from"./SubmitApprove-D43sSLMC.js";import{b as lt,a as ut,i as ct,an as f,k as oe,w as it,a8 as pt,f as mt,e as he,g as q,y as ve,C as dt,bL as yt}from"./index-LRhcxFAI.js";import{S as ft}from"./shop-CeqcS6K2.js";import{P as O}from"./order-H59PKTFP.js";import{P as ht}from"./flashSale-DDyqLyYN.js";import{a as be,b as ge,c as vt,d as bt,e as gt}from"./payHelp-D3qS7LGk.js";import{a as d}from"./payHelp-BuwJxNdC.js";import{r as wt}from"./order-CCndJpZE.js";import"./BackIcon-CDrGaEPo.js";import"./offlineGoods-DvT2Go6q.js";import"./ImgBoutiqueLable-B-2xCcw4.js";import"./USDT-Dlu99aCg.js";import"./FMCP-f3k58DsE.js";import"./point-arrow-C6HCTn4p.js";import"./usePointRelase-CmObHy9j.js";import"./piggyBank-CpEOuPx1.js";const z=V=>(Xe("data-v-50d8db82"),V=V(),Ye(),V),_t={key:1},At={class:"page-body overflow-y-auto"},Tt={class:"bg-b6 rounded-xl p-3"},kt={class:"flex items-center gap-x-1"},It=z(()=>r("div",{class:"w-[30px] h-[30px] bg-b5 rounded-full"},[r("img",{src:Me})],-1)),St={class:"text-b2"},xt=z(()=>r("img",{src:Re,class:"w-4 h-4"},null,-1)),Ct=[xt],Pt={class:"flex items-center justify-center gap-x-1 mt-2.5 h-10"},$t=z(()=>r("img",{src:we,class:"w-[17px] h-[17px]"},null,-1)),Lt={class:"text-b1 text-[28px] font-bold"},Ut={class:"bg-b6 rounded-xl p-3 mt-3"},Nt={class:"text-b3"},Bt={class:"flex items-center"},qt=z(()=>r("img",{src:we,class:"w-4 h-4 mr-1.5"},null,-1)),Ot={class:"text-b1 font-normal"},Dt={class:"gap-x-3 py-4 flex items-center justify-between"},Et={key:0,class:"relative flex-1"},Vt={class:"relative flex-1"},Wt={class:"flex items-center justify-center gap-x-0.5"},Gt={class:"font-Puhui"},Mt={class:"text-b1 font-semibold text-center"},Rt={class:"font-Puhui"},Ht={class:"text-b1 text-base font-semibold text-center"},Ft={class:"text-b2 text-sm font-normal flex flex-col gap-y-2 mt-5"},jt=Fe({setup(V){const{checkLoginAuth:_e,checkRegisterAuth:Ae}=lt(),{loadingToggle:se}=it(),Te=je(),T=j(Te.query.payId),[ke,ne]=U(!0),re=j(!1),{accountStore:a}=ut(),{balanceState:C,getPaymentOptions:Ie,fetchAllBalances:ae,autoSelectPaymentMethod:Se,checkSufficientBalance:le}=at(re),{submit:xe}=ct(),{t:P}=ze(),[D,$]=U(!1),[Ce,J]=U(!1),K=j(null),[Pe,Q]=U(!1),[$e,W]=U(!1),[Le,X]=U(!1),G=j(0),v=me({0:null,1:null}),e=me({address:null,lockUser:null,status:null,type:null,postscripts:[],detailList:[],totalAmount:null,goods:[],groupGoods:[],createTime:null,countdownTime:null,otherLock:!1,payAddress:null}),M=Z(()=>f(e==null?void 0:e.address)===f(a==null?void 0:a.account)),Ue=()=>{let t=null,o=null;switch(e==null?void 0:e.status){case d.TIMEOUT:t=oe("images/payHelp/timeout.png"),o=P("payhelp.order_timeout");break;case d.CANCELLED:t=oe("images/payHelp/orderClose.png"),o=P("order.status5");break;case d.PAID:t=oe("images/payHelp/paySuccess.png");const n=(e==null?void 0:e.payAddress)&&f(a==null?void 0:a.account)===f(e==null?void 0:e.payAddress);o=M.value&&n?P("payhelp.pay_success_owner"):P(n?"common.pay success":"payhelp.pay_success_other");break}return{img:t,text:o}},ue=Z(()=>Ue()),Ne=()=>{const t={approveM:0,approveU:0,approveV:0};return Object.values(v).forEach(o=>{if(!o)return;const n=+(o==null?void 0:o.realTotalAmountShow),l=+(o==null?void 0:o.voucherAmount);switch(o.paySource){case O.WALLET:t.approveM+=n;break;case O.WITHDRAW_POINTS:t.approveV+=l;break;case O.USDT_WALLET:t.approveU+=n;break}}),t},k=Z(()=>Ne()),Be=(t,o)=>o===O.WITHDRAW_POINTS?Math.min(C.voucherBalance,t):0,qe=(t,o,n=!1)=>{const l=new N(o).times(t||0).times(C.pointSelfRate).div(100).toString(),c=n?new N(l).div(C.pointSelfRate).times(.5).toNumber():0;return{integral:l,voucherAmount:c}},Oe=t=>t.reduce((o,n)=>{const l=n.goodsType!==ft.SD;l&&(re.value=!0);const c=o.findIndex(i=>i.boutique===l),y=qe(n==null?void 0:n.goodsTotalPrice,n==null?void 0:n.discountRatio,l);return n.integral=y.integral,n.voucherAmount=y.voucherAmount,c===-1?o.push({boutique:l,paySource:l?O.WITHDRAW_POINTS:O.WALLET,goods:[n],totalAmount:n.goodsTotalPrice,integral:+y.integral,voucherAmount:+y.voucherAmount}):(o[c].goods.push(n),o[c].totalAmount=new N(o[c].totalAmount).plus(+n.goodsTotalPrice).toNumber(),o[c].integral=new N(o[c].integral).plus(+y.integral).toNumber(),o[c].voucherAmount+=new N(o[c].voucherAmount).plus(+y.voucherAmount).toNumber()),o},[]),ce=t=>{var o,n;e.address=t==null?void 0:t.address,e.payAddress=t==null?void 0:t.payAddress,e.lockUser=(t==null?void 0:t.lockUser)||null,e.status=t==null?void 0:t.status,e.createTime=t==null?void 0:t.createTime,e.type=(o=t==null?void 0:t.submitInfo)==null?void 0:o.type,e.postscripts=(n=t==null?void 0:t.submitInfo)==null?void 0:n.postscripts,e.totalAmount=t==null?void 0:t.totalAmount},De=t=>{var o;if(ce(t),t==null||t.orderGoods.forEach(n=>{let l=n;e.goods.push({goodsIcons:l.icons,goodsTotalPrice:+new N(l.price).times(l.number),...n})}),e.groupGoods=Oe(e.goods).sort((n,l)=>Number(n.boutique)-Number(l.boutique)),((o=e.groupGoods)==null?void 0:o.length)===1){const n=Se(e.groupGoods[0].totalAmount,e.groupGoods[0].voucherAmount);e.groupGoods[0].paySource=n}},Y=async()=>{if(e.status===d.WAIT){if((e==null?void 0:e.status)===d.WAIT&&!(e!=null&&e.lockUser)&&(a!=null&&a.account)&&f(e.address)!==f(a==null?void 0:a.account)){const{success:t}=await vt(T.value);if(!t)return;e.lockUser=a.account}if(e.otherLock=(a==null?void 0:a.account)&&(e==null?void 0:e.lockUser)&&f(e==null?void 0:e.lockUser)!==f(a==null?void 0:a.account),(e==null?void 0:e.status)===d.WAIT){const t=await pt();e.countdownTime=+(e==null?void 0:e.createTime)+15*60*1e3-t*1e3,e.countdownTime<=0&&(e.status=d.TIMEOUT)}}},Ee=()=>{var t,o,n,l,c,y;if(v[0]&&v[1]&&((t=v[0])==null?void 0:t.paySource)!==((o=v[1])==null?void 0:o.paySource))for(const i of Object.values(v)){if(!i)return;const b=i==null?void 0:i.paySource,L=+(i==null?void 0:i.realTotalAmountShow);if(!le(b,L))return K.value=b,J(!0),!1}else{const i=((n=v[0])==null?void 0:n.paySource)||((l=v[1])==null?void 0:l.paySource),b=(((c=v[0])==null?void 0:c.realTotalAmountShow)||0)+(((y=v[1])==null?void 0:y.realTotalAmountShow)||0);if(!le(i,b))return K.value=i,J(!0),!1}return!0},Ve=()=>{var n;let t=[],o=(n=k.value)==null?void 0:n.approveV;e.groupGoods.forEach(l=>{l.goods.forEach(c=>{t.push({goodsId:c.goodsId,num:c.number,payType:ht.MC,paySource:l.paySource})})});try{return{type:e==null?void 0:e.type,postscripts:e==null?void 0:e.postscripts,detailList:t,genOrder:!1,voucherAmount:o}}catch{return!1}},We=async()=>{if(_e(!0)&&await Ae(!0)){$(!0);try{if(!Ee())return;const t=Ve();if(!t)return;const{success:o,data:n}=await bt(T.value.toString(),t);if(!o){const{success:H,data:F}=await ge(T.value);if(!H)return;ce(F),Y();return}const{allOrderId:l,merchants:c,discounts:y,amounts:i,sources:b,buyer:L}=n,I=await xe(l,c,y,i,b,L);if(!I.success){Y(),f(a==null?void 0:a.account)===f(e==null?void 0:e.address)&&be(T.value);return}if(fe.loading({message:P("order.wait block chain"),forbidClick:!0,duration:0}),await wt({allOrderId:l,hash:I.result.hash}),fe.clear(),!I.result.hash)return;const R=I.result.hash;let S;const E=async()=>{if(G.value>=5){$(!1),G.value=0;return}if(S=await yt(R),(S==null?void 0:S.status)===1){$(!1),G.value=0,ie();return}setTimeout(async()=>{G.value++,E()},5e3)};E()}catch(t){console.log(t,"erro")}finally{$(!1)}}},Ge=async()=>{$(!0);try{const{success:t}=await gt(T.value);if(!t)return;e.status=d.CANCELLED,W(!1)}finally{$(!1)}},ie=async()=>{se(!0),ne(!0);const t=T.value;if(t==null||t==="")return;const{success:o,data:n}=await ge(t);if(se(!1),ne(!1),!o){e.status=d.CANCELLED;return}De(n),await Y(),e.otherLock&&e.status===d.WAIT&&Q(!0)};return Je(async()=>{ae(),await ie()}),Ke(async()=>{e!=null&&e.lockUser&&(e!=null&&e.address)&&(a!=null&&a.account)&&f(a==null?void 0:a.account)===f(e==null?void 0:e.address)&&f(e==null?void 0:e.lockUser)===f(a.account)&&e.status===d.WAIT&&be(T.value)}),(t,o)=>{var c;const n=de("VanButton"),l=de("van-count-down");return p(),w(et,{title:s(M)?t.$t("order.waitBlockOrder"):t.$t("payhelp.payHelp"),class:"bg-gray1 font-Puhui px-3 relative",style:Qe({background:((c=s(e))==null?void 0:c.status)===s(d).WAIT?"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)":"#F2F0EF"}),themeVars:{navBarBackgroundColor:"transparent","count-down-font-size":"16px"}},{default:x(()=>{var y,i,b,L,I,R,S,E,H,F,pe;return[s(ke)?g("",!0):(p(),_(B,{key:0},[(y=s(e))!=null&&y.status&&((i=s(e))==null?void 0:i.status)!==s(d).WAIT?(p(),w(Ze,{key:0,name:(b=s(ue))==null?void 0:b.text,imgUrl:(L=s(ue))==null?void 0:L.img},null,8,["name","imgUrl"])):g("",!0),((I=s(e))==null?void 0:I.status)===s(d).WAIT?(p(),_("div",_t,[r("div",At,[r("div",Tt,[r("div",kt,[It,r("div",St,[s(M)?(p(),_(B,{key:0},[ee(m(t.$t("payhelp.owner_wait_tip")),1)],64)):(p(),_(B,{key:1},[ee(m(s(mt)(s(e).address,"...",5,5))+" "+m(t.$t("payhelp.other_wait_tip")),1)],64))]),r("div",{onClick:o[0]||(o[0]=u=>s(X)(!0))},Ct)]),r("div",Pt,[$t,r("span",Lt,m(s(he)((R=s(e))==null?void 0:R.totalAmount)),1)])]),(p(!0),_(B,null,ye(s(e).groupGoods,u=>(p(),_(B,{key:u.boutique},[s(e).type===2?(p(),w(nt,{key:0,goodsBoutiqueFlag:u.boutique},null,8,["goodsBoutiqueFlag"])):g("",!0),r("div",Ut,[(p(!0),_(B,null,ye(u.goods,h=>(p(),w(tt,{key:h.goodsId,goods:h,showGoodsType:"",showDesc:"",class:"h-[80px] mb-3 last:mb-0"},{"bottom-left":x(()=>[r("div",Nt,m(t.$t("order.quantity",{number:h.number}))+"ï¼Œ"+m(t.$t("order.sumtotal"))+": ",1)]),"bottom-price":x(()=>[r("div",Bt,[qt,r("div",Ot,m(s(he)((h==null?void 0:h.goodsTotalPrice)||0)),1)])]),_:2},1032,["goods"]))),128))]),A(rt,{paymentOptions:s(Ie)(0,u.boutique)||[],loading:s(C).loading,boutique:u.boutique,modelValue:u.paySource,"onUpdate:modelValue":h=>u.paySource=h,onGetPointBalance:s(ae),class:"mt-3"},null,8,["paymentOptions","loading","boutique","modelValue","onUpdate:modelValue","onGetPointBalance"]),A(ot,{ref:h=>s(v)[Number(u.boutique)]=h,totalAmount:u.totalAmount,"usdt-rate":s(C).usdtRate,"voucher-price":s(C).voucherBalance,integral:u.integral,voucherAmount:Be(u.voucherAmount,u.paySource),paySource:u.paySource},null,8,["totalAmount","usdt-rate","voucher-price","integral","voucherAmount","paySource"])],64))),128))]),r("div",Dt,[s(M)?(p(),_("div",Et,[A(n,{round:"",class:"bg-b6 text-b1 text-base !border !border-solid !border-b4 h-[46px] w-full",loading:s(D),disabled:(S=s(e))==null?void 0:S.otherLock,onClick:o[1]||(o[1]=u=>s(W)(!0))},{default:x(()=>[ee(m(t.$t("order.cancelOrder")),1)]),_:1},8,["loading","disabled"])])):g("",!0),r("div",Vt,[s(k).approveM>0?(p(),w(te,{key:0,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:s(q).order,token:s(q).MCOIN,symbol:"MCOIN",loading:s(D),approveAmount:Number(s(k).approveM)},null,8,["contract","token","loading","approveAmount"])):g("",!0),((E=s(k))==null?void 0:E.approveU)>0?(p(),w(te,{key:1,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:s(q).order,token:s(q).USDT,symbol:"USDT",loading:s(D),approveAmount:Number(s(k).approveU)},null,8,["contract","token","loading","approveAmount"])):g("",!0),((H=s(k))==null?void 0:H.approveV)>0?(p(),w(te,{key:2,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:s(q).order,token:s(q).FMCP,symbol:t.$t("voucher.voucher"),loading:s(D),approveAmount:Number((F=s(k))==null?void 0:F.approveV)},null,8,["contract","token","symbol","loading","approveAmount"])):g("",!0),A(n,{round:"",class:"pay-btn btn-yellow w-full h-[46px] text-base font-semibold",loading:s(D),disabled:(pe=s(e))==null?void 0:pe.otherLock,onClick:We},{default:x(()=>{var u,h;return[r("div",Wt,[r("span",null,m(t.$t("common.pay")),1),((u=s(e))==null?void 0:u.countdownTime)>0?(p(),w(l,{key:0,time:(h=s(e))==null?void 0:h.countdownTime,format:"mm:ss",onFinish:o[2]||(o[2]=()=>{s(e).status=s(d).TIMEOUT})},null,8,["time"])):g("",!0)])]}),_:1},8,["loading","disabled"])])])])):g("",!0),A(st,{paySource:K.value,show:s(Ce),onClose:o[3]||(o[3]=u=>s(J)(!1))},null,8,["paySource","show"]),A(ve,{noClose:"",show:s(Pe),onClose:o[5]||(o[5]=u=>s(Q)(!1))},{default:x(()=>[r("div",Gt,[r("div",Mt,m(t.$t("payhelp.lockTips")),1),r("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:o[4]||(o[4]=u=>s(Q)(!1))},m(t.$t("common.I_see")),1)])]),_:1},8,["show"]),A(ve,{noClose:"",show:s(Le),onClose:o[7]||(o[7]=u=>s(X)(!1))},{default:x(()=>[r("div",Rt,[r("div",Ht,m(t.$t("payhelp.instructions")),1),r("ul",Ft,[r("li",null,m(t.$t("payhelp.instructions_1")),1),r("li",null,m(t.$t("payhelp.instructions_2")),1),r("li",null,m(t.$t("payhelp.instructions_3")),1)]),r("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:o[6]||(o[6]=u=>s(X)(!1))},m(t.$t("common.I_see")),1)])]),_:1},8,["show"]),A(dt,{show:s($e),title:t.$t("order.cancelOrder"),content:t.$t("order.cancelOrderTips"),showConfirm:!0,showReject:!0,confirmText:t.$t("common.confirm"),noClose:"",onClose:o[8]||(o[8]=u=>s(W)(!1)),onConfirm:o[9]||(o[9]=u=>Ge()),onReject:o[10]||(o[10]=u=>s(W)(!1))},null,8,["show","title","content","confirmText"])],64))]}),_:1},8,["title","style"])}}}),Ao=He(jt,[["__scopeId","data-v-50d8db82"]]);export{Ao as default};
