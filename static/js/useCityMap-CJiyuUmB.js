import{aB as F,aC as L,aD as I}from"./index-7OiUoGXy.js";const P=()=>{const o=F(),p=()=>{sessionStorage.removeItem("location_permission_denied_shown"),o.clearLocationErrorFlag()};let y=!1;const x=t=>{y||(y=!0,navigator.geolocation?(console.log("原生能力开始获取位置"),navigator.geolocation.getCurrentPosition(e=>{y=!1,C(e,t)},e=>{y=!1,D(e),t==="reset"&&o.setMsgError("需开启应用的位置权限允许获取您的当前地理位置","位置获取失败")},{timeout:1e4,maximumAge:3e5})):(console.log("原生能力不支持定位"),y=!1,o.setLocationCity(null),o.setDefaultLocation(),o.setPositionFinished(!0)))},C=async(t,e)=>{var l;console.log("原生能力获取位置成功",t);const{latitude:n,longitude:u}=t.coords;p(),o.setLngLat(u,n),o.setPositionFinished(!0);try{const i={areaLongitude:u,areaLatitude:n};let r=null,c=null,a=null;if(o.currentActiveCity?(c=o.currentActiveCity,r=await L({...i,areaLevel:2}),a=r.data):(r=await Promise.all([I(),L({...i,areaLevel:2})]),c=r[0].data,a=r[1].data),a&&a.overseasFlag&&(a=await L({...i,areaLevel:1}),console.log("gpsCity-海外城市 areaLevel=1",a)),a)if(o.locationCity&&((l=o.locationCity)==null?void 0:l.areaId)!==a.areaId&&o.clearLocationErrorFlag(),o.setLocationCity(a),c&&(c==null?void 0:c.areaId)!==a.areaId){o.setCurrentCity(c,"manual");const g=window.location.hash;e!=="cityErr"&&(g.indexOf("/city/cityMap")>-1||g.indexOf("/city/search")>-1||g.indexOf("/city/poi")>-1)&&o.setCityChangeTips(c,a)}else o.locationMatchMode!=="manual"&&o.setCurrentCity(a,"auto");else o.setLocationCity(null),o.setNavigatorState(!0),o.setDefaultLocation()}catch{o.setLocationCity(null),o.setNavigatorState(!0),o.setDefaultLocation()}},D=t=>{console.log("原生能力获取位置失败",t),o.setPositionFinished(!0),o.setLocationCity(null),o.setLngLat(null,null),o.setNavigatorState(!0),o.setDefaultLocation()};return{getUserLocation:x,showPosition:C,distanceFormat:(t,e="",n=2,u=999)=>{const l=Number((t?t/1e3:0).toFixed(n));if(l>u)return">999km";if(l>=1){const i=l>0?Number(l).toFixed(n):0;return`${e}${i}km`}else{const i=t?Number(t):0;return`${e}${i}m`}},clearPermissionDeniedFlag:p,getLeafletjsAddressTitle:t=>{var e;if(t!=null&&t.name&&(t==null?void 0:t.name)!=="")return t==null?void 0:t.name;if(t!=null&&t.display_name){let n=((e=t==null?void 0:t.display_name)==null?void 0:e.split(","))||[];n=n.map(i=>i==null?void 0:i.trim()),n=n.filter(i=>{var r,c;return i!=((r=t==null?void 0:t.address)==null?void 0:r.postcode)&&i!=((c=t==null?void 0:t.address)==null?void 0:c.country)});const u=n.findIndex(i=>Number(i)>=0);let l="";if(u>-1){let i=n[0]+"号";l=n[1]+i}else l=n.length?n.length?n[0]:(t==null?void 0:t.country)||"":"";return l||"未知地址"}},getLeafletjsAddressDescription:t=>{var l,i,r,c,a,g,h;let e=((i=(l=t==null?void 0:t.display_name)==null?void 0:l.split(","))==null?void 0:i.reverse())||[];e=e.map(f=>f==null?void 0:f.trim()),e=e.filter(f=>{var m,v;return f!=((m=t==null?void 0:t.address)==null?void 0:m.postcode)&&f!=((v=t==null?void 0:t.address)==null?void 0:v.country)});const n=e.findIndex(f=>Number(f)>=0);let u="";return e.length?e.forEach((f,m)=>{n===m?u+=f+"号":u+=f}):u=((r=t==null?void 0:t.address)==null?void 0:r.county)||((c=t==null?void 0:t.address)==null?void 0:c.city)||((a=t==null?void 0:t.address)==null?void 0:a.region)||((g=t==null?void 0:t.address)==null?void 0:g.state)||((h=t==null?void 0:t.address)==null?void 0:h.country),u||"未知地址"}}};export{P as u};
